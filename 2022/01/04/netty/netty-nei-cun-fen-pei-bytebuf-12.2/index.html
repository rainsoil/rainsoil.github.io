<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Netty内存分配ByteBuf(12, railsoil">
    <meta name="description" content="4. Pooled 池化内存分配1. PooledByteBufAllocator 简述现在开始, 我们来分析Pooled 池化内存的分配原理, 我们首先还是先找到 AbstractByteBufAllocator 的子类 PooledBy">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Netty内存分配ByteBuf(12 | railsoil</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="railsoil" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">railsoil</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">railsoil</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/2.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Netty内存分配ByteBuf(12</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Netty/" class="post-category">
                                Netty
                            </a>
                        
                            <a href="/categories/Netty/Netty/" class="post-category">
                                Netty
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-01-04
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    20.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    96 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="4-Pooled-池化内存分配"><a href="#4-Pooled-池化内存分配" class="headerlink" title="4. Pooled 池化内存分配"></a>4. Pooled 池化内存分配</h2><h3 id="1-PooledByteBufAllocator-简述"><a href="#1-PooledByteBufAllocator-简述" class="headerlink" title="1. PooledByteBufAllocator 简述"></a>1. PooledByteBufAllocator 简述</h3><p>现在开始, 我们来分析Pooled 池化内存的分配原理, 我们首先还是先找到 AbstractByteBufAllocator 的子类 PooledByteBufAllocator  实现的分配内存的两个方法. newDirectBuffer()方法和 newHeapBuffer()方法：</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> ByteBuf <span class="token function">newHeapBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        PoolThreadCache cache <span class="token operator">=</span> threadCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        PoolArena<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> heapArena <span class="token operator">=</span> cache<span class="token punctuation">.</span>heapArena<span class="token punctuation">;</span>

        ByteBuf buf<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>heapArena <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            buf <span class="token operator">=</span> heapArena<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnpooledHeapByteBuf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">toLeakAwareBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> ByteBuf <span class="token function">newDirectBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        PoolThreadCache cache <span class="token operator">=</span> threadCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        PoolArena<span class="token operator">&lt;</span>ByteBuffer<span class="token operator">></span> directArena <span class="token operator">=</span> cache<span class="token punctuation">.</span>directArena<span class="token punctuation">;</span>

        ByteBuf buf<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>directArena <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            buf <span class="token operator">=</span> directArena<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>PlatformDependent<span class="token punctuation">.</span><span class="token function">hasUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                buf <span class="token operator">=</span> UnsafeByteBufUtil<span class="token punctuation">.</span><span class="token function">newUnsafeDirectByteBuf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnpooledDirectByteBuf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">toLeakAwareBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>我们发现这两个方法大体结构上是一样的. 我们以newDirectBuffer 为例简单的分析一下：</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> ByteBuf <span class="token function">newDirectBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        PoolThreadCache cache <span class="token operator">=</span> threadCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        PoolArena<span class="token operator">&lt;</span>ByteBuffer<span class="token operator">></span> directArena <span class="token operator">=</span> cache<span class="token punctuation">.</span>directArena<span class="token punctuation">;</span>

        ByteBuf buf<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>directArena <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            buf <span class="token operator">=</span> directArena<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>PlatformDependent<span class="token punctuation">.</span><span class="token function">hasUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                buf <span class="token operator">=</span> UnsafeByteBufUtil<span class="token punctuation">.</span><span class="token function">newUnsafeDirectByteBuf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnpooledDirectByteBuf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">toLeakAwareBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>首先,我们看到它是通过 threadCache.get() 拿到一个类型为PoolThreadCache 的cache 对象, 然后, 通过  cache 拿到 PoolArena 对象, 最终会调用 directArena.allocate()  方法分配 ByteBuf. 这个地方大家可能会看的比较懵, 我们来详细分析一下，我们跟进到  threadCache  对象其实是PoolThreadLocalCache 类型的变量, 跟进到 PoolThreadLocalCache 的源码:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">PoolThreadLocalCache</span> <span class="token keyword">extends</span> <span class="token class-name">FastThreadLocal</span><span class="token operator">&lt;</span>PoolThreadCache<span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">synchronized</span> PoolThreadCache <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> PoolArena<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> heapArena <span class="token operator">=</span> <span class="token function">leastUsedArena</span><span class="token punctuation">(</span>heapArenas<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> PoolArena<span class="token operator">&lt;</span>ByteBuffer<span class="token operator">></span> directArena <span class="token operator">=</span> <span class="token function">leastUsedArena</span><span class="token punctuation">(</span>directArenas<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PoolThreadCache</span><span class="token punctuation">(</span>
                    heapArena<span class="token punctuation">,</span> directArena<span class="token punctuation">,</span> tinyCacheSize<span class="token punctuation">,</span> smallCacheSize<span class="token punctuation">,</span> normalCacheSize<span class="token punctuation">,</span>
                    DEFAULT_MAX_CACHED_BUFFER_CAPACITY<span class="token punctuation">,</span> DEFAULT_CACHE_TRIM_INTERVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onRemoval</span><span class="token punctuation">(</span>PoolThreadCache threadCache<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            threadCache<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> PoolArena<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">leastUsedArena</span><span class="token punctuation">(</span>PoolArena<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> arenas<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>arenas <span class="token operator">==</span> null <span class="token operator">||</span> arenas<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            PoolArena<span class="token operator">&lt;</span>T<span class="token operator">></span> minArena <span class="token operator">=</span> arenas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arenas<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                PoolArena<span class="token operator">&lt;</span>T<span class="token operator">></span> arena <span class="token operator">=</span> arenas<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>arena<span class="token punctuation">.</span>numThreadCaches<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> minArena<span class="token punctuation">.</span>numThreadCaches<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    minArena <span class="token operator">=</span> arena<span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> minArena<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>从名字上来看, 我们发现PoolThreadLocalCache 的initialValue()  方法就是用来初始化PoolThreadLocalCache  的, 首先就调用了leastUsedArena() 方法分别获取类型为 PoolArena 的 heapArena 对象和directArena 对象. 然后把heapArena 对象和directArena 对象 当做参数出传递到了 PoolThreadLocalCache  的构造器中, 那么  heapArena 对象和directArena 对象 是在哪里被初始化的呢? 我们查找一下发现在PooledByteBufAllocator 的 构造器中调用 newArenaArray() 方法给heapArenas 和directArenas 赋值了。</p>
<pre class=" language-java"><code class="language-java">   <span class="token keyword">public</span> <span class="token function">PooledByteBufAllocator</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> preferDirect<span class="token punctuation">,</span> <span class="token keyword">int</span> nHeapArena<span class="token punctuation">,</span> <span class="token keyword">int</span> nDirectArena<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maxOrder<span class="token punctuation">,</span>
                                  <span class="token keyword">int</span> tinyCacheSize<span class="token punctuation">,</span> <span class="token keyword">int</span> smallCacheSize<span class="token punctuation">,</span> <span class="token keyword">int</span> normalCacheSize<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>preferDirect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolThreadLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tinyCacheSize <span class="token operator">=</span> tinyCacheSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>smallCacheSize <span class="token operator">=</span> smallCacheSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>normalCacheSize <span class="token operator">=</span> normalCacheSize<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> chunkSize <span class="token operator">=</span> <span class="token function">validateAndCalculateChunkSize</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">,</span> maxOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nHeapArena <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"nHeapArena: "</span> <span class="token operator">+</span> nHeapArena <span class="token operator">+</span> <span class="token string">" (expected: >= 0)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nDirectArena <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"nDirectArea: "</span> <span class="token operator">+</span> nDirectArena <span class="token operator">+</span> <span class="token string">" (expected: >= 0)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> pageShifts <span class="token operator">=</span> <span class="token function">validateAndCalculatePageShifts</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nHeapArena <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            heapArenas <span class="token operator">=</span> <span class="token function">newArenaArray</span><span class="token punctuation">(</span>nHeapArena<span class="token punctuation">)</span><span class="token punctuation">;</span>
            List<span class="token operator">&lt;</span>PoolArenaMetric<span class="token operator">></span> metrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>PoolArenaMetric<span class="token operator">></span><span class="token punctuation">(</span>heapArenas<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> heapArenas<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                PoolArena<span class="token punctuation">.</span>HeapArena arena <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolArena<span class="token punctuation">.</span>HeapArena</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> maxOrder<span class="token punctuation">,</span> pageShifts<span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                heapArenas<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arena<span class="token punctuation">;</span>
                metrics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>arena<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            heapArenaMetrics <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>metrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            heapArenas <span class="token operator">=</span> null<span class="token punctuation">;</span>
            heapArenaMetrics <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nDirectArena <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            directArenas <span class="token operator">=</span> <span class="token function">newArenaArray</span><span class="token punctuation">(</span>nDirectArena<span class="token punctuation">)</span><span class="token punctuation">;</span>
            List<span class="token operator">&lt;</span>PoolArenaMetric<span class="token operator">></span> metrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>PoolArenaMetric<span class="token operator">></span><span class="token punctuation">(</span>directArenas<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> directArenas<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                PoolArena<span class="token punctuation">.</span>DirectArena arena <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolArena<span class="token punctuation">.</span>DirectArena</span><span class="token punctuation">(</span>
                        <span class="token keyword">this</span><span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> maxOrder<span class="token punctuation">,</span> pageShifts<span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                directArenas<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arena<span class="token punctuation">;</span>
                metrics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>arena<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            directArenaMetrics <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>metrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            directArenas <span class="token operator">=</span> null<span class="token punctuation">;</span>
            directArenaMetrics <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>进去到newArenaArray() 方法:</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> PoolArena<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">newArenaArray</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PoolArena</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>其实就是创建一个固定大小的 PoolArena 数组, 数组大小由传入的参数 数 nHeapArena 和 nDirectArena 来决定, 我们再回到PooledByteBufAllocator 的构造器源码, 看 nHeapArena 和 nDirectArena 是怎么初始化的, 我们找到了PooledByteBufAllocator 的重载构造器:</p>
<pre class=" language-java"><code class="language-java">   <span class="token keyword">public</span> <span class="token function">PooledByteBufAllocator</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> preferDirect<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>preferDirect<span class="token punctuation">,</span> DEFAULT_NUM_HEAP_ARENA<span class="token punctuation">,</span> DEFAULT_NUM_DIRECT_ARENA<span class="token punctuation">,</span> DEFAULT_PAGE_SIZE<span class="token punctuation">,</span> DEFAULT_MAX_ORDER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>我们发现, nHeapArena 和 nDirectArena  是通过  DEFAULT_NUM_HEAP_ARENA, DEFAULT_NUM_DIRECT_ARENA 这两个常量默认赋值的, 再继续跟进常量的定义:</p>
<pre class=" language-java"><code class="language-java">  DEFAULT_NUM_HEAP_ARENA <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>
                SystemPropertyUtil<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
                        <span class="token string">"io.netty.allocator.numHeapArenas"</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
                                defaultMinNumArena<span class="token punctuation">,</span>
                                runtime<span class="token punctuation">.</span><span class="token function">maxMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> defaultChunkSize <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DEFAULT_NUM_DIRECT_ARENA <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>
                SystemPropertyUtil<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
                        <span class="token string">"io.netty.allocator.numDirectArenas"</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
                                defaultMinNumArena<span class="token punctuation">,</span>
                                PlatformDependent<span class="token punctuation">.</span><span class="token function">maxDirectMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> defaultChunkSize <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>到这里为止 , 我们才知道 nHeapArena 和 nDirectArena 的默认赋值, 默认是分配CPU 核数*2, 也就是把 defaultMinNumArena的值赋值给 nHeapArena 和 nDirectArena . 那么Netty 为什么这样设计呢? 其实主要目的就是为了保证Netty 中的每一个线程任务都可以有一个独享的 Arena, 保证在每个线程分配内存的是是不用加锁的.</p>
<p>基于上面的分析, 我们知道 Arena 有HeapArena 和 DirectArena , 这里我们统称为Arena . 假设我们有四个线程, 那么对应会分配四个 Arena , 在创建ByteBuf 的时候, 首先通过 PoolThreadCache 获取Arena  对象并 赋值给其成员变量, 然后, 每个线程通过PoolThreadCache  调用get 方法的时候会拿到它底层的Arena , 也就是说 EventLoop1 拿到 Arena1,  EventLoop2拿到 Arena2, 以此类推, 如下图所示：</p>
<p> <img src="http://files.luyanan.com//img/20191007173949.png"></p>
<p>那么PoolThreadCache 除了可以只在Arena  上进行内存分配，还可以在他底层维护ByteBuf 缓存列表进行分配.举个例子: 我们通过PooledByteBufAllocator 去创建了一个1024字节大小的ByteBuf, 当我们用完释放之后, 我们可能会在其他地方继续分配1024 字节大小的ByteBuf. 这个时候, 其实不需要要在 Arena  上进行内存分配, 而是直接通过 PoolThreadCache 中维护的ByteBuf 的缓存列表直接拿过来返回, 那么, 在  PooledByteBufAllocator 中维护三种规定大小的缓存列表, 分别是三个值 tinyCacheSize、smallCacheSize、normalCacheSize：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PooledByteBufAllocator</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractByteBufAllocator</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> InternalLogger logger <span class="token operator">=</span> InternalLoggerFactory<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>PooledByteBufAllocator<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_NUM_HEAP_ARENA<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_NUM_DIRECT_ARENA<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_PAGE_SIZE<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_MAX_ORDER<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 8192 &lt;&lt; 11 = 16 MiB per chunk</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_TINY_CACHE_SIZE<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_SMALL_CACHE_SIZE<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_NORMAL_CACHE_SIZE<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_MAX_CACHED_BUFFER_CAPACITY<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_CACHE_TRIM_INTERVAL<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MIN_PAGE_SIZE <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_CHUNK_SIZE <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> Integer<span class="token punctuation">.</span>MAX_VALUE <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> defaultPageSize <span class="token operator">=</span> SystemPropertyUtil<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"io.netty.allocator.pageSize"</span><span class="token punctuation">,</span> <span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Throwable pageSizeFallbackCause <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">validateAndCalculatePageShifts</span><span class="token punctuation">(</span>defaultPageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            pageSizeFallbackCause <span class="token operator">=</span> t<span class="token punctuation">;</span>
            defaultPageSize <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        DEFAULT_PAGE_SIZE <span class="token operator">=</span> defaultPageSize<span class="token punctuation">;</span>

        <span class="token keyword">int</span> defaultMaxOrder <span class="token operator">=</span> SystemPropertyUtil<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"io.netty.allocator.maxOrder"</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Throwable maxOrderFallbackCause <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">validateAndCalculateChunkSize</span><span class="token punctuation">(</span>DEFAULT_PAGE_SIZE<span class="token punctuation">,</span> defaultMaxOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            maxOrderFallbackCause <span class="token operator">=</span> t<span class="token punctuation">;</span>
            defaultMaxOrder <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        DEFAULT_MAX_ORDER <span class="token operator">=</span> defaultMaxOrder<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Determine reasonable default for nHeapArena and nDirectArena.</span>
        <span class="token comment" spellcheck="true">// Assuming each arena has 3 chunks, the pool should not consume more than 50% of max memory.</span>
        <span class="token keyword">final</span> Runtime runtime <span class="token operator">=</span> Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Use 2 * cores by default to reduce condition as we use 2 * cores for the number of EventLoops</span>
        <span class="token comment" spellcheck="true">// in NIO and EPOLL as well. If we choose a smaller number we will run into hotspots as allocation and</span>
        <span class="token comment" spellcheck="true">// deallocation needs to be synchronized on the PoolArena.</span>
        <span class="token comment" spellcheck="true">// See https://github.com/netty/netty/issues/3888</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> defaultMinNumArena <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> defaultChunkSize <span class="token operator">=</span> DEFAULT_PAGE_SIZE <span class="token operator">&lt;&lt;</span> DEFAULT_MAX_ORDER<span class="token punctuation">;</span>
        DEFAULT_NUM_HEAP_ARENA <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>
                SystemPropertyUtil<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
                        <span class="token string">"io.netty.allocator.numHeapArenas"</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
                                defaultMinNumArena<span class="token punctuation">,</span>
                                runtime<span class="token punctuation">.</span><span class="token function">maxMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> defaultChunkSize <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DEFAULT_NUM_DIRECT_ARENA <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>
                SystemPropertyUtil<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
                        <span class="token string">"io.netty.allocator.numDirectArenas"</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
                                defaultMinNumArena<span class="token punctuation">,</span>
                                PlatformDependent<span class="token punctuation">.</span><span class="token function">maxDirectMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> defaultChunkSize <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// cache sizes</span>
        DEFAULT_TINY_CACHE_SIZE <span class="token operator">=</span> SystemPropertyUtil<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"io.netty.allocator.tinyCacheSize"</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DEFAULT_SMALL_CACHE_SIZE <span class="token operator">=</span> SystemPropertyUtil<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"io.netty.allocator.smallCacheSize"</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DEFAULT_NORMAL_CACHE_SIZE <span class="token operator">=</span> SystemPropertyUtil<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"io.netty.allocator.normalCacheSize"</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 32 kb is the default maximum capacity of the cached buffer. Similar to what is explained in</span>
        <span class="token comment" spellcheck="true">// 'Scalable memory allocation using jemalloc'</span>
        DEFAULT_MAX_CACHED_BUFFER_CAPACITY <span class="token operator">=</span> SystemPropertyUtil<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
                <span class="token string">"io.netty.allocator.maxCachedBufferCapacity"</span><span class="token punctuation">,</span> <span class="token number">32</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// the number of threshold of allocations when cached entries will be freed up if not frequently used</span>
        DEFAULT_CACHE_TRIM_INTERVAL <span class="token operator">=</span> SystemPropertyUtil<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
                <span class="token string">"io.netty.allocator.cacheTrimInterval"</span><span class="token punctuation">,</span> <span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.allocator.numHeapArenas: &amp;#123;&amp;#125;"</span><span class="token punctuation">,</span> DEFAULT_NUM_HEAP_ARENA<span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.allocator.numDirectArenas: &amp;#123;&amp;#125;"</span><span class="token punctuation">,</span> DEFAULT_NUM_DIRECT_ARENA<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pageSizeFallbackCause <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.allocator.pageSize: &amp;#123;&amp;#125;"</span><span class="token punctuation">,</span> DEFAULT_PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.allocator.pageSize: &amp;#123;&amp;#125;"</span><span class="token punctuation">,</span> DEFAULT_PAGE_SIZE<span class="token punctuation">,</span> pageSizeFallbackCause<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>maxOrderFallbackCause <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.allocator.maxOrder: &amp;#123;&amp;#125;"</span><span class="token punctuation">,</span> DEFAULT_MAX_ORDER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.allocator.maxOrder: &amp;#123;&amp;#125;"</span><span class="token punctuation">,</span> DEFAULT_MAX_ORDER<span class="token punctuation">,</span> maxOrderFallbackCause<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.allocator.chunkSize: &amp;#123;&amp;#125;"</span><span class="token punctuation">,</span> DEFAULT_PAGE_SIZE <span class="token operator">&lt;&lt;</span> DEFAULT_MAX_ORDER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.allocator.tinyCacheSize: &amp;#123;&amp;#125;"</span><span class="token punctuation">,</span> DEFAULT_TINY_CACHE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.allocator.smallCacheSize: &amp;#123;&amp;#125;"</span><span class="token punctuation">,</span> DEFAULT_SMALL_CACHE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.allocator.normalCacheSize: &amp;#123;&amp;#125;"</span><span class="token punctuation">,</span> DEFAULT_NORMAL_CACHE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.allocator.maxCachedBufferCapacity: &amp;#123;&amp;#125;"</span><span class="token punctuation">,</span> DEFAULT_MAX_CACHED_BUFFER_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.allocator.cacheTrimInterval: &amp;#123;&amp;#125;"</span><span class="token punctuation">,</span> DEFAULT_CACHE_TRIM_INTERVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> PooledByteBufAllocator DEFAULT <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">PooledByteBufAllocator</span><span class="token punctuation">(</span>PlatformDependent<span class="token punctuation">.</span><span class="token function">directBufferPreferred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> PoolArena<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> heapArenas<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> PoolArena<span class="token operator">&lt;</span>ByteBuffer<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> directArenas<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> tinyCacheSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> smallCacheSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> normalCacheSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>PoolArenaMetric<span class="token operator">></span> heapArenaMetrics<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>PoolArenaMetric<span class="token operator">></span> directArenaMetrics<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> PoolThreadLocalCache threadCache<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">PooledByteBufAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">PooledByteBufAllocator</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> preferDirect<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>preferDirect<span class="token punctuation">,</span> DEFAULT_NUM_HEAP_ARENA<span class="token punctuation">,</span> DEFAULT_NUM_DIRECT_ARENA<span class="token punctuation">,</span> DEFAULT_PAGE_SIZE<span class="token punctuation">,</span> DEFAULT_MAX_ORDER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">PooledByteBufAllocator</span><span class="token punctuation">(</span><span class="token keyword">int</span> nHeapArena<span class="token punctuation">,</span> <span class="token keyword">int</span> nDirectArena<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maxOrder<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> nHeapArena<span class="token punctuation">,</span> nDirectArena<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> maxOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">PooledByteBufAllocator</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> preferDirect<span class="token punctuation">,</span> <span class="token keyword">int</span> nHeapArena<span class="token punctuation">,</span> <span class="token keyword">int</span> nDirectArena<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maxOrder<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>preferDirect<span class="token punctuation">,</span> nHeapArena<span class="token punctuation">,</span> nDirectArena<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> maxOrder<span class="token punctuation">,</span>
                DEFAULT_TINY_CACHE_SIZE<span class="token punctuation">,</span> DEFAULT_SMALL_CACHE_SIZE<span class="token punctuation">,</span> DEFAULT_NORMAL_CACHE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>我们看到, 在 PooledByteBufAllocator 的构造器中, 分 别 赋 值 了 tinyCacheSize=512 ， smallCacheSize=256 ，<br>normalCacheSize=64。通过这样一种方式，Netty 中给我们预创建固定规格的内存池，大大提高了内存分配的性能。</p>
<h3 id="2-DirectArena-内存分配流程"><a href="#2-DirectArena-内存分配流程" class="headerlink" title="2. DirectArena 内存分配流程"></a>2. DirectArena 内存分配流程</h3><p>Arena 分配内存的基本流程有三个步骤:</p>
<ol>
<li>从对象池中拿到 PooledByteBuf 进行复用</li>
<li>从缓存中进行内存分配</li>
<li>从内存堆中进行内存分配</li>
</ol>
<p>我们以directBuff 为例, 首先来看从对象池中拿到 PooledByteBuf  对象进行复用的情况, 我们依旧跟进到 PooledByteBufAllocator 的 newDirectBuffer()方法</p>
<pre class=" language-java"><code class="language-java"> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> ByteBuf <span class="token function">newDirectBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        PoolThreadCache cache <span class="token operator">=</span> threadCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        PoolArena<span class="token operator">&lt;</span>ByteBuffer<span class="token operator">></span> directArena <span class="token operator">=</span> cache<span class="token punctuation">.</span>directArena<span class="token punctuation">;</span>

        ByteBuf buf<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>directArena <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            buf <span class="token operator">=</span> directArena<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>PlatformDependent<span class="token punctuation">.</span><span class="token function">hasUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                buf <span class="token operator">=</span> UnsafeByteBufUtil<span class="token punctuation">.</span><span class="token function">newUnsafeDirectByteBuf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnpooledDirectByteBuf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">toLeakAwareBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>上面的PoolArena 我们已经清楚, 现在我们直接跟进到 PoolArena 的allocate()  方法:</p>
<pre class=" language-java"><code class="language-java">    PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">allocate</span><span class="token punctuation">(</span>PoolThreadCache cache<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf <span class="token operator">=</span> <span class="token function">newByteBuf</span><span class="token punctuation">(</span>maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">allocate</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> buf<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>在这个地方其实就非常清晰了, 首先调用 newByteBuf()  方法拿到一个PooledByteBuf 对象, 接下来通过 allocate()  方法在线程私有的 PoolThreadCache 中分配一块内存, 然后buf 里面的内存地址之类的值进行初始化,我们跟进到  newByteBuf()  看一下, 选择 DirectArena 对象：</p>
<pre class=" language-java"><code class="language-java">     <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> PooledByteBuf<span class="token operator">&lt;</span>ByteBuffer<span class="token operator">></span> <span class="token function">newByteBuf</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>HAS_UNSAFE<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> PooledUnsafeDirectByteBuf<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> PooledDirectByteBuf<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>我们发现首先判断是否支持 Unsafe, 默认情况下一般是支持 Unsafe 的, 虽然我们继续进入到 PooledUnsafeDirectByteBuf 的 newInstance()方法：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">PooledUnsafeDirectByteBuf</span> <span class="token keyword">extends</span> <span class="token class-name">PooledByteBuf</span><span class="token operator">&lt;</span>ByteBuffer<span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Recycler<span class="token operator">&lt;</span>PooledUnsafeDirectByteBuf<span class="token operator">></span> RECYCLER <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Recycler</span><span class="token operator">&lt;</span>PooledUnsafeDirectByteBuf<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> PooledUnsafeDirectByteBuf <span class="token function">newObject</span><span class="token punctuation">(</span>Handle<span class="token operator">&lt;</span>PooledUnsafeDirectByteBuf<span class="token operator">></span> handle<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PooledUnsafeDirectByteBuf</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> PooledUnsafeDirectByteBuf <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        PooledUnsafeDirectByteBuf buf <span class="token operator">=</span> RECYCLER<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">.</span><span class="token function">reuse</span><span class="token punctuation">(</span>maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> buf<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>顾名思义, 我看到首先就是从 RECYCLER (也就是内存回收站) 对象的 get() 方法中拿到一个buf, 从上面的代码片段来看, RECYCLER 对象实现了一个newObject() 方法, 当回收站里面没有可用的buf时就会去创建一个新的buf. 因为创建的buf 可能是从回收站拿出来的 , 复用前需要重置,因此继续往下看就会调用buf 的reuse()  方法.</p>
<pre class=" language-java"><code class="language-java">   <span class="token comment" spellcheck="true">/**
     * Method must be called before reuse this &amp;#123;@link PooledByteBufAllocator&amp;#125;
     */</span>
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">reuse</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">maxCapacity</span><span class="token punctuation">(</span>maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setRefCnt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setIndex0</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">discardMarks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>我们发现 reuse() 就是对所有的参数重新归为初始状态, 到这里我们已经清楚从内存池获取buf 对象的全过程. 那么接下来, 再回到PoolArena 的 allocate()方法. 看看真实的内存是如何分配出来的, buf 的内存分配主要有两种情况: 分别是:从缓存中进行内存分配和从内存堆中进行内存分配, 我们来看代码, 进入 allocate() 方法具体逻辑：</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">allocate</span><span class="token punctuation">(</span>PoolThreadCache cache<span class="token punctuation">,</span> PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> normCapacity <span class="token operator">=</span> <span class="token function">normalizeCapacity</span><span class="token punctuation">(</span>reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTinyOrSmall</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// capacity &lt; pageSize</span>
            <span class="token keyword">int</span> tableIdx<span class="token punctuation">;</span>
            PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> tiny <span class="token operator">=</span> <span class="token function">isTiny</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tiny<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// &lt; 512</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">allocateTiny</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// was able to allocate out of the cache so move on</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                tableIdx <span class="token operator">=</span> <span class="token function">tinyIdx</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                table <span class="token operator">=</span> tinySubpagePools<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">allocateSmall</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// was able to allocate out of the cache so move on</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                tableIdx <span class="token operator">=</span> <span class="token function">smallIdx</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                table <span class="token operator">=</span> smallSubpagePools<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> head <span class="token operator">=</span> table<span class="token punctuation">[</span>tableIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/**
             * Synchronize on the head. This is needed as &amp;#123;@link PoolChunk#allocateSubpage(int)&amp;#125; and
             * &amp;#123;@link PoolChunk#free(long)&amp;#125; may modify the doubly linked list as well.
             */</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> s <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> head<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">assert</span> s<span class="token punctuation">.</span>doNotDestroy <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span>elemSize <span class="token operator">==</span> normCapacity<span class="token punctuation">;</span>
                    <span class="token keyword">long</span> handle <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">assert</span> handle <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    s<span class="token punctuation">.</span>chunk<span class="token punctuation">.</span><span class="token function">initBufWithSubpage</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>tiny<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        allocationsTiny<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        allocationsSmall<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">allocateNormal</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>normCapacity <span class="token operator">&lt;=</span> chunkSize<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">allocateNormal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// was able to allocate out of the cache so move on</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">allocateNormal</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Huge allocations are never served via the cache so just call allocateHuge</span>
            <span class="token function">allocateHuge</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这段代码逻辑看起来非常复杂, 其实大部分的逻辑基本上都是判断不同的规格大小, 从其对应的缓存中获取内存, 如果所有的规格都不满足, 那就直接调用allocateHuge()  方法进行真实的内存分配.</p>
<h3 id="3-内存池的内存规格"><a href="#3-内存池的内存规格" class="headerlink" title="3. 内存池的内存规格"></a>3. 内存池的内存规格</h3><p>在前面的源码分析中, 关于内存规格大小我们应该还有些印象, 其实在Netty 内存池中主要设置了四种规格大小的内存: </p>
<ul>
<li><p>tiny 是指0-512byte 之间的规格大小</p>
</li>
<li><p>small 是指512byte - 8kb 之间的规格大小</p>
</li>
<li><p>normal 是指8kb - 16MB 之间的规格大小</p>
</li>
<li><p>buge 是指16MB 以上的</p>
<p>为什么Netty 会选择这些值作为一个分界点呢? 其实在Netty 底层还有一个内存单位的封装. 为了更高效的管理内存, 避免内存浪费, 把每一个区间的内存规格都做了细分. 默认情况下, Netty 将内存规格分为四个部分. Netty 中所有的内存申请是以Chunk 为单位向内存申请的, 大小为16M， 后续的内存分配都是在这个Chunk里面的操作. 8KB 对应的是一个Page, 一个Chunk 会以Page 为单位进行切分. 8KB 对应的Chunk 被划分为2048个Page. 小于8K的对应的是SubPage. 例如: 我们申请的是一段内存空间只有1K , 却给我们分配了一个Page, 显然另外7K 就会被浪费, 所以继续把Page 进行划分, 节省空间 . 如下图所示:</p>
<p><img src="http://files.luyanan.com//img/20191008220148.png"></p>
</li>
</ul>
<p>至此, 小伙伴应该已经非常清楚Netty的内存池缓存管理机制了. </p>
<h3 id="4-命中缓存的分配"><a href="#4-命中缓存的分配" class="headerlink" title="4. 命中缓存的分配"></a>4. 命中缓存的分配</h3><p>前面我们简单分析了directArena 内容分配大概流程, 知道其先命中缓存, 如果命中不到, 则去分配一款连续内存. 现在带大家剖析命中缓存的相关逻辑. 前面我们也讲到 PoolThreadCache 中维护了三个缓存数组(实际上是六个, 这<br>里 仅 仅 以 Direct 为 例 , Heap 类 型 的 逻 辑 是 一 样 的 ): tinySubPageDirectCaches, smallSubPageDirectCaches, 和<br>normalDirectCaches 分别代表 tiny 类型, small 类型和 normal 类型的缓存数组）。这三个数组保存在 PoolThreadCache<br>的成员变量中:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">PoolThreadCache</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> MemoryRegionCache<span class="token operator">&lt;</span>ByteBuffer<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tinySubPageDirectCaches<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> MemoryRegionCache<span class="token operator">&lt;</span>ByteBuffer<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> smallSubPageDirectCaches<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> MemoryRegionCache<span class="token operator">&lt;</span>ByteBuffer<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> normalDirectCaches<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>其实是在构造方法中进行了初始化:</p>
<pre class=" language-java"><code class="language-java"><span class="token function">PoolThreadCache</span><span class="token punctuation">(</span>PoolArena<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> heapArena<span class="token punctuation">,</span> PoolArena<span class="token operator">&lt;</span>ByteBuffer<span class="token operator">></span> directArena<span class="token punctuation">,</span>
                    <span class="token keyword">int</span> tinyCacheSize<span class="token punctuation">,</span> <span class="token keyword">int</span> smallCacheSize<span class="token punctuation">,</span> <span class="token keyword">int</span> normalCacheSize<span class="token punctuation">,</span>
                    <span class="token keyword">int</span> maxCachedBufferCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> freeSweepAllocationThreshold<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>directArena <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            tinySubPageDirectCaches <span class="token operator">=</span> <span class="token function">createSubPageCaches</span><span class="token punctuation">(</span>
                    tinyCacheSize<span class="token punctuation">,</span> PoolArena<span class="token punctuation">.</span>numTinySubpagePools<span class="token punctuation">,</span> SizeClass<span class="token punctuation">.</span>Tiny<span class="token punctuation">)</span><span class="token punctuation">;</span>
            smallSubPageDirectCaches <span class="token operator">=</span> <span class="token function">createSubPageCaches</span><span class="token punctuation">(</span>
                    smallCacheSize<span class="token punctuation">,</span> directArena<span class="token punctuation">.</span>numSmallSubpagePools<span class="token punctuation">,</span> SizeClass<span class="token punctuation">.</span>Small<span class="token punctuation">)</span><span class="token punctuation">;</span>

            numShiftsNormalDirect <span class="token operator">=</span> <span class="token function">log2</span><span class="token punctuation">(</span>directArena<span class="token punctuation">.</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            normalDirectCaches <span class="token operator">=</span> <span class="token function">createNormalCaches</span><span class="token punctuation">(</span>
                    normalCacheSize<span class="token punctuation">,</span> maxCachedBufferCapacity<span class="token punctuation">,</span> directArena<span class="token punctuation">)</span><span class="token punctuation">;</span>

            directArena<span class="token punctuation">.</span>numThreadCaches<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>我们以tiny 类型为例 跟到createSubPageCaches 方法中:</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> MemoryRegionCache<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">createSubPageCaches</span><span class="token punctuation">(</span>
            <span class="token keyword">int</span> cacheSize<span class="token punctuation">,</span> <span class="token keyword">int</span> numCaches<span class="token punctuation">,</span> SizeClass sizeClass<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
            MemoryRegionCache<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryRegionCache</span><span class="token punctuation">[</span>numCaches<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cache<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// TODO: maybe use cacheSize / cache.length</span>
                cache<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SubPageMemoryRegionCache</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>cacheSize<span class="token punctuation">,</span> sizeClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> cache<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>从代码来看, 其实就是创建了一个缓存数组, 这个缓存数组的长度, 也就是 numCaches, 在不同的类型, 这个长度不一样 . tiny类型长度是32,small 类型长度为4, normal 类型长度为3.我们知道， 缓存数组中每个节点代表一个缓存对象, 里面维护一个队列. 队列大小由PooledByteBufAllocator 类 中 的 tinyCacheSize, smallCacheSize, normalCacheSize 属性决定的。其中每个缓存对象, 队列中缓存的ByteBuf 大小的固定的. netty 将每种缓存区类型分为了不同的长度规格 ,而每个缓存中的队列缓存的Bytebuf的长度, 都是同一个规格的长度, 而缓冲区数组的长度, 就是规格的数量. 比如: 在 tiny 类型中, Netty将其长度为了32个规格, 每个规格都是16的整数倍, 也就是包含0Byte、16Byte、32Byte、48Byte、64Byte，96Byte…总共32种规格. 而在其缓存数组tinySubPageDirectCaches 中, 这每一种规格代表数组中的一个缓存对象缓存的ByteBuf的大小, 我们以tinySubPageDirectCaches[1]为例,(这里下标选择1是因为下标为0的规格是0Byte, 其实就代表一个空的缓存, 这里不进行举例). 在  <code>tinySubPageDirectCaches[1]</code>  的缓存对象中所缓存的ByteBuf的缓存长度是16Byte, tinySubPageDirectCaches[2] 中缓存的ByteBuf 长度为32Byte. 以此类推, tinySubPageDirectCaches[31]中缓存的 ByteBuf 长度为 496Byte。其具体类型规则的配置如下:<br>tiny:总共 32 个规格, 均是 16 的整数倍, 0Byte, 16Byte, 32Byte, 48Byte, 64Byte, 80Byte, 96Byte……496Byte；</p>
<p>small:4 种规格, 512Byte, 1KB, 2KB, 4KB；</p>
<p>normal: 3种规格, 8KB、16KB、32KB;</p>
<p> 如此我们得出结论PoolThreadCache 中缓存数组的数据结构如下图所示:</p>
<p><img src="http://files.luyanan.com//img/20191010211930.png"></p>
<p>在基本了解缓存数组的数据结构后, 我们再继续剖析在缓存中分配内存的逻辑. 回到到 PoolArena 的 allocate() 方法中:</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">allocate</span><span class="token punctuation">(</span>PoolThreadCache cache<span class="token punctuation">,</span> PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> normCapacity <span class="token operator">=</span> <span class="token function">normalizeCapacity</span><span class="token punctuation">(</span>reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//  规格化</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTinyOrSmall</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// capacity &lt; pageSize</span>
            <span class="token keyword">int</span> tableIdx<span class="token punctuation">;</span>
            PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 判断是不是tiny</span>
            <span class="token keyword">boolean</span> tiny <span class="token operator">=</span> <span class="token function">isTiny</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tiny<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// &lt; 512</span>
                <span class="token comment" spellcheck="true">// 缓存分配</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">allocateTiny</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// was able to allocate out of the cache so move on</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 通过tinyIdx 拿到tableIdx</span>
                tableIdx <span class="token operator">=</span> <span class="token function">tinyIdx</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// subpage 的数组</span>
                table <span class="token operator">=</span> tinySubpagePools<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">allocateSmall</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// was able to allocate out of the cache so move on</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                tableIdx <span class="token operator">=</span> <span class="token function">smallIdx</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                table <span class="token operator">=</span> smallSubpagePools<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 拿到对应的节点</span>
            <span class="token keyword">final</span> PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> head <span class="token operator">=</span> table<span class="token punctuation">[</span>tableIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/**
             * Synchronize on the head. This is needed as &amp;#123;@link PoolChunk#allocateSubpage(int)&amp;#125; and
             * &amp;#123;@link PoolChunk#free(long)&amp;#125; may modify the doubly linked list as well.
             */</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> s <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 默认情况下head的next 也是自身</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> head<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">assert</span> s<span class="token punctuation">.</span>doNotDestroy <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span>elemSize <span class="token operator">==</span> normCapacity<span class="token punctuation">;</span>
                    <span class="token keyword">long</span> handle <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">assert</span> handle <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    s<span class="token punctuation">.</span>chunk<span class="token punctuation">.</span><span class="token function">initBufWithSubpage</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>tiny<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        allocationsTiny<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        allocationsSmall<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">allocateNormal</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>normCapacity <span class="token operator">&lt;=</span> chunkSize<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 首先在缓存上进行内存分配</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">allocateNormal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// was able to allocate out of the cache so move on</span>
                <span class="token comment" spellcheck="true">// 分配成功. 返回</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 分配不成功, 做实际的内存分配</span>
            <span class="token function">allocateNormal</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Huge allocations are never served via the cache so just call allocateHuge</span>
            <span class="token comment" spellcheck="true">// 大于这个值, 就不在缓存上分配</span>
            <span class="token function">allocateHuge</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>首先是通过normalizeCapacity()  方法进行内存规格化, 我们跟到normalizeCapacity 方法中:</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">int</span> <span class="token function">normalizeCapacity</span><span class="token punctuation">(</span><span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reqCapacity <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"capacity: "</span> <span class="token operator">+</span> reqCapacity <span class="token operator">+</span> <span class="token string">" (expected: 0+)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reqCapacity <span class="token operator">>=</span> chunkSize<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> reqCapacity<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

     <span class="token comment" spellcheck="true">// 如果 > tiny</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isTiny</span><span class="token punctuation">(</span>reqCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// >= 512</span>
            <span class="token comment" spellcheck="true">// Doubled</span>

            <span class="token comment" spellcheck="true">// 找一个2的幂次方数值, 确保数值大小等于reqCapacity</span>
            <span class="token keyword">int</span> normalizedCapacity <span class="token operator">=</span> reqCapacity<span class="token punctuation">;</span>
            normalizedCapacity <span class="token operator">--</span><span class="token punctuation">;</span>
            normalizedCapacity <span class="token operator">|=</span> normalizedCapacity <span class="token operator">>>></span>  <span class="token number">1</span><span class="token punctuation">;</span>
            normalizedCapacity <span class="token operator">|=</span> normalizedCapacity <span class="token operator">>>></span>  <span class="token number">2</span><span class="token punctuation">;</span>
            normalizedCapacity <span class="token operator">|=</span> normalizedCapacity <span class="token operator">>>></span>  <span class="token number">4</span><span class="token punctuation">;</span>
            normalizedCapacity <span class="token operator">|=</span> normalizedCapacity <span class="token operator">>>></span>  <span class="token number">8</span><span class="token punctuation">;</span>
            normalizedCapacity <span class="token operator">|=</span> normalizedCapacity <span class="token operator">>>></span> <span class="token number">16</span><span class="token punctuation">;</span>
            normalizedCapacity <span class="token operator">++</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>normalizedCapacity <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                normalizedCapacity <span class="token operator">>>>=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> normalizedCapacity<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Quantum-spaced</span>
     <span class="token comment" spellcheck="true">// 如果是16 的倍数 , </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>reqCapacity <span class="token operator">&amp;</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> reqCapacity<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

     <span class="token comment" spellcheck="true">// 如果不是16的倍数, 变成最大小于当前值的值+ 16</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>reqCapacity <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p> 上面代码中 <code>if (!isTiny(reqCapacity))</code> 代表如果大于tiny 类型的大小，也就是512, 则会找一个2的幂次方的数值, 确保这个数值大小等于reqCapacity。如果是tiny , 则继续往下 <code> if ((reqCapacity &amp; 15) == 0)</code>, 这里判断如果是16 的倍数, 则直接返回 . 如果不是16的倍数, 则返回(reqCapacity &amp; ~15) + 16 , 也就是变成最小大于当前值的16 的倍数值。从上面规格化逻辑看出, 这里将缓存大小规格化成固定大小, 确保每个缓存对象缓存的ByteBuf 容量统一. 回到allocate() 方法, ： if(isTinyOrSmall(normCapacity)) 这里是根据规格化后的大小判断是否是tiny 或者small类型, 我们跟进去:</p>
<pre class=" language-java"><code class="language-java">   <span class="token comment" spellcheck="true">// capacity &lt; pageSize</span>
    <span class="token keyword">boolean</span> <span class="token function">isTinyOrSmall</span><span class="token punctuation">(</span><span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>normCapacity <span class="token operator">&amp;</span> subpageOverflowMask<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这个方法是判断如果normCapacity 小于一个page 的大小, 则就是8KB 代表其是tiny 或者small.</p>
<p>继续看allocate() 方法，如果当前大小是tiny 或者small, 则 isTiny(normCapacity)判断是否是 tiny 类型,跟进去:</p>
<pre class=" language-java"><code class="language-java">   <span class="token comment" spellcheck="true">// normCapacity &lt; 512</span>
    <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isTiny</span><span class="token punctuation">(</span><span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>normCapacity <span class="token operator">&amp;</span> <span class="token number">0xFFFFFE00</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这个方法是判断如果小于512, 就认为是tiny.</p>
<p>再继续看 allocate() 方法, 如果是tiny, 则通过 cache.allocateTiny(this, buf, reqCapacity, normCapacity)在缓存上分配. 我们就以tiny 类型为例, 分析在缓存上分配ByteBuf 的流, allocateTiny 是缓存分配的入口. 我们跟进去: 进入到了PoolThreadCache 的 allocateTiny()方法中:</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">boolean</span> <span class="token function">allocateTiny</span><span class="token punctuation">(</span>PoolArena<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> area<span class="token punctuation">,</span> PooledByteBuf<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token function">cacheForTiny</span><span class="token punctuation">(</span>area<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里有个方法cacheForTiny(area, normCapacity), 这个方法的作用是根据normCapacity 找到tiny类型缓存数组中的一个缓存对象, 我们跟进去cacheForTiny方法:</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">private</span> MemoryRegionCache<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">cacheForTiny</span><span class="token punctuation">(</span>PoolArena<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> area<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> idx <span class="token operator">=</span> PoolArena<span class="token punctuation">.</span><span class="token function">tinyIdx</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>area<span class="token punctuation">.</span><span class="token function">isDirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">cache</span><span class="token punctuation">(</span>tinySubPageDirectCaches<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">cache</span><span class="token punctuation">(</span>tinySubPageHeapCaches<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>PoolArena.tinyIdx(normCapacity)是找到tiny类型缓存数组的下标, 继续跟进到 tinyIdx 方法:</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">tinyIdx</span><span class="token punctuation">(</span><span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> normCapacity <span class="token operator">>>></span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里相当于直接将 normCapacity 除以16, 通过前面的内容我们知道，  tiny 类型缓存数组中的每个元素规格化的数据都是16的倍数, 所以通过这种方式可以找到其下标, 如果是16Byte 会拿到下标为1的元素， 如果是32Byte 会拿到下标为2的元素.</p>
<p>回到acheForTiny()方法中： if (area.isDirect()) 这里是判断是否分配堆外内存, 因为我们是按照堆外内存进行举例的, 所以这里是true, 再继续跟到到 cache(tinySubPageDirectCaches, idx)方法：</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> MemoryRegionCache<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">cache</span><span class="token punctuation">(</span>MemoryRegionCache<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> cache<span class="token punctuation">,</span> <span class="token keyword">int</span> idx<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">==</span> null <span class="token operator">||</span> idx <span class="token operator">></span> cache<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cache<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里我们看到直接通过下标的方式拿到了缓存数组中的对象, 回到到 PoolThreadCache 的 allocateTiny()方法中：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">boolean</span> <span class="token function">allocateTiny</span><span class="token punctuation">(</span>PoolArena<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> area<span class="token punctuation">,</span> PooledByteBuf<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token function">cacheForTiny</span><span class="token punctuation">(</span>area<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>拿到了缓存对象后, 我们跟到 <code>allocate(cacheForTiny(area, normCapacity), buf, reqCapacity)</code>  方法中:</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">allocate</span><span class="token punctuation">(</span>MemoryRegionCache<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> cache<span class="token punctuation">,</span> PooledByteBuf buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// no cache found so just return false here</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> allocated <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span> allocations <span class="token operator">>=</span> freeSweepAllocationThreshold<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            allocations <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> allocated<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>分析上面的代码, 看到cache.allocate(buf, reqCapacity) 进行继续分配, 再继续往里跟, 来到内部类MemoryRegionCache 的 allocate(PooledByteBuf buf, int reqCapacity)方法：</p>
<pre class=" language-java"><code class="language-java">   <span class="token comment" spellcheck="true">/**
         * Allocate something out of the cache if possible and remove the entry from the cache.
         */</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">allocate</span><span class="token punctuation">(</span>PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            Entry<span class="token operator">&lt;</span>T<span class="token operator">></span> entry <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">initBuf</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>chunk<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>handle<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            entry<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// allocations is not thread-safe which is fine as this is only called from the same thread all time.</span>
            <span class="token operator">++</span> allocations<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这个方法, 首先通过 queue.poll()这种方式弹出一个Entry, 我们之前分析过MemoryRegionCache 维护这一个队列, 而队列中的每一个值是一个entry, 我们简单来看一下Entry 这个类</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> Handle<span class="token operator">&lt;</span>Entry<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> recyclerHandle<span class="token punctuation">;</span>
            PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> chunk<span class="token punctuation">;</span>
            <span class="token keyword">long</span> handle <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

            <span class="token function">Entry</span><span class="token punctuation">(</span>Handle<span class="token operator">&lt;</span>Entry<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> recyclerHandle<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>recyclerHandle <span class="token operator">=</span> recyclerHandle<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token keyword">void</span> <span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                chunk <span class="token operator">=</span> null<span class="token punctuation">;</span>
                handle <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                recyclerHandle<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p> 我们重点关注 chunk 和handler 这两个属性,     chunk 代表一块连续的内存, 我们之前简单介绍过, Netty 是通过chunk 为单位进行内存分配的. handler 相当于一个指针, 可以唯一定位到chunk 里面的一块连续的内存. 这样, 通过chunk和handler 就可以定位到ByteBuf 中的指定的一块连续的内存, 有关ByteBuf 相关的读写， 都会在这块内存中进行, 现在再回到MemoryRegionCache 的 allocate(PooledByteBuf buf,int reqCapacity)方法：</p>
<pre class=" language-java"><code class="language-java">       <span class="token comment" spellcheck="true">/**
         * Allocate something out of the cache if possible and remove the entry from the cache.
         */</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">allocate</span><span class="token punctuation">(</span>PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            Entry<span class="token operator">&lt;</span>T<span class="token operator">></span> entry <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">initBuf</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>chunk<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>handle<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            entry<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// allocations is not thread-safe which is fine as this is only called from the same thread all time.</span>
            <span class="token operator">++</span> allocations<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>弹出entry后, 通过<code>initBuf(entry.chunk, entry.handle, buf, reqCapacity)</code>  这种方式给ByteBuf 初始化， 这里参数传入我们刚才分析过的 当前的entry的chunk 和handler, 因为我们分析的 tiny 类型的缓存对象是SubPageMemoryRegionCache 类型, 所以继续回到SubPageMemoryRegionCache 类的initBuf(entry.chunk, entry.handle, buf, reqCapacity)方法中：</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initBuf</span><span class="token punctuation">(</span>
                PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> chunk<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            chunk<span class="token punctuation">.</span><span class="token function">initBufWithSubpage</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里的chunk 调用了了 initBufWithSubpage(buf, handle, reqCapacity)方法, 其实就是PoolChunk 类中的方法, 我们继续initBufWithSubpage() 方法:</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">void</span> <span class="token function">initBufWithSubpage</span><span class="token punctuation">(</span>PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">initBufWithSubpage</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> <span class="token function">bitmapIdx</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>上面代码中, 调用了 bitmapIdx()方法, 有关 bitmapIdx()方法相关的逻辑, 会再后面进行剖析,这里继续往里看, 看 initBufWithSubpage 的逻辑:</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initBufWithSubpage</span><span class="token punctuation">(</span>PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> bitmapIdx<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> bitmapIdx <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> memoryMapIdx <span class="token operator">=</span> <span class="token function">memoryMapIdx</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

        PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> subpage <span class="token operator">=</span> subpages<span class="token punctuation">[</span><span class="token function">subpageIdx</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> subpage<span class="token punctuation">.</span>doNotDestroy<span class="token punctuation">;</span>
        <span class="token keyword">assert</span> reqCapacity <span class="token operator">&lt;=</span> subpage<span class="token punctuation">.</span>elemSize<span class="token punctuation">;</span>

        buf<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">,</span> handle<span class="token punctuation">,</span>
            <span class="token function">runOffset</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>bitmapIdx <span class="token operator">&amp;</span> <span class="token number">0x3FFFFFFF</span><span class="token punctuation">)</span> <span class="token operator">*</span> subpage<span class="token punctuation">.</span>elemSize<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> subpage<span class="token punctuation">.</span>elemSize<span class="token punctuation">,</span>
            arena<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">threadCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>我们先关注 init()  方法, 因为我们是以PooledUnsafeDirectByteBuf 为例,所以这里走的是PooledUnsafeDirectByteBuf 的  init() 方法, 进入init() 方法：</p>
<pre class=" language-java"><code class="language-java">  <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>PoolChunk<span class="token operator">&lt;</span>ByteBuffer<span class="token operator">></span> chunk<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> maxLength<span class="token punctuation">,</span>
              PoolThreadCache cache<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> length<span class="token punctuation">,</span> maxLength<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initMemoryAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    
</code></pre>
<p>首先调用了父类的init()  方法，继续跟进去:</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> chunk<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> maxLength<span class="token punctuation">,</span> PoolThreadCache cache<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> handle <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> chunk <span class="token operator">!=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>chunk <span class="token operator">=</span> chunk<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handle <span class="token operator">=</span> handle<span class="token punctuation">;</span>
        memory <span class="token operator">=</span> chunk<span class="token punctuation">.</span>memory<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>offset <span class="token operator">=</span> offset<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> length<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxLength <span class="token operator">=</span> maxLength<span class="token punctuation">;</span>
        tmpNioBuf <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> cache<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>上面的代码就是将PooledUnsafeDirectByteBuf 的各个属性进行了初始化:</p>
<p>this.chunk = chunk 这里初始化了 chunk, 代表当前的 ByteBuf 是在哪一块内存中分配的。</p>
<p>this.handle = handle 这里初始化了 handle, 代表当前的 ByteBuf 是这块内存的哪个连续内存。</p>
<p>有关 offset 和 length, 我们会在之后再分析, 在这里我们只需要知道, 通过缓存分配 ByteBuf, 我们只需要通过一个chunk 和 handle, 就可以确定一块内存，以上就是通过缓存分配 ByteBuf 对象的全过程。</p>
<p>现在，我们回到 MemoryRegionCache 的 allocate(PooledByteBuf buf, int reqCapacity)方法：</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">allocate</span><span class="token punctuation">(</span>PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            Entry<span class="token operator">&lt;</span>T<span class="token operator">></span> entry <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">initBuf</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>chunk<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>handle<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            entry<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// allocations is not thread-safe which is fine as this is only called from the same thread all time.</span>
            <span class="token operator">++</span> allocations<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>分析完了initBuf() 方法，再继续往下看, entry.recycle() 这步是将 entry 对象进行回收, 因为entry 对象弹出后没有在被引用，可能gc 会将entry 对象进行回收, netty为了将对象进行循环利用, 就将其对象放在回收站进行回收,我们跟进到recycle() 方法:</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">void</span> <span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                chunk <span class="token operator">=</span> null<span class="token punctuation">;</span>
                handle <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                recyclerHandle<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>chunk = null  和handler = -1  表示当前entry 不指向任何一块内存,recyclerHandle.recycle(this) 将当前entry 回收, 以上就是命中缓存的流程, 因为这里我们是假设缓存中有值的情况下， 如果第一次分配, 缓存中是没有值的, 那么在缓存中没有值的i情况下, Netty 是如何进行分配的呢? 我们在后面再详细分析：</p>
<p>最后, 我们简单总结一下MemoryRegionCache 对象的基本结构, 如下图所示:</p>
<p><img src="http://files.luyanan.com//img/20191010224444.png"></p>
<h3 id="5-Page-级别的内存分配"><a href="#5-Page-级别的内存分配" class="headerlink" title="5. Page 级别的内存分配"></a>5. Page 级别的内存分配</h3><p>之前我们介绍过,Netty 内存分配的单位是chunk, 一个chunk 的大小是16MB,实际上每个chunk都以双向链表的形式保存在一个chunkList中, 而多个chunkList 同样也是双向链表进行关联的, 大概结构如下:</p>
<p><img src="http://files.luyanan.com//img/20191010225320.png"></p>
<p>在chunkList 中, 是根据chunk 的内存使用率归到一个chunkList中, 这样, 在内存分配时, 会根据百分比找到相应的chunkList, 在chunkList 中选择一个chunk 进行内存分配, 我们来看PoolArena 有关 chunkList 的成员变量:</p>
<pre class=" language-java"><code class="language-java">        q100 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q075 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>q100<span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q050 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>q075<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q025 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>q050<span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q000 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>q025<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        qInit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>q000<span class="token punctuation">,</span> Integer<span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>这里总共定义了6个chunkList, 并在构造方法中将其进行初始化, 我们跟到其构造方法:</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">protected</span> <span class="token function">PoolArena</span><span class="token punctuation">(</span>PooledByteBufAllocator parent<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maxOrder<span class="token punctuation">,</span> <span class="token keyword">int</span> pageShifts<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkSize<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pageSize <span class="token operator">=</span> pageSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxOrder <span class="token operator">=</span> maxOrder<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pageShifts <span class="token operator">=</span> pageShifts<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chunkSize <span class="token operator">=</span> chunkSize<span class="token punctuation">;</span>
        subpageOverflowMask <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>pageSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tinySubpagePools <span class="token operator">=</span> <span class="token function">newSubpagePoolArray</span><span class="token punctuation">(</span>numTinySubpagePools<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tinySubpagePools<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            tinySubpagePools<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newSubpagePoolHead</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        numSmallSubpagePools <span class="token operator">=</span> pageShifts <span class="token operator">-</span> <span class="token number">9</span><span class="token punctuation">;</span>
        smallSubpagePools <span class="token operator">=</span> <span class="token function">newSubpagePoolArray</span><span class="token punctuation">(</span>numSmallSubpagePools<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> smallSubpagePools<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            smallSubpagePools<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newSubpagePoolHead</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        q100 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q075 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>q100<span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q050 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>q075<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q025 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>q050<span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q000 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>q025<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        qInit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>q000<span class="token punctuation">,</span> Integer<span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        q100<span class="token punctuation">.</span><span class="token function">prevList</span><span class="token punctuation">(</span>q075<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q075<span class="token punctuation">.</span><span class="token function">prevList</span><span class="token punctuation">(</span>q050<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q050<span class="token punctuation">.</span><span class="token function">prevList</span><span class="token punctuation">(</span>q025<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q025<span class="token punctuation">.</span><span class="token function">prevList</span><span class="token punctuation">(</span>q000<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q000<span class="token punctuation">.</span><span class="token function">prevList</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        qInit<span class="token punctuation">.</span><span class="token function">prevList</span><span class="token punctuation">(</span>qInit<span class="token punctuation">)</span><span class="token punctuation">;</span>

        List<span class="token operator">&lt;</span>PoolChunkListMetric<span class="token operator">></span> metrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>PoolChunkListMetric<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        metrics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>qInit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        metrics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>q000<span class="token punctuation">)</span><span class="token punctuation">;</span>
        metrics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>q025<span class="token punctuation">)</span><span class="token punctuation">;</span>
        metrics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>q050<span class="token punctuation">)</span><span class="token punctuation">;</span>
        metrics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>q075<span class="token punctuation">)</span><span class="token punctuation">;</span>
        metrics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>q100<span class="token punctuation">)</span><span class="token punctuation">;</span>
        chunkListMetrics <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>metrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>首先通过new PoolChunkList() 这种方式将每个chunkList 进行创建,我们以q050 = new PoolChunkList(q075, 50, 100, chunkSize)  为例进行简单介绍, q075 表示当前q50 的下一个节点是q075, 刚才我们讲过ChunkList 是通过双向链表进行关联的. 所以这里不难理解, 参数50 和100 表示当前chunkList 中存储的chunk 的内存使用率都在50% 到100% 之间. 最后chunkSize 为其设置大小, 创建完ChunkList 之后, 再设置其上一个节点,, q050.prevList(q025)  为例, 这里代表当前chunkList 的上一个节点是q025, 以这种方式创建完成之后, chunkList 的节点关系就变成了如下图所示:</p>
<p><img src="http://files.luyanan.com//img/20191011103228.png"></p>
<p>Netty中,chunk 又包含了多个Page, 每个page 的大小为8KB, 如果要分配16KB的内存, 就要在chunk 汇总找到连续的两个page就可以分配, 对应关系如下:</p>
<p><img src="http://files.luyanan.com//img/20191011103351.png"></p>
<p>很多场景下,为缓冲区分配8KB的内存也是一种浪费, 比如只需要分配2KB的缓存区, 如果使用8KB的就会造成6KB的浪费, 这种情况下，Netty 又会将page 切分成多个subpage, 每个subpage 大小要根据分配的缓冲区大小而指定, 比如要分配2KB 的内存, 就会将一个page切分成4个subpage, 每个subpage 的大小为2KB, 如下图:</p>
<p><img src="http://files.luyanan.com//img/20191011104117.png"></p>
<p>来看看PoolSubpage 的基本结构:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">PoolSubpage</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">PoolSubpageMetric</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> chunk<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> memoryMapIdx<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> runOffset<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bitmap<span class="token punctuation">;</span>

    PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> prev<span class="token punctuation">;</span>
    PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> next<span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> doNotDestroy<span class="token punctuation">;</span>
    <span class="token keyword">int</span> elemSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxNumElems<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> bitmapLength<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> nextAvail<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> numAvail<span class="token punctuation">;</span>
    
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>chunk  代表其子页属于哪个chunk, bitmap 用于记录子页的内存分配情况, prev和 next, 代表子页是按照双向链表进行关联的, 这里分别指向上一个和下一个节点, elemSize 属性代表就是这个子页是按照多大内存进行划分的, 如果按照1KB 进行划分, 则可以划分出8个子页, 简单介绍了内存分配的数据结构.</p>
<p>我们开始剖析Netty 级别上分配内存的流程, 还是回到PoolArena 的 allocate 方法：</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">allocate</span><span class="token punctuation">(</span>PoolThreadCache cache<span class="token punctuation">,</span> PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> normCapacity <span class="token operator">=</span> <span class="token function">normalizeCapacity</span><span class="token punctuation">(</span>reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTinyOrSmall</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// capacity &lt; pageSize</span>
            <span class="token keyword">int</span> tableIdx<span class="token punctuation">;</span>
            PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> tiny <span class="token operator">=</span> <span class="token function">isTiny</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tiny<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// &lt; 512</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">allocateTiny</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// was able to allocate out of the cache so move on</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                tableIdx <span class="token operator">=</span> <span class="token function">tinyIdx</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                table <span class="token operator">=</span> tinySubpagePools<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">allocateSmall</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// was able to allocate out of the cache so move on</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                tableIdx <span class="token operator">=</span> <span class="token function">smallIdx</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                table <span class="token operator">=</span> smallSubpagePools<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> head <span class="token operator">=</span> table<span class="token punctuation">[</span>tableIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/**
             * Synchronize on the head. This is needed as &amp;#123;@link PoolChunk#allocateSubpage(int)&amp;#125; and
             * &amp;#123;@link PoolChunk#free(long)&amp;#125; may modify the doubly linked list as well.
             */</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> s <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> head<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">assert</span> s<span class="token punctuation">.</span>doNotDestroy <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span>elemSize <span class="token operator">==</span> normCapacity<span class="token punctuation">;</span>
                    <span class="token keyword">long</span> handle <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">assert</span> handle <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    s<span class="token punctuation">.</span>chunk<span class="token punctuation">.</span><span class="token function">initBufWithSubpage</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>tiny<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        allocationsTiny<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        allocationsSmall<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">allocateNormal</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>normCapacity <span class="token operator">&lt;=</span> chunkSize<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">allocateNormal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// was able to allocate out of the cache so move on</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">allocateNormal</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Huge allocations are never served via the cache so just call allocateHuge</span>
            <span class="token function">allocateHuge</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>我们之前讲过, 如果在缓存中分配不成功, 则会开辟一块连续的内存进行缓冲区分配, 这里我们先跳过isTinyOrSmall(normCapacity)往后的代码, 之后再来分析。</p>
<p>首先if (normCapacity &lt;= chunkSize) 说明其小于16KB , 然后首先在缓存中分配, 以为最初缓存中没有值, 所以会走到 allocateNormal(buf, reqCapacity, normCapacity), 这里实际上就是在page级别上进行分配, 分配一个或者多个page 的空间, 我们跟进到 allocateNormal()  方法:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">allocateNormal</span><span class="token punctuation">(</span>PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">// 首先在原来的chunk 上进行内存分配(1)   </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>q050<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span> q025<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span>
            q000<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span> qInit<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span>
            q075<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token operator">++</span>allocationsNormal<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add a new chunk.</span>
    <span class="token comment" spellcheck="true">// 创建chunk 进行内存分配(2)</span>
        PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> c <span class="token operator">=</span> <span class="token function">newChunk</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">,</span> maxOrder<span class="token punctuation">,</span> pageShifts<span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> handle <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span>allocationsNormal<span class="token punctuation">;</span>
        <span class="token keyword">assert</span> handle <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 初始化 byteBuf(3)</span>
        c<span class="token punctuation">.</span><span class="token function">initBuf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        qInit<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里主要拆解了如下步骤:</p>
<ol>
<li>在原有的chunk 中进行分配</li>
<li>创建chunk 进行分配</li>
<li>初始化byteBuf </li>
</ol>
<p>首先我们来看第一步, 在原有的chunk 中进行分配:</p>
<pre class=" language-java"><code class="language-java">   <span class="token keyword">if</span> <span class="token punctuation">(</span>q050<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span> q025<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span>
            q000<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span> qInit<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span>
            q075<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token operator">++</span>allocationsNormal<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>我们之前讲过, chunkList 是存储不同内存使用量的chunk 集合,每个chunkList 通过双向链表的形式进行关联, 这里的 q050.allocate(buf, reqCapacity, normCapacity)  就代表首先在q050 这个chunkList 进行内存分配, 我们以q050 为例进行分析, 跟到q050.allocate(buf, reqCapacity, normCapacity)方法中：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">boolean</span> <span class="token function">allocate</span><span class="token punctuation">(</span>PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>head <span class="token operator">==</span> null <span class="token operator">||</span> normCapacity <span class="token operator">></span> maxCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Either this PoolChunkList is empty or the requested capacity is larger then the capacity which can</span>
            <span class="token comment" spellcheck="true">// be handled by the PoolChunks that are contained in this PoolChunkList.</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//  从head 节点往下遍历</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> cur <span class="token operator">=</span> head<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> handle <span class="token operator">=</span> cur<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                cur <span class="token operator">=</span> cur<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                cur<span class="token punctuation">.</span><span class="token function">initBuf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cur<span class="token punctuation">.</span><span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> maxUsage<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">remove</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    nextList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>首先会从head节点进行往下遍历, <code>ong handle = cur.allocate(normCapacity)</code>  表示对于每个chunk 都尝试去分配, if (handle &lt; 0) 说明没有分配到, 则通过 cur = cur.next 找到下一个节点继续进行分配, 我们讲过chunk 也是通过双向链表进行关联的. 所以对这块逻辑应该不会陌生, 如果handler 大于0 说明已经分配到内存, 则通过cur.initBuf(buf, handle, reqCapacity)对 byteBuf 进行初始化；if (cur.usage() &gt;= maxUsage) 代表当前 chunk 的内存使用率大于其最大<br>使用率, 则通过 remove(cur)从当前的 chunkList 中移除, 再通过 nextList.add(cur)添加到下一个 chunkList 中。<br>我们再回到 PoolArena 的 allocateNormal()方法中：</p>
<p>看第二步 PoolChunk c = newChunk(pageSize, maxOrder, pageShifts, chunkSize)，这里的参数 pageSize 是 8192, 也就是 8KB。</p>
<p>maxOrder 为11;</p>
<p>pageShifts 为 13, 2 的 13 次方正好是 8192, 也就是 8KB；<br>chunkSize 为 16777216, 也就是 16MB。</p>
<p>因为我们分析的是堆外内存, newChunk(pageSize, maxOrder, pageShifts, chunkSize)所以会走到 DirectArena 的<br>    ()方法：</p>
<pre class=" language-java"><code class="language-java">     <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> PoolChunk<span class="token operator">&lt;</span>ByteBuffer<span class="token operator">></span> <span class="token function">newChunk</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maxOrder<span class="token punctuation">,</span> <span class="token keyword">int</span> pageShifts<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkSize<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunk</span><span class="token operator">&lt;</span>ByteBuffer<span class="token operator">></span><span class="token punctuation">(</span>
                    <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">allocateDirect</span><span class="token punctuation">(</span>chunkSize<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    pageSize<span class="token punctuation">,</span> maxOrder<span class="token punctuation">,</span> pageShifts<span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里直接通过构造函数创建了一个chunk , allocateDirect(chunkSize) 这里是通过JDK 的api 申请一块直接内存, 我们跟到 PoolChunk 的构造函数:</p>
<pre class=" language-java"><code class="language-java"> <span class="token function">PoolChunk</span><span class="token punctuation">(</span>PoolArena<span class="token operator">&lt;</span>T<span class="token operator">></span> arena<span class="token punctuation">,</span> T memory<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maxOrder<span class="token punctuation">,</span> <span class="token keyword">int</span> pageShifts<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkSize<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        unpooled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>arena <span class="token operator">=</span> arena<span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">// memory 为一个ByteBuf</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>memory <span class="token operator">=</span> memory<span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">// 8KB</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pageSize <span class="token operator">=</span> pageSize<span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">// 13</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pageShifts <span class="token operator">=</span> pageShifts<span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">// 11   </span>
     <span class="token keyword">this</span><span class="token punctuation">.</span>maxOrder <span class="token operator">=</span> maxOrder<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chunkSize <span class="token operator">=</span> chunkSize<span class="token punctuation">;</span>
        unusable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>maxOrder <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log2ChunkSize <span class="token operator">=</span> <span class="token function">log2</span><span class="token punctuation">(</span>chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        subpageOverflowMask <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>pageSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        freeBytes <span class="token operator">=</span> chunkSize<span class="token punctuation">;</span>

        <span class="token keyword">assert</span> maxOrder <span class="token operator">&lt;</span> <span class="token number">30</span> <span class="token operator">:</span> <span class="token string">"maxOrder should be &lt; 30, but is: "</span> <span class="token operator">+</span> maxOrder<span class="token punctuation">;</span>
        maxSubpageAllocs <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> maxOrder<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Generate the memory map.</span>
      <span class="token comment" spellcheck="true">//  节点数量为4096   </span>
     memoryMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>maxSubpageAllocs <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">// 也就是4096个节点</span>
        depthMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>memoryMap<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> memoryMapIndex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">// d 相当于一个深度, 赋值的内容代表当前节点的深度</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> d <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> d <span class="token operator">&lt;=</span> maxOrder<span class="token punctuation">;</span> <span class="token operator">++</span> d<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// move down the tree one level at a time</span>
            <span class="token keyword">int</span> depth <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> d<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> p <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> p <span class="token operator">&lt;</span> depth<span class="token punctuation">;</span> <span class="token operator">++</span> p<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// in each level traverse left to right and set value to the depth of subtree</span>
                memoryMap<span class="token punctuation">[</span>memoryMapIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> d<span class="token punctuation">;</span>
                depthMap<span class="token punctuation">[</span>memoryMapIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> d<span class="token punctuation">;</span>
                memoryMapIndex <span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        subpages <span class="token operator">=</span> <span class="token function">newSubpageArray</span><span class="token punctuation">(</span>maxSubpageAllocs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>首先将传入的参数的值进行赋值 <code>this.memory = memory</code>  就是将参数中创建的堆外内存进行保存, 就是chunk 所指向的那块连续的内存, 在这个chunk 中所分配的BteBuf, 都会在这块内存中进行读写.</p>
<p>我们重点关注 memoryMap = new byte[maxSubpageAllocs &lt;&lt; 1] 和 depthMap = new byte[memoryMap.length]<br>这两步：首先看 memoryMap = new byte[maxSubpageAllocs &lt;&lt; 1]；这里初始化了一个字节数组 memoryMap, 大<br>小为 maxSubpageAllocs &lt;&lt; 1, 也就是 4096；depthMap = new byte[memoryMap.length] 同样也是初始化了一个字<br>节数组, 大小为 memoryMap 的大小, 也就是 4096。继续往下分析之前, 我们看 chunk 的一个层级关系。</p>
<p><img src="http://files.luyanan.com//img/20191011112610.png"></p>
<p>这是一个二叉树的结构，左侧的数字代表层级, 右侧代表一块连续的内存, 每个父节下又拆分成多个子节点, 最顶层表示的内存范围为0-16KB， 其下又分为两层, 范围为0-8MB，8-16MB, 以此类推, 最后到11层, 以8KB 的大小划分, 也就是一个page 的大小.</p>
<p>如果我们分配一个8MB 的缓冲区, 则会将第二层的第一个节点, 也就是0-8 这样连续的内存进行分配, 分配完成后会将这个节点设置为不可用, 结合上面的图, 我们再看构造函数中的for 循环：</p>
<pre class=" language-java"><code class="language-java">   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> d <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> d <span class="token operator">&lt;=</span> maxOrder<span class="token punctuation">;</span> <span class="token operator">++</span> d<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// move down the tree one level at a time</span>
            <span class="token keyword">int</span> depth <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> d<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> p <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> p <span class="token operator">&lt;</span> depth<span class="token punctuation">;</span> <span class="token operator">++</span> p<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// in each level traverse left to right and set value to the depth of subtree</span>
                memoryMap<span class="token punctuation">[</span>memoryMapIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> d<span class="token punctuation">;</span>
                depthMap<span class="token punctuation">[</span>memoryMapIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> d<span class="token punctuation">;</span>
                memoryMapIndex <span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>实际上这个for循环就是将上面的结构包装成一个字节数组memoryMap, 外层循环用于控制层数, 内层循环用于控制里面每层的节点, 这里经过循环后， memoryMap 和depthMap 内容为以下表现形式：</p>
<blockquote>
<p>[0, 0, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4………..]</p>
</blockquote>
<p>这里注意一下, 因为程序汇总数组的下标是从1开始设置的, 所以第零个节点元素为默认值0.</p>
<p>这里数字代表层级, 同时也代表了当前层级的节点, 相同的数字个数就是这一层级的节点数.</p>
<p>其中0 为2(因为这里分配时下标是从1开始的, 所以第0个位置的默认是0, 实际上第0层元素只有一个, 就是头节点), 1为2, 2为4, 3为8, 4为16, n 为2的n次方个, 也及时11有2 的11次方个.</p>
<p>我们再回到PoolArena 的 allocateNormal()方法：</p>
<pre class=" language-java"><code class="language-java">   <span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">allocateNormal</span><span class="token punctuation">(</span>PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>q050<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span> q025<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span>
            q000<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span> qInit<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span>
            q075<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token operator">++</span>allocationsNormal<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add a new chunk.</span>
        PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> c <span class="token operator">=</span> <span class="token function">newChunk</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">,</span> maxOrder<span class="token punctuation">,</span> pageShifts<span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> handle <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span>allocationsNormal<span class="token punctuation">;</span>
        <span class="token keyword">assert</span> handle <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
        c<span class="token punctuation">.</span><span class="token function">initBuf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        qInit<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>我们继续剖析 long handle = c.allocate(normCapacity) 这步，跟到 allocate(normCapacity)中：</p>
<pre class=" language-jade"><code class="language-jade">   <span class="token tag">long</span> <span class="token plain-text">allocate(int normCapacity) &amp;#123;</span>
        <span class="token flow-control"><span class="token branch keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>normCapacity <span class="token operator">&amp;</span> subpageOverflowMask<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// >= pageSize</span></span>
            <span class="token tag">return</span> <span class="token plain-text">allocateRun(normCapacity);</span>
        &amp;#125; else &amp;#123;
            <span class="token tag">return</span> <span class="token plain-text">allocateSubpage(normCapacity);</span>
        &amp;#125;
    &amp;#125;
</code></pre>
<p>如果分配的以page 为单位, 则走到allocateRun(normCapacity) 方法中, 跟进去</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">allocateRun</span><span class="token punctuation">(</span><span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> d <span class="token operator">=</span> maxOrder <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token function">log2</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span> <span class="token operator">-</span> pageShifts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token function">allocateNode</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> id<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        freeBytes <span class="token operator">-=</span> <span class="token function">runLength</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>int d = maxOrder - (log2(normCapacity) - pageShifts) 表示根据 normCapacity 计算出第几层；</p>
<p>int id = allocateNode(d) 表示根据层级关系, 去分配一个节点, 其中 id 代表 memoryMap 中的下标。</p>
<p>我们跟到 allocateNode()方法中：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">allocateNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> d<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 下标初始值为1</span>
        <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 代表 当前层级第一个节点的初始下标</span>
        <span class="token keyword">int</span> initial <span class="token operator">=</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// has last d bits = 0 and rest all = 1</span>
    <span class="token comment" spellcheck="true">// 获取第一个节点的值</span>
        <span class="token keyword">byte</span> val <span class="token operator">=</span> <span class="token function">value</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 如果值大于层级, 说明chunk 不可用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">></span> d<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// unusable</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 当前下标对应的节点值如果小于层级,或者当前下标小于层级的初始下标</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>val <span class="token operator">&lt;</span> d <span class="token operator">||</span> <span class="token punctuation">(</span>id <span class="token operator">&amp;</span> initial<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// id &amp; initial == 1 &lt;&lt; d for all ids at depth d, for &lt; d it is 0</span>
            <span class="token comment" spellcheck="true">// 当前下标乘以2, 代表当前节点的子节点的初始位置</span>
            id <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 获取id 位置的值</span>
            val <span class="token operator">=</span> <span class="token function">value</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 如果当前节点值大于层数(节点不可用)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">></span> d<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// id 为偶数则+1, id 为奇数则-1(拿的是其兄弟节点)</span>
                id <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 获取id 的值</span>
                val <span class="token operator">=</span> <span class="token function">value</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span> value <span class="token operator">=</span> <span class="token function">value</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> value <span class="token operator">==</span> d <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>id <span class="token operator">&amp;</span> initial<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> d <span class="token operator">:</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"val = %d, id &amp; initial = %d, d = %d"</span><span class="token punctuation">,</span>
                value<span class="token punctuation">,</span> id <span class="token operator">&amp;</span> initial<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 将找到的节点设置为不可用</span>
        <span class="token function">setValue</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> unusable<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// mark as unusable</span>
    <span class="token comment" spellcheck="true">// 逐层往上标记被使用    </span>
    <span class="token function">updateParentsAlloc</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里是实际上从一个节点往下找, 找到层级为d 未被使用的节点，我们可以通过注释体会其逻辑, 找到相关节点后通过setValue 将当前节点设置为不可用, 其中id 是当前节点的下标, unusable 代表一个不可用的值, 这里是12, 以为我们的层级只有12层, 所以设置为12之后就相当于标记不可用,设置成不可用之后, 通过updateParentsAlloc(id) 逐层设置为被使用, 我们跟进 updateParentsAlloc() 方法:</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateParentsAlloc</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>id <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 取到当前节点的父节点id</span>
            <span class="token keyword">int</span> parentId <span class="token operator">=</span> id <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 获取当前节点的值</span>
            <span class="token keyword">byte</span> val1 <span class="token operator">=</span> <span class="token function">value</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 找到当前节点的兄弟节点</span>
            <span class="token keyword">byte</span> val2 <span class="token operator">=</span> <span class="token function">value</span><span class="token punctuation">(</span>id <span class="token operator">^</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 如果当前节点值大小兄弟节点,则保存当前节点值到val,否则, 保存兄弟节点值到val.</span>
            <span class="token comment" spellcheck="true">// 如果当前节点是不可用的, 则当前节点值是12, 大于兄弟节点的值,所以这里将兄弟节点的值进行保存</span>
            <span class="token keyword">byte</span> val <span class="token operator">=</span> val1 <span class="token operator">&lt;</span> val2 <span class="token operator">?</span> val1 <span class="token operator">:</span> val2<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 将val 的值设置为父节点下标所对应的值</span>
            <span class="token function">setValue</span><span class="token punctuation">(</span>parentId<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// id 设置为父节点id, 继续循环</span>
            id <span class="token operator">=</span> parentId<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里其实是循环将兄弟节点的值替换成父节点的值, 我们可以通过注释仔细的进行逻辑分析, 如果实在理解有困难, 我通过画图帮助大家理解, 简单起见, 我们这里只设置为三层：</p>
<p><img src="http://files.luyanan.com//img/20191011120814.png"></p>
<p>我们模拟其分配场景, 假设只有三层, 其中 index 代表数组 memoryMap 的下标, value 代表其值, memoryMap 中的值<br>就为[0, 0, 1, 1, 2, 2, 2, 2]。我们要分配一个 4MB 的 byteBuf, 在我们调用 allocateNode(int d)中传入的 d 是 2, 也就是<br>第二层。根据我们上面分分析的逻辑这里会找到第二层的第一个节点, 也就是 0-4mb 这个节点, 找到之后将其设置为 不可用, 这样 memoryMap 中的值就为[0, 0, 1, 1, 12, 2, 2, 2]，二叉树的结构就会变为：</p>
<p><img src="http://files.luyanan.com//img/20191011120905.png"></p>
<p>注意标红部分, 将 index 为 4 的节点设置为了不可用。将这个节点设置为不可用之后, 则会将进行向上设置不可用, 循<br>环将兄弟节点数值较小的节点替换到父节点, 也就是将 index 为 2 的节点的值替换成了 index 的为 5 的节点的值, 这样<br>数组的值就会变为[0, 1, 2, 1, 12, 2, 2, 2]，二叉树的结构变为：</p>
<p><img src="http://files.luyanan.com//img/20191011120943.png"></p>
<blockquote>
<p>注意: 这里节点标红仅仅代表节点变化,并不是当前节点为不可用状态, 真正不可用状态的判断依据是value 的值为12</p>
</blockquote>
<p>这样, 如果再次分配一个 4MB 内存的 ByteBuf, 根据其逻辑, 则会找到第二层的第二个节点, 也就是 4-8MB。再根据我<br>们的逻辑, 通过向上设置不可用, index为2就会设置成不可用状态, 将value的值设置为12, 数组数值变为[0, 1, 12, 1, 12, 12, 2, 2]二叉树如下图所示：</p>
<p><img src="http://files.luyanan.com//img/20191011121137.png"></p>
<p>这样我们看到, 通过分配两个4mb 的ByteBuf 之后, 当前节点和其父节点都会设置成不可用状态, 当index =2 的节点设置为不可用之后, 将不会再找到这个节点下的子节点. 以此类推, 直到所有的内存分配完毕的时候, index 为1 的节点也会变成不可用状态, 这样所有的page 就分配完毕, chunk 中再无可用的节点.  现在再回到 PoolArena的allocateNormal()<br>方法：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">allocateNormal</span><span class="token punctuation">(</span>PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>q050<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span> q025<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span>
           q000<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span> qInit<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span>
           q075<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
           <span class="token operator">++</span>allocationsNormal<span class="token punctuation">;</span>
           <span class="token keyword">return</span><span class="token punctuation">;</span>
       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

       <span class="token comment" spellcheck="true">// Add a new chunk.</span>
       PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> c <span class="token operator">=</span> <span class="token function">newChunk</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">,</span> maxOrder<span class="token punctuation">,</span> pageShifts<span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">long</span> handle <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token operator">++</span>allocationsNormal<span class="token punctuation">;</span>
       <span class="token keyword">assert</span> handle <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
       c<span class="token punctuation">.</span><span class="token function">initBuf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
       qInit<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>通过以上的逻辑我们知道<code>ong handle = c.allocate(normCapacity)</code>  这一步其实返回的就是 memoryMap 的一个下标, 通过这个下标我们能唯一的定义一块内存, 继续往下跟, 通过过 c.initBuf(buf, handle, reqCapacity)初始化 ByteBuf 之后, 通过 qInit.add(c)将新创建的 chunk 添加到 chunkList 中，我们跟到 initBuf 方法中去：</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">void</span> <span class="token function">initBuf</span><span class="token punctuation">(</span>PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> memoryMapIdx <span class="token operator">=</span> <span class="token function">memoryMapIdx</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> bitmapIdx <span class="token operator">=</span> <span class="token function">bitmapIdx</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmapIdx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span> val <span class="token operator">=</span> <span class="token function">value</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">assert</span> val <span class="token operator">==</span> unusable <span class="token operator">:</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
            buf<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> handle<span class="token punctuation">,</span> <span class="token function">runOffset</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span><span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> <span class="token function">runLength</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span><span class="token punctuation">,</span>
                     arena<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">threadCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">initBufWithSubpage</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> bitmapIdx<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>从上面的代码中, 看出通过memoryMapIdx(handle)找到 memoryMap 的下标, 其实就是 handle 的值。bitmapIdx(handle)<br>是有关 subPage 中使用到的逻辑, 如果是 page 级别的分配, 这里只返回 0, 所以进入到 if 块中。if 中首先断言当前节<br>点是不是不可用状态, 然后通过 init 方法进行初始化。其中 runOffset(memoryMapIdx)表示偏移量, 偏移量相当于分配<br>给缓冲区的这块内存相对于 chunk 中申请的内存的首地址偏移了多少。参数 runLength(memoryMapIdx), 表示根据下<br>标获取可分配的最大长度。我们跟到 init()方法中, 这里会走到 PooledByteBuf 的 init()方法：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> chunk<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> maxLength<span class="token punctuation">,</span> PoolThreadCache cache<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> handle <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> chunk <span class="token operator">!=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>chunk <span class="token operator">=</span> chunk<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handle <span class="token operator">=</span> handle<span class="token punctuation">;</span>
        memory <span class="token operator">=</span> chunk<span class="token punctuation">.</span>memory<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>offset <span class="token operator">=</span> offset<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> length<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxLength <span class="token operator">=</span> maxLength<span class="token punctuation">;</span>
        tmpNioBuf <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> cache<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这段代码又是我们熟悉的, 将属性进行了初始化, 以上就是完整的DirectUnsafePooledByteBuf 在Page 级别的完整分配的流程, 逻辑也是复杂的.</p>
<h3 id="6-SubPage-级别的内存分配"><a href="#6-SubPage-级别的内存分配" class="headerlink" title="6. SubPage 级别的内存分配."></a>6. SubPage 级别的内存分配.</h3><p>通过之前的学习我们知道,如果我们分配一个缓冲区大小远小于page, 则直接在一个page 上进行分配则会造成内存浪费, 所以需要将page 继续进行切分成多个子块进行分配, 子块分配的个数根据你要分配的缓冲区大小而定, 比如只需要分配1KB的内存, 就会将一个page 分为8等分. 简单起见, 我们这里仅仅以16字节为例, 讲解其分配逻辑, 在分析其逻辑前, 首先看 PoolArean 的一个属性:</p>
<blockquote>
<pre><code>private final PoolSubpage&lt;T&gt;[] tinySubpagePools;
</code></pre>
</blockquote>
<p>这个属性是一个PoolSubpage 的数组, 有点类似于一个 subpage 的缓存, 我们创建一个subpage 之后, 会将创建的subpage 与该属性其中的每个关联, 下次在分配的的时候可以直接通过该属性的元素去找关联的subpage, 我们其中是在构造方法中初始化的, 看构造方法中其初始化的代码:</p>
<blockquote>
<pre><code>tinySubpagePools = newSubpagePoolArray(numTinySubpagePools);
</code></pre>
</blockquote>
<p>这里的 numTinySubpagePools 为32, 跟到 <code>newSubpagePoolArray(numTinySubpagePools)</code>  方法中:</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">newSubpagePoolArray</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PoolSubpage</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里直接创建了一个 PoolSubpage 数组, 长度为32, 在构造方法中创建完毕后, 会通过循环为其赋值:</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tinySubpagePools<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            tinySubpagePools<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newSubpagePoolHead</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>继续跟进到 <code>newSubpagePoolHead(pageSize);</code> 方法中:</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">newSubpagePoolHead</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageSize<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolSubpage</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        head<span class="token punctuation">.</span>prev <span class="token operator">=</span> head<span class="token punctuation">;</span>
        head<span class="token punctuation">.</span>next <span class="token operator">=</span> head<span class="token punctuation">;</span>
        <span class="token keyword">return</span> head<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>在 <code>newSubpagePoolHead</code> 方法中创建了一个 PoolSubpage 对象head.</p>
<pre class=" language-java"><code class="language-java">    head<span class="token punctuation">.</span>prev <span class="token operator">=</span> head<span class="token punctuation">;</span>
    head<span class="token punctuation">.</span>next <span class="token operator">=</span> head<span class="token punctuation">;</span>
</code></pre>
<p>这种写法我们知道SubPage 其实也是个双向链表,这里的将head的上一个节点和下一个节点设置为自身,有关PoolSubpage 的关联关系, 我们稍后分析, 这样通过循环创建 PoolSubpage, 总共会创建出来32个subpage, 其中每个subpage 实际代表一块内存大小。</p>
<p><img src="http://files.luyanan.com//img/20191011140957.png"></p>
<p>tinySubpagePools 的结构就有点类似之前的缓存数据 tinySubPageDirectCaches 的结构, 了解了tinySubpagePools  属性, 我们看 看 PoolArean 的 allocate 方法, 也就是缓冲区的入口方法:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">allocate</span><span class="token punctuation">(</span>PoolThreadCache cache<span class="token punctuation">,</span> PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> normCapacity <span class="token operator">=</span> <span class="token function">normalizeCapacity</span><span class="token punctuation">(</span>reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTinyOrSmall</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// capacity &lt; pageSize</span>
            <span class="token keyword">int</span> tableIdx<span class="token punctuation">;</span>
            PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> tiny <span class="token operator">=</span> <span class="token function">isTiny</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tiny<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// &lt; 512</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">allocateTiny</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// was able to allocate out of the cache so move on</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                tableIdx <span class="token operator">=</span> <span class="token function">tinyIdx</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                table <span class="token operator">=</span> tinySubpagePools<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">allocateSmall</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// was able to allocate out of the cache so move on</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                tableIdx <span class="token operator">=</span> <span class="token function">smallIdx</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                table <span class="token operator">=</span> smallSubpagePools<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> head <span class="token operator">=</span> table<span class="token punctuation">[</span>tableIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/**
             * Synchronize on the head. This is needed as &amp;#123;@link PoolChunk#allocateSubpage(int)&amp;#125; and
             * &amp;#123;@link PoolChunk#free(long)&amp;#125; may modify the doubly linked list as well.
             */</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> s <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> head<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">assert</span> s<span class="token punctuation">.</span>doNotDestroy <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span>elemSize <span class="token operator">==</span> normCapacity<span class="token punctuation">;</span>
                    <span class="token keyword">long</span> handle <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">assert</span> handle <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    s<span class="token punctuation">.</span>chunk<span class="token punctuation">.</span><span class="token function">initBufWithSubpage</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>tiny<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        allocationsTiny<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        allocationsSmall<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">allocateNormal</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>normCapacity <span class="token operator">&lt;=</span> chunkSize<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">allocateNormal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// was able to allocate out of the cache so move on</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">allocateNormal</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Huge allocations are never served via the cache so just call allocateHuge</span>
            <span class="token function">allocateHuge</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p> 之前我们在这个方法剖析过page级别相关内存分配逻辑, 现在我们来看subpage 级别分配的相关逻辑, 假设我们分配16字节的缓存区, <code>isTinyOrSmall(normCapacity)</code>  就会返回true, 进入if块, 同样 <code>if (tiny)</code>  这里会返回true. 继续跟进到 <code>if (tiny)</code> 的逻辑, 首先会在缓存中分配缓冲区, 如果分配不到, 就开辟一块内存进行内存分配, 先看着一步:</p>
<blockquote>
<pre><code>tableIdx = tinyIdx(normCapacity);
</code></pre>
</blockquote>
<p>这是通过 normCapacity 拿到tableIdx, 我们跟进去:</p>
<pre class=" language-java"><code class="language-java">   <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">tinyIdx</span><span class="token punctuation">(</span><span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> normCapacity <span class="token operator">>>></span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里将 normCapacity  除以16, 其实也就是1, 我们回到 到 PoolArena 的 allocate()方法继续看：</p>
<blockquote>
<pre><code>table = tinySubpagePools;
</code></pre>
</blockquote>
<p>这里将tinySubpagePools 赋值到局部变量table, 继续往下看:</p>
<p><code>final PoolSubpage head = table[tableIdx]</code> 这步时通过下标拿到一个 PoolSubpage, 因为我们以16字节为例, 所以我们拿到下标为1的PoolSubpage, 对应的内存大小也就是16Byte, 再看 <code>final PoolSubpage head = table[tableIdx]</code> 这一步, 跟我们刚才了解到了tinySubpagePools 属性, 默认情况下 head.next 也是自身, 所以<code>if (s != head)</code> 会返回false, 我们继续往下看, 会走到 <code>allocateNormal(buf, reqCapacity, normCapacity)</code>   这个方法:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">allocateNormal</span><span class="token punctuation">(</span>PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>q050<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span> q025<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span>
            q000<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span> qInit<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span>
            q075<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token operator">++</span>allocationsNormal<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add a new chunk.</span>
        PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> c <span class="token operator">=</span> <span class="token function">newChunk</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">,</span> maxOrder<span class="token punctuation">,</span> pageShifts<span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> handle <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span>allocationsNormal<span class="token punctuation">;</span>
        <span class="token keyword">assert</span> handle <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
        c<span class="token punctuation">.</span><span class="token function">initBuf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        qInit<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里的逻辑我们之前已经剖析过了, 首先在原来的chunk 中分配, 如果分配不成功, 则会创建chunk 进行分配, 我们看这一步<code>long handle = c.allocate(normCapacity);</code>  跟到  <code>allocate(normCapacity);</code> 这个方法:</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">long</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>normCapacity <span class="token operator">&amp;</span> subpageOverflowMask<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// >= pageSize</span>
            <span class="token keyword">return</span> <span class="token function">allocateRun</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">allocateSubpage</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>前面我们分析page级别的时候, 剖析的是 <code>allocateRun(normCapacity)</code> 方法, 因为这里我们是以16字节举例, 所以这次我们剖析 <code>allocateSubpage(normCapacity)</code> 方法, 也就是在 subpage级别进行内存分配的.</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">allocateSubpage</span><span class="token punctuation">(</span><span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Obtain the head of the PoolSubPage pool that is owned by the PoolArena and synchronize on it.</span>
        <span class="token comment" spellcheck="true">// This is need as we may add it back and so alter the linked-list structure.</span>
        PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> head <span class="token operator">=</span> arena<span class="token punctuation">.</span><span class="token function">findSubpagePoolHead</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> d <span class="token operator">=</span> maxOrder<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// subpages are only be allocated from pages i.e., leaves</span>
            <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token function">allocateNode</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> id<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> subpages <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subpages<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> pageSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageSize<span class="token punctuation">;</span>

            freeBytes <span class="token operator">-=</span> pageSize<span class="token punctuation">;</span>

            <span class="token keyword">int</span> subpageIdx <span class="token operator">=</span> <span class="token function">subpageIdx</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> subpage <span class="token operator">=</span> subpages<span class="token punctuation">[</span>subpageIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>subpage <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                subpage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolSubpage</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token function">runOffset</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                subpages<span class="token punctuation">[</span>subpageIdx<span class="token punctuation">]</span> <span class="token operator">=</span> subpage<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                subpage<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> subpage<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>首先, 通过<code>PoolSubpage head = arena.findSubpagePoolHead(normCapacity)</code> 这种方式找到head节点, 实际上这里head 就是我们分析的tinySubpagePools 属性的第一个节点, 也就是对应16KB的那个节点, int d = maxOrder 是将11赋值给d, 也就是在内存树的第11层取值, 这部分前面剖析过了,。int id = allocateNode(d)  这个也是前面分析过的, 字节数组 memoryMap 的下标, 这里指向一个page, 如果第一次分配, 指向的是0-8KB 的那个page, 前面已经对此进行详细的剖析了, <code>final PoolSubpage[] subpages = this.subpages</code>  这一步, 是拿到PoolChunk 中成员变量subpage的值, 也就是 PoolSubpage 数组, 在PoolChunk 进行初始化的时候， 也会初始化该数组, 长度为2048, 也就是每个chunk 都维护着一个subpage 的列表, 如果每一个page 级别的内存都需要被切分成子page, 则会将这个page 放入该列表中, 专门用于分配子page, 所以这个列表中的subpage 其实就是一个用于切分的page.</p>
<p><img src="http://files.luyanan.com//img/20191011144649.png"></p>
<p><code>int subpageIdx = subpageIdx(id)</code>  这一步是通过id 拿到这个 PoolSubpage 数组的下标, 如果id 对应的page 是0-8KB 的节点, 这里拿到的下标就是0, 在 if (subpage == null) 中, 因为默认 subpages 只是创建一个数组, 并没有数组中赋值, 所以第一次走到这里会返回true, 跟到if 块中:</p>
<blockquote>
<pre><code>subpage = new PoolSubpage&lt;T&gt;(head, this, id, runOffset(id), pageSize, normCapacity);
</code></pre>
</blockquote>
<p>这里通过 <code>new PoolSubpage</code> 创建一个新的subpage 之后, 通过<code>subpages[subpageIdx] = subpage</code>  这种方式将新创建的subpage 根据下表赋值到subpages 中的元素中, 在new PoolSubpage 的构造方法中, 传入head, 就是我们刚才提到过的tinySubpagePools 属性中的节点, 如果我们分配的16字节的缓冲区, 则这里对应的就是第一个节点, 我们跟到PoolSubpage  的构造方法中</p>
<pre class=" language-java"><code class="language-java"> <span class="token function">PoolSubpage</span><span class="token punctuation">(</span>PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> head<span class="token punctuation">,</span> PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> chunk<span class="token punctuation">,</span> <span class="token keyword">int</span> memoryMapIdx<span class="token punctuation">,</span> <span class="token keyword">int</span> runOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token keyword">int</span> elemSize<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chunk <span class="token operator">=</span> chunk<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>memoryMapIdx <span class="token operator">=</span> memoryMapIdx<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>runOffset <span class="token operator">=</span> runOffset<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pageSize <span class="token operator">=</span> pageSize<span class="token punctuation">;</span>
        bitmap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">long</span><span class="token punctuation">[</span>pageSize <span class="token operator">>>></span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// pageSize / 16 / 64</span>
        <span class="token function">init</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> elemSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里重点关注属性 bitmap, 这是一个long类型的数组, 初始大小为8, 这里只是初始化的大小, 真正的大小要根据将page 切分多少块而确定的, 这里将属性进行了赋值, 我们跟到init()  方法:</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> head<span class="token punctuation">,</span> <span class="token keyword">int</span> elemSize<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        doNotDestroy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>elemSize <span class="token operator">=</span> elemSize<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>elemSize <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            maxNumElems <span class="token operator">=</span> numAvail <span class="token operator">=</span> pageSize <span class="token operator">/</span> elemSize<span class="token punctuation">;</span>
            nextAvail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            bitmapLength <span class="token operator">=</span> maxNumElems <span class="token operator">>>></span> <span class="token number">6</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>maxNumElems <span class="token operator">&amp;</span> <span class="token number">63</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                bitmapLength <span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bitmapLength<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                bitmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token function">addToPool</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p><code>this.elemSize = elemSize</code>  表示保存当前分配的缓存区大小, 这里我们以16字节举例, <code>maxNumElems = numAvail = pageSize / elemSize</code>   这里初始化了两个属性 性 maxNumElems, numAvail, 值都为 pageSize / elemSize, 表示一个 page 大小除以分配的缓冲区大小, 也就是表示当前 page 被划分了多少分。</p>
<p>nextAvail 则表示剩余可用的块数, 由于第一次分配都是可用的, 所以 numAvail=maxNumElems；</p>
<p>bitmapLength 表示bitmap 的实际大小, 刚才我们分析过, bitmap 初始化的大小为8, 但实际上并不一定需要8个元素, 元素个数要根据page切分的子块而定, 这里的大小是所切分的子块数除以64.</p>
<p>再往下看, <code>if ((maxNumElems &amp; 63) != 0)</code>   判断maxNumElems 也就是当前配置所切分的子块是不是64的倍数, 如果不是, 则bigmapLength 加1 , 最后通过循环, 将其分配的大小中的元素赋值为0.</p>
<p>这里详细分析一下bitmap, 这里是个long 类型的数组, long 数组中的每一个值, 也就是long 类型的数字, 其中的每一个比特位, 都标记着page 中每一个子块的内存是否已分配, 如果比特位是1, 表示该快已经分配, 如果比特位是0, 表示该子块未分配. 标记顺序是其二进制数从低位到高位进行排列的, 我们应该知道为什么bitmap 大小要设置为子块数量乘以64, 因为long类型的数字是64位, 每一个元素能记录64个子块的数量, 这样就可以通过 子page 个数除以64 的方式决定bitmap中元素的数量, 如果子块不能整除64, 则通过元素数量+1 方式, 除以64之后剩余的子块通过long中比特位由低到高进行排列记录, 其逻辑结构如下图所示：</p>
<p><img src="http://files.luyanan.com//img/20191011153603.png"></p>
<p>进入到 PoolSubpage 的addToPool(head) 方法:</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addToPool</span><span class="token punctuation">(</span>PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> head<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> prev <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> next <span class="token operator">==</span> null<span class="token punctuation">;</span>
        prev <span class="token operator">=</span> head<span class="token punctuation">;</span>
        next <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        next<span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        head<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里的head我们刚才讲过, 是Arena 中数组 tinySubpagePools 中的元素, 通过以上逻辑, 就会将新创建的Subpage 通过双向链表的方式关联到 tinySubpagePools 中的元素, 我们以16字节为例, 关联关系如下图所示：</p>
<p><img src="http://files.luyanan.com//img/20191011154018.png"></p>
<p>这样, 下次如果还需要分配16字节的内存, 就可以通过tinySubpagePools 找到其元素关联的subpage 进行分配了, 我们再回到PoolChunk 的 allocateSubpage()方法：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">allocateSubpage</span><span class="token punctuation">(</span><span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Obtain the head of the PoolSubPage pool that is owned by the PoolArena and synchronize on it.</span>
        <span class="token comment" spellcheck="true">// This is need as we may add it back and so alter the linked-list structure.</span>
        PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> head <span class="token operator">=</span> arena<span class="token punctuation">.</span><span class="token function">findSubpagePoolHead</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> d <span class="token operator">=</span> maxOrder<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// subpages are only be allocated from pages i.e., leaves</span>
            <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token function">allocateNode</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> id<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> subpages <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subpages<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> pageSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageSize<span class="token punctuation">;</span>

            freeBytes <span class="token operator">-=</span> pageSize<span class="token punctuation">;</span>

            <span class="token keyword">int</span> subpageIdx <span class="token operator">=</span> <span class="token function">subpageIdx</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> subpage <span class="token operator">=</span> subpages<span class="token punctuation">[</span>subpageIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>subpage <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                subpage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolSubpage</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token function">runOffset</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                subpages<span class="token punctuation">[</span>subpageIdx<span class="token punctuation">]</span> <span class="token operator">=</span> subpage<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                subpage<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> subpage<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>创建完一个subpage， 我们就可以通过subpage.allocate() 方法进行内存分配, 我们跟到allocate()  方法：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">long</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>elemSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">toHandle</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>numAvail <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span>doNotDestroy<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> bitmapIdx <span class="token operator">=</span> <span class="token function">getNextAvail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> q <span class="token operator">=</span> bitmapIdx <span class="token operator">>>></span> <span class="token number">6</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> r <span class="token operator">=</span> bitmapIdx <span class="token operator">&amp;</span> <span class="token number">63</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> <span class="token punctuation">(</span>bitmap<span class="token punctuation">[</span>q<span class="token punctuation">]</span> <span class="token operator">>>></span> r <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
        bitmap<span class="token punctuation">[</span>q<span class="token punctuation">]</span> <span class="token operator">|=</span> 1L <span class="token operator">&lt;&lt;</span> r<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span> numAvail <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">removeFromPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">toHandle</span><span class="token punctuation">(</span>bitmapIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>其中 bitmapIdx 表示从 bitmap 中找到一个可用的bit 位的下标, 注意, 这里是bit的下标, 并不是数组的下标, 我们之前分析过，因为每一个比特位代表一个子块的内存分配情况, 通过这个下标就可以知道哪个比特位是未分配状态, 我们跟进去：</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getNextAvail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> nextAvail <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextAvail<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextAvail <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>nextAvail <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> nextAvail<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">findNextAvail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>上述代表片段中的nextAvail 表示下一个可用的bitmapIdx, 在释放的时候就会被标记, 标记被释放的子块对应  bitmapIdx的下标, 如果&lt; 0 则代表没有被释放的子块, 则通过findNextAvail() 方法进行查找, 继续跟进 findNextAvail() 方法:</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">findNextAvail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bitmap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bitmap<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> bitmapLength <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bitmapLength<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bitmapLength<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> bits <span class="token operator">=</span> bitmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">~</span>bits <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">findNextAvail0</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里会遍历bitmap 中的每一个元素, 如果当前元素中所有的比特位并没有全部标记被使用, 则通过findNextAvail() 方法一个一个往后找标记未使用的比特位, 再继续跟findNextAvail0</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">findNextAvail0</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">long</span> bits<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> maxNumElems <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxNumElems<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> baseVal <span class="token operator">=</span> i <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">64</span><span class="token punctuation">;</span> j <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bits <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> val <span class="token operator">=</span> baseVal <span class="token operator">|</span> j<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&lt;</span> maxNumElems<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            bits <span class="token operator">>>>=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里从当前元素的第一个比特位开始查找, 知道找到一个标记位0的比特位, 并返回当前比特位的下标,大致流程如下图所示:</p>
<p><img src="http://files.luyanan.com//img/20191011155250.png"></p>
<p>我们回到allocate() 方法中:</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">long</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>elemSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">toHandle</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>numAvail <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span>doNotDestroy<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

     <span class="token comment" spellcheck="true">// 取一个bitmap 中可用的id(绝对id)</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> bitmapIdx <span class="token operator">=</span> <span class="token function">getNextAvail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">// 除以64 (bitmap 的相对下标)</span>
        <span class="token keyword">int</span> q <span class="token operator">=</span> bitmapIdx <span class="token operator">>>></span> <span class="token number">6</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">// 除以64 取余, 其实就是当前绝对id 的偏移量</span>
        <span class="token keyword">int</span> r <span class="token operator">=</span> bitmapIdx <span class="token operator">&amp;</span> <span class="token number">63</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> <span class="token punctuation">(</span>bitmap<span class="token punctuation">[</span>q<span class="token punctuation">]</span> <span class="token operator">>>></span> r <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">// 当前位标记位1</span>
        bitmap<span class="token punctuation">[</span>q<span class="token punctuation">]</span> <span class="token operator">|=</span> 1L <span class="token operator">&lt;&lt;</span> r<span class="token punctuation">;</span>

     <span class="token comment" spellcheck="true">// 如果可用的page 为0</span>
     <span class="token comment" spellcheck="true">// 可用的子page -1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span> numAvail <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">removeFromPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

     <span class="token comment" spellcheck="true">// 将bitmapIdx 转换为handler</span>
        <span class="token keyword">return</span> <span class="token function">toHandle</span><span class="token punctuation">(</span>bitmapIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>找到可用的bitmapIdx , 通过 <code>int q = bitmapIdx &gt;&gt;&gt;6</code> 获取bitmap 中 bitmapIdx 所属元素的数组下标, <code>int r = bitmapIdx &amp; 63</code> 表示获取bitmapIdx 的位置是从当前元素最低开始的第几个比特位, <code>bitmap[q] |= 1L &lt;&lt; r</code> 是将bitmap 的位置设置为不可用, 特就是比特位设置为1, 表示已占用, 然后将可用子配置的数量numAvail 减1.  如果没有可用子page 的数量, 则会将 PoolArena 中的数组 tinySubpagePools 所关联的 subpage 进行移除。最后通过toHandle(bitmapIdx)  获取当前子块的handle, 上一小节我们知道handler 指向的是当前chunk 中的唯一的一块内存, 我们跟进toHandle(bitmapIdx) 中：</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">toHandle</span><span class="token punctuation">(</span><span class="token keyword">int</span> bitmapIdx<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> 0x4000000000000000L <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> bitmapIdx <span class="token operator">&lt;&lt;</span> <span class="token number">32</span> <span class="token operator">|</span> memoryMapIdx<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>(long) bitmapIdx &lt;&lt; 32 是将 bitmapIdx 右移 32 位, 而 32 位正好是一个 int 的长度, 这样, 通过 (long) bitmapIdx &lt;&lt;<br>32 | memoryMapIdx 计算, 就可以将 memoryMapIdx, 也就是 page 所属的下标的二进制数保存在 (long) bitmapIdx<br>&lt;&lt; 32 的低 32 位中。0x4000000000000000L 是一个最高位是 1 并且所有低位都是 0 的二进制数, 这样通过按位或的<br>方式可以将 (long) bitmapIdx &lt;&lt; 32 | memoryMapIdx 计算出来的结果保存在 0x4000000000000000L 的所有低位中, 这样, 返回对的数字就可以指向 chunk 中唯一的一块内存，我们回到 PoolArena 的 allocateNormal 方法中：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">allocateNormal</span><span class="token punctuation">(</span>PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>q050<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span> q025<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span>
            q000<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span> qInit<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span>
            q075<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token operator">++</span>allocationsNormal<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add a new chunk.</span>
        PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> c <span class="token operator">=</span> <span class="token function">newChunk</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">,</span> maxOrder<span class="token punctuation">,</span> pageShifts<span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> handle <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span>allocationsNormal<span class="token punctuation">;</span>
        <span class="token keyword">assert</span> handle <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
        c<span class="token punctuation">.</span><span class="token function">initBuf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        qInit<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>分析完了 <code>long handle = c.allocate(normCapacity)</code> 这步, 这里返回的handle 就指向 chunk 中的某个page 中的某个子块所对应的连续内存, 最后, 通过 initBuf() 初始化后， 将创建的chunk 加到chunkList 里面, 我们跟进到initBuf 方法里面</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">void</span> <span class="token function">initBuf</span><span class="token punctuation">(</span>PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> memoryMapIdx <span class="token operator">=</span> <span class="token function">memoryMapIdx</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> bitmapIdx <span class="token operator">=</span> <span class="token function">bitmapIdx</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmapIdx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span> val <span class="token operator">=</span> <span class="token function">value</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">assert</span> val <span class="token operator">==</span> unusable <span class="token operator">:</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
            buf<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> handle<span class="token punctuation">,</span> <span class="token function">runOffset</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span><span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> <span class="token function">runLength</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span><span class="token punctuation">,</span>
                     arena<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">threadCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">initBufWithSubpage</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> bitmapIdx<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这部分在前面已经剖析过, 相信大家不会陌生, 这里有区别是的<code>if (bitmapIdx == 0)</code> 的判断, 这里的bitmapIdx 不会是0, 这样, 就会走到 initBufWithSubpage(buf, handle, bitmapIdx, reqCapacity)方法中，跟到 initBufWithSubpage()方法：</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initBufWithSubpage</span><span class="token punctuation">(</span>PooledByteBuf<span class="token operator">&lt;</span>T<span class="token operator">></span> buf<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> bitmapIdx<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> bitmapIdx <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> memoryMapIdx <span class="token operator">=</span> <span class="token function">memoryMapIdx</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

        PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> subpage <span class="token operator">=</span> subpages<span class="token punctuation">[</span><span class="token function">subpageIdx</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> subpage<span class="token punctuation">.</span>doNotDestroy<span class="token punctuation">;</span>
        <span class="token keyword">assert</span> reqCapacity <span class="token operator">&lt;=</span> subpage<span class="token punctuation">.</span>elemSize<span class="token punctuation">;</span>

        buf<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">,</span> handle<span class="token punctuation">,</span>
            <span class="token function">runOffset</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>bitmapIdx <span class="token operator">&amp;</span> <span class="token number">0x3FFFFFFF</span><span class="token punctuation">)</span> <span class="token operator">*</span> subpage<span class="token punctuation">.</span>elemSize<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> subpage<span class="token punctuation">.</span>elemSize<span class="token punctuation">,</span>
            arena<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">threadCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>首先拿到memoryMapIdx , 这里会将我们之前计算的 handle 传入, 跟进去:</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">memoryMapIdx</span><span class="token punctuation">(</span><span class="token keyword">long</span> handle<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> handle<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里将其强制转换为一个int 类型, 也就是去掉高32位, 这样就能得到memoryMapIdx, 回到initBufWithSubpage()  方法中:我们注意在buf 调用init()  方法中的一个参数 <code>runOffset(memoryMapIdx) + (bitmapIdx &amp; 0x3FFFFFFF) * subpage.elemSize</code>  这里的偏移量就是原来page 的偏移量 + 子块的偏移量: bitmapIdx &amp; 0x3FFFFFFF 代表当前分配<br>的子 page 是属于第几个子 page。(bitmapIdx &amp; 0x3FFFFFFF) * subpage.elemSize 表示在当前 page 的偏移量。这样, 分<br>配的 ByteBuf 在内存读写的时候, 就会根据偏移量进行读写。最后，我们跟到 init()方法中：</p>
<pre class=" language-java"><code class="language-java">
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> chunk<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> maxLength<span class="token punctuation">,</span> PoolThreadCache cache<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> handle <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> chunk <span class="token operator">!=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>chunk <span class="token operator">=</span> chunk<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handle <span class="token operator">=</span> handle<span class="token punctuation">;</span>
        memory <span class="token operator">=</span> chunk<span class="token punctuation">.</span>memory<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>offset <span class="token operator">=</span> offset<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> length<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxLength <span class="token operator">=</span> maxLength<span class="token punctuation">;</span>
        tmpNioBuf <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> cache<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里又是我们熟悉的逻辑, 初始化属性之后, 一个缓冲区分配完成, 以上就是SubPage 级别的缓冲区分配逻辑。</p>
<h3 id="7-内存池ByteBuf-内存回收"><a href="#7-内存池ByteBuf-内存回收" class="headerlink" title="7. 内存池ByteBuf 内存回收"></a>7. 内存池ByteBuf 内存回收</h3><p>我们知道,堆外内存是不受JVM 垃圾回收机制控制的, 所以我们分配一块堆外内存进行ByteBuf 操作时, 使用完毕要对对象进行回收, 本节就以 PooledUnsafeDirectByteBuf 为例讲解有关内存分配的相关逻辑, PooledUnsafeDirectByteBuf 中内存释放的入口方法是其父类 AbstractReferenceCountedByteBuf 中的release() 方法:</p>
<pre class=" language-java"><code class="language-java"> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">int</span> decrement<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">release0</span><span class="token punctuation">(</span><span class="token function">checkPositive</span><span class="token punctuation">(</span>decrement<span class="token punctuation">,</span> <span class="token string">"decrement"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">release0</span><span class="token punctuation">(</span><span class="token keyword">int</span> decrement<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> refCnt <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>refCnt<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>refCnt <span class="token operator">&lt;</span> decrement<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalReferenceCountException</span><span class="token punctuation">(</span>refCnt<span class="token punctuation">,</span> <span class="token operator">-</span>decrement<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>refCntUpdater<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> refCnt<span class="token punctuation">,</span> refCnt <span class="token operator">-</span> decrement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>refCnt <span class="token operator">==</span> decrement<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">deallocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p><code>if (refCnt == decrement)</code>  中判断当前ByteBuf 是否没有被引用了, 如果没有被引用, 则通过deallocate() 方法进行释放 ,因为我们是以因为我们是以 PooledUnsafeDirectByteBuf 为例, 所以这里会调用其父类 PooledByteBuf 的 deallocate()方法：</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> handle <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handle<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>handle <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            memory <span class="token operator">=</span> null<span class="token punctuation">;</span>
            chunk<span class="token punctuation">.</span>arena<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> maxLength<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>我们首先来分析  free()  方法:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">free</span><span class="token punctuation">(</span>PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> chunk<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">,</span> PoolThreadCache cache<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>unpooled<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> size <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">chunkSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">destroyChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
            activeBytesHuge<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">-</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            deallocationsHuge<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            SizeClass sizeClass <span class="token operator">=</span> <span class="token function">sizeClass</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> cache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> normCapacity<span class="token punctuation">,</span> sizeClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// cached so not free it.</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token function">freeChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> sizeClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>首先判断是不是unpooled, 我们这里是 Pooled, 所以会走到else 块中：</p>
<p>sizeClass(normCapacity) 计算是哪种级别的size, 我们按照tiny 级别进行分析</p>
<p>cache.add(this, chunk, handle, normCapacity, sizeClass) 是将当前ByteBuf  进行缓存.</p>
<p>我们之前讲过, 在分配ByteBuf 时首先在缓存上分配, 而这步, 就是将其缓存的过程, 继续跟进去:</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span>PoolArena<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> area<span class="token punctuation">,</span> PoolChunk chunk<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">,</span> SizeClass sizeClass<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        MemoryRegionCache<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> cache <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>area<span class="token punctuation">,</span> normCapacity<span class="token punctuation">,</span> sizeClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>首先根据类型拿到相关类型的缓存节点, 这里会根据不同的内存规格去找不同的对象, 我们简单回顾一下, 每个缓存对象都包含一个queue, queue 中每个节点是entry, 每一个entry 中包含一个chunk 和handle, 可以指向唯一的连续的内存, 我们跟到cache中:</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">private</span> MemoryRegionCache<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">cache</span><span class="token punctuation">(</span>PoolArena<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> area<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">,</span> SizeClass sizeClass<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>sizeClass<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> Normal<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token function">cacheForNormal</span><span class="token punctuation">(</span>area<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> Small<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token function">cacheForSmall</span><span class="token punctuation">(</span>area<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> Tiny<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token function">cacheForTiny</span><span class="token punctuation">(</span>area<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>假设我们是tiny类型, 这里就会走到   <code>cacheForTiny(area, normCapacity)</code> 方法中, 跟进去:</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">private</span> MemoryRegionCache<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">cacheForTiny</span><span class="token punctuation">(</span>PoolArena<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> area<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> idx <span class="token operator">=</span> PoolArena<span class="token punctuation">.</span><span class="token function">tinyIdx</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>area<span class="token punctuation">.</span><span class="token function">isDirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">cache</span><span class="token punctuation">(</span>tinySubPageDirectCaches<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">cache</span><span class="token punctuation">(</span>tinySubPageHeapCaches<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这个方法我们之前剖析过, 就是根据大小找到第几个缓存中的第几个缓存, 拿到下标后, 通过cache 去找相对应的缓存对象.</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> MemoryRegionCache<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">cache</span><span class="token punctuation">(</span>MemoryRegionCache<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> cache<span class="token punctuation">,</span> <span class="token keyword">int</span> idx<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">==</span> null <span class="token operator">||</span> idx <span class="token operator">></span> cache<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cache<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>我们这里看到, 是直接通过下标拿到的缓存对象, 回到 add()  方法:</p>
<pre class=" language-java"><code class="language-java">  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token string">"unchecked"</span><span class="token punctuation">,</span> <span class="token string">"rawtypes"</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
    <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span>PoolArena<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> area<span class="token punctuation">,</span> PoolChunk chunk<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">,</span> SizeClass sizeClass<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        MemoryRegionCache<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> cache <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>area<span class="token punctuation">,</span> normCapacity<span class="token punctuation">,</span> sizeClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里的cache 对象调用了一个add方法, 这个方法就是将chunk 和handle 封装成一个 entry 加到queue, 我们跟到add() 方法中:</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span>PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> chunk<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            Entry<span class="token operator">&lt;</span>T<span class="token operator">></span> entry <span class="token operator">=</span> <span class="token function">newEntry</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> queued <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queued<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// If it was not possible to cache the chunk, immediately recycle the entry</span>
                entry<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> queued<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>我们之前介绍过, 从在缓存对象中分配的时候从queue 弹出一个entry, 会放到一个对象池里面, 而这里的<code> Entry&lt;T&gt; entry = newEntry(chunk, handle);</code>  就是从对象池中去取一个entry 对象, 然后将chunk 和handle 进行赋值, 然后通过<code>queue.offer(entry)</code>  加到queue, 我们回到free() 方法:</p>
<pre class=" language-java"><code class="language-java">   <span class="token keyword">void</span> <span class="token function">free</span><span class="token punctuation">(</span>PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> chunk<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">,</span> PoolThreadCache cache<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>unpooled<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> size <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">chunkSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">destroyChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
            activeBytesHuge<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">-</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            deallocationsHuge<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            SizeClass sizeClass <span class="token operator">=</span> <span class="token function">sizeClass</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> cache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> normCapacity<span class="token punctuation">,</span> sizeClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// cached so not free it.</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token function">freeChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> sizeClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里加到缓存之后, 如果成功, 就会return, 如果不成功, 就会调用 <code> freeChunk(chunk, handle, sizeClass);</code>  方法, 这个方法的意思是： 将原来给ByteBuf 分配的内存区段标记位未使用,跟进到 ` freeChunk()  方法：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">freeChunk</span><span class="token punctuation">(</span>PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> chunk<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> SizeClass sizeClass<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> destroyChunk<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>sizeClass<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> Normal<span class="token operator">:</span>
                <span class="token operator">++</span>deallocationsNormal<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> Small<span class="token operator">:</span>
                <span class="token operator">++</span>deallocationsSmall<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> Tiny<span class="token operator">:</span>
                <span class="token operator">++</span>deallocationsTiny<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            destroyChunk <span class="token operator">=</span> <span class="token operator">!</span>chunk<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>destroyChunk<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// destroyChunk not need to be called while holding the synchronized lock.</span>
            <span class="token function">destroyChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>我们在跟到free() 方法中：</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">boolean</span> <span class="token function">free</span><span class="token punctuation">(</span>PoolChunk<span class="token operator">&lt;</span>T<span class="token operator">></span> chunk<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        chunk<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> minUsage<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">remove</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Move the PoolChunk down the PoolChunkList linked-list.</span>
            <span class="token keyword">return</span> <span class="token function">move0</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p><code>chunk.free(handle);</code> 的意思是通过chunk 释放一段连续的内存, 再跟回到free() 方法中：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token keyword">long</span> handle<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> memoryMapIdx <span class="token operator">=</span> <span class="token function">memoryMapIdx</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> bitmapIdx <span class="token operator">=</span> <span class="token function">bitmapIdx</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmapIdx <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// free a subpage</span>
            PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> subpage <span class="token operator">=</span> subpages<span class="token punctuation">[</span><span class="token function">subpageIdx</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">assert</span> subpage <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> subpage<span class="token punctuation">.</span>doNotDestroy<span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Obtain the head of the PoolSubPage pool that is owned by the PoolArena and synchronize on it.</span>
            <span class="token comment" spellcheck="true">// This is need as we may add it back and so alter the linked-list structure.</span>
            PoolSubpage<span class="token operator">&lt;</span>T<span class="token operator">></span> head <span class="token operator">=</span> arena<span class="token punctuation">.</span><span class="token function">findSubpagePoolHead</span><span class="token punctuation">(</span>subpage<span class="token punctuation">.</span>elemSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>subpage<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> bitmapIdx <span class="token operator">&amp;</span> <span class="token number">0x3FFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        freeBytes <span class="token operator">+=</span> <span class="token function">runLength</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setValue</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">,</span> <span class="token function">depth</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateParentsFree</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>if (bitmapIdx != 0)  这里判断是当前缓存区分配的级别是page 还是subpage, 如果是subpage , 则会找到相关的subpage 将其位标记为0， 如果不是subpage, 这里通过分配内存的反向标记, 将该内存标记为未使用. 回 到 PooledByteBuf 的 deallocate方法中：</p>
<pre class=" language-java"><code class="language-java">  <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> handle <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handle<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>handle <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            memory <span class="token operator">=</span> null<span class="token punctuation">;</span>
            chunk<span class="token punctuation">.</span>arena<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> maxLength<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>最后, 通过recycle()  将释放的ByteBuf 放入对象回收站</p>
<h3 id="8-SocketChannel-读取ByteBuf-的过程"><a href="#8-SocketChannel-读取ByteBuf-的过程" class="headerlink" title="8. SocketChannel 读取ByteBuf 的过程"></a>8. SocketChannel 读取ByteBuf 的过程</h3><p>我们首先看NioEventLoop 的processSelectedKey 方法:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processSelectedKey</span><span class="token punctuation">(</span>SelectionKey k<span class="token punctuation">,</span> AbstractNioChannel ch<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> AbstractNioChannel<span class="token punctuation">.</span>NioUnsafe unsafe <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>k<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> EventLoop eventLoop<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                eventLoop <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ignored<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// If the channel implementation throws an exception because there is no event loop, we ignore this</span>
                <span class="token comment" spellcheck="true">// because we are only trying to determine if ch is registered to this event loop and thus has authority</span>
                <span class="token comment" spellcheck="true">// to close ch.</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Only close ch if ch is still registerd to this EventLoop. ch could have deregistered from the event loop</span>
            <span class="token comment" spellcheck="true">// and thus the SelectionKey could be cancelled as part of the deregistration process, but the channel is</span>
            <span class="token comment" spellcheck="true">// still healthy and should not be closed.</span>
            <span class="token comment" spellcheck="true">// See https://github.com/netty/netty/issues/5125</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>eventLoop <span class="token operator">!=</span> <span class="token keyword">this</span> <span class="token operator">||</span> eventLoop <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// close the channel if the key is not valid anymore</span>
            unsafe<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">voidPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> readyOps <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// We first need to call finishConnect() before try to trigger a read(...) or write(...) as otherwise</span>
            <span class="token comment" spellcheck="true">// the NIO JDK channel implementation may throw a NotYetConnectedException.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> SelectionKey<span class="token punctuation">.</span>OP_CONNECT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// remove OP_CONNECT as otherwise Selector.select(..) will always return without blocking</span>
                <span class="token comment" spellcheck="true">// See https://github.com/netty/netty/issues/924</span>
                <span class="token keyword">int</span> ops <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ops <span class="token operator">&amp;=</span> <span class="token operator">~</span>SelectionKey<span class="token punctuation">.</span>OP_CONNECT<span class="token punctuation">;</span>
                k<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>ops<span class="token punctuation">)</span><span class="token punctuation">;</span>

                unsafe<span class="token punctuation">.</span><span class="token function">finishConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Process OP_WRITE first as we may be able to write some queued buffers and so free memory.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> SelectionKey<span class="token punctuation">.</span>OP_WRITE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Call forceFlush which will also take care of clear the OP_WRITE once there is nothing left to write</span>
                ch<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forceFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Also check for readOps of 0 to workaround possible JDK bug which may otherwise lead</span>
            <span class="token comment" spellcheck="true">// to a spin loop</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token punctuation">(</span>SelectionKey<span class="token punctuation">.</span>OP_READ <span class="token operator">|</span> SelectionKey<span class="token punctuation">.</span>OP_ACCEPT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> readyOps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                unsafe<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ch<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// Connection already closed - no need to handle write.</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> ignored<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            unsafe<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">voidPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p><code>if ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != 0 || readyOps == 0)</code> 这里的判断表示轮询到大事件是OP_READ 或者 OP_ACCEPT 事件.  如果当前 <strong>NioEventLoop</strong> 是work 线程的话, 那么这里就是OP_READ  事件, 也就是读事件, 表示客户端发来了数据流, 这里会调用 unsafe 的redis()  方法进行读取， 如果是work 线程, 那么这里的channel  是NioServerSocketChannel, 其绑定的 unsafe 是NioByteUnsafe, 这里会走到 NioByteUnsafe 的 read()方法中：</p>
<pre class=" language-java"><code class="language-java">   <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ChannelConfig config <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ChannelPipeline pipeline <span class="token operator">=</span> <span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ByteBufAllocator allocator <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> RecvByteBufAllocator<span class="token punctuation">.</span>Handle allocHandle <span class="token operator">=</span> <span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            allocHandle<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

            ByteBuf byteBuf <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> close <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">do</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    byteBuf <span class="token operator">=</span> allocHandle<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    allocHandle<span class="token punctuation">.</span><span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token function">doReadBytes</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>allocHandle<span class="token punctuation">.</span><span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// nothing was read. release the buffer.</span>
                        byteBuf<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        byteBuf <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        close <span class="token operator">=</span> allocHandle<span class="token punctuation">.</span><span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                    allocHandle<span class="token punctuation">.</span><span class="token function">incMessagesRead</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    readPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    byteBuf <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>allocHandle<span class="token punctuation">.</span><span class="token function">continueReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                allocHandle<span class="token punctuation">.</span><span class="token function">readComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pipeline<span class="token punctuation">.</span><span class="token function">fireChannelReadComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>close<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">closeOnRead</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">handleReadException</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> byteBuf<span class="token punctuation">,</span> t<span class="token punctuation">,</span> close<span class="token punctuation">,</span> allocHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">finally</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Check if there is a readPending which was not processed yet.</span>
                <span class="token comment" spellcheck="true">// This could be for two reasons:</span>
                <span class="token comment" spellcheck="true">// * The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method</span>
                <span class="token comment" spellcheck="true">// * The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...) method</span>
                <span class="token comment" spellcheck="true">//</span>
                <span class="token comment" spellcheck="true">// See https://github.com/netty/netty/issues/2254</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>readPending <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>config<span class="token punctuation">.</span><span class="token function">isAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">removeReadOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>首先获取SocketChannel 的 config, pipeline 等相关属性，final ByteBufAllocator allocator = config.getAllocator(); 这<br>一步是获取一个 ByteBuf 的内存分配器, 用于分配 ByteBuf。这里会走到 DefaultChannelConfig 的 getAllocator 方法中:</p>
<pre class=" language-java"><code class="language-java">  <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> ByteBufAllocator <span class="token function">getAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> allocator<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里返回的 DefaultChannelConfig  的成员变量, 我们看这个成员变量：</p>
<blockquote>
<pre><code>private volatile ByteBufAllocator allocator = ByteBufAllocator.DEFAULT;
</code></pre>
</blockquote>
<p>这里调用的 ByteBufAllocator 的DEFAULT属性, 跟进去:</p>
<blockquote>
<pre><code>ByteBufAllocator DEFAULT = ByteBufUtil.DEFAULT_ALLOCATOR;
</code></pre>
</blockquote>
<p>看到这里又调用了ByteBufUtil 的静态属性DEFAULT_ALLOCATOR, 再跟进去</p>
<blockquote>
<pre><code>
static final ByteBufAllocator DEFAULT_ALLOCATOR;
</code></pre>
</blockquote>
<p>DEFAULT_ALLOCATOR  这个属性是在static 块中初始化的, 我们跟到static 块中：</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">static</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        String allocType <span class="token operator">=</span> SystemPropertyUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
                <span class="token string">"io.netty.allocator.type"</span><span class="token punctuation">,</span> PlatformDependent<span class="token punctuation">.</span><span class="token function">isAndroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"unpooled"</span> <span class="token operator">:</span> <span class="token string">"pooled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        allocType <span class="token operator">=</span> allocType<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span>Locale<span class="token punctuation">.</span>US<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ByteBufAllocator alloc<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"unpooled"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>allocType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            alloc <span class="token operator">=</span> UnpooledByteBufAllocator<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.allocator.type: &amp;#123;&amp;#125;"</span><span class="token punctuation">,</span> allocType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"pooled"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>allocType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            alloc <span class="token operator">=</span> PooledByteBufAllocator<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.allocator.type: &amp;#123;&amp;#125;"</span><span class="token punctuation">,</span> allocType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            alloc <span class="token operator">=</span> PooledByteBufAllocator<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.allocator.type: pooled (unknown: &amp;#123;&amp;#125;)"</span><span class="token punctuation">,</span> allocType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        DEFAULT_ALLOCATOR <span class="token operator">=</span> alloc<span class="token punctuation">;</span>

        THREAD_LOCAL_BUFFER_SIZE <span class="token operator">=</span> SystemPropertyUtil<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"io.netty.threadLocalDirectBufferSize"</span><span class="token punctuation">,</span> <span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.threadLocalDirectBufferSize: &amp;#123;&amp;#125;"</span><span class="token punctuation">,</span> THREAD_LOCAL_BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        MAX_CHAR_BUFFER_SIZE <span class="token operator">=</span> SystemPropertyUtil<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"io.netty.maxThreadLocalCharBufferSize"</span><span class="token punctuation">,</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"-Dio.netty.maxThreadLocalCharBufferSize: &amp;#123;&amp;#125;"</span><span class="token punctuation">,</span> MAX_CHAR_BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>首先判断运行环境是不是安卓, 如果不是安卓, 在返回”pooled”  字符串保存到  allocType 中, 然后通过if 判断, 最后局部变量alloc = PooledByteBufAllocator.DEFAULT;  最后将alloc  赋值到成员变量 DEFAULT_ALLOCATOR, 我们跟到PooledByteBufAllocator 的 DEFAULT 属性中：</p>
<blockquote>
<pre><code>public static final PooledByteBufAllocator DEFAULT =        new PooledByteBufAllocator(PlatformDependent.directBufferPreferred());
</code></pre>
</blockquote>
<p>我们看到这里直接通过new 的方式, 创建了一个PooledByteBufAllocator 对象， 也就是基于申请一块连续内存进行缓冲区分配的缓存区分配器, 回到NioByteUnsafe 的 read()  方法中：</p>
<pre class=" language-java"><code class="language-java">   <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ChannelConfig config <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ChannelPipeline pipeline <span class="token operator">=</span> <span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ByteBufAllocator allocator <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> RecvByteBufAllocator<span class="token punctuation">.</span>Handle allocHandle <span class="token operator">=</span> <span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            allocHandle<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

            ByteBuf byteBuf <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> close <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">do</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    byteBuf <span class="token operator">=</span> allocHandle<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    allocHandle<span class="token punctuation">.</span><span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token function">doReadBytes</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>allocHandle<span class="token punctuation">.</span><span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// nothing was read. release the buffer.</span>
                        byteBuf<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        byteBuf <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        close <span class="token operator">=</span> allocHandle<span class="token punctuation">.</span><span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                    allocHandle<span class="token punctuation">.</span><span class="token function">incMessagesRead</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    readPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    byteBuf <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>allocHandle<span class="token punctuation">.</span><span class="token function">continueReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                allocHandle<span class="token punctuation">.</span><span class="token function">readComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pipeline<span class="token punctuation">.</span><span class="token function">fireChannelReadComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>close<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">closeOnRead</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">handleReadException</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> byteBuf<span class="token punctuation">,</span> t<span class="token punctuation">,</span> close<span class="token punctuation">,</span> allocHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">finally</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Check if there is a readPending which was not processed yet.</span>
                <span class="token comment" spellcheck="true">// This could be for two reasons:</span>
                <span class="token comment" spellcheck="true">// * The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method</span>
                <span class="token comment" spellcheck="true">// * The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...) method</span>
                <span class="token comment" spellcheck="true">//</span>
                <span class="token comment" spellcheck="true">// See https://github.com/netty/netty/issues/2254</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>readPending <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>config<span class="token punctuation">.</span><span class="token function">isAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">removeReadOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里ByteBufAllocator allocator = config.getAllocator()中的 allocator , 就是 PooledByteBufAllocator。<br>final RecvByteBufAllocator.Handle allocHandle = recvBufAllocHandle() 是创建一个 handle,handle是对RecvByteBufAllocator 进行实际操作的对象, 我们跟进recvBufAllocHandle：</p>
<pre class=" language-java"><code class="language-java"> <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> RecvByteBufAllocator<span class="token punctuation">.</span>Handle <span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>recvHandle <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                recvHandle <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRecvByteBufAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> recvHandle<span class="token punctuation">;</span>
        
</code></pre>
<p>这里是我们之前剖析过的逻辑, 如果不存在, 则创建handle 的实例. 同样, <code>allocHandle.reset(config)</code> 是将配置重置, 重置完配置后, 进行 <code>do-while</code>     循环, 有关循环终止条件 <code>allocHandle.continueReading()</code>. 在  <code>do-while </code> 循环中, 首先看 <code>byteBuf = allocHandle.allocate(allocator)</code> 这一步, 这里传入了刚才创建的allocate 对象 , 也就是PooledByteBufAllocator，这里会进入 DefaultMaxMessagesRecvByteBufAllocator 类的 allocate()方法中：</p>
<pre class=" language-java"><code class="language-java">   <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> ByteBuf <span class="token function">allocate</span><span class="token punctuation">(</span>ByteBufAllocator alloc<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> alloc<span class="token punctuation">.</span><span class="token function">ioBuffer</span><span class="token punctuation">(</span><span class="token function">guess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里的guess() 方法, 会调用AdaptiveRecvByteBufAllocator 的 guess()  方法：</p>
<pre class=" language-java"><code class="language-java">  <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">guess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> nextReceiveBufferSize<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里会返回AdaptiveRecvByteBufAllocator 的成员变量nextReceiveBufferSize, 也就是下次所分配的缓冲区的大小,第一个分配的时候u也会分配初始大小, 也就是1024字节, 这样, alloc.ioBuffer(guess())  就会分配一个PooledByteBuf，我们跟到AbstractByteBufAllocator 的 ioBuffer 方法中：</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">public</span> ByteBuf <span class="token function">ioBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>PlatformDependent<span class="token punctuation">.</span><span class="token function">hasUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">directBuffer</span><span class="token punctuation">(</span>DEFAULT_INITIAL_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">heapBuffer</span><span class="token punctuation">(</span>DEFAULT_INITIAL_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里首先判断是否能够获取jdk 的unsafe 对象, 默认为true, 所以会走到directBuffer(initialCapacity) 中, 这里最终会分配一个 PooledUnsafeDirectByteBuf 对象 , 回到NioByteUnsafe 的read(） 方法中, 分配完了ByteBuf 之后, 再看这一步 allocHandle.lastBytesRead(doReadBytes(byteBuf))。</p>
<p>首先看参数doReadBytes(byteBuf)方法, 这步是将channel 中的数据读取到我们刚分配到了ByteBuf 中, 并返回读取到的字节数, 这里会调用NioSocketChannel 的 doReadBytes()方法：</p>
<pre class=" language-java"><code class="language-java">  <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">doReadBytes</span><span class="token punctuation">(</span>ByteBuf byteBuf<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> RecvByteBufAllocator<span class="token punctuation">.</span>Handle allocHandle <span class="token operator">=</span> <span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        allocHandle<span class="token punctuation">.</span><span class="token function">attemptedBytesRead</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">.</span><span class="token function">writableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> byteBuf<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span><span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allocHandle<span class="token punctuation">.</span><span class="token function">attemptedBytesRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>首先拿到绑定在channel 中的handle, 因为我们已经创建了handle,所以这里会直接拿到, 再看allocHandle.attemptedBytesRead(byteBuf.writableBytes()) 这步, , byteBuf.writableBytes()  返回的是ByteBuf 可写的字节数, 也就是最多能从channel 中读取多少字节写到ByteBuf,  allocate 的 attemptedBytesRead 会把可写字节数设置到<br>DefaultMaxMessagesRecvByteBufAllocator 类 的 attemptedBytesRead 属 性 中 ， 跟 到<br>DefaultMaxMessagesRecvByteBufAllocator 中的 attemptedBytesRead 我们会看到：</p>
<pre class=" language-java"><code class="language-java">  <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">attemptedBytesRead</span><span class="token punctuation">(</span><span class="token keyword">int</span> bytes<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            attemptedBytesRead <span class="token operator">=</span> bytes<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>继续看doReadBytes()  方法, 往下看到最后, 通过<code>byteBuf.writeBytes(javaChannel(), allocHandle.attemptedBytesRead())</code>  将JDK 底层的channel 数据写入到我们创建的ByteBuf 中, 并返回实际写入的字节数.  回到 NioByteUnsafe 的 read() 方法中继续看<code>allocHandle.lastBytesRead(doReadBytes(byteBuf))</code>  这一步, 刚才我们剖析过 <code>doReadBytes(byteBuf)</code>  返回的是刚才写入的ByteBuf 的字节数, 再看 lastBytesRead()   方法, 跟到DefaultMaxMessagesRecvByteBufAllocator 的lastBytesRead()   方法中:</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token keyword">int</span> bytes<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            lastBytesRead <span class="token operator">=</span> bytes<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Ignore if bytes is negative, the interface contract states it will be detected externally after call.</span>
            <span class="token comment" spellcheck="true">// The value may be "invalid" after this point, but it doesn't matter because reading will be stopped.</span>
            totalBytesRead <span class="token operator">+=</span> bytes<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>totalBytesRead <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                totalBytesRead <span class="token operator">=</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里会赋值两个属性, lastBytesRead 代表最后读取的字节数, 这里赋值为我们刚才写入ByteBuf 的字节数, totalBytesRead 代表总共读取的字节数, 这里将写入的字节数相加。继续来到 NioByteUnsafe 的read(） 方法, 如果最后一次性读取数据为0, 说明已经将channel 中的数据全部读取完毕, 将新创建的ByteBuf 释放循环使用, 并跳出循环, <code>allocHandle.incMessagesRead(1);</code> 这步是增加消息的读取次数, 因为我们这里循环最多16次, 所以当消息增加次数增加到16 会结束循环。 读取完毕后, 会通过<code>pipeline.fireChannelReadComplete()</code>   将传入 channelRead 事件.</p>
<p>至此, 小伙伴应该有个疑问, 如果一次读取不完, 就传递channelRead 事件. 那么server 接受到的数据就有可能不是完整的, 其实关于这点, Netty 也做了相应的处理, 循环结束后, 会执行到<code>allocHandle.readComplete();</code>   这一步.</p>
<p>其实我们知道第一次分配ByteBuf 的初始容量是1024, 但是初始容量不一定一定满足所有的业务场景, netty 中, 将每次读取数据的字节数进行记录, 然后之后分配ByteBuf 的时候, 容量会尽可能的符合业务场景所需要的大小, 具体实现方式在 allocHandle.readComplete(）这一步体现的,  我们跟到 AdaptiveRecvByteBufAllocator 的 readComplete()  方法中:</p>
<pre class=" language-java"><code class="language-java">  <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">record</span><span class="token punctuation">(</span><span class="token function">totalBytesRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这里调用了record()  方法, 并传入了这一次所读取的字节总数, 跟到record() 方法:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">record</span><span class="token punctuation">(</span><span class="token keyword">int</span> actualReadBytes<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>actualReadBytes <span class="token operator">&lt;=</span> SIZE_TABLE<span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index <span class="token operator">-</span> INDEX_DECREMENT <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>decreaseNow<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    index <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>index <span class="token operator">-</span> INDEX_DECREMENT<span class="token punctuation">,</span> minIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    nextReceiveBufferSize <span class="token operator">=</span> SIZE_TABLE<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    decreaseNow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    decreaseNow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>actualReadBytes <span class="token operator">>=</span> nextReceiveBufferSize<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                index <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>index <span class="token operator">+</span> INDEX_INCREMENT<span class="token punctuation">,</span> maxIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                nextReceiveBufferSize <span class="token operator">=</span> SIZE_TABLE<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
                decreaseNow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>首先看判断条件 <code>if (actualReadBytes &lt;= SIZE_TABLE[Math.max(0, index - INDEX_DECREMENT - 1)]) </code> . 这里index 是当前分配的缓存区大小所在的SIZE_TABLE 的索引, 将这个索引进行缩进, 然后根据缩进后的索引找出 SIZE_TABLE 所存储的内存值, 再判断是否大于等于这次读取的最大字节数， 如果条件成立, 说明分配的内存过大, 需要缩容操作, 我们看if 块中缩容相关的逻辑, 首先 <code>if (decreaseNow)</code>   会判断是否立即进行收缩操作, 通常第一次不会进行收缩操作, 然后会将 decreaseNow 设置为true, 代表下一次直接进行收缩操作, 假设需要立即进行收缩操作,我们看收缩操作的相关逻辑。</p>
<p><code> index = Math.max(index - INDEX_DECREMENT, minIndex);</code> 这一步将索引缩进一步, 但不能小于最小索引值, 然后通过<code>nextReceiveBufferSize = SIZE_TABLE[index]</code> 获取设置索引之后的内存, 赋值在nextReceiveBufferSize , 也就是下次需要分配的大小, 下次就会根据这个大小分配ByteBuf了, 这样就实现了缩容操作.</p>
<p>再看 <code>else if (actualReadBytes &gt;= nextReceiveBufferSize)</code> 这里判断这次读取字节的总量比上次分配的大小还要大, 则进行扩容操作. 扩容操作也非常简单, 索引步进 , 然后拿到步进后的索引锁对应的内存值, 作为下次所需要的分配的大小在NioByteUnsafe 的 read()  方法， 经过了缩容或者扩容操作后， 通过pipeline.fireChannelReadComplete()传播<br>ChannelReadComplete()事件 , 以上就是读取客户端消息的相关流程.</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">luyanan</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://rainsoil.github.io/2022/01/04/netty/netty-nei-cun-fen-pei-bytebuf-12.2/">https://rainsoil.github.io/2022/01/04/netty/netty-nei-cun-fen-pei-bytebuf-12.2/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">luyanan</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/01/04/docker/docker-zhi-wang-luo-pian-3/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/13.jpg" class="responsive-img" alt="Docker之网络篇(3)">
                        
                        <span class="card-title">Docker之网络篇(3)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-01-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Docker/" class="post-category">
                                    Docker
                                </a>
                            
                            <a href="/categories/Docker/Docker/" class="post-category">
                                    Docker
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/01/04/netty/java-io-yan-jin-zhi-lu-1/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/15.jpg" class="responsive-img" alt="Java IO   演进之路(1)">
                        
                        <span class="card-title">Java IO   演进之路(1)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-01-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Netty/" class="post-category">
                                    Netty
                                </a>
                            
                            <a href="/categories/Netty/Netty/" class="post-category">
                                    Netty
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <a href="/about" target="_blank">luyanan</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">803.3k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/rainsoil" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:luyanan0718@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=914596513" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 914596513" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
