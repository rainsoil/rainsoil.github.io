<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Mybatis 编程式开发(1), railsoil">
    <meta name="description" content="
1. Mybatis 编程式开发
编程式使用&amp;nbsp;&amp;nbsp;&amp;nbsp;大部分时候，我们都是在 Spring 里面去集成 MyBatis。因为 Spring 对 MyBatis 的一些操作进行的封装，我们不能直接看到它的本质，所以">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Mybatis 编程式开发(1) | railsoil</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="railsoil" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">railsoil</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">railsoil</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/2.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Mybatis 编程式开发(1)</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/mybatis/" class="post-category">
                                mybatis
                            </a>
                        
                            <a href="/categories/mybatis/mybatis/" class="post-category">
                                mybatis
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-01-04
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    8.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    32 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <hr>
<h1 id="1-Mybatis-编程式开发"><a href="#1-Mybatis-编程式开发" class="headerlink" title="1. Mybatis 编程式开发"></a>1. Mybatis 编程式开发</h1><hr>
<h3 id="编程式使用"><a href="#编程式使用" class="headerlink" title="编程式使用"></a>编程式使用</h3><p>&nbsp;&nbsp;&nbsp;大部分时候，我们都是在 Spring 里面去集成 MyBatis。因为 Spring 对 MyBatis 的<br>一些操作进行的封装，我们不能直接看到它的本质，所以先看下不使用容器的时候，也<br>就是编程的方式，MyBatis 怎么使用。</p>
<p>&nbsp;&nbsp;先引入 mybatis jar 包。<br>&nbsp;&nbsp;&nbsp;&nbsp;首先我们要创建一个全局配置文件，这里面是对 MyBatis 的核心行为的控制，比如<br>mybatis-config.xml。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;第二个就是我们的映射器文件，Mapper.xml，通常来说一张表对应一个，我们会在<br>这个里面配置我们增删改查的 SQL 语句，以及参数和返回的结果集的映射关系。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;跟 JDBC 的代码一样，我们要执行对数据库的操作，必须创建一个会话，这个在<br>MyBatis 里面就是 SqlSession。SqlSession 又是工厂类根据全局配置文件创建的。所以<br>整个的流程就是这样的（如下代码）。最后我们通过 SqlSession 接口上的方法，传入我<br>们的 Statement ID 来执行 SQL。这是第一种方式。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;这种方式有一个明显的缺点，就是会对 Statement ID 硬编码，而且不能在编译时进<br>行类型检查，所以通常我们会使用第二种方式，就是定义一个 Mapper 接口的方式。这<br>个接口全路径必须跟 Mapper.xml 里面的 namespace 对应起来，方法也要跟 Statement<br>ID 一一对应。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
String resource <span class="token operator">=</span> <span class="token string">"mybatis-config.xml"</span><span class="token punctuation">;</span>
InputStream inputStream <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
SqlSessionFactory sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span>
<span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
SqlSession session <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
BlogMapper mapper <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span>BlogMapper<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Blog blog <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectBlogById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">finally</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这个就是我们单独使用 MyBatis 的全部流程。</p>
<p>这个案例非常重要，后面我们讲源码还是基于它。</p>
<h4 id="核心对象的生命周期"><a href="#核心对象的生命周期" class="headerlink" title="核心对象的生命周期"></a>核心对象的生命周期</h4><p>&nbsp;&nbsp;在编程式使用的这个 demo 里面，我们看到了 MyBatis 里面的几个核心对象：<br>SqlSessionFactoryBuiler、SqlSessionFactory、SqlSession 和 Mapper 对象。这几个<br>核心对象在 MyBatis 的整个工作流程里面的不同环节发挥作用。如果说我们不用容器，自己去管理这些对象的话，我们必须思考一个问题：什么时候创建和销毁这些对象？</p>
<p>在一些分布式的应用里面，多线程高并发的场景中，如果要写出高效的代码，必须<br>了解这四个对象的生命周期。这四个对象的声明周期的描述在官网上面也可以找到。</p>
<p><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/getting-started.html">http://www.mybatis.org/mybatis-3/zh/getting-started.html</a></p>
<p>我们从每个对象的作用的角度来理解一下，只有理解了它们是干什么的，才知道什<br>么时候应该创建，什么时候应该销毁。</p>
<h5 id="1）SqlSessionFactoryBuiler"><a href="#1）SqlSessionFactoryBuiler" class="headerlink" title="1）SqlSessionFactoryBuiler"></a>1）SqlSessionFactoryBuiler</h5><p>首 先 是 SqlSessionFactoryBuiler 。 它 是 用 来 构 建 SqlSessionFactory 的 ， 而<br>SqlSessionFactory 只需要一个，所以只要构建了这一个 SqlSessionFactory，它的使命<br>就完成了，也就没有存在的意义了。所以它的生命周期只存在于==方法的局部==。</p>
<h5 id="2）SqlSessionFactory"><a href="#2）SqlSessionFactory" class="headerlink" title="2）SqlSessionFactory"></a>2）SqlSessionFactory</h5><p>SqlSessionFactory 是用来创建 SqlSession 的，每次应用程序访问数据库，都需要<br>创建一个会话。因为我们一直有创建会话的需要，所以 SqlSessionFactory 应该存在于<br>应用的整个生命周期中（==作用域是应用作用域==）。创建 SqlSession 只需要一个实例来做<br>这件事就行了，否则会产生很多的混乱，和浪费资源。所以我们要采用单例模式</p>
<h5 id="3）SqlSession"><a href="#3）SqlSession" class="headerlink" title="3）SqlSession"></a>3）SqlSession</h5><p>SqlSession 是一个会话，因为它不是线程安全的，不能在线程间共享。所以我们在<br>请求开始的时候创建一个 SqlSession 对象，在请求结束或者说方法执行完毕的时候要及<br>时关闭它（==一次请求或者操作中==）。</p>
<h5 id="4）Mapper"><a href="#4）Mapper" class="headerlink" title="4）Mapper"></a>4）Mapper</h5><p>Mapper（实际上是一个代理对象）是从 SqlSession 中获取的。</p>
<pre class=" language-java"><code class="language-java">BlogMapper mapper <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span>BlogMapper<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>它的作用是发送 SQL 来操作数据库的数据。它应该在一个 SqlSession 事务方法之<br>内。</p>
<p>最后总结如下：</p>
<table>
<thead>
<tr>
<th>对象</th>
<th>生命周期</th>
</tr>
</thead>
<tbody><tr>
<td>SqlSessionFactoryBuiler</td>
<td>方法局部（method）</td>
</tr>
<tr>
<td>SqlSessionFactory（单例）</td>
<td>应用级别（application）</td>
</tr>
<tr>
<td>SqlSession</td>
<td>请求和操作（request/method）</td>
</tr>
<tr>
<td>Mapper</td>
<td>方法（method）</td>
</tr>
<tr>
<td>这个就是我们在编程式的使用里面看到的四个对象的生命周期的总结。</td>
<td></td>
</tr>
</tbody></table>
<h4 id="核心配置解读"><a href="#核心配置解读" class="headerlink" title="核心配置解读"></a>核心配置解读</h4><p>第一个是 config 文件。大部分时候我们只需要很少的配置就可以让 MyBatis 运行起<br>来。其实 MyBatis 里面提供的配置项非常多，我们没有配置的时候使用的是系统的默认<br>值。<br>mybatis-3 的 源 码 托 管 在 github 上 。 源 码 地 址<br><a target="_blank" rel="noopener" href="https://github.com/mybatis/mybatis-3/releases">https://github.com/mybatis/mybatis-3/releases</a></p>
<p>目前最新的版本是 3.5.1，大家可以从官方上下载到最新的源码。</p>
<p>第一个是 jar 包和文档。第二个第三个是源码。</p>
<p>在这个压缩包里面，解压出来有一个 mybatis-3.5.1.pdf，是英文版本的。如果阅读<br>英文困难，可以基于 3.5.1 的中文版本学习<br><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/index.html">http://www.mybatis.org/mybatis-3/zh/index.html</a></p>
<h5 id="一级标签"><a href="#一级标签" class="headerlink" title="一级标签"></a>一级标签</h5><h6 id="configuration"><a href="#configuration" class="headerlink" title="configuration"></a>configuration</h6><p>configuration 是整个配置文件的根标签，实际上也对应着 MyBatis 里面最重要的<br>配置类 Configuration。它贯穿 MyBatis 执行流程的每一个环节。我们打开这个类看一<br>下，这里面有很多的属性，跟其他的子标签也能对应上。</p>
<p>注意：MyBatis 全局配置文件顺序是固定的，否则启动的时候会报错。</p>
<h6 id="properties"><a href="#properties" class="headerlink" title="properties"></a>properties</h6><p>第一个是 properties 标签，用来配置参数信息，比如最常见的数据库连接信息。</p>
<p>为了避免直接把参数写死在 xml 配置文件中，我们可以把这些参数单独放在<br>properties 文件中，用 properties 标签引入进来，然后在 xml 配置文件中用${}引用就<br>可以了。</p>
<p>可以用 resource 引用应用里面的相对路径，也可以用 url 指定本地服务器或者网络的绝对路径。</p>
<p>我们为什么要把这些配置独立出来？有什么好处？或者说，公司的项目在打包的时<br>候，有没有把 properties 文件打包进去？</p>
<ol>
<li> 提取，利于多处引用，维护简单；</li>
<li> 把配置文件放在外部，避免修改后重新编译打包，只需要重启应用；</li>
<li> 程序和配置分离，提升数据的安全性，比如生产环境的密码只有运维人员掌握。<h6 id="settings"><a href="#settings" class="headerlink" title="settings"></a>settings</h6>setttings 里面是 MyBatis 的一些核心配置，我们最后再看，先看下其他的以及标签。<h6 id="typeAliases"><a href="#typeAliases" class="headerlink" title="typeAliases"></a>typeAliases</h6>TypeAlias 是类型的别名，跟 Linux 系统里面的 alias 一样，主要用来简化全路径类<br>名的拼写。比如我们的参数类型和返回值类型都可能会用到我们的 Bean，如果每个地方<br>都配置全路径的话，那么内容就比较多，还可能会写错。</li>
</ol>
<p>我们可以为自己的 Bean 创建别名，既可以指定单个类，也可以指定一个 package，<br>自动转换。配置了别名以后，只需要写别名就可以了，比如 com.domain.Blog<br>都只要写 blog 就可以了。</p>
<p>MyBatis 里面有系统预先定义好的类型别名，在 TypeAliasRegistry 中。</p>
<h6 id="typeHandlers【重点】"><a href="#typeHandlers【重点】" class="headerlink" title="typeHandlers【重点】"></a>typeHandlers【重点】</h6><p>由于 Java 类型和数据库的 JDBC 类型不是一一对应的（比如 String 与 varchar），<br>所以我们把 Java 对象转换为数据库的值，和把数据库的值转换成 Java 对象，需要经过<br>一定的转换，这两个方向的转换就要用到 TypeHandler。</p>
<p>有的同学可能会有疑问，我没有做任何的配置，为什么实体类对象里面的一个 String<br>属性，可以保存成数据库里面的 varchar 字段，或者保存成 char 字段？</p>
<p>这是因为 MyBatis 已经内置了很多 TypeHandler（在 type 包下），它们全部全部<br>注册在 TypeHandlerRegistry 中，他们都继承了抽象类 BaseTypeHandler，泛型就是要处理的 Java 数据类型。</p>
<p>当我们做数据类型转换的时候，就会自动调用对应的 TypeHandler 的方法。</p>
<p>如果我们需要自定义一些类型转换规则，或者要在处理类型的时候做一些特殊的动<br>作，就可以编写自己的 TypeHandler，跟系统自定义的 TypeHandler 一样，继承抽象类<br>BaseTypeHandler<T>。有 4 个抽象方法必须实现，我们把它分成两类：</p>
<p>set 方法从 Java 类型转换成 JDBC 类型的，get 方法是从 JDBC 类型转换成 Java 类<br>型的。<br>| 从java类型到JDBC类型             | 从JDBC类型到JAVA类型                                         |<br>| ——————————– | ———————————————————— |<br>| setNonNullParameter:设置非空参数 | getNullableResult：获取空结果集（根据列名），一般都是调用这个getNullableResult：获取空结果集（根据下标值）getNullableResult：存储过程用的 |</p>
<p>比如我们想要在获取或者设置 String 类型的时候做一些特殊处理，我们可以写一个<br>String 类型的 TypeHandler</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTypeHandler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseTypeHandler</span><span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNonNullParameter</span><span class="token punctuation">(</span>PreparedStatement ps<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> String parameter<span class="token punctuation">,</span>
JdbcType jdbcType<span class="token punctuation">)</span>
<span class="token keyword">throws</span> SQLException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 设置 String 类型的参数的时候调用，Java 类型到 JDBC 类型</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"---------------setNonNullParameter1："</span><span class="token operator">+</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
ps<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> String <span class="token function">getNullableResult</span><span class="token punctuation">(</span>ResultSet rs<span class="token punctuation">,</span> String columnName<span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 根据列名获取 String 类型的参数的时候调用，JDBC 类型到 java 类型</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"---------------getNullableResult1："</span><span class="token operator">+</span>columnName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>columnName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 后面两个方法省略…………</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>第二步，在 mybatis-config.xml 文件中注册：</p>
<pre class=" language-java"><code class="language-java"><span class="token operator">&lt;</span>typeHandlers<span class="token operator">></span>
<span class="token operator">&lt;</span>typeHandler handler<span class="token operator">=</span><span class="token string">"com.type.MyTypeHandler"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>typeHandler<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>typeHandlers<span class="token operator">></span>
</code></pre>
<p>第三步，在我们需要使用的字段上指定，比如：<br>插入值的时候，从 Java 类型到 JDBC 类型，在字段属性中指定 typehandler：</p>
<pre class=" language-java"><code class="language-java"><span class="token operator">&lt;</span>insert id<span class="token operator">=</span><span class="token string">"insertBlog"</span> parameterType<span class="token operator">=</span><span class="token string">"com.domain.Blog"</span><span class="token operator">></span>
insert into <span class="token function">blog</span> <span class="token punctuation">(</span>bid<span class="token punctuation">,</span> name<span class="token punctuation">,</span> author_id<span class="token punctuation">)</span>
<span class="token function">values</span> <span class="token punctuation">(</span>#<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>bid<span class="token punctuation">,</span>jdbcType<span class="token operator">=</span>INTEGER<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>
#<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>name<span class="token punctuation">,</span>jdbcType<span class="token operator">=</span>VARCHAR<span class="token punctuation">,</span>typeHandler<span class="token operator">=</span>com<span class="token punctuation">.</span>type<span class="token punctuation">.</span>MyTypeHandler<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>
#<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>authorId<span class="token punctuation">,</span>jdbcType<span class="token operator">=</span>INTEGER<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>insert<span class="token operator">></span>
</code></pre>
<p>返回值的时候，从 JDBC 类型到 Java 类型，在 resultMap 的列上指定 typehandler：</p>
<pre class=" language-java"><code class="language-java"><span class="token operator">&lt;</span>result column<span class="token operator">=</span><span class="token string">"name"</span> property<span class="token operator">=</span><span class="token string">"name"</span> jdbcType<span class="token operator">=</span><span class="token string">"VARCHAR"</span>
typeHandler<span class="token operator">=</span><span class="token string">"com.type.MyTypeHandler"</span><span class="token operator">/</span><span class="token operator">></span>
</code></pre>
<h6 id="objectFactory【重点】"><a href="#objectFactory【重点】" class="headerlink" title="objectFactory【重点】"></a>objectFactory【重点】</h6><p>当我们把数据库返回的结果集转换为实体类的时候，需要创建对象的实例，由于我<br>们不知道需要处理的类型是什么，有哪些属性，所以不能用 new 的方式去创建。在<br>MyBatis 里面，它提供了一个工厂类的接口，叫做 ObjectFactory，专门用来创建对象的<br>实例，里面定义了 4 个方法。<br>| 方法                                                         | 作用                           |<br>| ———————————————————— | —————————— |<br>| void setProperties(Properties properties);                   | 设置参数时调用                 |<br>| <T> T create(Class<T> type);                                 | 创建对象（调用无参构造函数）   |<br>| <T> T create(Class<T> type, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List<Object>constructorArgs); | 创建对象（调用带参数构造函数） |<br>| <T> boolean isCollection(Class<T> type)                      | 判断是否集合                   |</p>
<p>ObjectFactory 有一个默认的实现类 DefaultObjectFactory，创建对象的方法最终<br>都调用了 instantiateClass()，是通过反射来实现的。</p>
<p>如果想要修改对象工厂在初始化实体类的时候的行为，就可以通过创建自己的对象<br>工厂，继承 DefaultObjectFactory 来实现（不需要再实现 ObjectFactory 接口）。</p>
<p>例如：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyObjectFactory</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultObjectFactory</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> Object <span class="token function">create</span><span class="token punctuation">(</span>Class <span class="token class-name">type</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>Blog<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
Blog blog <span class="token operator">=</span> <span class="token punctuation">(</span>Blog<span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
blog<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"by object factory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
blog<span class="token punctuation">.</span><span class="token function">setBid</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
blog<span class="token punctuation">.</span><span class="token function">setAuthorId</span><span class="token punctuation">(</span><span class="token number">2222</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> blog<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
Object result <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>我们可以直接用自定义的工厂类来创建对象</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObjectFactoryTest</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
MyObjectFactory factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyObjectFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Blog myBlog <span class="token operator">=</span> <span class="token punctuation">(</span>Blog<span class="token punctuation">)</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>Blog<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>myBlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这样我们就直接拿到了一个对象<br>如果在 config 文件里面注册，在创建对象的时候会被自动调用：<br>如果在 config 文件里面注册，在创建对象的时候会被自动调用：</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>objectFactory</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.mybatis.example.MyObjectFactory<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token comment" spellcheck="true">&lt;!-- 对象工厂注入的参数 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>666<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>objectFactory</span><span class="token punctuation">></span></span>
</code></pre>
<p>这样，就可以让 MyBatis 的创建实体类的时候使用我们自己的对象工厂。</p>
<h6 id="plugins"><a href="#plugins" class="headerlink" title="plugins"></a>plugins</h6><p>插件是 MyBatis 的一个很强大的机制，跟很多其他的框架一样，MyBatis 预留了插<br>件的接口，让 MyBatis 更容易扩展。</p>
<p>根据官方的定义，插件可以拦截这四个对象的这些方法，我们把这四个对象称作<br>MyBatis 的四大对象。我们会在带大家阅读源码，知道了这 4 大对象的作用之后，再来<br>分析自定义插件的开发和插件运行的原理。<br><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/configuration.html#plugins">http://www.mybatis.org/mybatis-3/zh/configuration.html#plugins</a></p>
<table>
<thead>
<tr>
<th>类（或接口）</th>
<th>方法</th>
</tr>
</thead>
<tbody><tr>
<td>Executor</td>
<td>update, query, flushStatements, commit, rollback, getTransaction, close, isClosed</td>
</tr>
<tr>
<td>ParameterHandler</td>
<td>getParameterObject, setParameters</td>
</tr>
</tbody></table>
<p>ResultSetHandler| handleResultSets, handleOutputParameters<br>StatementHandler |prepare, parameterize, batch, update, query</p>
<h6 id="environments、environment"><a href="#environments、environment" class="headerlink" title="environments、environment"></a>environments、environment</h6><p>environments 标签用来管理数据库的环境，比如我们可以有开发环境、测试环境、<br>生产环境的数据库。可以在不同的环境中使用不同的数据库地址或者类型。</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environments</span> <span class="token attr-name">default</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>development<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environment</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>development<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transactionManager</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>JDBC<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataSource</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>POOLED<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>driver<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.mysql.jdbc.Driver<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span>
<span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jdbc:mysql://127.0.0.1:3306/-mybatis?useUnicode<span class="token punctuation">=</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataSource</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environment</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environments</span><span class="token punctuation">></span></span>
</code></pre>
<p>一个 environment 标签就是一个数据源，代表一个数据库。这里面有两个关键的标<br>签，一个是事务管理器，一个是数据源。</p>
<h6 id="transactionManager"><a href="#transactionManager" class="headerlink" title="transactionManager"></a>transactionManager</h6><p>如果配置的是 JDBC，则会使用 Connection 对象的 commit()、rollback()、close()管理事务</p>
<p>如果配置成 MANAGED，会把事务交给容器来管理，比如 JBOSS，Weblogic。因<br>为我们跑的是本地程序，如果配置成 MANAGE 不会有任何事务。</p>
<p>如 果 是 Spring + MyBatis ， 则 没 有 必 要 配 置 ， 因 为 我 们 会 直 接 在<br>applicationContext.xml 里面配置数据源，覆盖 MyBatis 的配置。</p>
<h6 id="dataSource"><a href="#dataSource" class="headerlink" title="dataSource"></a>dataSource</h6><p>将在下一节（settings）详细分析。在跟 Spring 集成的时候，事务和数据源都会交<br>给 Spring 来管理。</p>
<h6 id="mappers"><a href="#mappers" class="headerlink" title="mappers"></a>mappers</h6><p><mappers>标签配置的是我们的映射器，也就是 Mapper.xml 的路径。这里配置的<br>目的是让 MyBatis 在启动的时候去扫描这些映射器，创建映射关系。</p>
<p>我们有四种指定 Mapper 文件的方式：</p>
<p><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/configuration.html#mappers">http://www.mybatis.org/mybatis-3/zh/configuration.html#mappers</a></p>
<ol>
<li>使用相对于类路径的资源引用（resource）</li>
<li>使用完全限定资源定位符（绝对路径）（URL）</li>
<li>使用映射器接口实现类的完全限定类名</li>
<li>将包内的映射器接口实现全部注册为映射器（最常用）</li>
</ol>
<h6 id="settings-1"><a href="#settings-1" class="headerlink" title="settings"></a>settings</h6><p>最后 settings 我们来单独说一下，因为 MyBatis 的一些最关键的配置都在这个标签<br>里面（只讲解一些主要的）。</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>含义</th>
<th>简介</th>
<th>有效值</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>cacheEnabled</td>
<td>是否使用缓存</td>
<td>是整个工程中所有映射器配置缓存的开关，即是一个全局缓存开关</td>
<td>true/false</td>
<td>true</td>
</tr>
<tr>
<td>lazyLoadingEnabled</td>
<td>是否开启延迟加载</td>
<td>控制全局是否使用延迟加载（association、collection）。当有特殊关联关系需要单独配置时，可以使用 fetchType 属性来覆盖此配置</td>
<td>true/false</td>
<td>false</td>
</tr>
<tr>
<td>aggressiveLazyLoading</td>
<td>是否需要侵入式延迟加载</td>
<td>开启时，无论调用什么方法加载某个对象，都会加载该对象的所有属性，关闭之后只会按需加载</td>
<td>true/false</td>
<td>false</td>
</tr>
<tr>
<td>defaultExecutorType</td>
<td>设置默认的执行器</td>
<td>有三种执行器：SIMPLE 为普通执行器；REUSE 执行器会重用与处理语句；BATCH 执行器将重用语句并执行批量更新</td>
<td>SIMPLE/REUSE/BATCH</td>
<td>SIMPLE</td>
</tr>
<tr>
<td>lazyLoadTriggerMethods</td>
<td>指定哪个对象的方法触发一次延迟加载</td>
<td>配置需要触发延迟加载的方法的名字，该方法就会触发一次延迟加载</td>
<td>一个逗号分隔的方法名称列表</td>
<td>equals，clone，hashCode，toString</td>
</tr>
<tr>
<td>localCacheScope</td>
<td>MyBatis 利用本地缓存机制（LocalCache）防止循环引用（circularreferences）和加速重复嵌套查询</td>
<td>默认值为 SESSION，这种情况下会缓存一个会话中执行的所有查询。若设置值为STATEMENT，本地会话仅用在语句执行上，对相同 SqlSession 的不同调用将不会共享数据</td>
<td>SESSION/STATEMEN T</td>
<td>SESSION</td>
</tr>
<tr>
<td>logImpl</td>
<td>日志实现</td>
<td>指定 MyBatis 所用日志的具体实现，未指定时将自动查找</td>
<td>SLF4J、LOG4J、LOG4J2、JDK_LOGGING、COMMONS_LOGGING、STDOUT_LOGGING、NO_LOGGING</td>
<td>无</td>
</tr>
<tr>
<td>multipleResultSetsEnabled</td>
<td>是否允许单一语句返回多结果集</td>
<td>即 Mapper 配置中一个单一的 SQL 配置是否能返回多个结果集</td>
<td>true/false</td>
<td>true</td>
</tr>
<tr>
<td>useColumnLabel</td>
<td>使用列标签代替列名</td>
<td>设置是否使用列标签代替列名</td>
<td>true/false</td>
<td>true</td>
</tr>
<tr>
<td>useGeneratedKeys</td>
<td>是否支持 JDBC 自动生成主键</td>
<td>设置之后，将会强制使用自动生成主键</td>
<td></td>
<td></td>
</tr>
<tr>
<td>的策略</td>
<td>true/false</td>
<td>false</td>
<td></td>
<td></td>
</tr>
<tr>
<td>autoMappingBehavior</td>
<td>指定 MyBatis 自动 映射字段或属性的方式</td>
<td>有三种方式，NONE时将取消自动映射；PARTIAL时只会自动映射没有定义结果集的结果映射；FULL 时会映射任意复杂的结果集</td>
<td>NONE/PARTIAL/FULL PARTIAL</td>
<td></td>
</tr>
<tr>
<td>autoMappingUnknownColumnBehavior</td>
<td>设置当自动映射时发现未知列的动作</td>
<td>有三种动作：NONE 时不做任何操作；WARNING 时会输出提醒日志；FAILING时会抛出 SqlSessionException 异常表示映射失败</td>
<td>NONE/WARNING/FAILING</td>
<td>NONE</td>
</tr>
<tr>
<td>defaultStatementTimeout</td>
<td>设置超时时间</td>
<td>该超时时间即数据库驱动连接数据库时，等待数据库回应的最大秒数</td>
<td>任意正整数</td>
<td>无</td>
</tr>
<tr>
<td>defaultFetchSize</td>
<td>设置驱动的结果集获取数量（fetchSize）的提示值</td>
<td>为了防止从数据库查询出来的结果过多，而导致内存溢出，可以通过设置fetchSize 参数来控制结果集的数量</td>
<td>任意正整数</td>
<td>无</td>
</tr>
<tr>
<td>safeRowBoundsEnabled</td>
<td>允许在嵌套语句中使用分页（RowBound，即行内嵌套语句）</td>
<td>如果允许在 SQL 的行内嵌套语句中使用分页，就设置该值为 false</td>
<td>true/false</td>
<td>false</td>
</tr>
<tr>
<td>safeResultHandlerEnabled</td>
<td>允许在嵌套语句中使用分页（ResultHandler，即结果集处理）</td>
<td>如果允许在 SQL 的结果集使用分页，就设置该值为 false</td>
<td>true/false</td>
<td>true</td>
</tr>
<tr>
<td>mapUnderscoreToCamelCase</td>
<td>是否开启驼峰命名规则（camel case）映射</td>
<td>表明数据库中的字段名称与工程中Java 实体类的映射是否采用驼峰命名规则校验</td>
<td>true/false</td>
<td>false</td>
</tr>
<tr>
<td>jdbcTypeForNull</td>
<td>JDBC类型的默认设置</td>
<td>当没有为参数提供特定的 JDBC 类型时，为空值指定 JDBC 类型。某些驱动需要指定列的 JDBC 类型，多数情况直接用一般类型即可，比如 NULL、VARCHAR 或 OTHER</td>
<td>常用 NULL、VARCHAR、OTHER</td>
<td>OTHER</td>
</tr>
<tr>
<td>defaultScriptingLanguage</td>
<td>动态 SQL 默认语言</td>
<td>指定动态 SQL 生成的默认语言</td>
<td>一个类型别名或者一个类的全路径名</td>
<td>org.apache.ibatis.scripting.xmltags.XMLLanguageDriver</td>
</tr>
<tr>
<td>callSettersOnNulls</td>
<td>是否在控制情况下调用 Set 方法</td>
<td>指定当结果集中值为 null 时是否调用映射对象的 sette（r map 对象时为 put）方法，这对于有 Map.keySet()依赖或null 值初始化时是有用的。注意基本类型是不能设置成 null 的</td>
<td>true/false</td>
<td>false</td>
</tr>
<tr>
<td>returnInstanceForEmptyRow</td>
<td>返回空实体集对象</td>
<td>当返回行的所有列都是空时，MyBatis默认返回 null。当开启这个设置时，MyBatis 会返回一个空实例。请注意，它也适用于嵌套的结果集（从MyBatis3.4.2 版本开始）</td>
<td>true/false</td>
<td>false</td>
</tr>
<tr>
<td>logPrefix</td>
<td>日志前缀</td>
<td>指定 MyBatis 所用日志的具体实现，未指定时将自动查找</td>
<td>任意字符串</td>
<td>无</td>
</tr>
<tr>
<td>vfsImpl</td>
<td>vfs 实现</td>
<td>指定 vfs 的实现</td>
<td>自定义 VFS 的实现的类的全限定名，以逗号分隔</td>
<td>无</td>
</tr>
<tr>
<td>useActualParamName</td>
<td>使用方法签名 允许使用方法签名中的名称作为语句参数名称。要使用该特性，工程必须采用 Java8 编译，并且加上-parameters选项（从 MyBatis3.4.1 版本开始）</td>
<td>自定义 VFS 的实现的类的全限定名，以逗号分隔</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>configurationFactory</td>
<td>配置工厂</td>
<td>指定提供配置示例的类。返回的配置实例用于加载反序列化的懒加载参数。这个类必须有一个签名的静态配置getconfiguration()方法（从MyBatis3.2.3 版本开始）</td>
<td>一个类型别名或者一个类型的全路径名</td>
<td>无</td>
</tr>
</tbody></table>
<h3 id="Mapper-xml-映射配置文件"><a href="#Mapper-xml-映射配置文件" class="headerlink" title="Mapper.xml 映射配置文件"></a>Mapper.xml 映射配置文件</h3><p><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/sqlmap-xml.html">http://www.mybatis.org/mybatis-3/zh/sqlmap-xml.html</a></p>
<p>&nbsp;&nbsp;映射器里面最主要的是配置了 SQL语句，也解决了我们的参数映射和结果集映射的问题。一共有 8 个标签:</p>
<ul>
<li>cache- 给定命名空间的缓存配置(是否开启二级缓存)</li>
<li>cache-ref-其他命名空间缓存配置的引用.</li>
<li>resultMap- 是最复杂也是最强大的元素,用来描述如何从数据库结果集中加载对象<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>BaseResultMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Employee<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>emp_id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>empId<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>emp_name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>empName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gender<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>CHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gender<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>d_id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dId<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span>
</code></pre>
</li>
<li>sql- 可被其他语句引用的可重用语句块<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sql</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Base_Column_List<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
emp_id, emp_name, gender, email, d_id
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sql</span><span class="token punctuation">></span></span>
</code></pre>
</li>
<li>增删改查标签:</li>
<li><ul>
<li>insert: 映射插入语句</li>
</ul>
</li>
<li><ul>
<li>update: 映射修改语句</li>
</ul>
</li>
<li><ul>
<li>delete: 映射删除语句</li>
</ul>
</li>
<li><ul>
<li>select: 映射查询语句<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><table>
<thead>
<tr>
<th>配置名称</th>
<th>配置含义</th>
<th>配置简介</th>
</tr>
</thead>
<tbody><tr>
<td>configuration</td>
<td>包裹所有的配置标签</td>
<td>整个配置文件的顶级标签</td>
</tr>
<tr>
<td>properties</td>
<td>属性</td>
<td>该标签可以引入外部配置的属性,也可以自己配置.该配置标签所在的同一个配置的其他配置均可以引用此配置的属性</td>
</tr>
<tr>
<td>setting</td>
<td>全局配置参数</td>
<td>用来配置一些改变运行时行为的信息,例如 是否使用缓存机制,是否使用延迟加载,是否使用错误处理机制等.</td>
</tr>
<tr>
<td>typeAliases</td>
<td>类型别名</td>
<td>用来设置一些别名来代码java的长类型声明(如java.lang.int变为int),减少配置编码的冗余</td>
</tr>
<tr>
<td>typeHandlers</td>
<td>类型处理器</td>
<td>将数据库获取的值以合适的方法转换为java类型,或者将java类型的参数转换为数据库对应的类型</td>
</tr>
<tr>
<td>objectFactory</td>
<td>对象工厂</td>
<td>实例化目标类的工厂类配置</td>
</tr>
<tr>
<td>plugins</td>
<td>插件</td>
<td>可以通过插件修改Mybatis的核心行为,例如对语句执行的某一点进行拦截调用.</td>
</tr>
<tr>
<td>environments</td>
<td>环境集合属性对象</td>
<td>数据库环境信息的集合,在同一个配置文件中,可以有多个数据库环境即可,这样可以使Mybatis将sql同时映射到多个数据库</td>
</tr>
<tr>
<td>environment</td>
<td>环境子属性对象</td>
<td>数据库环境配置的详细配置</td>
</tr>
<tr>
<td>transactionManager</td>
<td>事务管理</td>
<td>指定Mybatis的事务管理器</td>
</tr>
<tr>
<td>dataSource</td>
<td>数据源</td>
<td>使用其中的type指定数据源的链接类型,在标签对中可以使用property属性指定数据库连接池的其他信息</td>
</tr>
<tr>
<td>mappers</td>
<td>映射器</td>
<td>配置SQL映射文件的位置,告知Mybatis去哪里加载SQL映射文件</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
</ul>
<h4 id="Mybatis最佳实践"><a href="#Mybatis最佳实践" class="headerlink" title="Mybatis最佳实践"></a>Mybatis最佳实践</h4><h5 id="为什么需要动态sql？"><a href="#为什么需要动态sql？" class="headerlink" title="为什么需要动态sql？"></a>为什么需要动态sql？</h5><p>由于前台传入的查询参数不同,所以写了很多的if else,还需要非常注意SQL里面的and,空格,逗号和转义的单引号这些,拼接和调试SQL就是一件非常耗时的工作.<br> Mybatis的动态SQL就帮助我们解决了这个问题,他是基于OGNL表达式的</p>
<h5 id="动态标签有哪些"><a href="#动态标签有哪些" class="headerlink" title="动态标签有哪些?"></a>动态标签有哪些?</h5><p>按照官网的分类,Mybatis的动态标签主要有四类:if,choose(when,otherwise),trim(where,set),foreaach.</p>
<h6 id="if-需要判断的时候-条件写在test中"><a href="#if-需要判断的时候-条件写在test中" class="headerlink" title="if 需要判断的时候,条件写在test中"></a>if 需要判断的时候,条件写在test中</h6><p>以下语句可以用<where> 改写</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>selectDept<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>int<span class="token punctuation">"</span></span>
<span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.crud.bean.Department<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
select * from tbl_dept where 1=1
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>deptId !<span class="token punctuation">=</span> null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
and dept_id = #<span class="token entity" title="&#123;">&amp;#123;</span>deptId,jdbcType=INTEGER<span class="token entity" title="&#125;">&amp;#125;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>
</code></pre>
<h5 id="choose-when-otherwise-–需要选择一个条件的时候"><a href="#choose-when-otherwise-–需要选择一个条件的时候" class="headerlink" title="choose(when,otherwise) –需要选择一个条件的时候"></a>choose(when,otherwise) –需要选择一个条件的时候</h5><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>getEmpList_choose<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>empResultMap<span class="token punctuation">"</span></span>
<span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.crud.bean.Employee<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
SELECT * FROM tbl_emp e
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>where</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>choose</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>when</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>empId !<span class="token punctuation">=</span>null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
e.emp_id = #<span class="token entity" title="&#123;">&amp;#123;</span>emp_id, jdbcType=INTEGER<span class="token entity" title="&#125;">&amp;#125;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>when</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>when</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>empName !<span class="token punctuation">=</span> null and empName !<span class="token punctuation">=</span> <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
AND e.emp_name LIKE CONCAT(CONCAT('%', #<span class="token entity" title="&#123;">&amp;#123;</span>emp_name,
jdbcType=VARCHAR<span class="token entity" title="&#125;">&amp;#125;</span>),'%')
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>when</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>when</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email !<span class="token punctuation">=</span> null <span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
AND e.email = #<span class="token entity" title="&#123;">&amp;#123;</span>email, jdbcType=VARCHAR<span class="token entity" title="&#125;">&amp;#125;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>when</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>otherwise</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>otherwise</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>choose</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>where</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>
</code></pre>
<h6 id="trim-where-set-–需要去掉where-and-逗号之类的符号的时候"><a href="#trim-where-set-–需要去掉where-and-逗号之类的符号的时候" class="headerlink" title="trim(where,set)–需要去掉where,and,逗号之类的符号的时候"></a>trim(where,set)–需要去掉where,and,逗号之类的符号的时候</h6><p>主要最后一个条件 did多个一个逗号,就是用trim去掉的</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateByPrimaryKeySelective<span class="token punctuation">"</span></span>
<span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.crud.bean.Employee<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
update tbl_emp

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>set</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>empName !<span class="token punctuation">=</span> null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
emp_name = #<span class="token entity" title="&#123;">&amp;#123;</span>empName,jdbcType=VARCHAR<span class="token entity" title="&#125;">&amp;#125;</span>,
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gender !<span class="token punctuation">=</span> null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
gender = #<span class="token entity" title="&#123;">&amp;#123;</span>gender,jdbcType=CHAR<span class="token entity" title="&#125;">&amp;#125;</span>,
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email !<span class="token punctuation">=</span> null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
email = #<span class="token entity" title="&#123;">&amp;#123;</span>email,jdbcType=VARCHAR<span class="token entity" title="&#125;">&amp;#125;</span>,
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dId !<span class="token punctuation">=</span> null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
d_id = #<span class="token entity" title="&#123;">&amp;#123;</span>dId,jdbcType=INTEGER<span class="token entity" title="&#125;">&amp;#125;</span>,
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>set</span><span class="token punctuation">></span></span>
where emp_id = #<span class="token entity" title="&#123;">&amp;#123;</span>empId,jdbcType=INTEGER<span class="token entity" title="&#125;">&amp;#125;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">></span></span>
</code></pre>
<h6 id="trim用来指定或者去掉前缀或者后缀"><a href="#trim用来指定或者去掉前缀或者后缀" class="headerlink" title="trim用来指定或者去掉前缀或者后缀"></a>trim用来指定或者去掉前缀或者后缀</h6><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>insert</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>insertSelective<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.crud.bean.Employee<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
insert into tbl_emp
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trim</span> <span class="token attr-name">prefix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(<span class="token punctuation">"</span></span> <span class="token attr-name">suffix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>)<span class="token punctuation">"</span></span> <span class="token attr-name">suffixOverrides</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>,<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>empId !<span class="token punctuation">=</span> null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
emp_id,
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>empName !<span class="token punctuation">=</span> null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
emp_name,
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dId !<span class="token punctuation">=</span> null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
d_id,
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trim</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trim</span> <span class="token attr-name">prefix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>values (<span class="token punctuation">"</span></span> <span class="token attr-name">suffix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>)<span class="token punctuation">"</span></span> <span class="token attr-name">suffixOverrides</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>,<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>empId !<span class="token punctuation">=</span> null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
#<span class="token entity" title="&#123;">&amp;#123;</span>empId,jdbcType=INTEGER<span class="token entity" title="&#125;">&amp;#125;</span>,
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>empName !<span class="token punctuation">=</span> null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
#<span class="token entity" title="&#123;">&amp;#123;</span>empName,jdbcType=VARCHAR<span class="token entity" title="&#125;">&amp;#125;</span>,
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dId !<span class="token punctuation">=</span> null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
#<span class="token entity" title="&#123;">&amp;#123;</span>dId,jdbcType=INTEGER<span class="token entity" title="&#125;">&amp;#125;</span>,
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trim</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>insert</span><span class="token punctuation">></span></span>
</code></pre>
<h6 id="foreach—需要遍历集合的时候"><a href="#foreach—需要遍历集合的时候" class="headerlink" title="foreach—需要遍历集合的时候"></a>foreach—需要遍历集合的时候</h6><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>delete</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>deleteByList<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>java.util.List<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
delete from tbl_emp where emp_id in
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>list<span class="token punctuation">"</span></span> <span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token attr-name">open</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(<span class="token punctuation">"</span></span> <span class="token attr-name">separator</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>,<span class="token punctuation">"</span></span> <span class="token attr-name">close</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
#<span class="token entity" title="&#123;">&amp;#123;</span>item.empId,jdbcType=VARCHAR<span class="token entity" title="&#125;">&amp;#125;</span>
&lt;/forea
</code></pre>
<p>动态SQL主要是用来解决SQL语句生成的问题</p>
<h5 id="批量操作"><a href="#批量操作" class="headerlink" title="批量操作"></a>批量操作</h5><p>   我们在生产的项目中会有一个批量操作的场景,比如导入文件批量处理数据的情况(批量新增商户,批量修改商户信息),当数据量非常大,比如超过几万条的时候,在java代码中循环发送SQL到数据库执行肯定是不现实的,因为这意味着要跟数据库创建几万次绘画,即使我们使用了数据库连接池技术,对于数据库服务器来说也是不堪重负的</p>
<p>   在Mybatis里面支持批量操作的,包括批量的插入,更新,删除.我们可以直接传入一个List,Set,Map或者数组,配置动态SQL的标签,Mybatis会自动帮我们生成语法正确的SQL语句</p>
<h6 id="批量插入"><a href="#批量插入" class="headerlink" title="批量插入"></a>批量插入</h6><p>批量插入的语法是这样的,只要在value后面增加插入的值就可以了</p>
<pre class=" language-mysql"><code class="language-mysql">insert into tbl_emp (emp_id, emp_name, gender,email, d_id) values ( ?,?,?,?,? ) , ( ?,?,?,?,? ) , ( ?,?,?,?,? ) , ( ?,?,?,?,? ) , ( ?,?,?,?,? ) , ( ?,?,?,?,? ) , ( ?,?,?,?,? ) , ( ?,?,?,?,? ) , ( ?,?,?,?,? ) , 
</code></pre>
<p>在Mapper文件里面,我们可以使用foreach标签拼接values部分的语句</p>
<pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- 批量插入 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>insert</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>batchInsert<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>java.util.List<span class="token punctuation">"</span></span> <span class="token attr-name">useGeneratedKeys</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>selectKey</span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>long<span class="token punctuation">"</span></span> <span class="token attr-name">keyProperty</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AFTER<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
SELECT LAST_INSERT_ID()
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>selectKey</span><span class="token punctuation">></span></span>
insert into tbl_emp (emp_id, emp_name, gender,email, d_id)
values
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>list<span class="token punctuation">"</span></span> <span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>emps<span class="token punctuation">"</span></span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>index<span class="token punctuation">"</span></span> <span class="token attr-name">separator</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>,<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
( #<span class="token entity" title="&#123;">&amp;#123;</span>emps.empId<span class="token entity" title="&#125;">&amp;#125;</span>,#<span class="token entity" title="&#123;">&amp;#123;</span>emps.empName<span class="token entity" title="&#125;">&amp;#125;</span>,#<span class="token entity" title="&#123;">&amp;#123;</span>emps.gender<span class="token entity" title="&#125;">&amp;#125;</span>,#<span class="token entity" title="&#123;">&amp;#123;</span>emps.email<span class="token entity" title="&#125;">&amp;#125;</span>,#<span class="token entity" title="&#123;">&amp;#123;</span>emps.dId<span class="token entity" title="&#125;">&amp;#125;</span> )
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreach</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>insert</span><span class="token punctuation">></span></span>
</code></pre>
<p>java代码里面,直接传入一个List类型的参数</p>
<p>  我们来测试一下.效率要比循环发送SQL执行的要高的多,最关键的地方就在于减少了跟数据库交互的次数,并且避免了开启和结束事务的时间消耗。</p>
<h6 id="批量更新"><a href="#批量更新" class="headerlink" title="批量更新"></a>批量更新</h6><p>批量更新的语法是这样的,通过case when,来匹配id相关的字段值</p>
<pre class=" language-mysql"><code class="language-mysql">update tbl_emp set
emp_name =
case emp_id
when ? then ?
when ? then ?
when ? then ? end ,
gender =
case emp_id
when ? then ?
when ? then ?
when ? then ? end ,
email =
case emp_id
when ? then ?
when ? then ?
when ? then ? end
where emp_id in ( ? , ? , ? )
</code></pre>
<p>所以在Mapper文件里面最关键的就是case when和where的配置</p>
<p>需要注意一下open属性和separator属性</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateBatch<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
update tbl_emp set
emp_name =
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>list<span class="token punctuation">"</span></span> <span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>emps<span class="token punctuation">"</span></span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>index<span class="token punctuation">"</span></span> <span class="token attr-name">separator</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span> <span class="token punctuation">"</span></span> <span class="token attr-name">open</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>case emp_id<span class="token punctuation">"</span></span>
<span class="token attr-name">close</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>end<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
when #<span class="token entity" title="&#123;">&amp;#123;</span>emps.empId<span class="token entity" title="&#125;">&amp;#125;</span> then #<span class="token entity" title="&#123;">&amp;#123;</span>emps.empName<span class="token entity" title="&#125;">&amp;#125;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreach</span><span class="token punctuation">></span></span>
,gender =
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>list<span class="token punctuation">"</span></span> <span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>emps<span class="token punctuation">"</span></span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>index<span class="token punctuation">"</span></span> <span class="token attr-name">separator</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span> <span class="token punctuation">"</span></span> <span class="token attr-name">open</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>case emp_id<span class="token punctuation">"</span></span>
<span class="token attr-name">close</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>end<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
when #<span class="token entity" title="&#123;">&amp;#123;</span>emps.empId<span class="token entity" title="&#125;">&amp;#125;</span> then #<span class="token entity" title="&#123;">&amp;#123;</span>emps.gender<span class="token entity" title="&#125;">&amp;#125;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreach</span><span class="token punctuation">></span></span>
,email =
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>list<span class="token punctuation">"</span></span> <span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>emps<span class="token punctuation">"</span></span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>index<span class="token punctuation">"</span></span> <span class="token attr-name">separator</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span> <span class="token punctuation">"</span></span> <span class="token attr-name">open</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>case emp_id<span class="token punctuation">"</span></span>
<span class="token attr-name">close</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>end<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
when #<span class="token entity" title="&#123;">&amp;#123;</span>emps.empId<span class="token entity" title="&#125;">&amp;#125;</span> then #<span class="token entity" title="&#123;">&amp;#123;</span>emps.email<span class="token entity" title="&#125;">&amp;#125;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreach</span><span class="token punctuation">></span></span>
where emp_id in
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>list<span class="token punctuation">"</span></span> <span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>emps<span class="token punctuation">"</span></span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>index<span class="token punctuation">"</span></span> <span class="token attr-name">separator</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>,<span class="token punctuation">"</span></span> <span class="token attr-name">open</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(<span class="token punctuation">"</span></span>
<span class="token attr-name">close</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
#<span class="token entity" title="&#123;">&amp;#123;</span>emps.empId<span class="token entity" title="&#125;">&amp;#125;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreach</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">></span></span>
</code></pre>
<p>批量删除也是类似的</p>
<h6 id="Batch-Executor"><a href="#Batch-Executor" class="headerlink" title="Batch Executor"></a>Batch Executor</h6><p>当然Mybatis的动态标签的批量操作也是存在一定的缺点的,比如数据量比较大的时候,拼接出来的SQL语句过大.</p>
<p>MySql的服务端对于接受的数据包有大小限制,max_allowed_packet 默认是4M，需要修改默认配置才可以解决这个问题</p>
<pre><code>Caused by: com.mysql.jdbc.PacketTooBigException: Packet for query is too large (7188967 &gt;
4194304). You can change this value on the server by setting the max_allowed_packet&#39; variable.
</code></pre>
<p>在我们的全局配置文件中,可以配置默认的Executor的类型,其中有一种BatchExecutor</p>
<blockquote>
<setting name="defaultExecutorType" value="BATCH" />
也可以在创建会话的时候指定执行器的类型
SqlSession session = sqlSessionFactory.openSession(ExecutorType.BATCH);
</blockquote>
<p>BatchExecutor 底层的对JDBC ps.addBatch()的封装,原理是攒一批SQL以后再发送</p>
<h6 id="嵌套-关联-查询-N-1-延迟加载"><a href="#嵌套-关联-查询-N-1-延迟加载" class="headerlink" title="嵌套(关联)查询/N+1/延迟加载"></a>嵌套(关联)查询/N+1/延迟加载</h6><p>我们在查询业务数据的时候，经常会遇到跨表关联的情况,比如查询员工就会关联部门,查询成绩就会关联课程,查询订单就会关联商品等等</p>
<p>我们映射结果有两个标签,一个是resultType,一个是resultMap.</p>
<p>resultType是select标签的一个属性,适用于返回JDK类型(如Integer,String等等)和实体类.这种情况下结果集的列和实体类的属性可以直接映射,如果返回的字段无法直接映射,就要欧阳那个resultMap来建立映射关系.</p>
<p>  对于关联查询的这种情况,通常不能用resultType来映射,要么就是修改dto,在里面增加字段,这个会导致增加很多无关的字段,要么就是引用关联的对象,比如Blog里面包含一个Author对象，这种情况下就要用到关联查询(assocation,或者嵌套查询),Mybatis可以帮我们自动做结果的映射.</p>
<h6 id="一对一的关联查询有两种配置方式"><a href="#一对一的关联查询有两种配置方式" class="headerlink" title="一对一的关联查询有两种配置方式:"></a>一对一的关联查询有两种配置方式:</h6><ol>
<li>嵌套结果<pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- 根据文章查询作者，一对一查询的结果，嵌套查询 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>BlogWithAuthorResultMap<span class="token punctuation">"</span></span>
<span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.domain.associate.BlogAndAuthor<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bid<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bid<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token comment" spellcheck="true">&lt;!-- 联合查询，将 author 的属性映射到 ResultMap --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>association</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>author<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.gupaoedu.domain.Author<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>author_id<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>authorId<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>author_name<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>authorName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>association</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span>
</code></pre>
</li>
<li>嵌套查询:<pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- 另一种联合查询 (一对一)的实现，但是这种方式有“N+1”的问题 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>BlogWithAuthorQueryMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.domain.associate.BlogAndAuthor<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bid<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bid<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>association</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>author<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.gupaoedu.domain.Author<span class="token punctuation">"</span></span>
<span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>author_id<span class="token punctuation">"</span></span> <span class="token attr-name">select</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>selectAuthor<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span> <span class="token comment" spellcheck="true">&lt;!-- selectAuthor 定义在下面--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span>
<span class="token comment" spellcheck="true">&lt;!-- 嵌套查询 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>selectAuthor<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>int<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.domain.Author<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
select author_id authorId, author_name authorName
from author where author_id = #<span class="token entity" title="&#123;">&amp;#123;</span>authorId<span class="token entity" title="&#125;">&amp;#125;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>
</code></pre>
其中第二种查询方式:嵌套查询,由于是分两次查询,当我们查询了员工信息之后,会再发送一条SQL到数据库查询部门信息</li>
</ol>
<p>我们只执行了一次查询员工信息的SQL(所谓的1),如果返回了N条记录,就会再发送N条到数据库查询部门信息(所谓的N),这个就是我们所说的N+1的问题,这样就会白白的浪费我们的应用和数据库的性能.</p>
<p>如果我们用了嵌套查询的方式,怎么解决这个问题呢?能不能等到使用部门信息的时候再去查询呢?这个就是我们所说的延迟加载,或者叫懒加载.</p>
<p>在Mybatis里面可以通过开启延迟加载的开关来解决这个问题.</p>
<p>在settings标签里面可以配置</p>
<pre class=" language-xml"><code class="language-xml">
<span class="token comment" spellcheck="true">&lt;!--延迟加载的全局开关。当开启时，所有关联对象都会延迟加载。默认 false --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>lazyLoadingEnabled<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token comment" spellcheck="true">&lt;!--当开启时，任何方法的调用都会加载该对象的所有属性。默认 false，可通过 select 标签的
fetchType 来覆盖--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>aggressiveLazyLoading<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token comment" spellcheck="true">&lt;!-- Mybatis 创建具有延迟加载能力的对象所用到的代理工具，默认 JAVASSIST --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>proxyFactory<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>CGLIB<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre>
<p>lazyLoadingEnabled 决定了是否延迟加载.<br>aggressiveLazyLoading 决定了是不是对象的所有方法都会触发查询</p>
<p>先来测试一下(也可以修改成查询列表)</p>
<ol>
<li>没有开启延迟加载的开关,会连续发送两次查询</li>
<li>开启了延迟加载的开关,调用 blog.getAuthor()以及默认的(equals,clone,hshCode,toString)时才会发送第二次查询,其他方法并不会触发查询.比图blog.getName().</li>
<li>如果开启了 aggressiveLazyLoading=true ,其他方法也会触发查询,比如 blog.getName()</li>
</ol>
<p>问题:为什么可以做到延迟加载呢?blog.getAuthor(),只是一个获取属性的方法,里面并没有链接数据库的代码,为什么会触发对数据库的查询<br>   将  blog对象打印出来</p>
<blockquote>
<p>System.out.println(blog.getClass());</p>
</blockquote>
<pre><code>class com.domain.associate.BlogAndAuthor_$$_jvst70_0
</code></pre>
<p>   这个类的名字的后面有个jvst,是JAVASSIST的缩写,原来到这里带延迟加载的功能的对象blog已经变成了一个代理对象.</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">luyanan</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://rainsoil.github.io/2022/01/04/mybatis/mybatis-bian-cheng-shi-kai-fa-1/">https://rainsoil.github.io/2022/01/04/mybatis/mybatis-bian-cheng-shi-kai-fa-1/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">luyanan</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/01/04/mysql/mysql-xing-neng-you-hua-zong-jie-5/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/10.jpg" class="responsive-img" alt="MySQL性能优化总结(5)">
                        
                        <span class="card-title">MySQL性能优化总结(5)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-01-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/mysql/" class="post-category">
                                    mysql
                                </a>
                            
                            <a href="/categories/mysql/mysql/" class="post-category">
                                    mysql
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/01/04/mybatis/mybatis-ti-xi-jie-gou-he-gong-zuo-yuan-li-2/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="Mybatis 体系结构和工作原理(2)">
                        
                        <span class="card-title">Mybatis 体系结构和工作原理(2)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-01-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/mybatis/" class="post-category">
                                    mybatis
                                </a>
                            
                            <a href="/categories/mybatis/mybatis/" class="post-category">
                                    mybatis
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <a href="/about" target="_blank">luyanan</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">803.3k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/rainsoil" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:luyanan0718@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=914596513" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 914596513" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
