<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Istio架构原理和实战(2), railsoil">
    <meta name="description" content="Istio 核心架构和实战1. 组件介绍Components 官网:https://istio.io/docs/ops/deployment/architecture/#components
1.1 Proxy[Envoy]proxy 在I">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Istio架构原理和实战(2) | railsoil</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="railsoil" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">railsoil</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">railsoil</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/10.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Istio架构原理和实战(2)</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Service-Mesh/" class="post-category">
                                Service Mesh
                            </a>
                        
                            <a href="/categories/Service-Mesh/Service-Mesh/" class="post-category">
                                Service Mesh
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-01-04
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    4.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    23 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Istio-核心架构和实战"><a href="#Istio-核心架构和实战" class="headerlink" title="Istio 核心架构和实战"></a><code>Istio</code> 核心架构和实战</h1><h2 id="1-组件介绍"><a href="#1-组件介绍" class="headerlink" title="1. 组件介绍"></a>1. 组件介绍</h2><p><code>Components</code> 官网:<a target="_blank" rel="noopener" href="https://istio.io/docs/ops/deployment/architecture/#components">https://istio.io/docs/ops/deployment/architecture/#components</a></p>
<h3 id="1-1-Proxy-Envoy"><a href="#1-1-Proxy-Envoy" class="headerlink" title="1.1 Proxy[Envoy]"></a>1.1 <code>Proxy[Envoy]</code></h3><p><code>proxy</code> 在<code>Istio</code> 架构中必须存在. </p>
<p><code>Envoy</code> 是由<code>Lyft</code>开发并开源的,使用<code>C++</code> 编写的高性能代理,负责在服务网格中服务的进出流量</p>
<blockquote>
<p>Istio uses an extended version of the Envoy proxy. Envoy is a highperformance proxy developed in C++ to mediate all inbound and outbound traffic for all services in the service mesh. Envoy proxies are the only Istio components that interact with data plane traffic.</p>
</blockquote>
<p><code>官网:</code><a target="_blank" rel="noopener" href="https://www.envoyproxy.io/">https://www.envoyproxy.io/</a></p>
<blockquote>
<p>ENVOY IS AN OPEN SOURCE EDGE AND SERVICE PROXY, DESIGNED FOR CLOUD-NATIVE APPLICATIONS</p>
</blockquote>
<p><code>github</code>: <a target="_blank" rel="noopener" href="https://github.com/envoyproxy/envoy">https://github.com/envoyproxy/envoy</a></p>
<blockquote>
<p>Envoy is hosted by the Cloud Native Computing Foundation (CNCF). If you are a company that wants to help shape the evolution of technologies that are container-packaged, dynamically-scheduled and microservices-oriented, consider joining the CNCF. For details about who’s involved and how Envoy plays a role, read the CNCF announcement.</p>
</blockquote>
<h4 id="1-1-1-Features"><a href="#1-1-1-Features" class="headerlink" title="1.1.1  Features"></a>1.1.1  <code>Features</code></h4><ul>
<li>Dynamic service discovery </li>
<li>Load balancing </li>
<li>TLS termination </li>
<li>HTTP/2 and gRPC proxies </li>
<li>Circuit breakers </li>
<li>Health checks </li>
<li>Staged rollouts with %-based traffic split </li>
<li>Fault injection </li>
<li>Rich metrics</li>
</ul>
<h4 id="1-1-2-为什么选择Envoy"><a href="#1-1-2-为什么选择Envoy" class="headerlink" title="1.1.2  为什么选择Envoy"></a>1.1.2  为什么选择<code>Envoy</code></h4><p>对于<code>Sidecar/Proxy</code> 其实不仅仅可以选择<code>Envoy</code>, 还可以用<code>Likerd</code>、<code>Nginx</code>和<code>NginMesh</code>等. </p>
<p>像<code>Nginx</code> 作为分布式架构中比较广泛使用的网关,<code>Istio</code> 默认却没有选择,是因为<code>Nginx</code> 没有<code>Envoy</code> 优秀的配置扩展,<code>Envoy</code> 可以实时配置. </p>
<h3 id="1-2-Mixer"><a href="#1-2-Mixer" class="headerlink" title="1.2 Mixer"></a>1.2 <code>Mixer</code></h3><blockquote>
<p><code>Mixer</code> 在<code>Istio</code> 架构中不是必须的. </p>
</blockquote>
<p><code>官网</code>: <a target="_blank" rel="noopener" href="https://istio.io/docs/ops/deployment/architecture/#mixer">https://istio.io/docs/ops/deployment/architecture/#mixer</a></p>
<blockquote>
<p>Mixer is a platform-independent component. Mixer enforces access control and usage policies across the service mesh, and collects telemetry data from the Envoy proxy and other services. The proxy extracts request level attributes, and sends them to Mixer for evaluation. You can find more information on this attribute extraction and policy evaluation in our Mixer Configuration documentation. </p>
<p>Mixer includes a flexible plugin model. This model enables Istio to interface with a variety of host environments and infrastructure backends. Thus, Istio abstracts the Envoy proxy and Istio-managed services from these details.</p>
</blockquote>
<ul>
<li>为集群执行访问控制,哪些用户可以访问哪些服务? 包括白名单检查、ACL 检查等. </li>
<li>策略管理,比如某个服务最多只能接受多少流量请求</li>
<li>遥测报告上报,比如从<code>Envoy</code>中收集数据[请求数据、使用时间、使用的协议等], 通过<code>Adpater</code> 上报给<code>Primethues</code>、<code>Heapster</code>等. </li>
</ul>
<h3 id="1-3-Pilot"><a href="#1-3-Pilot" class="headerlink" title="1.3 Pilot"></a>1.3 <code>Pilot</code></h3><p><code>Pilot</code>在<code>Istio</code>架构中必须要有</p>
<blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/ops/deployment/architecture/#pilot">https://istio.io/docs/ops/deployment/architecture/#pilot</a></p>
</blockquote>
<blockquote>
<p>Pilot provides service discovery for the Envoy sidecars, traffic management capabilities for intelligent routing (e.g., A/B tests, canary rollouts, etc.), and resiliency (timeouts, retries, circuit breakers, etc.).</p>
<p>Pilot converts high level routing rules that control traffic behavior into Envoy-specific configurations, and propagates them to the sidecars at runtime. Pilot abstracts platform-specific service discovery mechanisms and synthesizes them into a standard format that any sidecar conforming with the <a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/api/api">Envoy API</a> can consume.</p>
</blockquote>
<p><code>Pilot</code> 为<code>Envoy Sidecar</code> 提供了服务发现功能, 为智能路由提供了流量管理能力(比如A/B测试,金丝雀发布等)</p>
<p><code>Pilot</code> 本身不做服务注册,它会提供一个接口,对接已有的服务注册系统,比如<code>Eureka</code>、<code>Etcd</code>等, <code>Pilot</code> 对配置的格式做了抽象,整理成能够符合<code>Envoy</code> 数据层的<code>API</code></p>
<blockquote>
<ol>
<li><code>Pilot</code> 定义了一个抽象模型,从特定平台细节中解耦,用于对接外部的不同平台</li>
<li><code>Envoy API</code> 负责和<code>Envoy</code> 的通讯,主要是发送服务发现信息和流量控制规则给<code>Envoy</code></li>
<li><code>Platform Adapter</code>  是<code>Pilot</code> 抽象模型的实现版本,用于对接外部的不同平台</li>
</ol>
</blockquote>
<h3 id="1-4-Galley"><a href="#1-4-Galley" class="headerlink" title="1.4 Galley"></a>1.4 <code>Galley</code></h3><p><code>Galley</code> 在<code>Istio</code> 架构中不是必须的</p>
<blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/ops/deployment/architecture/#galley">https://istio.io/docs/ops/deployment/architecture/#galley</a></p>
</blockquote>
<blockquote>
<p>Galley is Istio’s configuration validation, ingestion, processing and distribution component. It is responsible for insulating the rest of the Istio components from the details of obtaining user configuration from the underlying platform (e.g. Kubernetes).</p>
</blockquote>
<p>主要负责<code>Istio</code> 配置的校验、各种配置之间的统筹,为<code>Istio</code> 提供配置管理服务, 通过<code>Kubernetes</code> 的<code>webhook</code> 机制对<code>pilot</code> 和<code>mixer</code>的配置进行验证. </p>
<h3 id="1-5-Citadel"><a href="#1-5-Citadel" class="headerlink" title="1.5 Citadel"></a>1.5 <code>Citadel</code></h3><p><code>Citadel</code>在<code>Istio</code> 架构中不是必须的</p>
<blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/ops/deployment/architecture/#citadel">https://istio.io/docs/ops/deployment/architecture/#citadel</a></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://istio.io/docs/concepts/security/">Citadel</a> enables strong service-to-service and end-user authentication with built-in identity and credential management. You can use Citadel to upgrade unencrypted traffic in the service mesh. Using Citadel, operators can enforce policies based on service identity rather than on relatively unstable layer 3 or layer 4 network identifiers. Starting from release 0.5, you can use <a target="_blank" rel="noopener" href="https://istio.io/docs/concepts/security/#authorization">Istio’s authorization feature</a> to control who can access your services.</p>
</blockquote>
<p>在有一些场景中,对于安全的要求是非常高的,比如支付,所以<code>Citadel</code> 就是用来保证安全的. </p>
<h2 id="2-实战之Bookinfo"><a href="#2-实战之Bookinfo" class="headerlink" title="2. 实战之Bookinfo"></a>2. 实战之<code>Bookinfo</code></h2><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/examples/bookinfo/">https://istio.io/docs/examples/bookinfo/</a></p>
</blockquote>
<blockquote>
<p>This example deploys a sample application composed of four separate microservices used to demonstrate various Istio features.</p>
<p>The application displays information about a book, similar to a single catalog entry of an online book store. Displayed on the page is a description of the book, book details (ISBN, number of pages, and so on), and a few book reviews.</p>
<p>The Bookinfo application is broken into four separate microservices:</p>
<ul>
<li><code>productpage</code>. The <code>productpage</code> microservice calls the <code>details</code> and <code>reviews</code> microservices to populate the page.</li>
<li><code>details</code>. The <code>details</code> microservice contains book information.</li>
<li><code>reviews</code>. The <code>reviews</code> microservice contains book reviews. It also calls the <code>ratings</code> microservice.</li>
<li><code>ratings</code>. The <code>ratings</code> microservice contains book ranking information that accompanies a book review.</li>
</ul>
<p>There are 3 versions of the <code>reviews</code> microservice:</p>
<ul>
<li>Version v1 doesn’t call the <code>ratings</code> service.</li>
<li>Version v2 calls the <code>ratings</code> service, and displays each rating as 1 to 5 black stars.</li>
<li>Version v3 calls the <code>ratings</code> service, and displays each rating as 1 to 5 red stars.</li>
</ul>
<p>The end-to-end architecture of the application is shown below.</p>
<p><img src="http://files.luyanan.com//img/20200506162752.png" alt="image-20200506162720701"></p>
</blockquote>
<blockquote>
<p> This application is polyglot, i.e., the microservices are written in different languages. It’s worth noting that these services have no dependencies on Istio, but make an interesting service mesh example, particularly because of the multitude of services, languages and versions for the <code>reviews</code> service.</p>
</blockquote>
<h3 id="2-1-理解Bookinfo"><a href="#2-1-理解Bookinfo" class="headerlink" title="2.1 理解Bookinfo"></a>2.1 理解<code>Bookinfo</code></h3><ol>
<li> <code>productpage</code> 是<code>python</code>  语言编写的,用于前端页面展示,会调用 <code>reviews</code>微服务和<code>details</code>服务</li>
<li><code>details</code> 是<code>Ruby</code> 语言编写的,是书籍的详情信息</li>
<li><code>reviews</code> 是java编写的,是书籍的评论信息,会调用<code>ratings</code> 微服务, 有3个版本</li>
<li><code>ratings</code>是<code>node.js</code> 语言编写的,是书籍的评分部分</li>
</ol>
<h3 id="2-2-Sidecar-自动注入到微服务"><a href="#2-2-Sidecar-自动注入到微服务" class="headerlink" title="2.2 Sidecar 自动注入到微服务"></a>2.2 <code>Sidecar</code> 自动注入到微服务</h3><p><code>官网</code>: <a target="_blank" rel="noopener" href="https://istio.io/docs/examples/bookinfo/#start-the-application-services">https://istio.io/docs/examples/bookinfo/#start-the-application-services</a></p>
<blockquote>
<p>To run the sample with Istio requires no changes to the application itself. Instead, you simply need to configure and run the services in an Istio-enabled environment, with Envoy sidecars injected along side each service. The resulting deployment will look like this</p>
</blockquote>
<blockquote>
<p>All of the microservices will be packaged with an Envoy sidecar that intercepts incoming and outgoing calls for the services, providing the hooks needed to externally control, via the Istio control plane, routing, telemetry collection, and policy enforcement for the application as a whole.</p>
</blockquote>
<ol>
<li> Change directory to the root of the Istio installation.</li>
</ol>
<pre class=" language-bash"><code class="language-bash"><span class="token function">cd</span> istio-1.0.6
</code></pre>
<ol start="2">
<li><p>)The default Istio installation uses automatic sidecar injection. Label the namespace that will host the application with <code>istio-injection=enabled</code>:</p>
<pre class=" language-bash"><code class="language-bash">kubectl label namespace default istio-injection<span class="token operator">=</span>enabled
kubectl get namespaces --show-labels
</code></pre>
</li>
<li><p>Deploy your application using the kubectl command:</p>
<pre class=" language-bash"><code class="language-bash">kubectl apply -f istio-1.0.6/samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre>
</li>
<li><p>查看<code>pod</code></p>
<pre class=" language-bash"><code class="language-bash">kubectl get pods
</code></pre>
<pre class=" language-text"><code class="language-text">NAME READY STATUS
details-v1-d458c8599-l2rpr 2/2 Running
productpage-v1-79d85ff9fc-jvlrn 2/2 Running
ratings-v1-567bfb85cf-lrkpm 2/2 Running
reviews-v1-fd6c96c74-ncl8k 2/2 Running
reviews-v2-68d98477f6-s5f7l 2/2 Running
reviews-v3-8495f5f6bb-mx8q2 2/2 Running
</code></pre>
</li>
<li><p>查看<code>sv</code></p>
<pre class=" language-bash"><code class="language-bash">kubectl get svc
</code></pre>
<pre class=" language-bash"><code class="language-bash">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span> AGE
details ClusterIP 10.103.89.119 <span class="token operator">&lt;</span>none<span class="token operator">></span> 9080/TCP 5m48s
kubernetes ClusterIP 10.96.0.1 <span class="token operator">&lt;</span>none<span class="token operator">></span> 443/TCP 18d
productpage ClusterIP 10.104.220.93 <span class="token operator">&lt;</span>none<span class="token operator">></span> 9080/TCP 5m48s
ratings ClusterIP 10.106.48.89 <span class="token operator">&lt;</span>none<span class="token operator">></span> 9080/TCP 5m48s
reviews ClusterIP 10.98.5.206 <span class="token operator">&lt;</span>none<span class="token operator">></span> 9080/TCP 5m48s
</code></pre>
</li>
<li><p>测试一下是否成功</p>
<pre class=" language-bash"><code class="language-bash">kubectl <span class="token function">exec</span> -it <span class="token punctuation">$(</span>kubectl get pod -l app<span class="token operator">=</span>ratings -o
jsonpath<span class="token operator">=</span><span class="token string">'&amp;#123;.items[0].metadata.name&amp;#125;'</span><span class="token punctuation">)</span> -c ratings -- curl
productpage:9080/productpage <span class="token operator">|</span> <span class="token function">grep</span> -o <span class="token string">"&lt;title>.*&lt;/title>"</span>
</code></pre>
<pre class=" language-bash"><code class="language-bash"><span class="token operator">&lt;</span>title<span class="token operator">></span>Simple Bookstore App<span class="token operator">&lt;</span>/title<span class="token operator">></span>
</code></pre>
</li>
</ol>
<h3 id="2-3-通过Ingress-方式访问"><a href="#2-3-通过Ingress-方式访问" class="headerlink" title="2.3 通过Ingress 方式访问"></a>2.3 通过<code>Ingress</code> 方式访问</h3><ol>
<li> 创建<code>ingress</code> 规则</li>
</ol>
<p>   <code>productpage-ingress.yaml</code> 资源文件</p>
<pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#ingress</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> productpage<span class="token punctuation">-</span>ingress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> productpage.istio.luyanan.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> productpage
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">9080</span>
</code></pre>
<ol start="2">
<li><p>访问测试</p>
<pre class=" language-bash"><code class="language-bash">productpage.istio.luyanan.com
</code></pre>
</li>
</ol>
<h3 id="2-4-通过Istio的Ingressgateway访问"><a href="#2-4-通过Istio的Ingressgateway访问" class="headerlink" title="2.4  通过Istio的Ingressgateway访问"></a>2.4  通过<code>Istio</code>的<code>Ingressgateway</code>访问</h3><p><code>官网</code>: <a target="_blank" rel="noopener" href="https://istio.io/docs/examples/bookinfo/#determine-the-ingress-ip-and-port">https://istio.io/docs/examples/bookinfo/#determine-the-ingress-ip-and-port</a></p>
<ol>
<li><p>Define the ingress gateway for the application:</p>
<p><code>istio-1.0.6/samples/bookinfo/networking/bookinfo-gateway.yaml</code></p>
<p>可以查看一下该yaml文件，一个是Gateway，一个是VirtualService</p>
<pre class=" language-bash"><code class="language-bash">kubectl apply -f bookinfo-gateway.yaml
</code></pre>
</li>
<li><p>Confirm the gateway has been created:</p>
<pre class=" language-bash"><code class="language-bash">kubectl get gateway
</code></pre>
</li>
<li><p>set the <code>INGRESS_HOST</code> and <code>INGRESS_PORT</code> variables for accessing the gateway</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">export</span> INGRESS_HOST<span class="token operator">=</span><span class="token punctuation">$(</span>kubectl get po -l istio<span class="token operator">=</span>ingressgateway -n istio-system -o
jsonpath<span class="token operator">=</span><span class="token string">'&amp;#123;.items[0].status.hostIP&amp;#125;'</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-bash"><code class="language-bash"><span class="token function">export</span> INGRESS_PORT<span class="token operator">=</span><span class="token punctuation">$(</span>kubectl -n istio-system get <span class="token function">service</span> istio-ingressgateway -
o jsonpath<span class="token operator">=</span><span class="token string">'&amp;#123;.spec.ports[?(@.name=="http2")].nodePort&amp;#125;'</span><span class="token punctuation">)</span>
</code></pre>
</li>
<li><p>Set <code>GATEWAY_URL</code> :</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">export</span> GATEWAY_URL<span class="token operator">=</span><span class="token variable">$INGRESS_HOST</span><span class="token keyword">:</span><span class="token variable">$INGRESS_PORT</span>
</code></pre>
</li>
<li><p>查看<code>INGRESS_PORT</code>端口</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 比如结果为31380</span>
<span class="token function">env</span> <span class="token operator">|</span> <span class="token function">grep</span> INGRESS_PORT
</code></pre>
</li>
<li><p>测试</p>
<p>不断的访问测试,发现会访问<code>review</code>的不同版本</p>
</li>
<li><p>Apply default destination rules</p>
<p> <code>官网</code>: <a target="_blank" rel="noopener" href="https://istio.io/docs/examples/bookinfo/#apply-default-destination-rules">https://istio.io/docs/examples/bookinfo/#apply-default-destination-rules</a></p>
<blockquote>
<p>Before you can use Istio to control the Bookinfo version routing, you need to define the available versions, called <em>subsets</em>, in <a target="_blank" rel="noopener" href="https://istio.io/docs/concepts/traffic-management/#destination-rules">destination rules</a>.</p>
</blockquote>
<p><code>istio-1.0.6/samples/bookinfo/networking/destination-rule-all.yaml</code></p>
<pre class=" language-bash"><code class="language-bash">kubectl apply -f destination-rule-all.yaml
</code></pre>
</li>
</ol>
<h3 id="2-5-体验Istio的流量管理"><a href="#2-5-体验Istio的流量管理" class="headerlink" title="2.5 体验Istio的流量管理"></a>2.5 体验<code>Istio</code>的流量管理</h3><p>流量这块就体现了<code>Pilot</code>和<code>Envoy</code>的功能</p>
<h4 id="2-5-1-基于版本的路由"><a href="#2-5-1-基于版本的路由" class="headerlink" title="2.5.1 基于版本的路由"></a>2.5.1 基于版本的路由</h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/traffic-management/request-routing/#apply-a-virtual-service">https://istio.io/docs/tasks/traffic-management/request-routing/#apply-a-virtual-service</a></p>
</blockquote>
<p>之前刷新<code>productpage</code>页面的时候,发现<code>review</code>的版本一直会变,能不能一直访问某个版本呢?</p>
<p><code>istio-1.0.6/samples/bookinfo/networking/virtual-service-reviews-v3.yaml</code></p>
<pre class=" language-bash"><code class="language-bash">kubectl apply -f virtual-service-reviews-v3.yaml
</code></pre>
<p>再次访问测试<code>http://121.41.10.13:31380/productpage</code></p>
<h4 id="2-5-2-基于用户身份的路由"><a href="#2-5-2-基于用户身份的路由" class="headerlink" title="2.5.2 基于用户身份的路由"></a>2.5.2 基于用户身份的路由</h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/traffic-management/request-routing/#route-based-on-user-identity">https://istio.io/docs/tasks/traffic-management/request-routing/#route-based-on-user-identity</a></p>
</blockquote>
<blockquote>
<p>Next, you will change the route configuration so that all traffic from a specific user is routed to a specific service version. In this case, all traffic from a user named Jason will be routed to the service <code>reviews:v2</code>.</p>
<p>Note that Istio doesn’t have any special, built-in understanding of user identity. This example is enabled by the fact that the <code>productpage</code> service adds a custom <code>end-user</code> header to all outbound HTTP requests to the reviews service.</p>
<p>Remember, <code>reviews:v2</code> is the version that includes the star ratings feature.</p>
</blockquote>
<ol>
<li><p>根据对应文件创建资源</p>
<pre class=" language-bash"><code class="language-bash">istio-1.0.6/samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
</code></pre>
</li>
<li><p>测试</p>
<p><code># 使用jason来登录[右上角有Sign in的功能或者url?u=jason]，一直会访问到v2版本</code></p>
<blockquote>
<p>On the /productpage of the Bookinfo app, log in as user jason. Refresh the browser. What do you see? The star ratings appear next to each review.</p>
</blockquote>
<p>  <code># 使用其他用户登陆,一直会访问到v1版本</code></p>
<blockquote>
<p>Log in as another user (pick any name you wish). Refresh the browser. Now the stars are gone. This is because traffic is routed to reviews:v1 for all users except Jason.</p>
</blockquote>
</li>
</ol>
<h4 id="2-5-3-基于权重的路由"><a href="#2-5-3-基于权重的路由" class="headerlink" title="2.5.3  基于权重的路由"></a>2.5.3  基于权重的路由</h4><ol>
<li><p>根据对应文件创建资源</p>
<p><code>istio-1.0.6/samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml</code></p>
<p>一般几率访问到v1,一般的几率访问到v3</p>
<p>这里就相当于之前的蓝绿部署,AB测试或者灰度发布</p>
<p>权重加起来必须是100</p>
<pre class=" language-bash"><code class="language-bash">kubectl apply -f virtual-service-reviews-50-v3.yaml
</code></pre>
</li>
<li><p>测试</p>
<pre class=" language-bash"><code class="language-bash">http://121.41.10.13:31380/productpage
</code></pre>
</li>
</ol>
<h4 id="2-5-4-故障注入"><a href="#2-5-4-故障注入" class="headerlink" title="2.5.4  故障注入"></a>2.5.4  故障注入</h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/traffic-management/fault-injection/">https://istio.io/docs/tasks/traffic-management/fault-injection/</a></p>
</blockquote>
<blockquote>
<p>Apply application version routing by either performing the <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/traffic-management/request-routing/">request routing</a> task or by running the following commands:</p>
</blockquote>
<p><code>istio-1.0.6/samples/bookinfo/networking/</code></p>
<pre class=" language-bash"><code class="language-bash">kubectl apply -f virtual-service-all-v1.yaml
kubectl apply -f virtual-service-reviews-test-v2.yaml
</code></pre>
<p>With the above configuration, this is how requests flow:</p>
<pre class=" language-bash"><code class="language-bash">productpage → reviews:v2 → ratings <span class="token punctuation">(</span>only <span class="token keyword">for</span> user jason<span class="token punctuation">)</span>
productpage → reviews:v1 <span class="token punctuation">(</span>for everyone else<span class="token punctuation">)</span>
</code></pre>
<blockquote>
<p>To test the Bookinfo application microservices for resiliency, inject a 7s delay between the <code>reviews:v2</code> and <code>ratings</code> microservices for user <code>jason</code>. This test will uncover a bug that was intentionally introduced into the Bookinfo app.</p>
<p>Note that the <code>reviews:v2</code> service has a 10s hard-coded connection timeout for calls to the <code>ratings</code> service. Even with the 7s delay that you introduced, you still expect the end-to-end flow to continue without any errors.</p>
</blockquote>
<ol>
<li> 创建一个故障注入规则,使得<code>jason</code> 用户访问v2 到<code>ratings</code> 有7秒的延迟</li>
</ol>
<pre class=" language-bash"><code class="language-bash">kubectl apply -f virtual-service-ratings-test-delay.yaml
</code></pre>
<ol start="2">
<li><p>使得<code>jason</code>账户登陆,并且访问<code>productpage</code>页面,会得到这样一个返回信息</p>
<pre class=" language-text"><code class="language-text">Error fetching product reviews!
Sorry, product reviews are currently unavailable for this book.
</code></pre>
</li>
<li><p>View the web page response times:</p>
<pre class=" language-text"><code class="language-text">Open the Developer Tools menu in you web browser.
Open the Network tab
Reload the /productpage web page. You will see that the page actually loads in
about 6 seconds.
</code></pre>
</li>
</ol>
<h4 id="2-5-5-流量迁移"><a href="#2-5-5-流量迁移" class="headerlink" title="2.5.5  流量迁移"></a>2.5.5  流量迁移</h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/traffic-management/traffic-shifting/">https://istio.io/docs/tasks/traffic-management/traffic-shifting/</a></p>
</blockquote>
<blockquote>
<p>This task shows you how to gradually migrate traffic from one version of a microservice to another. For example, you might migrate traffic from an older version to a new version.</p>
<p>A common use case is to migrate traffic gradually from one version of a microservice to another. In Istio, you accomplish this goal by configuring a sequence of rules that route a percentage of traffic to one service or another. In this task, you will send 50% of traffic to <code>reviews:v1</code> and 50% to <code>reviews:v3</code>. Then, you will complete the migration by sending 100% of traffic to <code>reviews:v3</code>.</p>
</blockquote>
<ol>
<li><p>让所有的流量都到v1</p>
<pre class=" language-bash"><code class="language-bash">kubectl apply -f virtual-service-all-v1.yaml
</code></pre>
</li>
<li><p>将v1的50% 流量转移到v3</p>
<pre class=" language-bash"><code class="language-bash">kubectl apply -f virtual-service-reviews-50-v3.yaml
</code></pre>
</li>
<li><p>确保v3版本没问题后,可以将流量都转移到v3</p>
<pre class=" language-bash"><code class="language-bash">kubectl apply -f virtual-service-reviews-v3.yaml
</code></pre>
</li>
<li><p>访问测试,看是否都访问到v3 版本</p>
</li>
</ol>
<h3 id="2-6-体验Istio的Obseerve"><a href="#2-6-体验Istio的Obseerve" class="headerlink" title="2.6  体验Istio的Obseerve"></a>2.6  体验<code>Istio</code>的<code>Obseerve</code></h3><p>这块就体现了<code>Mixer</code>和<code>Envoy</code>的功能</p>
<h4 id="2-6-1-收集Metrics"><a href="#2-6-1-收集Metrics" class="headerlink" title="2.6.1 收集Metrics"></a>2.6.1 收集<code>Metrics</code></h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/observability/metrics/collecting-metrics/">https://istio.io/docs/tasks/observability/metrics/collecting-metrics/</a></p>
</blockquote>
<blockquote>
<p>This task shows how to configure Istio to automatically gather telemetry for services in a mesh. At the end of this task, a new metric will be enabled for calls to services within your mesh.</p>
</blockquote>
<ol>
<li><p>Apply a YAML file with configuration for the new metric that Istio will generate and collect automatically</p>
<p><code>metrics-crd.yaml</code></p>
<pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># Configuration for metric instances</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> <span class="token string">"config.istio.io/v1alpha2"</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> instance
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> doublerequestcount
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">compiledTemplate</span><span class="token punctuation">:</span> metric
  <span class="token key atrule">params</span><span class="token punctuation">:</span>
    <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"2"</span> <span class="token comment" spellcheck="true"># count each request twice</span>
    <span class="token key atrule">dimensions</span><span class="token punctuation">:</span>
      <span class="token key atrule">reporter</span><span class="token punctuation">:</span> conditional((context.reporter.kind <span class="token punctuation">|</span> "inbound") == "outbound"<span class="token punctuation">,</span> <span class="token string">"client"</span><span class="token punctuation">,</span> "server")
      <span class="token key atrule">source</span><span class="token punctuation">:</span> source.workload.name <span class="token punctuation">|</span> "unknown"
      <span class="token key atrule">destination</span><span class="token punctuation">:</span> destination.workload.name <span class="token punctuation">|</span> "unknown"
      <span class="token key atrule">message</span><span class="token punctuation">:</span> <span class="token string">'"twice the fun!"'</span>
    <span class="token key atrule">monitored_resource_type</span><span class="token punctuation">:</span> <span class="token string">'"UNSPECIFIED"'</span>
<span class="token punctuation">---</span>
<span class="token comment" spellcheck="true"># Configuration for a Prometheus handler</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> <span class="token string">"config.istio.io/v1alpha2"</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> prometheus
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> doublehandler
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> double_request_count <span class="token comment" spellcheck="true"># Prometheus metric name</span>
    <span class="token key atrule">instance_name</span><span class="token punctuation">:</span> doublerequestcount.instance.istio<span class="token punctuation">-</span>system <span class="token comment" spellcheck="true"># Mixer instance name (fully-qualified)</span>
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> COUNTER
    <span class="token key atrule">label_names</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reporter
    <span class="token punctuation">-</span> source
    <span class="token punctuation">-</span> destination
    <span class="token punctuation">-</span> message
<span class="token punctuation">---</span>
<span class="token comment" spellcheck="true"># Rule to send metric instances to a Prometheus handler</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> <span class="token string">"config.istio.io/v1alpha2"</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> rule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> doubleprom
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">actions</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">handler</span><span class="token punctuation">:</span> doublehandler.prometheus
    <span class="token key atrule">instances</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> doublerequestcount
</code></pre>
</li>
<li><p>Send traffic to the sample application</p>
<pre class=" language-bash"><code class="language-bash">http://121.41.10.13:31380/productpage
</code></pre>
</li>
<li><p>访问 <code>prometheus</code></p>
<pre class=" language-bash"><code class="language-bash">http://prometheus.istio.luyanan.com/
</code></pre>
</li>
<li><p>根据 <code>istio_double_request_count</code> 进行查询</p>
</li>
<li><p>Understanding the metrics configuration</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/observability/metrics/collecting-metrics/#understanding-the-metrics-configuration">https://istio.io/docs/tasks/observability/metrics/collecting-metrics/#understanding-the-metrics-configuration</a></p>
</blockquote>
</li>
</ol>
<h4 id="2-6-2-查询Istio的Metrics"><a href="#2-6-2-查询Istio的Metrics" class="headerlink" title="2.6.2  查询Istio的Metrics"></a>2.6.2  查询<code>Istio</code>的<code>Metrics</code></h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/observability/metrics/querying-metrics/">https://istio.io/docs/tasks/observability/metrics/querying-metrics/</a></p>
</blockquote>
<blockquote>
<p>This task shows you how to query for Istio Metrics using Prometheus. As part of this task, you will use the web-based interface for querying metric values.</p>
</blockquote>
<ol>
<li> 访问<code> productpage</code></li>
</ol>
<pre class=" language-bash"><code class="language-bash">http://121.41.10.13:31380/productpage
</code></pre>
<ol start="2">
<li><p>打开<code>prometheus</code> 界面</p>
<pre class=" language-bash"><code class="language-bash">http://prometheus.istio.luyanan.com/
</code></pre>
</li>
<li><p>输入查询指标</p>
<pre class=" language-bash"><code class="language-bash">istio_requests_total
</code></pre>
</li>
<li><p>About the Prometheus add-on</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/observability/metrics/querying-metrics/#about-theprometheus-add-on">https://istio.io/docs/tasks/observability/metrics/querying-metrics/#about-theprometheus-add-on</a></p>
</blockquote>
</li>
</ol>
<h4 id="2-6-3-分布式追踪之Jaeger"><a href="#2-6-3-分布式追踪之Jaeger" class="headerlink" title="2.6.3 分布式追踪之Jaeger"></a>2.6.3 分布式追踪之<code>Jaeger</code></h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/observability/distributed-tracing/overview/">https://istio.io/docs/tasks/observability/distributed-tracing/overview/</a></p>
</blockquote>
<blockquote>
<p>Distributed tracing enables users to track a request through mesh that is distributed across multiple services. This allows a deeper understanding about request latency, serialization and parallelism via visualization</p>
</blockquote>
<blockquote>
<p><code>jaeger官网</code>:<a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/observability/distributed-tracing/jaeger/">https://istio.io/docs/tasks/observability/distributed-tracing/jaeger/</a></p>
</blockquote>
<blockquote>
<p>After completing this task, you understand how to have your application participate in tracing with <a target="_blank" rel="noopener" href="https://www.jaegertracing.io/">Jaeger</a>, regardless of the language, framework, or platform you use to build your application.</p>
</blockquote>
<blockquote>
<p>istio-tracing-c8b67b59c-8vgrl 1/1 Running —&gt; 即Jaeger，默认已经安装</p>
</blockquote>
<ol>
<li> 查看<code>jaeger</code> 的<code>svc</code></li>
</ol>
<pre class=" language-bash"><code class="language-bash">kubectl get svc -n istio-system <span class="token operator">|</span> <span class="token function">grep</span> jae
kubectl get svc jaeger-query -n istio-system -o yaml
</code></pre>
<ol start="2">
<li><p>配置<code>jaeage</code>的<code>ingress</code></p>
<p><code>jaeger-ingress.yaml</code></p>
<pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#ingress</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> jaeger<span class="token punctuation">-</span>ingress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> jaeger.istio.luyanan.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> jaeger<span class="token punctuation">-</span>query
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">16686</span>
</code></pre>
</li>
<li><p>浏览器访问</p>
<pre class=" language-bash"><code class="language-bash">jaeger.istio.luyanan.com
</code></pre>
</li>
<li><p>发送100个请求</p>
<pre class=" language-bash"><code class="language-bash"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">seq</span> 1 100<span class="token variable">`</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> curl -s -o /dev/null
http://121.41.10.13:31380/productpage<span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre>
</li>
<li><p>进入到<code>jaeger</code> 界面</p>
<p>选择<code>productpage</code>, 查询详情</p>
</li>
</ol>
<h4 id="2-6-4-Mesh-可视化之Kiali"><a href="#2-6-4-Mesh-可视化之Kiali" class="headerlink" title="2.6.4  Mesh  可视化之Kiali"></a>2.6.4  <code>Mesh</code>  可视化之<code>Kiali</code></h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/observability/kiali/">https://istio.io/docs/tasks/observability/kiali/</a></p>
</blockquote>
<blockquote>
<p>This task shows you how to visualize different aspects of your Istio mesh.</p>
<p>As part of this task, you install the <a target="_blank" rel="noopener" href="https://www.kiali.io/">Kiali</a> add-on and use the web-based graphical user interface to view service graphs of the mesh and your Istio configuration objects. Lastly, you use the Kiali Public API to generate graph data in the form of consumable JSON.</p>
</blockquote>
<h2 id="3-安装Istio-Helm"><a href="#3-安装Istio-Helm" class="headerlink" title="3. 安装Istio(Helm)"></a>3. 安装<code>Istio(Helm)</code></h2><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/setup/install/helm/">https://istio.io/docs/setup/install/helm/</a></p>
</blockquote>
<h3 id="3-1-下载安装Helm"><a href="#3-1-下载安装Helm" class="headerlink" title="3.1  下载安装Helm"></a>3.1  下载安装<code>Helm</code></h3><h4 id="3-1-1-Helm-简介"><a href="#3-1-1-Helm-简介" class="headerlink" title="3.1.1 Helm 简介"></a>3.1.1 <code>Helm</code> 简介</h4><p><code>Helm</code> 是<code>kubernetes</code> 的软件包管理工具,类似于<code>Ubuntu</code> 中的<code>apt</code>、<code>Contos</code> 中的<code>yum</code>等. 可以快速查找、下载和安装软件包,<code>Helm</code> 由客户端组件<code>helm</code>和服务端组件<code>tiller</code> 组成</p>
<h4 id="3-1-2-解决的问题"><a href="#3-1-2-解决的问题" class="headerlink" title="3.1.2   解决的问题"></a>3.1.2   解决的问题</h4><p>比如在k8s中部署一个<code>wordpress</code>  , 需要创建<code>deployment</code>、<code>service</code>、<code>secret</code>、<code>pv</code>等,这些资源有时候不方便管理,过于分散,如果使用<code>kubectl</code> 进行操作,发现还是比较恶心的,所以简单来说,<code>helm</code> 就是为了解决上述问题的 . </p>
<h4 id="3-1-3-各种名词概念"><a href="#3-1-3-各种名词概念" class="headerlink" title="3.1.3 各种名词概念"></a>3.1.3 各种名词概念</h4><ul>
<li><p><code>chart</code></p>
<p><code>helm</code> 的打包格式叫<code>chart</code>,<code>chart</code>即一系列文件,描述了一组相关的k8s集群资源</p>
</li>
<li><p><code>helm</code></p>
<p>客户端命令工具, 用于本地开发以及管理<code>chart</code>、<code>chart</code>仓库. </p>
</li>
<li><p><code>tiller</code></p>
<p><code>helm</code>的服务端,<code>tiller</code> 接收<code>helm</code>的请求,与k8s 的<code>apiserver</code>打交道,根据<code>chart</code> 生成一个<code>release</code> 并且管理<code>release</code></p>
</li>
<li><p><code>release</code></p>
<p><code>helm install</code> 命令在k8s集群中部署的<code>chart</code> 称之为<code>release</code></p>
</li>
<li><p><code>repository helm chart</code></p>
<p><code>helm</code>  客户端通过<code>http</code>协议来访问存储库中<code>chart</code>的索引文件和压缩包</p>
</li>
</ul>
<h4 id="3-1-4-图解Helm-原理"><a href="#3-1-4-图解Helm-原理" class="headerlink" title="3.1.4  图解Helm 原理"></a>3.1.4  图解<code>Helm</code> 原理</h4><p><img src="http://files.luyanan.com//img/20200506210601.png" alt="image-20200506210557791"></p>
<h4 id="3-1-5-release操作"><a href="#3-1-5-release操作" class="headerlink" title="3.1.5 release操作"></a>3.1.5 <code>release</code>操作</h4><p><strong>创建<code>release</code></strong></p>
<ol>
<li><code>helm</code>  客户端从指定的目录或本地<code>tar</code> 文件或远程<code>repo</code> 仓库解析出<code>chart</code> 的结构信息</li>
<li><code>helm</code> 客户端指定的<code>chart</code> 结构和<code>values</code> 信息通过<code>gRPC</code> 传递给<code>Tiller</code></li>
<li><code>Tiller</code> 服务端根据<code>chart</code> 和<code>values</code> 生成一个<code>release</code></li>
<li><code>Tiller</code>  将<code>install release</code>  请求直接传递给<code>kube-apiserver</code></li>
</ol>
<p><strong>删除<code>release</code></strong></p>
<ol>
<li><code>helm</code> 客户端从指定的目录或者本地<code>tar</code> 文件或者远程<code>repo</code> 仓库解析出<code>chart</code> 的结构信息</li>
<li><code>helm</code> 客户端指定的<code>chart</code>结构和<code>values</code> 信息通过<code>gRPC</code>传递给<code>Tiller</code></li>
<li><code>Tiller</code>服务器根据<code>chart</code> 和<code>values</code> 生成一个<code>release</code></li>
<li><code>Tiller</code> 将<code>delete release</code> 请求直接传递给<code>api-server</code></li>
</ol>
<p><strong>更新<code>release</code></strong></p>
<ol>
<li><code>helm</code> 客户端将需要更新的<code>chart</code> 的<code>release</code> 名称、<code>chart</code>结构和<code>values</code> 信息传给<code>Tiller</code></li>
<li><code>Tiller</code> 将收到信息生成新的<code>release</code>,并同时更新这个<code>release</code> 的<code>historty</code></li>
<li><code>Tiller</code>  将新的<code>release</code> 传递给<code>kube-apiserver</code>  进行更新</li>
</ol>
<h4 id="3-1-6-安装Helm"><a href="#3-1-6-安装Helm" class="headerlink" title="3.1.6 安装Helm"></a>3.1.6 安装<code>Helm</code></h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://github.com/helm/helm/releases">https://github.com/helm/helm/releases</a></p>
</blockquote>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 放到k8s 集群master节点</span>

<span class="token comment" spellcheck="true">## 解压</span>
<span class="token function">tar</span> -zxvf helm-v2.13.1-linux-amd64.tar.gz
<span class="token comment" spellcheck="true">#  复制helm 二进制到bin目录下, 并且配置环境变量</span>
<span class="token function">cp</span> linux-amd64/helm /usr/local/bin/
<span class="token function">export</span> PATH<span class="token operator">=</span><span class="token variable">$PATH</span>:/usr/local/bin

<span class="token comment" spellcheck="true">#  查看是否安装成功</span>
helm version
<span class="token punctuation">[</span>
Client: <span class="token operator">&amp;</span>version.Version<span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;SemVer:"v2.13.1",</span>
GitCommit:<span class="token string">"618447cbf203d147601b4b9bd7f8c37a5d39fbb4"</span>, GitTreeState:<span class="token string">"clean"</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;</span>
Error: could not <span class="token function">find</span> tiller
<span class="token punctuation">]</span>
</code></pre>
<h4 id="3-1-7-安装Tiller"><a href="#3-1-7-安装Tiller" class="headerlink" title="3.1.7 安装Tiller"></a>3.1.7 安装<code>Tiller</code></h4><p>重新安装<code>tiller</code>: <code>helm reset -f </code></p>
<ol>
<li><p>安装<code>tiller</code></p>
<pre class=" language-bash"><code class="language-bash">helm init --upgrade -i registry.cnhangzhou.aliyuncs.com/google_containers/tiller:v2.13.1 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts
</code></pre>
<pre class=" language-bash"><code class="language-bash">kubectl get pods -n kube-system -l app<span class="token operator">=</span>helm
kubectl get svc -n kube-system -l app<span class="token operator">=</span>helm
</code></pre>
</li>
<li><p>配置<code>rbac</code></p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">></span>helm-rbac-config.yaml<span class="token operator">&lt;&lt;</span><span class="token string">EOF
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tiller
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: tiller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
  - kind: ServiceAccount
    name: tiller
    namespace: kube-system
EOF</span>
kubectl create -f helm-rbac-config.yaml

<span class="token comment" spellcheck="true"># 配置tiller使用创建的ServiceAccount</span>
kubectl patch deploy --namespace kube-system tiller-deploy -p <span class="token string">'&amp;#123;"spec":&amp;#123;"template":&amp;#123;"spec":&amp;#123;"serviceAccount":"tiller"&amp;#125;&amp;#125;&amp;#125;&amp;#125;'</span>
</code></pre>
</li>
<li><p>验证</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 查看pod启动情况</span>
kubectl get pod -n kube-system -l app<span class="token operator">=</span>helm
<span class="token comment" spellcheck="true"># 再次查看版本，显示出server版本</span>
helm version
<span class="token punctuation">[</span>
Client: <span class="token operator">&amp;</span>version.Version<span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;SemVer:"v2.13.1",</span>
GitCommit:<span class="token string">"618447cbf203d147601b4b9bd7f8c37a5d39fbb4"</span>, GitTreeState:<span class="token string">"clean"</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;</span>
Server: <span class="token operator">&amp;</span>version.Version<span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;SemVer:"v2.13.1",</span>
GitCommit:<span class="token string">"618447cbf203d147601b4b9bd7f8c37a5d39fbb4"</span>, GitTreeState:<span class="token string">"clean"</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;</span>
<span class="token punctuation">]</span>
</code></pre>
</li>
</ol>
<h4 id="3-1-8-使用Helm-操作-chart"><a href="#3-1-8-使用Helm-操作-chart" class="headerlink" title="3.1.8 使用Helm 操作`chart``"></a>3.1.8 使用<code>Helm</code> 操作`chart``</h4><pre class=" language-bash"><code class="language-bash">helm create:创建一个chart模板，比如：helm create <span class="token function">test</span> ---<span class="token operator">></span>ls <span class="token function">test</span>
helm package:打包一个chart模板，比如：helm package <span class="token function">test</span> ---<span class="token operator">></span>test-0.1.0.tgz
heml search:查找可用的chart模板，比如：helm search nginx
helm inspect:查看指定chart的基本信息，比如：helm inspect <span class="token function">test</span>
helm install:根据指定的chart部署一个release到k8s集群，比如：helm <span class="token function">install</span> <span class="token function">test</span> ---
<span class="token operator">></span>get pods
</code></pre>
<h4 id="3-1-9-chart-模板"><a href="#3-1-9-chart-模板" class="headerlink" title="3.1.9 chart 模板"></a>3.1.9 <code>chart</code> 模板</h4><ul>
<li><p><code>chart</code> 文件结构</p>
<pre class=" language-text"><code class="language-text">wordpress
├── charts # 存放chart的定义
├── Chart.yaml # 包含chart信息的yaml文件，如chart的版本、名称等
├── README.md # chart的介绍信息
├── requirements.lock
├── requirements.yaml # chart需要的依赖
├── templates # k8s需要的资源
│ ├── deployment.yaml
│ ├── externaldb-secrets.yaml
│ ├── _helpers.tpl # 存放可重用的模板片段
│ ├── ingress.yaml
│ ├── NOTES.txt
│ ├── pvc.yaml
│ ├── secrets.yaml
│ ├── svc.yaml
│ └── tls-secrets.yaml
└── values.yaml # 当前chart的默认配置的值
</code></pre>
</li>
</ul>
<h3 id="3-2-使用helm-安装Istio"><a href="#3-2-使用helm-安装Istio" class="headerlink" title="3.2  使用helm 安装Istio"></a>3.2  使用<code>helm</code> 安装<code>Istio</code></h3><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/setup/install/helm/">https://istio.io/docs/setup/install/helm/</a></p>
</blockquote>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">luyanan</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://rainsoil.github.io/2022/01/04/service-mesh/istio-jia-gou-yuan-li-he-shi-zhan-2/">https://rainsoil.github.io/2022/01/04/service-mesh/istio-jia-gou-yuan-li-he-shi-zhan-2/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">luyanan</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/01/04/service-mesh/service-mesh-chu-ru-men-1/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="Service Mesh初入门(1)">
                        
                        <span class="card-title">Service Mesh初入门(1)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-01-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Service-Mesh/" class="post-category">
                                    Service Mesh
                                </a>
                            
                            <a href="/categories/Service-Mesh/Service-Mesh/" class="post-category">
                                    Service Mesh
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/01/04/spring-boot/springboot2.x-zhong-wen-pei-zhi-can-kao-zhi-nan/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/19.jpg" class="responsive-img" alt="SpringBoot2">
                        
                        <span class="card-title">SpringBoot2</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-01-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Spring-Boot/" class="post-category">
                                    Spring Boot
                                </a>
                            
                            <a href="/categories/Spring-Boot/Spring-Boot/" class="post-category">
                                    Spring Boot
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <a href="/about" target="_blank">luyanan</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">803.3k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/rainsoil" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:luyanan0718@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=914596513" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 914596513" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
