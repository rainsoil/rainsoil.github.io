<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="zookeeper之watcher原理分析, railsoil">
    <meta name="description" content="zookeeper原理之watcher源码分析watcher 的基本流程zookeeper 的watcher 机制, 总的来说分为三个过程: 客户端注册watcher、服务端处理watcher和客户端回调watcher . 
基于zk客户端">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>zookeeper之watcher原理分析 | railsoil</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="railsoil" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">railsoil</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">railsoil</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/22.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">zookeeper之watcher原理分析</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/zookpeer/" class="post-category">
                                zookpeer
                            </a>
                        
                            <a href="/categories/zookpeer/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="post-category">
                                微服务
                            </a>
                        
                            <a href="/categories/zookpeer/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="post-category">
                                微服务
                            </a>
                        
                            <a href="/categories/zookpeer/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1/zookpeer/" class="post-category">
                                zookpeer
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-01-04
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    8.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    44 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="zookeeper原理之watcher源码分析"><a href="#zookeeper原理之watcher源码分析" class="headerlink" title="zookeeper原理之watcher源码分析"></a>zookeeper原理之watcher源码分析</h1><h2 id="watcher-的基本流程"><a href="#watcher-的基本流程" class="headerlink" title="watcher 的基本流程"></a>watcher 的基本流程</h2><p>zookeeper 的watcher 机制, 总的来说分为三个过程: 客户端注册watcher、服务端处理watcher和客户端回调watcher . </p>
<h2 id="基于zk客户端发起一个数据操作"><a href="#基于zk客户端发起一个数据操作" class="headerlink" title="基于zk客户端发起一个数据操作"></a>基于zk客户端发起一个数据操作</h2><pre class=" language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> KeeperException<span class="token punctuation">,</span> InterruptedException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        ZooKeeper zooKeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">"192.168.9.22:2181"</span><span class="token punctuation">,</span>
                <span class="token number">4000</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>WatchedEvent watchedEvent<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"event.type:"</span> <span class="token operator">+</span> watchedEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String path <span class="token operator">=</span> <span class="token string">"/watcher"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//  创建节点</span>
        zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ZooDefs<span class="token punctuation">.</span>Ids<span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> CreateMode<span class="token punctuation">.</span>PERSISTENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//  注册监听</span>
        zooKeeper<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 修改节点的值触发监听</span>
        zooKeeper<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>在创建一个zookeeper 客户端对象实例的时候. 我们通过<code>new Watcher</code> 向构造方法中传入一个默认的watcher, 这个watcher 将作为整个整个zookeeper 会话期间默认的watcher,会一直被保存在客户端 ZKWatchManager  的 defaultWatcher 中, 代码如下: </p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token function">ZooKeeper</span><span class="token punctuation">(</span>String connectString<span class="token punctuation">,</span> <span class="token keyword">int</span> sessionTimeout<span class="token punctuation">,</span> Watcher watcher<span class="token punctuation">,</span> <span class="token keyword">boolean</span> canBeReadOnly<span class="token punctuation">,</span> HostProvider aHostProvider<span class="token punctuation">,</span> ZKClientConfig clientConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Initiating client connection, connectString="</span> <span class="token operator">+</span> connectString <span class="token operator">+</span> <span class="token string">" sessionTimeout="</span> <span class="token operator">+</span> sessionTimeout <span class="token operator">+</span> <span class="token string">" watcher="</span> <span class="token operator">+</span> watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientConfig <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            clientConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZKClientConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>clientConfig <span class="token operator">=</span> clientConfig<span class="token punctuation">;</span>
     
        <span class="token keyword">this</span><span class="token punctuation">.</span>watchManager <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">defaultWatchManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">// 这里将watcher 设置到ZKWatchManager  </span>
     <span class="token keyword">this</span><span class="token punctuation">.</span>watchManager<span class="token punctuation">.</span>defaultWatcher <span class="token operator">=</span> watcher<span class="token punctuation">;</span>
        ConnectStringParser connectStringParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectStringParser</span><span class="token punctuation">(</span>connectString<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hostProvider <span class="token operator">=</span> aHostProvider<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cnxn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientCnxn</span><span class="token punctuation">(</span>connectStringParser<span class="token punctuation">.</span><span class="token function">getChrootPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hostProvider<span class="token punctuation">,</span> sessionTimeout<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>watchManager<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClientCnxnSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> canBeReadOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cnxn<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p> ClientCnxn : 是zookeeper 客户端和zookeeper 服务端进行通信和事件通知处理的主要类, 它主要包含两个类: </p>
<ul>
<li> SendThread : 负责客户端和服务端的数据通信, 也包括事件信息的传输</li>
<li> EventThread : 主要在客户端回调注册的watcher 进行通知处理. </li>
</ul>
<h2 id="ClientCnxn-初始化"><a href="#ClientCnxn-初始化" class="headerlink" title="ClientCnxn  初始化"></a>ClientCnxn  初始化</h2><pre class=" language-java"><code class="language-java">
    <span class="token keyword">public</span> <span class="token function">ClientCnxn</span><span class="token punctuation">(</span>String chrootPath<span class="token punctuation">,</span> HostProvider hostProvider<span class="token punctuation">,</span> <span class="token keyword">int</span> sessionTimeout<span class="token punctuation">,</span> ZooKeeper zooKeeper<span class="token punctuation">,</span> ClientWatchManager watcher<span class="token punctuation">,</span> ClientCnxnSocket clientCnxnSocket<span class="token punctuation">,</span> <span class="token keyword">long</span> sessionId<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sessionPasswd<span class="token punctuation">,</span> <span class="token keyword">boolean</span> canBeReadOnly<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArraySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pendingQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>outgoingQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sessionPasswd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>closing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>seenRwServerBefore <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventOfDeath <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>xid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> States<span class="token punctuation">.</span>NOT_CONNECTED<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>zooKeeper <span class="token operator">=</span> zooKeeper<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>watcher <span class="token operator">=</span> watcher<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sessionId <span class="token operator">=</span> sessionId<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sessionPasswd <span class="token operator">=</span> sessionPasswd<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sessionTimeout <span class="token operator">=</span> sessionTimeout<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hostProvider <span class="token operator">=</span> hostProvider<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chrootPath <span class="token operator">=</span> chrootPath<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>connectTimeout <span class="token operator">=</span> sessionTimeout <span class="token operator">/</span> hostProvider<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>readTimeout <span class="token operator">=</span> sessionTimeout <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>readOnly <span class="token operator">=</span> canBeReadOnly<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//初始化sendThread</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sendThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientCnxn<span class="token punctuation">.</span>SendThread</span><span class="token punctuation">(</span>clientCnxnSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 初始化eventThread</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientCnxn<span class="token punctuation">.</span>EventThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clientConfig <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">getClientConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 启动两个线程</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sendThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="服务端接收请求处理流程"><a href="#服务端接收请求处理流程" class="headerlink" title="服务端接收请求处理流程"></a>服务端接收请求处理流程</h2><p>服务端有一个 NIOServerCnxn  类, 有来处理客户端发送过来的请求 </p>
<h3 id="NIOServerCnxn"><a href="#NIOServerCnxn" class="headerlink" title="NIOServerCnxn"></a>NIOServerCnxn</h3><h4 id="ZookeeperServer-processPacket-this-bb"><a href="#ZookeeperServer-processPacket-this-bb" class="headerlink" title="ZookeeperServer.processPacket(this, bb);"></a>ZookeeperServer.processPacket(this, bb);</h4><pre class=" language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processPacket</span><span class="token punctuation">(</span>ServerCnxn cnxn<span class="token punctuation">,</span> ByteBuffer incomingBuffer<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// We have the request, now process and setup for next</span>
        InputStream bais <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteBufferInputStream</span><span class="token punctuation">(</span>incomingBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        BinaryInputArchive bia <span class="token operator">=</span> BinaryInputArchive<span class="token punctuation">.</span><span class="token function">getArchive</span><span class="token punctuation">(</span>bais<span class="token punctuation">)</span><span class="token punctuation">;</span>
        RequestHeader h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        h<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>bia<span class="token punctuation">,</span> <span class="token string">"header"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Through the magic of byte buffers, txn will not be</span>
        <span class="token comment" spellcheck="true">// pointing</span>
        <span class="token comment" spellcheck="true">// to the start of the txn</span>
        incomingBuffer <span class="token operator">=</span> incomingBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 判断当前操作类型, 如果是auth操作, 就直接以下代码</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> OpCode<span class="token punctuation">.</span>auth<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"got auth packet "</span> <span class="token operator">+</span> cnxn<span class="token punctuation">.</span><span class="token function">getRemoteSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            AuthPacket authPacket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ByteBufferInputStream<span class="token punctuation">.</span><span class="token function">byteBuffer2Record</span><span class="token punctuation">(</span>incomingBuffer<span class="token punctuation">,</span> authPacket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            String scheme <span class="token operator">=</span> authPacket<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            AuthenticationProvider ap <span class="token operator">=</span> ProviderRegistry<span class="token punctuation">.</span><span class="token function">getProvider</span><span class="token punctuation">(</span>scheme<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Code authReturn <span class="token operator">=</span> KeeperException<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>AUTHFAILED<span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ap <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    authReturn <span class="token operator">=</span> ap<span class="token punctuation">.</span><span class="token function">handleAuthentication</span><span class="token punctuation">(</span>cnxn<span class="token punctuation">,</span> authPacket<span class="token punctuation">.</span><span class="token function">getAuth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>RuntimeException e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Caught runtime exception from AuthenticationProvider: "</span> <span class="token operator">+</span> scheme <span class="token operator">+</span> <span class="token string">" due to "</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    authReturn <span class="token operator">=</span> KeeperException<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>AUTHFAILED<span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>authReturn<span class="token operator">!=</span> KeeperException<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>OK<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ap <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"No authentication provider for scheme: "</span>
                            <span class="token operator">+</span> scheme <span class="token operator">+</span> <span class="token string">" has "</span>
                            <span class="token operator">+</span> ProviderRegistry<span class="token punctuation">.</span><span class="token function">listProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Authentication failed for scheme: "</span> <span class="token operator">+</span> scheme<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// send a response...</span>
                ReplyHeader rh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReplyHeader</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                        KeeperException<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>AUTHFAILED<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cnxn<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>rh<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ... and close connection</span>
                cnxn<span class="token punctuation">.</span><span class="token function">sendBuffer</span><span class="token punctuation">(</span>ServerCnxnFactory<span class="token punctuation">.</span>closeConn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cnxn<span class="token punctuation">.</span><span class="token function">disableRecv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Authentication succeeded for scheme: "</span>
                              <span class="token operator">+</span> scheme<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"auth success "</span> <span class="token operator">+</span> cnxn<span class="token punctuation">.</span><span class="token function">getRemoteSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ReplyHeader rh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReplyHeader</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                        KeeperException<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cnxn<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>rh<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> OpCode<span class="token punctuation">.</span>sasl<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                Record rsp <span class="token operator">=</span> <span class="token function">processSasl</span><span class="token punctuation">(</span>incomingBuffer<span class="token punctuation">,</span>cnxn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ReplyHeader rh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReplyHeader</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> KeeperException<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cnxn<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>rh<span class="token punctuation">,</span>rsp<span class="token punctuation">,</span> <span class="token string">"response"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// not sure about 3rd arg..what is it?</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//  最终进入这个代码块进行处理</span>
                <span class="token comment" spellcheck="true">// 封装请求对象</span>
                Request si <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span>cnxn<span class="token punctuation">,</span> cnxn<span class="token punctuation">.</span><span class="token function">getSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> h<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  h<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> incomingBuffer<span class="token punctuation">,</span> cnxn<span class="token punctuation">.</span><span class="token function">getAuthInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                si<span class="token punctuation">.</span><span class="token function">setOwner</span><span class="token punctuation">(</span>ServerCnxn<span class="token punctuation">.</span>me<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">submitRequest</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        cnxn<span class="token punctuation">.</span><span class="token function">incrOutstandingRequests</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="submitRequest"><a href="#submitRequest" class="headerlink" title="submitRequest"></a>submitRequest</h4><p>负责在服务端提交当前请求. </p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submitRequest</span><span class="token punctuation">(</span>Request si<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>firstProcessor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// Since all requests are passed to the request</span>
                    <span class="token comment" spellcheck="true">// processor it should wait for setting up the request</span>
                    <span class="token comment" spellcheck="true">// processor chain. The state will be updated to RUNNING</span>
                    <span class="token comment" spellcheck="true">// after the setup.</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> State<span class="token punctuation">.</span>INITIAL<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Unexpected interruption"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>firstProcessor <span class="token operator">==</span> null <span class="token operator">||</span> state <span class="token operator">!=</span> State<span class="token punctuation">.</span>RUNNING<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Not started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">touch</span><span class="token punctuation">(</span>si<span class="token punctuation">.</span>cnxn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 判断是否合法</span>
            <span class="token keyword">boolean</span> validpacket <span class="token operator">=</span> Request<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span>si<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>validpacket<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 调用firstProcessor 发起请求, firstProcessor 是一个接口, 有多个实现类, </span>
                firstProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token punctuation">.</span>cnxn <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">incInProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Received packet at server of unknown type "</span> <span class="token operator">+</span> si<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">new</span> <span class="token class-name">UnimplementedRequestProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MissingSessionException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Dropping request: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RequestProcessorException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Unable to process request:"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="firstProcessor-请求链组成"><a href="#firstProcessor-请求链组成" class="headerlink" title="firstProcessor  请求链组成"></a>firstProcessor  请求链组成</h4><p> firstProcessor  的初始化是在 ZookeeperServer  的 setupRequestProcessor  中完成的, 代码如下: </p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setupRequestProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        RequestProcessor finalProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        RequestProcessor syncProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>
                finalProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>SyncRequestProcessor<span class="token punctuation">)</span>syncProcessor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        firstProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrepRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> syncProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>PrepRequestProcessor<span class="token punctuation">)</span>firstProcessor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>从上面我们可以看到     firstProcessor  的实例是一个PrepRequestProcessor, 而这个构造方法中又传递到了一个Processor 构成一个调用链. </p>
<p> RequestProcessor syncProcessor = new SyncRequestProcessor(this,  finalProcessor); </p>
<p>而syncProcessor  的构造方法传递的又是一个Processor , 对应的是 FinalRequestProcessor . </p>
<p>所以整个调用链是 PrepRequestProcessor -&gt; SyncRequestProcessor - &gt;FinalRequestProcessor </p>
<h4 id="PredRequestProcessor-processRequest-si"><a href="#PredRequestProcessor-processRequest-si" class="headerlink" title="PredRequestProcessor.processRequest(si);"></a>PredRequestProcessor.processRequest(si);</h4><p>通过上面了解到调用链关系后, 我们继续往下看  firstProcessor.processRequest(si)； , 会调用到 PrepRequestProcessor . </p>
<pre class=" language-java"><code class="language-java">   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// request.addRQRec(">prep="+zks.outstandingChanges.size());</span>
        submittedRequests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p> processRequest  只是把request 添加到 submittedRequests  中, 这是一个异步操作,  submittedRequests  是一个阻塞队列. </p>
<blockquote>
<pre><code>LinkedBlockingQueue&lt;Request&gt; submittedRequests = new LinkedBlockingQueue&lt;Request&gt;();
</code></pre>
</blockquote>
<p>而 PrepRequestProcessor  这个类又继承了线程类, 因此我们直接找到当前类中的run方法如下: </p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                Request request <span class="token operator">=</span> submittedRequests<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">long</span> traceMask <span class="token operator">=</span> ZooTrace<span class="token punctuation">.</span>CLIENT_REQUEST_TRACE_MASK<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>type <span class="token operator">==</span> OpCode<span class="token punctuation">.</span>ping<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    traceMask <span class="token operator">=</span> ZooTrace<span class="token punctuation">.</span>CLIENT_PING_TRACE_MASK<span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    ZooTrace<span class="token punctuation">.</span><span class="token function">logRequest</span><span class="token punctuation">(</span>LOG<span class="token punctuation">,</span> traceMask<span class="token punctuation">,</span> <span class="token string">'P'</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Request<span class="token punctuation">.</span>requestOfDeath <span class="token operator">==</span> request<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token function">pRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RequestProcessorException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">XidRolloverException</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">handleException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">handleException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"PrepRequestProcessor exited loop!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="pRequest"><a href="#pRequest" class="headerlink" title="pRequest"></a>pRequest</h4><pre class=" language-java"><code class="language-java">  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">pRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token keyword">throws</span> RequestProcessorException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// LOG.info("Prep>>> cxid = " + request.cxid + " type = " +</span>
        <span class="token comment" spellcheck="true">// request.type + " id = 0x" + Long.toHexString(request.sessionId));</span>
        request<span class="token punctuation">.</span>hdr <span class="token operator">=</span> null<span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>txn <span class="token operator">=</span> null<span class="token punctuation">;</span>
        
        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>create<span class="token operator">:</span>
                CreateRequest createRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">pRequest2Txn</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>type<span class="token punctuation">,</span> zks<span class="token punctuation">.</span><span class="token function">getNextZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> createRequest<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>delete<span class="token operator">:</span>
                DeleteRequest deleteRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               
                <span class="token function">pRequest2Txn</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>type<span class="token punctuation">,</span> zks<span class="token punctuation">.</span><span class="token function">getNextZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> deleteRequest<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>setData<span class="token operator">:</span>
                SetDataRequest setDataRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SetDataRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                
                <span class="token function">pRequest2Txn</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>type<span class="token punctuation">,</span> zks<span class="token punctuation">.</span><span class="token function">getNextZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> setDataRequest<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>setACL<span class="token operator">:</span>
                SetACLRequest setAclRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SetACLRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                
                <span class="token function">pRequest2Txn</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>type<span class="token punctuation">,</span> zks<span class="token punctuation">.</span><span class="token function">getNextZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> setAclRequest<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>check<span class="token operator">:</span>
                CheckVersionRequest checkRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CheckVersionRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              
                <span class="token function">pRequest2Txn</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>type<span class="token punctuation">,</span> zks<span class="token punctuation">.</span><span class="token function">getNextZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> checkRequest<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>multi<span class="token operator">:</span>
                MultiTransactionRecord multiRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MultiTransactionRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    ByteBufferInputStream<span class="token punctuation">.</span><span class="token function">byteBuffer2Record</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>request<span class="token punctuation">,</span> multiRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    request<span class="token punctuation">.</span>hdr <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">TxnHeader</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span> request<span class="token punctuation">.</span>cxid<span class="token punctuation">,</span> zks<span class="token punctuation">.</span><span class="token function">getNextZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            Time<span class="token punctuation">.</span><span class="token function">currentWallTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> OpCode<span class="token punctuation">.</span>multi<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                List<span class="token operator">&lt;</span>Txn<span class="token operator">></span> txns <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Txn<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//Each op in a multi-op must have the same zxid!</span>
                <span class="token keyword">long</span> zxid <span class="token operator">=</span> zks<span class="token punctuation">.</span><span class="token function">getNextZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                KeeperException ke <span class="token operator">=</span> null<span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">//Store off current pending change records in case we need to rollback</span>
                HashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ChangeRecord<span class="token operator">></span> pendingChanges <span class="token operator">=</span> <span class="token function">getPendingChanges</span><span class="token punctuation">(</span>multiRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span>Op op<span class="token operator">:</span> multiRequest<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    Record subrequest <span class="token operator">=</span> op<span class="token punctuation">.</span><span class="token function">toRequestRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>

                    <span class="token comment" spellcheck="true">/* If we've already failed one of the ops, don't bother
                     * trying the rest as we know it's going to fail and it
                     * would be confusing in the logfiles.
                     */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ke <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        request<span class="token punctuation">.</span>hdr<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>OpCode<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        request<span class="token punctuation">.</span>txn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorTxn</span><span class="token punctuation">(</span>Code<span class="token punctuation">.</span>RUNTIMEINCONSISTENCY<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> 
                    
                    <span class="token comment" spellcheck="true">/* Prep the request and convert to a Txn */</span>
                    <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            <span class="token function">pRequest2Txn</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> zxid<span class="token punctuation">,</span> request<span class="token punctuation">,</span> subrequest<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            ke <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            request<span class="token punctuation">.</span>hdr<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>OpCode<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            request<span class="token punctuation">.</span>txn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorTxn</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Got user-level KeeperException when processing "</span>
                                    <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" aborting remaining multi ops."</span>
                                    <span class="token operator">+</span> <span class="token string">" Error Path:"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token operator">+</span> <span class="token string">" Error:"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            request<span class="token punctuation">.</span><span class="token function">setException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token comment" spellcheck="true">/* Rollback change records from failed multi-op */</span>
                            <span class="token function">rollbackPendingChanges</span><span class="token punctuation">(</span>zxid<span class="token punctuation">,</span> pendingChanges<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                    <span class="token comment" spellcheck="true">//FIXME: I don't want to have to serialize it here and then</span>
                    <span class="token comment" spellcheck="true">//       immediately deserialize in next processor. But I'm </span>
                    <span class="token comment" spellcheck="true">//       not sure how else to get the txn stored into our list.</span>
                    ByteArrayOutputStream baos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    BinaryOutputArchive boa <span class="token operator">=</span> BinaryOutputArchive<span class="token punctuation">.</span><span class="token function">getArchive</span><span class="token punctuation">(</span>baos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    request<span class="token punctuation">.</span>txn<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>boa<span class="token punctuation">,</span> <span class="token string">"request"</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
                    ByteBuffer bb <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>baos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    txns<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Txn</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>hdr<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bb<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    index<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                request<span class="token punctuation">.</span>hdr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TxnHeader</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span> request<span class="token punctuation">.</span>cxid<span class="token punctuation">,</span> zxid<span class="token punctuation">,</span>
                        Time<span class="token punctuation">.</span><span class="token function">currentWallTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                request<span class="token punctuation">.</span>txn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MultiTxn</span><span class="token punctuation">(</span>txns<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//create/close session don't require request record</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>createSession<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>closeSession<span class="token operator">:</span>
                <span class="token function">pRequest2Txn</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>type<span class="token punctuation">,</span> zks<span class="token punctuation">.</span><span class="token function">getNextZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
 
            <span class="token comment" spellcheck="true">//All the rest don't need to create a Txn - just verify session</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>sync<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>exists<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>getData<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>getACL<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>getChildren<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>getChildren2<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>ping<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>setWatches<span class="token operator">:</span>
                zks<span class="token punctuation">.</span>sessionTracker<span class="token punctuation">.</span><span class="token function">checkSession</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span>
                        request<span class="token punctuation">.</span><span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"unknown type "</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>hdr <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                request<span class="token punctuation">.</span>hdr<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>OpCode<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                request<span class="token punctuation">.</span>txn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorTxn</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Got user-level KeeperException when processing "</span>
                    <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">" Error Path:"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">" Error:"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// log at error level as we are returning a marshalling</span>
            <span class="token comment" spellcheck="true">// error to the user</span>
            LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Failed to process "</span> <span class="token operator">+</span> request<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

            StringBuilder sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ByteBuffer bb <span class="token operator">=</span> request<span class="token punctuation">.</span>request<span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>bb <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                bb<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>bb<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>bb<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"request buffer is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Dumping request buffer: 0x"</span> <span class="token operator">+</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>hdr <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                request<span class="token punctuation">.</span>hdr<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>OpCode<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                request<span class="token punctuation">.</span>txn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorTxn</span><span class="token punctuation">(</span>Code<span class="token punctuation">.</span>MARSHALLINGERROR<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>zxid <span class="token operator">=</span> zks<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nextProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>前面的N行代码都是根据当前的OP 类型进行判断和做相应的处理, 这个方法中的最后一行中, 我们会看到</p>
<blockquote>
<pre><code>nextProcessor.processRequest(request);
</code></pre>
</blockquote>
<h4 id="SyncRequestProcessor-processRequest"><a href="#SyncRequestProcessor-processRequest" class="headerlink" title="SyncRequestProcessor. processRequest"></a>SyncRequestProcessor. processRequest</h4><pre class=" language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// request.addRQRec(">sync");</span>
        queuedRequests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>这个方法的代码也是一样, 基于差异化操作, 把请求添加到queuedRequests中, 我们继续在当前类中找到run方法</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> logCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// we do this in an attempt to ensure that not all of the servers</span>
            <span class="token comment" spellcheck="true">// in the ensemble take a snapshot at the same time</span>
            <span class="token function">setRandRoll</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>snapCount<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                Request si <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>toFlush<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    si <span class="token operator">=</span> queuedRequests<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    si <span class="token operator">=</span> queuedRequests<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>si <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token function">flush</span><span class="token punctuation">(</span>toFlush<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>si <span class="token operator">==</span> requestOfDeath<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>si <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// track the number of records written to the log</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>zks<span class="token punctuation">.</span><span class="token function">getZKDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        logCount<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>logCount <span class="token operator">></span> <span class="token punctuation">(</span>snapCount <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> randRoll<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            <span class="token function">setRandRoll</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>snapCount<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// roll the log</span>
                            zks<span class="token punctuation">.</span><span class="token function">getZKDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rollLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// take a snapshot</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>snapInProcess <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> snapInProcess<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Too busy to snap, skipping"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                snapInProcess <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeperThread</span><span class="token punctuation">(</span><span class="token string">"Snapshot Thread"</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                            <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                                zks<span class="token punctuation">.</span><span class="token function">takeSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                                LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Unexpected exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
                                snapInProcess<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                            logCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>toFlush<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// optimization for read heavy workloads</span>
                        <span class="token comment" spellcheck="true">// iff this is a read, and there are no pending</span>
                        <span class="token comment" spellcheck="true">// flushes (writes), then just pass this to the next</span>
                        <span class="token comment" spellcheck="true">// processor</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProcessor <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            nextProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProcessor <span class="token keyword">instanceof</span> <span class="token class-name">Flushable</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                <span class="token punctuation">(</span><span class="token punctuation">(</span>Flushable<span class="token punctuation">)</span>nextProcessor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    toFlush<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>toFlush<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token function">flush</span><span class="token punctuation">(</span>toFlush<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">handleException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"SyncRequestProcessor exited!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="FinalRequestProcessor-processRequest"><a href="#FinalRequestProcessor-processRequest" class="headerlink" title="FinalRequestProcessor. processRequest"></a>FinalRequestProcessor. processRequest</h4><p> FinalRequestProcessor. processRequest  方法根据request方法中的操作更新内容中session 信息或者znode数据。 </p>
<p>这块代码又300行, 就不全部贴出来了, 我们直接定位到关键代码，根据客户端的OP 类型找到如下代码: </p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>exists<span class="token operator">:</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                lastOp <span class="token operator">=</span> <span class="token string">"EXIS"</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// TODO we need to figure out the security requirement for this!</span>
                <span class="token comment" spellcheck="true">// 反序列化(将byteBuffer反序列化为ExistsRequest, 这个就是我们在客户端请求的时候传过来的request对象)</span>
                ExistsRequest existsRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExistsRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ByteBufferInputStream<span class="token punctuation">.</span><span class="token function">byteBuffer2Record</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>request<span class="token punctuation">,</span>
                        existsRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                String path <span class="token operator">=</span> existsRequest<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'\0'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">KeeperException<span class="token punctuation">.</span>BadArgumentsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 终于找到一个很关键的代码, 判断请求的getwatch 是否存在, 如果存在,则传入 cnxn</span>
                <span class="token comment" spellcheck="true">// 对于exits 请求, 需要监听data 变化事件, 添加watch</span>
                Stat stat <span class="token operator">=</span> zks<span class="token punctuation">.</span><span class="token function">getZKDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">statNode</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> existsRequest
                        <span class="token punctuation">.</span><span class="token function">getWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> cnxn <span class="token operator">:</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 在服务端内存数据库中根据路径得到结果进行封装, 设置为ExistsResponse</span>
                rsp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExistsResponse</span><span class="token punctuation">(</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="客户端接收服务端处理完成的响应"><a href="#客户端接收服务端处理完成的响应" class="headerlink" title="客户端接收服务端处理完成的响应"></a>客户端接收服务端处理完成的响应</h2><p> ClientCnxnSocketNIO.doIO </p>
<p>服务端处理完成后, 会通过 NIOServerCnxn.sendResponse  发送返回的响应信息, 客户端会在 ClientCnxnSocketNIO.doIO  接收服务端的返回. 注意一下  SendThread.readResponse ,接收服务端的信息机进行读取. </p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">void</span> <span class="token function">doIO</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Packet<span class="token operator">></span> pendingQueue<span class="token punctuation">,</span> LinkedList<span class="token operator">&lt;</span>Packet<span class="token operator">></span> outgoingQueue<span class="token punctuation">,</span> ClientCnxn cnxn<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> InterruptedException<span class="token punctuation">,</span> IOException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        SocketChannel sock <span class="token operator">=</span> <span class="token punctuation">(</span>SocketChannel<span class="token punctuation">)</span> sockKey<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sock <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Socket is null!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sockKey<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> rc <span class="token operator">=</span> sock<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>incomingBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EndOfStreamException</span><span class="token punctuation">(</span>
                        <span class="token string">"Unable to read additional data from server sessionid 0x"</span>
                                <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">", likely server has closed socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>incomingBuffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                incomingBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>incomingBuffer <span class="token operator">==</span> lenBuffer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    recvCount<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token function">readLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>initialized<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">readConnectResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">enableRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">findSendablePacket</span><span class="token punctuation">(</span>outgoingQueue<span class="token punctuation">,</span>
                            cnxn<span class="token punctuation">.</span>sendThread<span class="token punctuation">.</span><span class="token function">clientTunneledAuthenticationInProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// Since SASL authentication has completed (if client is configured to do so),</span>
                        <span class="token comment" spellcheck="true">// outgoing packets waiting in the outgoingQueue can now be sent.</span>
                        <span class="token function">enableWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    lenBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    incomingBuffer <span class="token operator">=</span> lenBuffer<span class="token punctuation">;</span>
                    <span class="token function">updateLastHeard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    sendThread<span class="token punctuation">.</span><span class="token function">readResponse</span><span class="token punctuation">(</span>incomingBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    lenBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    incomingBuffer <span class="token operator">=</span> lenBuffer<span class="token punctuation">;</span>
                    <span class="token function">updateLastHeard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sockKey<span class="token punctuation">.</span><span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span><span class="token punctuation">(</span>outgoingQueue<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                Packet p <span class="token operator">=</span> <span class="token function">findSendablePacket</span><span class="token punctuation">(</span>outgoingQueue<span class="token punctuation">,</span>
                        cnxn<span class="token punctuation">.</span>sendThread<span class="token punctuation">.</span><span class="token function">clientTunneledAuthenticationInProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">updateLastSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// If we already started writing p, p.bb will already exist</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>bb <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>requestHeader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                                <span class="token punctuation">(</span>p<span class="token punctuation">.</span>requestHeader<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> OpCode<span class="token punctuation">.</span>ping<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                                <span class="token punctuation">(</span>p<span class="token punctuation">.</span>requestHeader<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> OpCode<span class="token punctuation">.</span>auth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            p<span class="token punctuation">.</span>requestHeader<span class="token punctuation">.</span><span class="token function">setXid</span><span class="token punctuation">(</span>cnxn<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                        p<span class="token punctuation">.</span><span class="token function">createBB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    sock<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>bb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">.</span>bb<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        sentCount<span class="token operator">++</span><span class="token punctuation">;</span>
                        outgoingQueue<span class="token punctuation">.</span><span class="token function">removeFirstOccurrence</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>requestHeader <span class="token operator">!=</span> null
                                <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>requestHeader<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> OpCode<span class="token punctuation">.</span>ping
                                <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>requestHeader<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> OpCode<span class="token punctuation">.</span>auth<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>pendingQueue<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                pendingQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>outgoingQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// No more packets to send: turn off write interest flag.</span>
                    <span class="token comment" spellcheck="true">// Will be turned on later by a later call to enableWrite(),</span>
                    <span class="token comment" spellcheck="true">// from within ZooKeeperSaslClient (if client is configured</span>
                    <span class="token comment" spellcheck="true">// to attempt SASL authentication), or in either doIO() or</span>
                    <span class="token comment" spellcheck="true">// in doTransport() if not.</span>
                    <span class="token function">disableWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>initialized <span class="token operator">&amp;&amp;</span> p <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>p<span class="token punctuation">.</span>bb<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// On initial connection, write the complete connect request</span>
                    <span class="token comment" spellcheck="true">// packet, but then disable further writes until after</span>
                    <span class="token comment" spellcheck="true">// receiving a successful connection response.  If the</span>
                    <span class="token comment" spellcheck="true">// session is expired, then the server sends the expiration</span>
                    <span class="token comment" spellcheck="true">// response and immediately closes its end of the socket.  If</span>
                    <span class="token comment" spellcheck="true">// the client is simultaneously writing on its end, then the</span>
                    <span class="token comment" spellcheck="true">// TCP stack may choose to abort with RST, in which case the</span>
                    <span class="token comment" spellcheck="true">// client would never receive the session expired event.  See</span>
                    <span class="token comment" spellcheck="true">// http://docs.oracle.com/javase/6/docs/technotes/guides/net/articles/connection_release.html</span>
                    <span class="token function">disableWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// Just in case</span>
                    <span class="token function">enableWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="SendThread-readResponse"><a href="#SendThread-readResponse" class="headerlink" title="SendThread. readResponse"></a>SendThread. readResponse</h4><p>这个方法里面主要流程如下: </p>
<ol>
<li>读取head, 如果其xid ==2, 表明是一个ping 的reponse,return</li>
<li>如果xid == 4,表明是一个 AuthPacket 的 response return </li>
<li>如果xid ==1, 表明是一个 notification , 此时要继续读取并构造一个event, 通过 EventThread.queueEvent , 并return.</li>
</ol>
<p>其他情况下:</p>
<p>从 pendingQueue  中拿出一个 Packet，校验后更新 packet 信息. </p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">void</span> <span class="token function">readResponse</span><span class="token punctuation">(</span>ByteBuffer incomingBuffer<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            ByteBufferInputStream bbis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteBufferInputStream</span><span class="token punctuation">(</span>
                    incomingBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            BinaryInputArchive bbia <span class="token operator">=</span> BinaryInputArchive<span class="token punctuation">.</span><span class="token function">getArchive</span><span class="token punctuation">(</span>bbis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ReplyHeader replyHdr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReplyHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 反序列化header</span>
            replyHdr<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>bbia<span class="token punctuation">,</span> <span class="token string">"header"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>replyHdr<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// -2 is the xid for pings</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Got ping response for sessionid: 0x"</span>
                            <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">" after "</span>
                            <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> lastPingSentNs<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000000</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>replyHdr<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// -4 is the xid for AuthPacket</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>replyHdr<span class="token punctuation">.</span><span class="token function">getErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> KeeperException<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>AUTHFAILED<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    state <span class="token operator">=</span> States<span class="token punctuation">.</span>AUTH_FAILED<span class="token punctuation">;</span>
                    eventThread<span class="token punctuation">.</span><span class="token function">queueEvent</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">WatchedEvent</span><span class="token punctuation">(</span>Watcher<span class="token punctuation">.</span>Event<span class="token punctuation">.</span>EventType<span class="token punctuation">.</span>None<span class="token punctuation">,</span>
                            Watcher<span class="token punctuation">.</span>Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>AuthFailed<span class="token punctuation">,</span> null<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Got auth sessionid:0x"</span>
                            <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 表示当前的消息类型为一个notification(意味着是服务端的一个响应事件)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>replyHdr<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// -1 means notification</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Got notification sessionid:0x"</span>
                        <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                WatcherEvent event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WatcherEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 反序列化响应信息</span>
                event<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>bbia<span class="token punctuation">,</span> <span class="token string">"response"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// convert from a server path to a client path</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>chrootPath <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    String serverPath <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>serverPath<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>chrootPath<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
                        event<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>serverPath<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> chrootPath<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        event<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span>serverPath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>chrootPath<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Got server path "</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">" which is too short for chroot path "</span>
                                <span class="token operator">+</span> chrootPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                WatchedEvent we <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WatchedEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Got "</span> <span class="token operator">+</span> we <span class="token operator">+</span> <span class="token string">" for sessionid 0x"</span>
                            <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                eventThread<span class="token punctuation">.</span><span class="token function">queueEvent</span><span class="token punctuation">(</span> we <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// If SASL authentication is currently in progress, construct and</span>
            <span class="token comment" spellcheck="true">// send a response packet immediately, rather than queuing a</span>
            <span class="token comment" spellcheck="true">// response as with other packets.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">clientTunneledAuthenticationInProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                GetSASLRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetSASLRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                request<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>bbia<span class="token punctuation">,</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                zooKeeperSaslClient<span class="token punctuation">.</span><span class="token function">respondToServer</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  ClientCnxn<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            Packet packet<span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>pendingQueue<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Nothing in the queue, but got "</span>
                            <span class="token operator">+</span> replyHdr<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 因为当前的数据包已经收到了响应,所以将他从pendingQueue 中移除了.</span>
                packet <span class="token operator">=</span> pendingQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/*
             * Since requests are processed in order, we better get a response
             * to the first request!
             */</span>
            <span class="token comment" spellcheck="true">// 校验 数据包信息, 校验成功后将数据包信息进行更新(替换为服务端信息)</span>
            <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>packet<span class="token punctuation">.</span>requestHeader<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> replyHdr<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    packet<span class="token punctuation">.</span>replyHeader<span class="token punctuation">.</span><span class="token function">setErr</span><span class="token punctuation">(</span>
                            KeeperException<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>CONNECTIONLOSS<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Xid out of order. Got Xid "</span>
                            <span class="token operator">+</span> replyHdr<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" with err "</span> <span class="token operator">+</span>
                            <span class="token operator">+</span> replyHdr<span class="token punctuation">.</span><span class="token function">getErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                            <span class="token string">" expected Xid "</span>
                            <span class="token operator">+</span> packet<span class="token punctuation">.</span>requestHeader<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">" for a packet with details: "</span>
                            <span class="token operator">+</span> packet <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                packet<span class="token punctuation">.</span>replyHeader<span class="token punctuation">.</span><span class="token function">setXid</span><span class="token punctuation">(</span>replyHdr<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                packet<span class="token punctuation">.</span>replyHeader<span class="token punctuation">.</span><span class="token function">setErr</span><span class="token punctuation">(</span>replyHdr<span class="token punctuation">.</span><span class="token function">getErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                packet<span class="token punctuation">.</span>replyHeader<span class="token punctuation">.</span><span class="token function">setZxid</span><span class="token punctuation">(</span>replyHdr<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>replyHdr<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    lastZxid <span class="token operator">=</span> replyHdr<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>packet<span class="token punctuation">.</span>response <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> replyHdr<span class="token punctuation">.</span><span class="token function">getErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 获取服务端的响应, 反序列化之后设置到packet.response 属性中, 所以我们可以在exits方法的最后一行中通过packet.response 拿到该请求的返回结果</span>
                    packet<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>bbia<span class="token punctuation">,</span> <span class="token string">"response"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Reading reply sessionid:0x"</span>
                            <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", packet:: "</span> <span class="token operator">+</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">finally</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 最后调用finishPacket 方法完成处理</span>
                <span class="token function">finishPacket</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="finishPacket-方法"><a href="#finishPacket-方法" class="headerlink" title="finishPacket 方法"></a>finishPacket 方法</h4><p>主要功能是把从packet 中取出对应的Watcher 注册到  ZKWatchManager  中. </p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">finishPacket</span><span class="token punctuation">(</span>Packet p<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>watchRegistration <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 将事件注册到 zkwatchermanage 中</span>
            <span class="token comment" spellcheck="true">// watchRegistration, 在组装请求的时候,我们初始化了这个对象, 把 watchRegistration 子类里面的</span>
            <span class="token comment" spellcheck="true">// watcher 实例放到了ZKWatcherMananage 的exists watches 中存储起来</span>
            p<span class="token punctuation">.</span>watchRegistration<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>replyHeader<span class="token punctuation">.</span><span class="token function">getErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// cb 就是AsnycCallback，如果为null, 表明是同步调用地方接口,不需要异步回调, 因为直接notifyAll</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>cb <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span>finished <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span>finished <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            eventThread<span class="token punctuation">.</span><span class="token function">queuePacket</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="watchRegistration-register"><a href="#watchRegistration-register" class="headerlink" title="watchRegistration.register"></a>watchRegistration.register</h4><pre class=" language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">int</span> rc<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldAddWatch</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 通过子类的实现取得 ZKWatchManager 中的 existsWatches</span>
                Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>Watcher<span class="token operator">>></span> watches <span class="token operator">=</span> <span class="token function">getWatches</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span><span class="token punctuation">(</span>watches<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    Set<span class="token operator">&lt;</span>Watcher<span class="token operator">></span> watchers <span class="token operator">=</span> watches<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>watchers <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        watchers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>Watcher<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        watches<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">,</span> watchers<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 将watcher 对象放到到 ZKWatchManager 中的 existsWatches 里面</span>
                    watchers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>下面这段代码是客户端存储watcher的几个map 集合, 分别对应三种注册监听事件. </p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ZKWatchManager</span> <span class="token keyword">implements</span> <span class="token class-name">ClientWatchManager</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>Watcher<span class="token operator">>></span> dataWatches <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>Watcher<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>Watcher<span class="token operator">>></span> existWatches <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>Watcher<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>Watcher<span class="token operator">>></span> childWatches <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>Watcher<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>总的来说, 当使用zookeeper 构造方法或者使用getData、exits和getChildren 三个接口来向zookeeper 服务器注册watcher 的时候, 首先将此消息传递给服务端, 传递成功后, 服务端会通知客户端, 然后客户端将该路径和watcher 对应关系存储起来备用. </p>
<h4 id="EventThread-queuePacket"><a href="#EventThread-queuePacket" class="headerlink" title="EventThread.queuePacket()"></a>EventThread.queuePacket()</h4><p> finishPacket  方法最终会调用 EventThread.queuePacket()    , 将当前的数据包添加到等待事件通知的队列中. </p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queuePacket</span><span class="token punctuation">(</span>Packet packet<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>wasKilled<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
             <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>waitingEvents<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isRunning<span class="token punctuation">)</span> waitingEvents<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token function">processEvent</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
          <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
             waitingEvents<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="事件触发"><a href="#事件触发" class="headerlink" title="事件触发"></a>事件触发</h2><p>通过那么长的说明, 只是为了清晰的说明事件的注册流程, 最终的触发, 还得需要通过事务性操作来完成. </p>
<p>在我们最开始的案例中,通过如下代码来完成事件的触发: </p>
<blockquote>
<p>zooKeeper.setData(path, “1”.getBytes(), -1);</p>
</blockquote>
<p>前面的客户端和服务端对戒的流程就不重复讲解了, 交互流程是一样的, 唯一的差别就是在于事件触发了. </p>
<h4 id="服务端的事件响应-DataTree-setData"><a href="#服务端的事件响应-DataTree-setData" class="headerlink" title="服务端的事件响应  DataTree.setData()"></a>服务端的事件响应  DataTree.setData()</h4><pre class=" language-java"><code class="language-java"> <span class="token keyword">public</span> Stat <span class="token function">setData</span><span class="token punctuation">(</span>String path<span class="token punctuation">,</span> <span class="token keyword">byte</span> data<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> version<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">,</span>
            <span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token keyword">throws</span> KeeperException<span class="token punctuation">.</span>NoNodeException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        Stat s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DataNode n <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">KeeperException<span class="token punctuation">.</span>NoNodeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span> lastdata<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            lastdata <span class="token operator">=</span> n<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
            n<span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
            n<span class="token punctuation">.</span>stat<span class="token punctuation">.</span><span class="token function">setMtime</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
            n<span class="token punctuation">.</span>stat<span class="token punctuation">.</span><span class="token function">setMzxid</span><span class="token punctuation">(</span>zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            n<span class="token punctuation">.</span>stat<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
            n<span class="token punctuation">.</span><span class="token function">copyStat</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// now update if the path is in a quota subtree.</span>
        String lastPrefix<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>lastPrefix <span class="token operator">=</span> <span class="token function">getMaxPrefixWithQuota</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateBytes</span><span class="token punctuation">(</span>lastPrefix<span class="token punctuation">,</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> data<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
              <span class="token operator">-</span> <span class="token punctuation">(</span>lastdata <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> lastdata<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 触发对应节点的NodeDataChanged 事件</span>
        dataWatches<span class="token punctuation">.</span><span class="token function">triggerWatch</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> EventType<span class="token punctuation">.</span>NodeDataChanged<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="WatcherManager-triggerWatch"><a href="#WatcherManager-triggerWatch" class="headerlink" title="WatcherManager. triggerWatch"></a>WatcherManager. triggerWatch</h4><pre class=" language-java"><code class="language-java"> <span class="token keyword">public</span> Set<span class="token operator">&lt;</span>Watcher<span class="token operator">></span> <span class="token function">triggerWatch</span><span class="token punctuation">(</span>String path<span class="token punctuation">,</span> EventType type<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">triggerWatch</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> type<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> Set<span class="token operator">&lt;</span>Watcher<span class="token operator">></span> <span class="token function">triggerWatch</span><span class="token punctuation">(</span>String path<span class="token punctuation">,</span> EventType type<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>Watcher<span class="token operator">></span> supress<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 根据事件类型、连接状态、节点路径创建WatchedEvent</span>
        WatchedEvent e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WatchedEvent</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span>
                KeeperState<span class="token punctuation">.</span>SyncConnected<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        HashSet<span class="token operator">&lt;</span>Watcher<span class="token operator">></span> watchers<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 从watcher 中移除path, 并返回其对应的watcher 集合.</span>
            watchers <span class="token operator">=</span> watchTable<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>watchers <span class="token operator">==</span> null <span class="token operator">||</span> watchers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    ZooTrace<span class="token punctuation">.</span><span class="token function">logTraceMessage</span><span class="token punctuation">(</span>LOG<span class="token punctuation">,</span>
                            ZooTrace<span class="token punctuation">.</span>EVENT_DELIVERY_TRACE_MASK<span class="token punctuation">,</span>
                            <span class="token string">"No watchers for "</span> <span class="token operator">+</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 遍历watcher 集合</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Watcher w <span class="token operator">:</span> watchers<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 根据watcher 从watcher 表中取出路径集合</span>
                HashSet<span class="token operator">&lt;</span>String<span class="token operator">></span> paths <span class="token operator">=</span> watch2Paths<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>paths <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 移除路径</span>
                    paths<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        
        <span class="token comment" spellcheck="true">//  遍历watcher 集合</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Watcher w <span class="token operator">:</span> watchers<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>supress <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> supress<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> watchers<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="w-process-e"><a href="#w-process-e" class="headerlink" title="w.process(e);"></a>w.process(e);</h4><p>还记得我们在服务端绑定事件的时候，watcher  绑定的是什么吗? 是 ServerCnxn，  所以w.process(e); , 其实就是调用的是 ServerCnxn  的process 方法, 而ServerCnxn 又是一个抽象方法, 分别是 NIOServerCnxn 和  NettyServerCnxn。那接下来我们扒开  NettyServerCnxn这个类的process 方法看看究竟. </p>
<pre class=" language-java"><code class="language-java">  <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>WatchedEvent event<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        ReplyHeader h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReplyHeader</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span>1L<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            ZooTrace<span class="token punctuation">.</span><span class="token function">logTraceMessage</span><span class="token punctuation">(</span>LOG<span class="token punctuation">,</span> ZooTrace<span class="token punctuation">.</span>EVENT_DELIVERY_TRACE_MASK<span class="token punctuation">,</span>
                                     <span class="token string">"Deliver event "</span> <span class="token operator">+</span> event <span class="token operator">+</span> <span class="token string">" to 0x"</span>
                                     <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sessionId<span class="token punctuation">)</span>
                                     <span class="token operator">+</span> <span class="token string">" through "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Convert WatchedEvent to a type that can be sent over the wire</span>
        WatcherEvent e <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 这个地方发送了一个事件,事件对象为WatchedEvent</span>
            <span class="token function">sendResponse</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token string">"notification"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e1<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Problem sending to "</span> <span class="token operator">+</span> <span class="token function">getRemoteSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>那接下来, 客户端会受到这个response, 触发SendThread.readResponse  方法</p>
<h3 id="客户端处理事件响应"><a href="#客户端处理事件响应" class="headerlink" title="客户端处理事件响应"></a>客户端处理事件响应</h3><h4 id="SendThread-readResponse-1"><a href="#SendThread-readResponse-1" class="headerlink" title="SendThread.readResponse"></a>SendThread.readResponse</h4><p>watcher.materializwatcher.materializ这块代码已经贴过了, 我们只挑选当前流程的代码进行讲解, 按照我们前面讲到的,  notifacation  通知消息的xid 为-1, u意味着直接找到-1的判断进行分析</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">void</span> <span class="token function">readResponse</span><span class="token punctuation">(</span>ByteBuffer incomingBuffer<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            ByteBufferInputStream bbis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteBufferInputStream</span><span class="token punctuation">(</span>
                    incomingBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            BinaryInputArchive bbia <span class="token operator">=</span> BinaryInputArchive<span class="token punctuation">.</span><span class="token function">getArchive</span><span class="token punctuation">(</span>bbis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ReplyHeader replyHdr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReplyHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 反序列化header</span>
            replyHdr<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>bbia<span class="token punctuation">,</span> <span class="token string">"header"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>replyHdr<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// -2 is the xid for pings</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Got ping response for sessionid: 0x"</span>
                            <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">" after "</span>
                            <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> lastPingSentNs<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000000</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>replyHdr<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// -4 is the xid for AuthPacket</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>replyHdr<span class="token punctuation">.</span><span class="token function">getErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> KeeperException<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>AUTHFAILED<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    state <span class="token operator">=</span> States<span class="token punctuation">.</span>AUTH_FAILED<span class="token punctuation">;</span>
                    eventThread<span class="token punctuation">.</span><span class="token function">queueEvent</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">WatchedEvent</span><span class="token punctuation">(</span>Watcher<span class="token punctuation">.</span>Event<span class="token punctuation">.</span>EventType<span class="token punctuation">.</span>None<span class="token punctuation">,</span>
                            Watcher<span class="token punctuation">.</span>Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>AuthFailed<span class="token punctuation">,</span> null<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Got auth sessionid:0x"</span>
                            <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 表示当前的消息类型为一个notification(意味着是服务端的一个响应事件)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>replyHdr<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// -1 means notification</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Got notification sessionid:0x"</span>
                        <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                WatcherEvent event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WatcherEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 反序列化响应信息</span>
                event<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>bbia<span class="token punctuation">,</span> <span class="token string">"response"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// convert from a server path to a client path</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>chrootPath <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    String serverPath <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>serverPath<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>chrootPath<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
                        event<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>serverPath<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> chrootPath<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        event<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span>serverPath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>chrootPath<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Got server path "</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">" which is too short for chroot path "</span>
                                <span class="token operator">+</span> chrootPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                WatchedEvent we <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WatchedEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Got "</span> <span class="token operator">+</span> we <span class="token operator">+</span> <span class="token string">" for sessionid 0x"</span>
                            <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                eventThread<span class="token punctuation">.</span><span class="token function">queueEvent</span><span class="token punctuation">(</span> we <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// If SASL authentication is currently in progress, construct and</span>
            <span class="token comment" spellcheck="true">// send a response packet immediately, rather than queuing a</span>
            <span class="token comment" spellcheck="true">// response as with other packets.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">clientTunneledAuthenticationInProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                GetSASLRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetSASLRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                request<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>bbia<span class="token punctuation">,</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                zooKeeperSaslClient<span class="token punctuation">.</span><span class="token function">respondToServer</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  ClientCnxn<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            Packet packet<span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>pendingQueue<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Nothing in the queue, but got "</span>
                            <span class="token operator">+</span> replyHdr<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 因为当前的数据包已经收到了响应,所以将他从pendingQueue 中移除了.</span>
                packet <span class="token operator">=</span> pendingQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/*
             * Since requests are processed in order, we better get a response
             * to the first request!
             */</span>
            <span class="token comment" spellcheck="true">// 校验 数据包信息, 校验成功后将数据包信息进行更新(替换为服务端信息)</span>
            <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>packet<span class="token punctuation">.</span>requestHeader<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> replyHdr<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    packet<span class="token punctuation">.</span>replyHeader<span class="token punctuation">.</span><span class="token function">setErr</span><span class="token punctuation">(</span>
                            KeeperException<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>CONNECTIONLOSS<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Xid out of order. Got Xid "</span>
                            <span class="token operator">+</span> replyHdr<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" with err "</span> <span class="token operator">+</span>
                            <span class="token operator">+</span> replyHdr<span class="token punctuation">.</span><span class="token function">getErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                            <span class="token string">" expected Xid "</span>
                            <span class="token operator">+</span> packet<span class="token punctuation">.</span>requestHeader<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">" for a packet with details: "</span>
                            <span class="token operator">+</span> packet <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                packet<span class="token punctuation">.</span>replyHeader<span class="token punctuation">.</span><span class="token function">setXid</span><span class="token punctuation">(</span>replyHdr<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                packet<span class="token punctuation">.</span>replyHeader<span class="token punctuation">.</span><span class="token function">setErr</span><span class="token punctuation">(</span>replyHdr<span class="token punctuation">.</span><span class="token function">getErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                packet<span class="token punctuation">.</span>replyHeader<span class="token punctuation">.</span><span class="token function">setZxid</span><span class="token punctuation">(</span>replyHdr<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>replyHdr<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    lastZxid <span class="token operator">=</span> replyHdr<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>packet<span class="token punctuation">.</span>response <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> replyHdr<span class="token punctuation">.</span><span class="token function">getErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 获取服务端的响应, 反序列化之后设置到packet.response 属性中, 所以我们可以在exits方法的最后一行中通过packet.response 拿到该请求的返回结果</span>
                    packet<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>bbia<span class="token punctuation">,</span> <span class="token string">"response"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Reading reply sessionid:0x"</span>
                            <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", packet:: "</span> <span class="token operator">+</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">finally</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 最后调用finishPacket 方法完成处理</span>
                <span class="token function">finishPacket</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="eventThread-queueEvent"><a href="#eventThread-queueEvent" class="headerlink" title="eventThread.queueEvent"></a>eventThread.queueEvent</h4><p> SendThread  接受到服务端的通知事件, 会通过调用 EventThread  类的queueEvent 方法将事件传给 EventThread 线程, queueEvent 方法根据该通知事件, 从 ZKWatchManager  中取出所有相关的watcher, 如果获取到相应的watcher, 就会让watcher 移除失效. </p>
<pre class=" language-java"><code class="language-java">   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queueEvent</span><span class="token punctuation">(</span>WatchedEvent event<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> EventType<span class="token punctuation">.</span>None
                    <span class="token operator">&amp;&amp;</span> sessionState <span class="token operator">==</span> event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 判断类型</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            sessionState <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// materialize the watchers based on the event</span>
            <span class="token comment" spellcheck="true">// 封装 WatcherSetEventPair 对象, 添加到waitingEvents 队列中</span>
            WatcherSetEventPair pair <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WatcherSetEventPair</span><span class="token punctuation">(</span>
                    watcher<span class="token punctuation">.</span><span class="token function">materialize</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            event<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// queue the pair (watch set &amp; event) for later processing</span>
            waitingEvents<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="watcher-materializ"><a href="#watcher-materializ" class="headerlink" title="watcher.materializ"></a>watcher.materializ</h4><p>通过  dataWatches 或者 existWatches 或者 childWatches 的 remove 取出对应的watch, 表明客户端watch 也是注册一次就移除. </p>
<p>同时需要根据 keeperState、eventType 和 path  返回应该被通知的watcher 集合. </p>
<pre class=" language-java"><code class="language-java"> <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> Set<span class="token operator">&lt;</span>Watcher<span class="token operator">></span> <span class="token function">materialize</span><span class="token punctuation">(</span>Watcher<span class="token punctuation">.</span>Event<span class="token punctuation">.</span>KeeperState state<span class="token punctuation">,</span>
                                        Watcher<span class="token punctuation">.</span>Event<span class="token punctuation">.</span>EventType type<span class="token punctuation">,</span>
                                        String clientPath<span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            Set<span class="token operator">&lt;</span>Watcher<span class="token operator">></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>Watcher<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> None<span class="token operator">:</span>
                result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>defaultWatcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> clear <span class="token operator">=</span> ClientCnxn<span class="token punctuation">.</span><span class="token function">getDisableAutoResetWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                        state <span class="token operator">!=</span> Watcher<span class="token punctuation">.</span>Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>SyncConnected<span class="token punctuation">;</span>

                <span class="token keyword">synchronized</span><span class="token punctuation">(</span>dataWatches<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span>Set<span class="token operator">&lt;</span>Watcher<span class="token operator">></span> ws<span class="token operator">:</span> dataWatches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        result<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>clear<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        dataWatches<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                <span class="token keyword">synchronized</span><span class="token punctuation">(</span>existWatches<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span>Set<span class="token operator">&lt;</span>Watcher<span class="token operator">></span> ws<span class="token operator">:</span> existWatches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        result<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>clear<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        existWatches<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                <span class="token keyword">synchronized</span><span class="token punctuation">(</span>childWatches<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span>Set<span class="token operator">&lt;</span>Watcher<span class="token operator">></span> ws<span class="token operator">:</span> childWatches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        result<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>clear<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        childWatches<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token keyword">case</span> NodeDataChanged<span class="token operator">:</span>
            <span class="token keyword">case</span> NodeCreated<span class="token operator">:</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataWatches<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">addTo</span><span class="token punctuation">(</span>dataWatches<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>existWatches<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">addTo</span><span class="token punctuation">(</span>existWatches<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> NodeChildrenChanged<span class="token operator">:</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>childWatches<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">addTo</span><span class="token punctuation">(</span>childWatches<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> NodeDeleted<span class="token operator">:</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataWatches<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">addTo</span><span class="token punctuation">(</span>dataWatches<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// XXX This shouldn't be needed, but just in case</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>existWatches<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    Set<span class="token operator">&lt;</span>Watcher<span class="token operator">></span> list <span class="token operator">=</span> existWatches<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token function">addTo</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"We are triggering an exists watch for delete! Shouldn't happen!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>childWatches<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">addTo</span><span class="token punctuation">(</span>childWatches<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                String msg <span class="token operator">=</span> <span class="token string">"Unhandled watch event type "</span> <span class="token operator">+</span> type
                    <span class="token operator">+</span> <span class="token string">" with state "</span> <span class="token operator">+</span> state <span class="token operator">+</span> <span class="token string">" on path "</span> <span class="token operator">+</span> clientPath<span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="waitingEvents-add"><a href="#waitingEvents-add" class="headerlink" title="waitingEvents.add"></a>waitingEvents.add</h4><p>最后一步, 接近真相了. </p>
<p>waitingEvents 是  EventThread  这个线程的祖寺啊队列, 很明显, 又是我们在第一步操作的时候实例化的一个线程. </p>
<p>从名字可以知道, waitingEvents  是一个待处理的watcher 的队列, EventThread   的run()  方法 会不断的从队列中取数据,交由  processEvent  方法处理</p>
<pre class=" language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
           <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
              isRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
              <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                  <span class="token comment" spellcheck="true">// 从待处理的事件队列中取出事件</span>
                 Object event <span class="token operator">=</span> waitingEvents<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> eventOfDeath<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    wasKilled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                 <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                     <span class="token comment" spellcheck="true">// 执行事件处理</span>
                    <span class="token function">processEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>wasKilled<span class="token punctuation">)</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>waitingEvents<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                       <span class="token keyword">if</span> <span class="token punctuation">(</span>waitingEvents<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          isRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                          <span class="token keyword">break</span><span class="token punctuation">;</span>
                       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
              <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
              LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Event thread exiting due to interruption"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"EventThread shut down for session: 0x&amp;#123;&amp;#125;"</span><span class="token punctuation">,</span>
                     Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token function">getSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="processEvent"><a href="#processEvent" class="headerlink" title="processEvent"></a>processEvent</h4><pre class=" language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processEvent</span><span class="token punctuation">(</span>Object event<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
          <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
              <span class="token comment" spellcheck="true">// 判断事件类型, </span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">WatcherSetEventPair</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                  <span class="token comment" spellcheck="true">// each watcher will process the event</span>
                  <span class="token comment" spellcheck="true">// 得到WatcherSetEventPair</span>
                  WatcherSetEventPair pair <span class="token operator">=</span> <span class="token punctuation">(</span>WatcherSetEventPair<span class="token punctuation">)</span> event<span class="token punctuation">;</span>
                  <span class="token comment" spellcheck="true">// 拿到符合触发机制的所有watcher列表， 循环调用. </span>
                  <span class="token keyword">for</span> <span class="token punctuation">(</span>Watcher watcher <span class="token operator">:</span> pair<span class="token punctuation">.</span>watchers<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                      <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          <span class="token comment" spellcheck="true">// 调用客户端的回调process</span>
                          watcher<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>pair<span class="token punctuation">.</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error while calling watcher "</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
              <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                  Packet p <span class="token operator">=</span> <span class="token punctuation">(</span>Packet<span class="token punctuation">)</span> event<span class="token punctuation">;</span>
                  <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                  String clientPath <span class="token operator">=</span> p<span class="token punctuation">.</span>clientPath<span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>replyHeader<span class="token punctuation">.</span><span class="token function">getErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                      rc <span class="token operator">=</span> p<span class="token punctuation">.</span>replyHeader<span class="token punctuation">.</span><span class="token function">getErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>cb <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                      LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Somehow a null cb got to EventThread!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>response <span class="token keyword">instanceof</span> <span class="token class-name">ExistsResponse</span>
                          <span class="token operator">||</span> p<span class="token punctuation">.</span>response <span class="token keyword">instanceof</span> <span class="token class-name">SetDataResponse</span>
                          <span class="token operator">||</span> p<span class="token punctuation">.</span>response <span class="token keyword">instanceof</span> <span class="token class-name">SetACLResponse</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                      StatCallback cb <span class="token operator">=</span> <span class="token punctuation">(</span>StatCallback<span class="token punctuation">)</span> p<span class="token punctuation">.</span>cb<span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>response <span class="token keyword">instanceof</span> <span class="token class-name">ExistsResponse</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                              cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span>
                                      <span class="token punctuation">(</span><span class="token punctuation">(</span>ExistsResponse<span class="token punctuation">)</span> p<span class="token punctuation">.</span>response<span class="token punctuation">)</span>
                                              <span class="token punctuation">.</span><span class="token function">getStat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                          <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>response <span class="token keyword">instanceof</span> <span class="token class-name">SetDataResponse</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                              cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span>
                                      <span class="token punctuation">(</span><span class="token punctuation">(</span>SetDataResponse<span class="token punctuation">)</span> p<span class="token punctuation">.</span>response<span class="token punctuation">)</span>
                                              <span class="token punctuation">.</span><span class="token function">getStat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                          <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>response <span class="token keyword">instanceof</span> <span class="token class-name">SetACLResponse</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                              cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span>
                                      <span class="token punctuation">(</span><span class="token punctuation">(</span>SetACLResponse<span class="token punctuation">)</span> p<span class="token punctuation">.</span>response<span class="token punctuation">)</span>
                                              <span class="token punctuation">.</span><span class="token function">getStat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                          <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>response <span class="token keyword">instanceof</span> <span class="token class-name">GetDataResponse</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                      DataCallback cb <span class="token operator">=</span> <span class="token punctuation">(</span>DataCallback<span class="token punctuation">)</span> p<span class="token punctuation">.</span>cb<span class="token punctuation">;</span>
                      GetDataResponse rsp <span class="token operator">=</span> <span class="token punctuation">(</span>GetDataResponse<span class="token punctuation">)</span> p<span class="token punctuation">.</span>response<span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> rsp
                                  <span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rsp<span class="token punctuation">.</span><span class="token function">getStat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                                  null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>response <span class="token keyword">instanceof</span> <span class="token class-name">GetACLResponse</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                      ACLCallback cb <span class="token operator">=</span> <span class="token punctuation">(</span>ACLCallback<span class="token punctuation">)</span> p<span class="token punctuation">.</span>cb<span class="token punctuation">;</span>
                      GetACLResponse rsp <span class="token operator">=</span> <span class="token punctuation">(</span>GetACLResponse<span class="token punctuation">)</span> p<span class="token punctuation">.</span>response<span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> rsp
                                  <span class="token punctuation">.</span><span class="token function">getAcl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rsp<span class="token punctuation">.</span><span class="token function">getStat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                                  null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>response <span class="token keyword">instanceof</span> <span class="token class-name">GetChildrenResponse</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                      ChildrenCallback cb <span class="token operator">=</span> <span class="token punctuation">(</span>ChildrenCallback<span class="token punctuation">)</span> p<span class="token punctuation">.</span>cb<span class="token punctuation">;</span>
                      GetChildrenResponse rsp <span class="token operator">=</span> <span class="token punctuation">(</span>GetChildrenResponse<span class="token punctuation">)</span> p<span class="token punctuation">.</span>response<span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> rsp
                                  <span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>response <span class="token keyword">instanceof</span> <span class="token class-name">GetChildren2Response</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                      Children2Callback cb <span class="token operator">=</span> <span class="token punctuation">(</span>Children2Callback<span class="token punctuation">)</span> p<span class="token punctuation">.</span>cb<span class="token punctuation">;</span>
                      GetChildren2Response rsp <span class="token operator">=</span> <span class="token punctuation">(</span>GetChildren2Response<span class="token punctuation">)</span> p<span class="token punctuation">.</span>response<span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> rsp
                                  <span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rsp<span class="token punctuation">.</span><span class="token function">getStat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>response <span class="token keyword">instanceof</span> <span class="token class-name">CreateResponse</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                      StringCallback cb <span class="token operator">=</span> <span class="token punctuation">(</span>StringCallback<span class="token punctuation">)</span> p<span class="token punctuation">.</span>cb<span class="token punctuation">;</span>
                      CreateResponse rsp <span class="token operator">=</span> <span class="token punctuation">(</span>CreateResponse<span class="token punctuation">)</span> p<span class="token punctuation">.</span>response<span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span>
                                  <span class="token punctuation">(</span>chrootPath <span class="token operator">==</span> null
                                          <span class="token operator">?</span> rsp<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                          <span class="token operator">:</span> rsp<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>chrootPath<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>response <span class="token keyword">instanceof</span> <span class="token class-name">MultiResponse</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          MultiCallback cb <span class="token operator">=</span> <span class="token punctuation">(</span>MultiCallback<span class="token punctuation">)</span> p<span class="token punctuation">.</span>cb<span class="token punctuation">;</span>
                          MultiResponse rsp <span class="token operator">=</span> <span class="token punctuation">(</span>MultiResponse<span class="token punctuation">)</span> p<span class="token punctuation">.</span>response<span class="token punctuation">;</span>
                          <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                  List<span class="token operator">&lt;</span>OpResult<span class="token operator">></span> results <span class="token operator">=</span> rsp<span class="token punctuation">.</span><span class="token function">getResultList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                  <span class="token keyword">int</span> newRc <span class="token operator">=</span> rc<span class="token punctuation">;</span>
                                  <span class="token keyword">for</span> <span class="token punctuation">(</span>OpResult result <span class="token operator">:</span> results<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                          <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token keyword">instanceof</span> <span class="token class-name">ErrorResult</span>
                                              <span class="token operator">&amp;&amp;</span> KeeperException<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                  <span class="token operator">!=</span> <span class="token punctuation">(</span>newRc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ErrorResult<span class="token punctuation">)</span> result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                                  <span class="token keyword">break</span><span class="token punctuation">;</span>
                                          <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                                  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                                  cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>newRc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>
                          <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                  cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                          <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>cb <span class="token keyword">instanceof</span> <span class="token class-name">VoidCallback</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                      VoidCallback cb <span class="token operator">=</span> <span class="token punctuation">(</span>VoidCallback<span class="token punctuation">)</span> p<span class="token punctuation">.</span>cb<span class="token punctuation">;</span>
                      cb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> clientPath<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
              <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
          <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
              LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Caught unexpected throwable"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="服务端接受数据请求"><a href="#服务端接受数据请求" class="headerlink" title="服务端接受数据请求."></a>服务端接受数据请求.</h2><p>服务端收到的数据包应该在哪里呢? zookee 启动的时候, 通过下面的代码中构建了一个</p>
<blockquote>
<p> ServerCnxnFactory cnxnFactory = ServerCnxnFactory.createFactory();  </p>
</blockquote>
<p>ServerCnxnFactory  ,它实现类 Thread, 所以在启动的时候, 会在run 方法中不断循环接受客户端的请求进行分发. </p>
<h4 id="NIOServerCnxnFactory-run"><a href="#NIOServerCnxnFactory-run" class="headerlink" title="NIOServerCnxnFactory.run"></a>NIOServerCnxnFactory.run</h4><pre class=" language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>ss<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 获取client 的连接请求</span>
                selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Set<span class="token operator">&lt;</span>SelectionKey<span class="token operator">></span> selected<span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    selected <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                ArrayList<span class="token operator">&lt;</span>SelectionKey<span class="token operator">></span> selectedList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>SelectionKey<span class="token operator">></span><span class="token punctuation">(</span>
                        selected<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Collections<span class="token punctuation">.</span><span class="token function">shuffle</span><span class="token punctuation">(</span>selectedList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>SelectionKey k <span class="token operator">:</span> selectedList<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> SelectionKey<span class="token punctuation">.</span>OP_ACCEPT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        SocketChannel sc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ServerSocketChannel<span class="token punctuation">)</span> k
                                <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        InetAddress ia <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInetAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> cnxncount <span class="token operator">=</span> <span class="token function">getClientCnxnCount</span><span class="token punctuation">(</span>ia<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>maxClientCnxns <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> cnxncount <span class="token operator">>=</span> maxClientCnxns<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Too many connections from "</span> <span class="token operator">+</span> ia
                                     <span class="token operator">+</span> <span class="token string">" - max is "</span> <span class="token operator">+</span> maxClientCnxns <span class="token punctuation">)</span><span class="token punctuation">;</span>
                            sc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Accepted socket connection from "</span>
                                     <span class="token operator">+</span> sc<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRemoteSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            sc<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            SelectionKey sk <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span>
                                    SelectionKey<span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            NIOServerCnxn cnxn <span class="token operator">=</span> <span class="token function">createConnection</span><span class="token punctuation">(</span>sc<span class="token punctuation">,</span> sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            sk<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>cnxn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">addCnxn</span><span class="token punctuation">(</span>cnxn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 处理客户端的读写请求</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>SelectionKey<span class="token punctuation">.</span>OP_READ <span class="token operator">|</span> SelectionKey<span class="token punctuation">.</span>OP_WRITE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        NIOServerCnxn c <span class="token operator">=</span> <span class="token punctuation">(</span>NIOServerCnxn<span class="token punctuation">)</span> k<span class="token punctuation">.</span><span class="token function">attachment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                       <span class="token comment" spellcheck="true">// 处理IO操作</span>
                        c<span class="token punctuation">.</span><span class="token function">doIO</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Unexpected ops in select "</span>
                                      <span class="token operator">+</span> k<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                selected<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Ignoring unexpected runtime exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Ignoring exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token function">closeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"NIOServerCnxn factory exited run method"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="NIOServerCnxn-doIO"><a href="#NIOServerCnxn-doIO" class="headerlink" title="NIOServerCnxn.doIO"></a>NIOServerCnxn.doIO</h4><pre class=" language-java"><code class="language-java"> <span class="token keyword">void</span> <span class="token function">doIO</span><span class="token punctuation">(</span>SelectionKey k<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSocketOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"trying to do i/o on a null socket for session:0x"</span>
                         <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 处理读请求, 表示接受</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> rc <span class="token operator">=</span> sock<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>incomingBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EndOfStreamException</span><span class="token punctuation">(</span>
                            <span class="token string">"Unable to read additional data from client sessionid 0x"</span>
                            <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">", likely client has closed socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>incomingBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> isPayload<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>incomingBuffer <span class="token operator">==</span> lenBuffer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// start of next request</span>
                        incomingBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        isPayload <span class="token operator">=</span> <span class="token function">readLength</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        incomingBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// continuation</span>
                        isPayload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>isPayload<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// not the case for 4letterword</span>
                        <span class="token function">readPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// four letter words take care</span>
                        <span class="token comment" spellcheck="true">// need not do anything else</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ZooLog.logTraceMessage(LOG,</span>
                <span class="token comment" spellcheck="true">// ZooLog.CLIENT_DATA_PACKET_TRACE_MASK</span>
                <span class="token comment" spellcheck="true">// "outgoingBuffers.size() = " +</span>
                <span class="token comment" spellcheck="true">// outgoingBuffers.size());</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>outgoingBuffers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ZooLog.logTraceMessage(LOG,</span>
                    <span class="token comment" spellcheck="true">// ZooLog.CLIENT_DATA_PACKET_TRACE_MASK,</span>
                    <span class="token comment" spellcheck="true">// "sk " + k + " is valid: " +</span>
                    <span class="token comment" spellcheck="true">// k.isValid());</span>

                    <span class="token comment" spellcheck="true">/*
                     * This is going to reset the buffer position to 0 and the
                     * limit to the size of the buffer, so that we can fill it
                     * with data from the non-direct buffers that we need to
                     * send.
                     */</span>
                    ByteBuffer directBuffer <span class="token operator">=</span> factory<span class="token punctuation">.</span>directBuffer<span class="token punctuation">;</span>
                    directBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">for</span> <span class="token punctuation">(</span>ByteBuffer b <span class="token operator">:</span> outgoingBuffers<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>directBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> b<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">/*
                             * When we call put later, if the directBuffer is to
                             * small to hold everything, nothing will be copied,
                             * so we've got to slice the buffer if it's too big.
                             */</span>
                            b <span class="token operator">=</span> <span class="token punctuation">(</span>ByteBuffer<span class="token punctuation">)</span> b<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>
                                    directBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">/*
                         * put() is going to modify the positions of both
                         * buffers, put we don't want to change the position of
                         * the source buffers (we'll do that after the send, if
                         * needed), so we save and reset the position after the
                         * copy
                         */</span>
                        <span class="token keyword">int</span> p <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        directBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        b<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>directBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">/*
                     * Do the flip: limit becomes position, position gets set to
                     * 0. This sets us up for the write.
                     */</span>
                    directBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">int</span> sent <span class="token operator">=</span> sock<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>directBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ByteBuffer bb<span class="token punctuation">;</span>

                    <span class="token comment" spellcheck="true">// Remove the buffers that we have sent</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>outgoingBuffers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        bb <span class="token operator">=</span> outgoingBuffers<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>bb <span class="token operator">==</span> ServerCnxnFactory<span class="token punctuation">.</span>closeConn<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CloseRequestException</span><span class="token punctuation">(</span><span class="token string">"close requested"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> left <span class="token operator">=</span> bb<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> sent<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">/*
                             * We only partially sent this buffer, so we update
                             * the position and exit the loop.
                             */</span>
                            bb<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>bb<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> sent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                        <span class="token function">packetSent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">/* We've sent the whole buffer, so drop the buffer */</span>
                        sent <span class="token operator">-=</span> bb<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        outgoingBuffers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ZooLog.logTraceMessage(LOG,</span>
                    <span class="token comment" spellcheck="true">// ZooLog.CLIENT_DATA_PACKET_TRACE_MASK, "after send,</span>
                    <span class="token comment" spellcheck="true">// outgoingBuffers.size() = " + outgoingBuffers.size());</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>factory<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>outgoingBuffers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>initialized
                                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>sk<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> SelectionKey<span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CloseRequestException</span><span class="token punctuation">(</span><span class="token string">"responded to info probe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                        sk<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>sk<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">~</span>SelectionKey<span class="token punctuation">.</span>OP_WRITE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        sk<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>sk<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">|</span> SelectionKey<span class="token punctuation">.</span>OP_WRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"CancelledKeyException causing close of session 0x"</span>
                     <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"CancelledKeyException stack trace"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CloseRequestException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// expecting close to log session closure</span>
            <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">EndOfStreamException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"EndOfStreamException stack trace"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// expecting close to log session closure</span>
            <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Exception causing close of session 0x"</span>
                     <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"IOException stack trace"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="NIOServerCnxn-readRequest"><a href="#NIOServerCnxn-readRequest" class="headerlink" title="NIOServerCnxn.readRequest"></a>NIOServerCnxn.readRequest</h4><p>读取客户端的请求, 进行具体的处理</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        zkServer<span class="token punctuation">.</span><span class="token function">processPacket</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> incomingBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="ZookeeperServer-processPacket"><a href="#ZookeeperServer-processPacket" class="headerlink" title="ZookeeperServer.processPacket"></a>ZookeeperServer.processPacket</h4><p>这个方法根据数据包的类型来处理不同的数据包，对于读写请求, 我们主要关注下面这块代码即可. </p>
<pre class=" language-java"><code class="language-java"> <span class="token comment" spellcheck="true">//  最终进入这个代码块进行处理</span>
                <span class="token comment" spellcheck="true">// 封装请求对象</span>
                Request si <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span>cnxn<span class="token punctuation">,</span> cnxn<span class="token punctuation">.</span><span class="token function">getSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> h<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  h<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> incomingBuffer<span class="token punctuation">,</span> cnxn<span class="token punctuation">.</span><span class="token function">getAuthInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                si<span class="token punctuation">.</span><span class="token function">setOwner</span><span class="token punctuation">(</span>ServerCnxn<span class="token punctuation">.</span>me<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">submitRequest</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">luyanan</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://rainsoil.github.io/2022/01/04/wei-fu-wu/zookpeer/zookeeper-zhi-watcher-yuan-li-fen-xi/">https://rainsoil.github.io/2022/01/04/wei-fu-wu/zookpeer/zookeeper-zhi-watcher-yuan-li-fen-xi/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">luyanan</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/01/04/shu-ju-ku/fen-ku-fen-biao-de-lei-xing-he-te-dian-2/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="分库分表的类型和特点(2)">
                        
                        <span class="card-title">分库分表的类型和特点(2)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-01-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">
                                    数据库
                                </a>
                            
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">
                                    数据库
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/01/04/shu-ju-ku/wei-shi-me-yao-fen-ku-fen-biao-1/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/6.jpg" class="responsive-img" alt="为什么要分库分表(1)">
                        
                        <span class="card-title">为什么要分库分表(1)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-01-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">
                                    数据库
                                </a>
                            
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">
                                    数据库
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <a href="/about" target="_blank">luyanan</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">803.3k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/rainsoil" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:luyanan0718@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=914596513" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 914596513" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
