<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="RocketMQ事务性消息, railsoil">
    <meta name="description" content="RocketMQ事务性消息​    在现在的很多分布式集群环境中, 经常会遇到本地事务无法解决的问题, 所以会引进分布式事务. 所谓的分布式事务是指分布式架构中多个服务的节点的数据一致性. 
1. 经典的X/OpenDTP事务模型​    ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>RocketMQ事务性消息 | railsoil</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="railsoil" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">railsoil</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">railsoil</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/8.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">RocketMQ事务性消息</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/RocketMQ/" class="post-category">
                                RocketMQ
                            </a>
                        
                            <a href="/categories/RocketMQ/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="post-category">
                                微服务
                            </a>
                        
                            <a href="/categories/RocketMQ/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="post-category">
                                微服务
                            </a>
                        
                            <a href="/categories/RocketMQ/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1/RocketMQ/" class="post-category">
                                RocketMQ
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-01-04
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    21 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="RocketMQ事务性消息"><a href="#RocketMQ事务性消息" class="headerlink" title="RocketMQ事务性消息"></a>RocketMQ事务性消息</h1><p>​    在现在的很多分布式集群环境中, 经常会遇到本地事务无法解决的问题, 所以会引进分布式事务. 所谓的分布式事务是指分布式架构中多个服务的节点的数据一致性. </p>
<h2 id="1-经典的X-OpenDTP事务模型"><a href="#1-经典的X-OpenDTP事务模型" class="headerlink" title="1. 经典的X/OpenDTP事务模型"></a>1. 经典的X/OpenDTP事务模型</h2><p>​    X/Open DTP(X/Open <code>Distributed Transaction Processing Reference Model</code>) 是X/Open 这个组织定义的一套分布式事务的标准， 也就是定义了规范和API接口,由各个厂商进行具体的实现. </p>
<p>​    这个标准提出了使用二阶段提交(2PC-<code> Two-Phase-Commit</code>) 来保证分布式事务的完整性.后来J2EE 也遵循了X/Open DTP 规范, 设计并使用了Java 的分布式事务编程接口规范-JTA</p>
<h3 id="1-1-X-Open-DTP-角色"><a href="#1-1-X-Open-DTP-角色" class="headerlink" title="1.1 X/Open DTP 角色"></a>1.1 <code>X/Open DTP</code> 角色</h3><p>在<code>X/Open DTP</code>事务模型中,定义了三个角色: </p>
<p><strong>AP:</strong> <code>application</code>,应用程序,也就是业务层,哪些操作属于同一个事务,就是<code>AP</code>定义的. </p>
<p><strong>RM</strong>: <code>Resource Manager</code>,资源管理器, 一般是数据库, 也可以是其他资源管理器, 比如消息队列. </p>
<p><strong>TM</strong>:<code>Transaction Manage</code>: 事务管理器、事务协调者,负责接收来自用户程序(<code>AP</code>)发起的XA事务指令,并调度和协调参与事务的所有<code>RM(S数据库)</code> , 确保事务正确完成. </p>
<p>​    在分布式系统中, 每一个机器节点虽然都能够明确知道自己在进行事务操作过程中的结果是成功还是失败, 但却无法直接获取到其他分布式节点的操作结果.因此, 当一个事务操作需要跨越多个分布式节点的时候, 为了保证事务处理的<code>ACID</code>特性, 就需要引入一个”协调者”(<code>TM</code>)来统一调度所有分布式节点的执行逻辑 , 这些被调度的分布式节点被称为<code>AP</code>.<code>TM</code>负责调度<code>AP</code>的行为, 并最终决定这些<code>AP</code> 是否要事务真正的进行提交到<code>RM</code>.</p>
<p>​    <code>XA</code>是<code>X/Open DTP</code> 定义的资源管理器和事务管理器之间的接口规范,<code>TM</code> 用它来通知和协调相关RM事务的开始、结束、提交和回滚.目前Oracle、Mysql、DR2 都提交了对<code>XA</code>的支持; <code>XA</code>接口是双向的系统接口, 在事务管理器(TM) 以及多个资源管理器之间形成通信的桥梁(XA不能自动提交).</p>
<p><img src="http://files.luyanan.com//img/20200115140700.png"></p>
<p><img src="http://files.luyanan.com//img/20200115140722.png"></p>
<h3 id="1-2-2PC"><a href="#1-2-2PC" class="headerlink" title="1.2    2PC"></a>1.2    2PC</h3><h4 id="1-2-1-第一阶段"><a href="#1-2-1-第一阶段" class="headerlink" title="1.2.1 第一阶段"></a>1.2.1 第一阶段</h4><p><img src="http://files.luyanan.com//img/20200115140836.png"></p>
<p>RM 在第一阶段会做两件事情: </p>
<ol>
<li>记录事务日志: reduo、undo</li>
<li>返回给TM 信息 : ok、error</li>
</ol>
<p>存在问题:如果第一阶段完成后TM宕机或者网络出现故障了,此时RM 就会一直阻塞,发生了死锁,因为没有 timeout机制,3PC就针对此问题进行了改造,加入了 timeout机制. </p>
<h4 id="1-2-2-第二阶段"><a href="#1-2-2-第二阶段" class="headerlink" title="1.2.2 第二阶段"></a>1.2.2 第二阶段</h4><p><img src="http://files.luyanan.com//img/20200115141134.png"></p>
<p>根据第一个阶段的返回结果进行提交或者回滚. </p>
<h3 id="1-3-CAP理论"><a href="#1-3-CAP理论" class="headerlink" title="1.3 CAP理论"></a>1.3 CAP理论</h3><p>CAP的含义是: </p>
<ul>
<li>C: <code>Consistency</code>一致性,同一个数据的多个副本是否实时相同. </li>
<li>A：<code>Availability</code>可用性, 可用性: 一定时间内 &amp; 系统返回一个明确的结果,则称之为该系统可用. </li>
<li>P：<code>Partition tolerance</code> 分区容错性,将同一服务分布在多个系统中, 从而保证某一个系统宕机, 让然有其他系统提供相同的服务. </li>
</ul>
<p>CAP 理论告诉我们, 在分布式系统中, C、A、P 三个条件中我们最多只能选择两个,那么问题来了,究竟选择哪两个条件较为合适呢? </p>
<p>​    对于一个业务系统来说, 可用性和分区容错性是必须满足的两个条件,并且这两个是相辅相成的. 业务系统之所以使用分布式系统, 主要原因有两个: </p>
<ul>
<li>提升系统性能, 当业务量猛增, 单个服务器已经无法满足我们的业务需求的时候, 就需要使用分布式系统,使用多个节点提供相同的功能, 从而整体上提升系统的性能,这就是使用分布式系统的第一个原因. </li>
<li>实现分区容错性, 单一节点或者多个节点处于相同的是网络环境下, 那么会存在一定的风险, 万一该机房断电、该地区发生自然灾害, 那么业务系统就全面瘫痪了.为了防止这一问题,采用分布式系统,将多个子系统分布在不同的地域、不同的机房, 从而保证了系统高可用. </li>
</ul>
<p>这说明分区容错性是分布式系统的根本, 如果分区容错性不能满足, 那使用分布式系统将失去意义. </p>
<p>​    此外,可用性对业务系统也尤为重要, 在大谈用户体验的今天,如果业务系统常出现”系统异常”、响应时间过程等情况, 这使得用户对系统的好感度大打折扣, 在互联网行业竞争激烈的今天,相同领域竞争者不甚枚举,系统的间歇性不可以会立马导致用户流向竞争对手。因此, 我们只能通用牺牲一致性来换取系统的<strong>可用性</strong>和<strong>分区容错</strong>. </p>
<h3 id="1-4-Base-理论"><a href="#1-4-Base-理论" class="headerlink" title="1.4 Base 理论"></a>1.4 Base 理论</h3><p>CAP理论告诉我们一个悲惨但不得不接受的事实– 我们只能在C、A、P 中选择两个条件, 而对于业务系统而言,我们往往选择牺牲一致性来换取系统的可用性和分区容错性. 不过要在这里指出的是, 所谓是”牺牲一致性”并不是完全放弃数据一致性, 而是牺牲”强一致性”换取”弱一致性”. </p>
<ul>
<li><p><code>BA:Basic Availabl </code> 基本可用</p>
<p> 整个系统在某些不可抗力的情况下, 让然能够保证”可用性”, 即一定时间内然然能返回一个明确的结果.只不过”基本可用”和”高可用”的区别是:</p>
<ul>
<li>“一定时间”可以适当延长,当举行大促时, 响应时间可以适当延长. </li>
<li>给部分用户返回一个降级页面, 给部分用户直接返回一个降级页面, 从而缓解服务器压力. 但要注意的是: 返回降级页面仍然是返回明确结果. </li>
</ul>
</li>
<li><p><code>S:Soft State</code>: 柔性状态,同一数据的不同副本的状态, 可以不需要实时一致. </p>
</li>
<li><p><code>E:Eventual Consisstency</code>: 最终一致性, 同一数据的不同副本状态, 可以不需要实时一致, 但一定要保证经过一段时间后仍然是一致的. </p>
</li>
</ul>
<h2 id="2-分布式事务常见解决方案"><a href="#2-分布式事务常见解决方案" class="headerlink" title="2. 分布式事务常见解决方案"></a>2. 分布式事务常见解决方案</h2><h3 id="2-1-最大努力通知方案"><a href="#2-1-最大努力通知方案" class="headerlink" title="2.1 最大努力通知方案"></a>2.1 最大努力通知方案</h3><p><img src="http://files.luyanan.com//img/20200115155523.png"></p>
<h3 id="2-2-TCC-两阶段补偿方案"><a href="#2-2-TCC-两阶段补偿方案" class="headerlink" title="2.2 TCC 两阶段补偿方案"></a>2.2 TCC 两阶段补偿方案</h3><p>TCC 是<code>Try-Confirm-Cance</code>, 比如在支付场景中,先冻结一部分资金,再去发起支付. 如果支付成功,则将冻结的资金进行实时扣除, 如果支付失败, 则取消资金冻结. </p>
<p>​    </p>
<p><img src="http://files.luyanan.com//img/20200115155726.png"></p>
<h4 id="2-2-1-Try阶段"><a href="#2-2-1-Try阶段" class="headerlink" title="2.2.1 Try阶段"></a>2.2.1 Try阶段</h4><p>完成所以业务检查(一致性),预留业务资源(准隔离性)</p>
<h4 id="2-2-2Confirm阶段"><a href="#2-2-2Confirm阶段" class="headerlink" title="2.2.2Confirm阶段"></a>2.2.2Confirm阶段</h4><p>确认执行业务操作, 不做任何业务检查, 只使用try 阶段预留的业务资源. </p>
<h4 id="2-2-3-Cancel阶段"><a href="#2-2-3-Cancel阶段" class="headerlink" title="2.2.3 Cancel阶段"></a>2.2.3 Cancel阶段</h4><p>取消try 阶段预留的业务资源, Try出现出现阶段时, 取消所有业务资源预留请求. </p>
<h3 id="2-3-关于状态机"><a href="#2-3-关于状态机" class="headerlink" title="2.3 关于状态机"></a>2.3 关于状态机</h3><p>在使用最终一致性的方案时, 一定要提到的一个概念就是状态机. </p>
<p>​    什么是状态机? 是一种特殊的组织代码的方式, 用这种方式能够确保你的对象随时都直到自己所处的状态以及能够做的操作。它也是一种用来进行对象行为建模的工具, 用于描述对象在他的生命周期内所经历的状态序列, 以及如何响应来自外界的各种事件. </p>
<p>​    状态机这个概念大家都不陌生, 比如TCP 协议的状态机. 同时我们在编写相关业务逻辑的时候经常也会需要处理各种事件和状态的切换, 比如swith、if/else . 所以我们其实一致都在跟状态机打交道,只是可能都没有意识到而已. 在处理一些业务逻辑比较复杂的需求的时候, 可以先看看是否适用于一个有限状态机来描述, 如果可以把业务模型抽象成一个有限的状态机, 那么代码就会逻辑非常清晰, 结构特别规整. </p>
<p>​    比如我们来简单描述一个订单. </p>
<p>​    我们以支付为例, 一笔订单可能会有等待支付、支付中、已支付状态, 那么我们就可以先去把可能出现的状态以及状态的流程画出来。 </p>
<p><img src="http://files.luyanan.com//img/20200115163617.png"></p>
<p>状态机的两个作用: </p>
<ul>
<li>实现幂等</li>
<li>通过状态驱动数据的变化</li>
<li>业务流程以及逻辑更加清晰, 特别是应对复杂的业务场景. </li>
</ul>
<h2 id="3-什么是幂等"><a href="#3-什么是幂等" class="headerlink" title="3. 什么是幂等"></a>3. 什么是幂等</h2><p>   简单来说, 重复调用多次产生的业务结果与调用一次产生的业务结果相同; 在分布式架构中, 我们调用一个远程服务去完成一个操作, 除了成功和我失败以外, 还有未知状态, 那么针对这个未知状态, 我们会采用一些重试的行为. 或者在消息中间件的使用场景中, 消费者可能会重复收到消息. 对于这两种情况, 消费端或者服务端需要采取一定的手段, 也就是考虑到重发的情况下保证数据的安全性.我们一般常用的手段： </p>
<ol>
<li>状态机实现幂等</li>
<li>数据库唯一约束实现幂等</li>
<li>通过<code>tokenId</code> 的方式去识别每次请求判断是否重复. </li>
</ol>
<h2 id="4-开源的分布式事务解决方案"><a href="#4-开源的分布式事务解决方案" class="headerlink" title="4. 开源的分布式事务解决方案"></a>4. 开源的分布式事务解决方案</h2><h3 id="4-1-TransactionProducer（事务消息）"><a href="#4-1-TransactionProducer（事务消息）" class="headerlink" title="4.1 TransactionProducer（事务消息）"></a>4.1 TransactionProducer（事务消息）</h3><p>RocketMQ 和其他消息中间件最大的一个区别就是支持了事务消息, 这也是分布式事务中基于消息的最终一致性方案. </p>
<h3 id="4-2-RocketMQ-消息的事务架构设计"><a href="#4-2-RocketMQ-消息的事务架构设计" class="headerlink" title="4.2  RocketMQ 消息的事务架构设计"></a>4.2  RocketMQ 消息的事务架构设计</h3><ol>
<li>生产者执行本地事务, 修改订单支付状态, 并且提交事务</li>
<li>生产者发送事务消息到broker上, 消息发送到broker 上在没有确认之前, 消息对于<code>consumer</code> 是 不可见的状态. </li>
<li>生产者确认事务消息, 使得发送到broker上的事务消息对于消费者可见. </li>
<li>消费者获取到消息进行消费,消费完之后执行ack 进行确认. </li>
<li>这里可能会存在一个问题 , 生产者本地事务成功后,发送事务确认消息到broker 上失败了怎么办? 这个时候意味着消费者无法正常消费到这个消息, 所以RocketMQ 提供了消息回查机制, 如果事务消息一直处于中间状态,broker 会发起重试去查询broker 上这个事务的处理状态。一旦发送事务处理成功, 则把这条消息设置为可见. </li>
</ol>
<p><img src="http://files.luyanan.com//img/20200116094256.png"></p>
<h3 id="4-3-事务消息的实践"><a href="#4-3-事务消息的实践" class="headerlink" title="4.3 事务消息的实践"></a>4.3 事务消息的实践</h3><p>通过一个下单以后扣减库存的数据一致性场景来演示RocketMQ的分布式事务特性. </p>
<p>TransactionProducer</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mq<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQClientException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>TransactionMQProducer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>common<span class="token punctuation">.</span>RemotingHelper<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>UnsupportedEncodingException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>UUID<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>ExecutorService<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>Executors<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author luyanan
 * @since 2020/1/16
 * &lt;p>事务生产者&lt;/p>
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionProducer</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException<span class="token punctuation">,</span> UnsupportedEncodingException<span class="token punctuation">,</span> InterruptedException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

        TransactionMQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionMQProducer</span><span class="token punctuation">(</span><span class="token string">"tx_producer_group"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.86.128:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//  自定义线程池</span>
        ExecutorService executorService <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setExecutorService</span><span class="token punctuation">(</span>executorService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setTransactionListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransactionListenerLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

            String orderId <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String body <span class="token operator">=</span> <span class="token string">"&amp;#123;'operation':'doOrder','orderId':'"</span> <span class="token operator">+</span> orderId <span class="token operator">+</span> <span class="token string">"'&amp;#125;"</span><span class="token punctuation">;</span>
            Message message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"ex_topic"</span><span class="token punctuation">,</span> <span class="token string">"TagA"</span><span class="token punctuation">,</span> orderId<span class="token punctuation">,</span> body<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>RemotingHelper<span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            producer<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> orderId <span class="token operator">+</span> <span class="token string">"&amp;"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>TransactionListenerLocal</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mq<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>LocalTransactionState<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>TransactionListener<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>MessageExt<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>ConcurrentHashMap<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author luyanan
 * @since 2020/1/16
 * &lt;p>&lt;/p>
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionListenerLocal</span> <span class="token keyword">implements</span> <span class="token class-name">TransactionListener</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Boolean<span class="token operator">></span> results <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * &lt;p>执行本地事务&lt;/p>
     *
     * @param message
     * @param o
     * @return &amp;#123;@link LocalTransactionState&amp;#125;
     * @author luyanan
     * @since 2020/1/16
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> LocalTransactionState <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span>Message message<span class="token punctuation">,</span> Object o<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行本地事务:"</span> <span class="token operator">+</span> o<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String orderId <span class="token operator">=</span> o<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//模拟插入数据库操作</span>
        <span class="token keyword">boolean</span> rs <span class="token operator">=</span> <span class="token function">saveOrder</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//这个返回状态表示broker 这个事务消息是否被确认,允许给到consumer 进行消费</span>
        <span class="token comment" spellcheck="true">// LocalTransactionState.ROLLBACK_MESSAGE 回滚</span>
        <span class="token comment" spellcheck="true">// LocalTransactionState.UNKNOW 未知</span>
        <span class="token keyword">return</span> rs <span class="token operator">?</span> LocalTransactionState<span class="token punctuation">.</span>COMMIT_MESSAGE <span class="token operator">:</span> LocalTransactionState<span class="token punctuation">.</span>UNKNOW<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">saveOrder</span><span class="token punctuation">(</span>String orderId<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果订单取模等于0, 表示成功, 否则失败</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>orderId<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
        results<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>orderId<span class="token punctuation">,</span> success<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> success<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> LocalTransactionState <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span>MessageExt messageExt<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        String orderId <span class="token operator">=</span> messageExt<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行事务执行状态的回查:orderId:"</span> <span class="token operator">+</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> rs <span class="token operator">=</span> Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"回调："</span> <span class="token operator">+</span> rs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rs <span class="token operator">?</span> LocalTransactionState<span class="token punctuation">.</span>COMMIT_MESSAGE <span class="token operator">:</span> LocalTransactionState<span class="token punctuation">.</span>ROLLBACK_MESSAGE<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>消费者</p>
<p>TransactionConsumer</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mq<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>DefaultMQPushConsumer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>ConsumeConcurrentlyContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>ConsumeConcurrentlyStatus<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>MessageListenerConcurrently<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQClientException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>ConsumeFromWhere<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>MessageExt<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>common<span class="token punctuation">.</span>RemotingHelper<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>UnsupportedEncodingException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author luyanan
 * @since 2020/1/16
 * &lt;p>事务 消费者&lt;/p>
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionConsumer</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException<span class="token punctuation">,</span> IOException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

        DefaultMQPushConsumer consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"tx_consumer_group"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.86.128:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span>ConsumeFromWhere<span class="token punctuation">.</span>CONSUME_FROM_FIRST_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"ex_topic"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> ConsumeConcurrentlyStatus <span class="token function">consumeMessage</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> list<span class="token punctuation">,</span> ConsumeConcurrentlyContext consumeConcurrentlyContext<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>messageExt <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    String orderId <span class="token operator">=</span> messageExt<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    String body <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RemotingHelper<span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到消息:"</span> <span class="token operator">+</span> body <span class="token operator">+</span> <span class="token string">"->开始扣钱库存:"</span> <span class="token operator">+</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ConsumeConcurrentlyStatus<span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-4-RocketMQ-事务消息的三种状态"><a href="#4-4-RocketMQ-事务消息的三种状态" class="headerlink" title="4.4  RocketMQ 事务消息的三种状态"></a>4.4  RocketMQ 事务消息的三种状态</h3><ol>
<li><code>ROLLBACK_MESSAGE</code>:  回滚事务</li>
<li><code>COMMIT_MESSAGE</code>: 提交事务</li>
<li><code>UNKNOW</code>: broker 会定时的回查producer 消息状态,知道彻底成功或者失败. </li>
</ol>
<p>当 <code>com.mq.TransactionListenerLocal#executeLocalTransaction</code> 方法返回<code>ROLLBACK_MESSAGE</code>的时候, 表示直接回滚事务, 当返回 <code>COMMIT_MESSAGE</code>的时候直接提交事务. </p>
<p>当返回<code>UNKNOW</code>的时候,broker 会在一段时间之后查<code>com.mq.TransactionListenerLocal#checkLocalTransaction</code>, 根据<code>com.mq.TransactionListenerLocal#checkLocalTransaction</code> 返回状态执行事务的操作(提交或者回滚)</p>
<p>​    如示例中,当返回<code>ROLLBACK_MESSAGE</code> 时消费者不会收到消息, 且不会调用回查函数, 当返回<code>COMMIT_MESSAGE</code> 时事务提交,消费者收到消息. 当返回<code>UNKNOW</code>的时候, 在一段时间之后调用回查函数, 并根据state 判断返回提交或者回滚状态,返回提交状态的消息将会被消费者消费, 所以此时消费者可以消费部分消息. </p>
<h2 id="5-消息的存储和发送"><a href="#5-消息的存储和发送" class="headerlink" title="5. 消息的存储和发送"></a>5. 消息的存储和发送</h2><p>​    由于分布式消息队列对于可靠性的要求比较高, 所以需要保证生产者将消息发送到broker 之后, 保证消息是不会丢失的,因此消息队列就少不了对于可靠性存储的要求. </p>
<h3 id="5-1-MQ消息存储选择"><a href="#5-1-MQ消息存储选择" class="headerlink" title="5.1 MQ消息存储选择"></a>5.1 MQ消息存储选择</h3><p>​    从主流的几种MQ 消息队列采用的存储方式来看, 主要会有几种: </p>
<ol>
<li>分布式KV存储, 比如使用ActiviteMQ中采用的LebelDB、Redis, 这种存储方式对于消息读写能力要求不高的情况下可以使用. </li>
<li>文件系统存储, 常见的比如 kafka、RocketMQ、RabbitMQ 都是采用消息刷盘到所部署的机器上的文件系统来做持久化, 这种方案适用于对于有高吞吐量要求的消息中间件, 因为消息刷盘是一种高效率、高可靠、高性能的持久化方式, 除非磁盘出现故障, 否则一般是不会出现无法持久化问题的. </li>
<li>关系型数据库,比如ActiviteMQ 可以采用Mysql 作为消息存储,关系型数据库在单表数量达到千万级的情况下IO性能会出现瓶颈, 所以ActiviteMQ 并不适用于高吞吐量的消息队列场景. </li>
</ol>
<h3 id="5-2-消息的存储结构"><a href="#5-2-消息的存储结构" class="headerlink" title="5.2 消息的存储结构"></a>5.2 消息的存储结构</h3><p>​    RocketMQ 就是采用文件系统的方式来存储消息, 消息的存储是由<code>ConsumeQueue</code>和<code>CommitLog</code> 配合完成的. <code>CommitLog</code> 是消息真正的物理存储文件。 <code>ConsumeQueue</code> 是消息的逻辑队列, 有点类似于数据库的索引文件, 里面存储的是指向<code>CommitLog</code>  文件中消息存储的地址. </p>
<p>​    每个Topic 下的每个<code>Message Queue</code>都会对应一个<code>ConsumerQueue</code> 文件,文件的地址是<code>$&#123;store_home&#125;/consumequeue/$&#123;topicNmae&#125;/$&#123;queueId&#125;/$&#123;filename&#125;,</code>, 默认路径是<code>/root/store</code>. 在rocketMQ的文件存储目录下, 可以看到这样一个结构的文件</p>
<p><img src="http://files.luyanan.com//img/20200116112604.png"></p>
<p>我们只需要关心<code>Commitlog</code>、<code>Consumerqueue</code>、<code>Index</code></p>
<h4 id="5-2-1-Commitlog"><a href="#5-2-1-Commitlog" class="headerlink" title="5.2.1 Commitlog"></a>5.2.1 Commitlog</h4><p><code>commitlog</code>是用来存放消息的物理文件, 每个broker 上的<code>commitlog</code>文件是当前机器上的所有<code>consumerqueue</code> 共享, 不做任何区分. </p>
<p>​    <code>commitlog</code>中的文件默认大小为1G，可以动态配置; 当一个文件写满以后, 会生成一个新的<code>commitlog</code>文件. 所有的topic 数据是顺序写入在<code>commitlog</code> 文件中的. </p>
<p>文件名的长度为20位, 左边补零, 剩余末起始偏移量,比如00000000000000000000 表示第一个文件， 文件大小为102410241024，当第一个文件写满之后，生 成第二个文件 000000000001073741824 表示第二个文件，起始偏移量为1073741824</p>
<p>00000000000000000000 表示第一个文件， 文件大小为102410241024，当第一个文件写满之后，生 成第二个文件 000000000001073741824 表示第二个文件，起始偏移量为1073741824</p>
<h4 id="5-2-2-consumeQueue"><a href="#5-2-2-consumeQueue" class="headerlink" title="5.2.2 consumeQueue"></a>5.2.2 consumeQueue</h4><p><code>consumeQueue</code> 表示消息 消费的逻辑队列, 这里面包含<code>messageQueue</code>在<code>commitlog</code> 中的真实物理地址偏移量ooffst,消息实体内容的大小和<code>Message Tag</code>的hash值。 对于实际物理存储来说, <code>consumerQueue</code> 对应每个topic 和<code>queueid</code>下的文件, 每个<code>consumerqueue</code>类型的文件也是有带大小的,每个文件默认大小为6000W字节,如果文件满了之后也会生成一个新的文件. </p>
<h4 id="5-2-3-IndexFile"><a href="#5-2-3-IndexFile" class="headerlink" title="5.2.3 IndexFile"></a>5.2.3 IndexFile</h4><p>​    索引文件, 如果一个消息包含key值的话 ,会使用<code>indexFile</code>存储消息索引.Index 索引文件提交了对<code>Commitlog</code> 进行数据检索, 提供了一种通过key 或者时间区间来查找<code>commitlog</code> 中的消息的方法. 在物理存储中, 文件名是以创建的时间戳命名的, 固定的单个<code>indexFile</code> 大小大概为400M,一个<code>indexFile</code> 可以保存2000W个索引. </p>
<h4 id="5-2-4-abort"><a href="#5-2-4-abort" class="headerlink" title="5.2.4 abort"></a>5.2.4 abort</h4><p>​    broker 就会在启动的时候创建一个名为abort的文件,并在<code>shutdown</code>的时候将其删除,用于标识进程是否正常退出,如果不是正常退出, 会在启动的时候做故障恢复. </p>
<h3 id="5-3-消息存储的消息结构"><a href="#5-3-消息存储的消息结构" class="headerlink" title="5.3 消息存储的消息结构"></a>5.3 消息存储的消息结构</h3><p> <img src="http://files.luyanan.com//img/20200116134637.png"></p>
<p>​    RrokerMQ 的消息存储采用的是混合型的存储结构, 也就是broker 单个实例下的所有队列公用一个日志数据文件<code>connitlog</code>. 这个是和kafka 的又一不同之处. </p>
<p>​    为什么不采用kafka 的设计, 针对不同的<code>partition</code>存储一个独立的物理文件呢? 这是因为在kafka的设计中, 一旦kafka 中Topic的的<code>partition</code>数量过多, 队列文件会过多, 那么会给磁盘的IO读写造成比较大的压力, 也就造成了性能瓶颈. 所以RocketMQ 进行了优化, 消息主题统一存储在<code>commitlog</code>中. </p>
<p>当然, 这种设计并不是银弹, 也是有他的优缺点: </p>
<p><strong>优点</strong>: 由于消息主题都是通过<code>commitlog</code> 进行读写, <code>comsumerQueue</code> 中只存储了很少的数据, 所以队列更加的轻量化, 对于磁盘的访问是串行化从而避免了磁盘的竞争. </p>
<p><strong>缺点</strong>: 消息写入磁盘虽然是基于顺序读写, 但是读的过程是随机的,读取一条消息会先读取<code>consumerQueue</code> , 在读<code>commitlog</code>, 会降低消息读的效率. </p>
<h3 id="5-4-消息发送到消息接收的整体流程"><a href="#5-4-消息发送到消息接收的整体流程" class="headerlink" title="5.4 消息发送到消息接收的整体流程"></a>5.4 消息发送到消息接收的整体流程</h3><ol>
<li><p>Producer 将消息发送到Broker 后, Broker 会采用同步或者异步的方式把消息写入到<code>commitlog</code>,RocketMQ 所有的消息都会存放在<code>commitlog</code>中, 为了保证消息存储不发生混乱, 对<code>commitlog</code> 写之前会加锁, 同时也可以使得消息能够被顺序写入到<code>commitlog</code>, 只要消息被持久化到磁盘文件<code>commitlog</code>,那么就可以保证producer 发送的消息不会丢失. </p>
<p><img src="http://files.luyanan.com//img/20200116135615.png"></p>
</li>
<li><p><code>commitlog</code>持久化后, 会把里面的消息<code>Dispatch</code>到对应的<code>consumer queue</code>上, <code>consumer queue</code> 相当于kafka 的<code>partition</code>, 是一个逻辑队列, 存储了这个queue 在<code>commitlog</code> 中的其实offset、log大小和MessageTag的hashCode. </p>
<p><img src="http://files.luyanan.com//img/20200116140325.png"></p>
</li>
<li><p>当消费者进行消息消费时,会先读取<code>consumerQueue</code>,逻辑消费队列<code>consumerQueue</code> 保存了指定topic 下的队列消息在<code>consumerLog</code> 中的起始物理偏移量offset、消息大小、和消息tag HashCode值. </p>
<p><img src="http://files.luyanan.com//img/20200116140504.png"></p>
</li>
<li><p>直接从<code>consumerqueue</code> 中读取消息是没有数据的, 真正的消息主题是在<code>consumerlog</code>中, 所以换需要从<code>consumerlog</code> 中读取消息. </p>
<p><img src="http://files.luyanan.com//img/20200116140934.png"></p>
</li>
</ol>
<h2 id="6-什么时候清理物理消息文件"><a href="#6-什么时候清理物理消息文件" class="headerlink" title="6. 什么时候清理物理消息文件"></a>6. 什么时候清理物理消息文件</h2><p>那消息文件到底删不删? 什么时候删除呢? </p>
<p>​    消息存储在<code>commitlog</code>之后, 的确是会被清理的,但是这个清理只会在以下任一条件成立后才会批量删除消息文件(<code>comitlog</code>)</p>
<ol>
<li>消息文件过期(默认72个小时),且到达清理时点(默认是凌晨4点),删除过期文件. </li>
<li>消息文件过期(默认72个小时),且磁盘空间达到了水位线(默认75%), 删除过期文件</li>
<li>磁盘已经达到了必须释放的上限(85%水位线)的时候, 则开始批量清理文件(无论是否过期), 直到空间充足. </li>
</ol>
<blockquote>
<p>注意： 若磁盘空间达到危险水位线(90%), 处于保护自身的目的, broker 会拒绝写入服务. </p>
</blockquote>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">luyanan</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://rainsoil.github.io/2022/01/04/wei-fu-wu/rocketmq/rocketmq-shi-wu-xing-xiao-xi/">https://rainsoil.github.io/2022/01/04/wei-fu-wu/rocketmq/rocketmq-shi-wu-xing-xiao-xi/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">luyanan</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/01/04/wei-fu-wu/sentinel/sentinel-de-ji-ben-ying-yong-yi-ji-yuan-li-fen-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="Sentinel的基本应用以及原理分析">
                        
                        <span class="card-title">Sentinel的基本应用以及原理分析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-01-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Sentinel/" class="post-category">
                                    Sentinel
                                </a>
                            
                            <a href="/categories/Sentinel/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="post-category">
                                    微服务
                                </a>
                            
                            <a href="/categories/Sentinel/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="post-category">
                                    微服务
                                </a>
                            
                            <a href="/categories/Sentinel/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1/Sentinel/" class="post-category">
                                    Sentinel
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/01/04/bing-fa-bian-cheng/xian-cheng-an-quan-xing-de-yuan-li-fen-xi-3/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="线程安全性的原理分析(3)">
                        
                        <span class="card-title">线程安全性的原理分析(3)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-01-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" class="post-category">
                                    并发编程
                                </a>
                            
                            <a href="/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" class="post-category">
                                    并发编程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <a href="/about" target="_blank">luyanan</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">803.3k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/rainsoil" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:luyanan0718@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=914596513" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 914596513" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
