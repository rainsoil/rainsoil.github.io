<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="分库分表之Sharding-JDBC(5), railsoil">
    <meta name="description" content="分库分表之Sharding-JDBC1. 架构与核心概念1.1 发展历史它是从当当网的内部架构ddframe  里面的一个分库分表的模块脱胎出来的, 用来解决当当的分库分表问题, 把跟业务相关的敏感的代码剥离后, 就得到了Sharding-">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>分库分表之Sharding-JDBC(5) | railsoil</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="railsoil" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">railsoil</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">railsoil</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/20.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">分库分表之Sharding-JDBC(5)</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">
                                数据库
                            </a>
                        
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">
                                数据库
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-01-04
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    7.1k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    31 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="分库分表之Sharding-JDBC"><a href="#分库分表之Sharding-JDBC" class="headerlink" title="分库分表之Sharding-JDBC"></a>分库分表之<a target="_blank" rel="noopener" href="https://gitee.com/Sharding-Sphere/sharding-sphere">Sharding-JDBC</a></h1><h2 id="1-架构与核心概念"><a href="#1-架构与核心概念" class="headerlink" title="1. 架构与核心概念"></a>1. 架构与核心概念</h2><h3 id="1-1-发展历史"><a href="#1-1-发展历史" class="headerlink" title="1.1 发展历史"></a>1.1 发展历史</h3><p>它是从当当网的内部架构<code>ddframe</code>  里面的一个分库分表的模块脱胎出来的, 用来解决当当的分库分表问题, 把跟业务相关的敏感的代码剥离后, 就得到了<code>Sharding-JDBC</code>. 它是一个工作在客户端的分库分表的解决方案. </p>
<p><code>DubboX</code>、<code>Elastic-job</code>  也是当当开源出来的产品. </p>
<p><img src="http://files.luyanan.com//img/20200407085557.png" alt="image-20200407085555819"></p>
<p>2018年5月份,  因为增加了<code>Proxy</code> 版本的和<code>Sharding-Sidecar</code>(尚未发布), <code>Sharding-JDBC</code> 更名为<code>Sharding-Sphere</code>, 从一个客户端的组件变成了一个套件. </p>
<p>2018年11月,<code>Sharding-Sphere</code> 正式进入<code>Apache</code> 基金孵化器, 这也是对<code>Sharding-Sphere</code>的质量和影响力的认可. 不过现在还没有毕业(名字带<code>incubator</code>), 一般我们用的还是<code>io.shardingsphere</code>的包. </p>
<p><img src="http://files.luyanan.com//img/20200407090055.png" alt="image-20200407090054679"></p>
<p>现在<code>Sharding-Sphere</code> 已经不属于当当网了, 也不属于作者张亮个人了. </p>
<p><img src="http://files.luyanan.com//img/20200407090241.png" alt="image-20200407090240517"></p>
<p>因为更名后和捐献给<code>Apache</code> 之后的<code>groupId</code> 都不一样, 所以在引入依赖的时候千万要注意. 主体功能是相同的, 但是在某些类的用法上有些差异, 如果要升级的话, <code>import</code> 要全部修改, 有些类和方法也要修改.</p>
<h3 id="1-2-基本特性"><a href="#1-2-基本特性" class="headerlink" title="1.2 基本特性"></a>1.2 基本特性</h3><p><code>Sharding-JDBC</code>是怎么工作的呢? </p>
<p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/overview/">https://shardingsphere.apache.org/document/current/cn/overview/</a></p>
<p>我们来看一下官网的定义:</p>
<blockquote>
<p>定位为轻量级 Java 框架，在 Java 的 JDBC 层提供的额外服务。 它使用客户端直连数据 库，以 jar 包形式提供服务，无需额外部署和依赖，可理解为增强版的 JDBC 驱动，完 全兼容 JDBC 和各种 ORM 框架。</p>
</blockquote>
<p>在<code>maven</code> 工程里面, 我们使用它的方式是引入依赖, 然后进行配置就可以了, 不用像<code>Mycat</code> 一样独立的运行一个服务, 客户端不需要修改任何一行代码, 原来是SSM 连接数据库, 现在还是SSM, 因为它是支持Mybatis的. </p>
<h3 id="1-3-架构"><a href="#1-3-架构" class="headerlink" title="1.3 架构"></a>1.3 架构</h3><p>我们在项目中引入<code>Sharding-JDBC</code>的依赖, 我们的业务代码在操作数据库的时候, 就会通过<code>Sharding-JDBC</code>的代码连接到数据库. </p>
<p>分库分表的一些核心动作, 比如SQL解析、路由、执行、结果处理, 都是由它完成的, 它工作在客户端. </p>
<p><img src="http://files.luyanan.com//img/20200407090830.png" alt="image-20200407090827980"></p>
<p>在<code>Sharding-Sphere</code>  里面同样提供了代理<code>Proxy</code>的版本, 跟Mycat 的作用是一样的.<code>Sharding-Sphere</code> 是一个<code>Kubernetes</code> 的云原生数据库代理, 正在开发中. </p>
<table>
<thead>
<tr>
<th></th>
<th><code>Sharding-JDBC</code></th>
<th><code>Sharding-Proxy</code></th>
<th><code>Sharding-Sidecar</code></th>
</tr>
</thead>
<tbody><tr>
<td>数据库</td>
<td>任何</td>
<td>Mysql</td>
<td>Mysql</td>
</tr>
<tr>
<td>连接消耗数</td>
<td>高</td>
<td>低</td>
<td>低</td>
</tr>
<tr>
<td>异构语言</td>
<td>仅java</td>
<td>任意</td>
<td>任意</td>
</tr>
<tr>
<td>性能</td>
<td>损耗低</td>
<td>损耗略高</td>
<td>损耗低</td>
</tr>
<tr>
<td>无中心化</td>
<td>是</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>静态入口</td>
<td>无</td>
<td>有</td>
<td>有</td>
</tr>
</tbody></table>
<h3 id="1-4-功能"><a href="#1-4-功能" class="headerlink" title="1.4 功能"></a>1.4 功能</h3><p>分库分表后的几大问题: 跨库关联查询、分布式事务、排序翻页计算、全局主键. </p>
<h4 id="1-4-1-数据分片"><a href="#1-4-1-数据分片" class="headerlink" title="1.4.1 数据分片"></a>1.4.1 数据分片</h4><ol>
<li><p>分库&amp; 分表</p>
</li>
<li><p>读写分离</p>
<p> <a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/read-write-split/">https://shardingsphere.apache.org/document/current/cn/features/read-write-split/</a></p>
</li>
<li><p>分片策略定制化</p>
</li>
<li><p>无中心化分布式主键(包括UUID、雪花、LAF)</p>
<p> <a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/sharding/other-features/key-generator/">https://shardingsphere.apache.org/document/current/cn/features/sharding/other-features/key-generator/</a></p>
</li>
</ol>
<h4 id="1-4-2-分布式事务"><a href="#1-4-2-分布式事务" class="headerlink" title="1.4.2 分布式事务"></a>1.4.2 分布式事务</h4><p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/transaction/">https://shardingsphere.apache.org/document/current/cn/features/transaction/</a></p>
<ol>
<li>标准化事务接口</li>
<li>XA 强一致性事务</li>
<li>弱性事务</li>
</ol>
<h3 id="1-5-核心概念"><a href="#1-5-核心概念" class="headerlink" title="1.5 核心概念"></a>1.5 核心概念</h3><p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/sharding/concept/sql/">https://shardingsphere.apache.org/document/current/cn/features/sharding/concept/sql/</a></p>
<p>逻辑表、真实表、分片键、数据节点、动态表、广播表、绑定表</p>
<h4 id="1-5-1-主要概念"><a href="#1-5-1-主要概念" class="headerlink" title="1.5.1 主要概念"></a>1.5.1 主要概念</h4><p><img src="http://files.luyanan.com//img/20200407094147.png" alt="image-20200407094146438"></p>
<p>逻辑表会在SQL 解析和路由时被替换成真实的表名</p>
<p>分片键不一定是主键, 也不一定有业务含义. </p>
<h4 id="1-5-2-动态表"><a href="#1-5-2-动态表" class="headerlink" title="1.5.2 动态表"></a>1.5.2 动态表</h4><p><img src="http://files.luyanan.com//img/20200407095255.png" alt="image-20200407095254815"></p>
<h4 id="1-5-3-广播表"><a href="#1-5-3-广播表" class="headerlink" title="1.5.3 广播表"></a>1.5.3 广播表</h4><p>跟Mycat的全局表对应</p>
<p><img src="http://files.luyanan.com//img/20200407095440.png" alt="image-20200407095438928"></p>
<h4 id="1-5-4-绑定表"><a href="#1-5-4-绑定表" class="headerlink" title="1.5.4  绑定表"></a>1.5.4  绑定表</h4><p>跟Mycat 的ER表对应</p>
<p><img src="http://files.luyanan.com//img/20200407095800.png" alt="image-20200407095759112"></p>
<h3 id="1-6-使用规范"><a href="#1-6-使用规范" class="headerlink" title="1.6 使用规范"></a>1.6 使用规范</h3><p>不支持的SQL </p>
<p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/sharding/use-norms/sql/">https://shardingsphere.apache.org/document/current/cn/features/sharding/use-norms/sql/</a></p>
<p>分页的说明</p>
<p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/sharding/use-norms/pagination/">https://shardingsphere.apache.org/document/current/cn/features/sharding/use-norms/pagination/</a></p>
<h2 id="2-Sharding-JDBC实战"><a href="#2-Sharding-JDBC实战" class="headerlink" title="2. Sharding-JDBC实战"></a>2. <code>Sharding-JDBC</code>实战</h2><p>快速入门</p>
<p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/quick-start/sharding-jdbc-quick-start/">https://shardingsphere.apache.org/document/current/cn/quick-start/sharding-jdbc-quick-start/</a></p>
<h3 id="2-1-引入依赖"><a href="#2-1-引入依赖" class="headerlink" title="2.1 引入依赖"></a>2.1 引入依赖</h3><p>注意, 在SpringBoot 中使用<code>Sharding-JDBC</code> ,可以直接引入<code>sharding-jdbc</code>的依赖,注意组织名称(<code>groupId</code>)的区别</p>
<p><code>https://mvnrepository.com/artifact/io.shardingjdbc</code>:  更名之前</p>
<p><code>https://mvnrepository.com/artifact/io.shardingsphere</code>: 更名之后</p>
<p><code>https://mvnrepository.com/artifact/org.apache.shardingsphere</code>: 捐献给<code>Apache</code> 之后</p>
<p>包名和某些类有差异,如果替换需要注意, <code>import</code> 的包名都需要修改. </p>
<p>核心依赖是(<code>artifactId</code>): <code>sharding-jdbc-core</code> 和 <code>sharding-core</code></p>
<p>前两个<code>groupId</code>在SpringBoot 中还提供了<code>starter</code>, Apache的暂时没有</p>
<h3 id="2-2-原生JDBC使用"><a href="#2-2-原生JDBC使用" class="headerlink" title="2.2  原生JDBC使用"></a>2.2  原生JDBC使用</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>database<span class="token punctuation">.</span>jdbc<span class="token punctuation">;</span>

<span class="token keyword">import</span> io<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>config<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>ShardingRuleConfiguration<span class="token punctuation">;</span>
<span class="token keyword">import</span> io<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>config<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>TableRuleConfiguration<span class="token punctuation">;</span>
<span class="token keyword">import</span> io<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>config<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>InlineShardingStrategyConfiguration<span class="token punctuation">;</span>
<span class="token keyword">import</span> io<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>shardingjdbc<span class="token punctuation">.</span>api<span class="token punctuation">.</span>ShardingDataSourceFactory<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>dbcp<span class="token punctuation">.</span>BasicDataSource<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>DataSource<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>Connection<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>PreparedStatement<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>ResultSet<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>SQLException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Properties<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author luyanan
 * @since 2020/4/7
 * &lt;p>jdbc&lt;/p>
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShardJDBCTest</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 配置普通的数据源</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> DataSource<span class="token operator">></span> dataSourceMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 配置第一个数据源</span>
        BasicDataSource dataSource1 <span class="token operator">=</span> <span class="token function">createDataSource</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://localhost:3306/shard0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//  配置第二个数据源</span>
        BasicDataSource dataSource2 <span class="token operator">=</span> <span class="token function">createDataSource</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://localhost:3306/shard1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        dataSourceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ds0"</span><span class="token punctuation">,</span> dataSource1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSourceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ds1"</span><span class="token punctuation">,</span> dataSource2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 配置Order 表规则</span>
        TableRuleConfiguration orderTableRuleConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TableRuleConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderTableRuleConfig<span class="token punctuation">.</span><span class="token function">setLogicTable</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderTableRuleConfig<span class="token punctuation">.</span><span class="token function">setActualDataNodes</span><span class="token punctuation">(</span><span class="token string">"ds$&amp;#123;0..1&amp;#125;.order$&amp;#123;0..1&amp;#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 配置分库+分表策略</span>
        orderTableRuleConfig<span class="token punctuation">.</span><span class="token function">setDatabaseShardingStrategyConfig</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">InlineShardingStrategyConfiguration</span><span class="token punctuation">(</span><span class="token string">"order_id"</span><span class="token punctuation">,</span> <span class="token string">"ds$&amp;#123;order_id % 2&amp;#125;"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderTableRuleConfig<span class="token punctuation">.</span><span class="token function">setTableShardingStrategyConfig</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">InlineShardingStrategyConfiguration</span><span class="token punctuation">(</span><span class="token string">"order_id"</span><span class="token punctuation">,</span> <span class="token string">"order$&amp;#123;order_id % 2&amp;#125;"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 配置分片规则</span>
        ShardingRuleConfiguration shardingRuleConfiguration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShardingRuleConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        shardingRuleConfiguration<span class="token punctuation">.</span><span class="token function">getTableRuleConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderTableRuleConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取数据源</span>
        DataSource dataSource <span class="token operator">=</span> ShardingDataSourceFactory<span class="token punctuation">.</span><span class="token function">createDataSource</span><span class="token punctuation">(</span>dataSourceMap<span class="token punctuation">,</span> shardingRuleConfiguration<span class="token punctuation">,</span> map<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        String sql <span class="token operator">=</span> <span class="token string">"select * from order where user_id = ?"</span><span class="token punctuation">;</span>
        Connection connection <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        PreparedStatement preparedStatement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        preparedStatement<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2673</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>ResultSet rs <span class="token operator">=</span> preparedStatement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// %2结果，路由到 shard1.order1</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"order_id---------"</span> <span class="token operator">+</span> rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"user_id---------"</span> <span class="token operator">+</span> rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"create_time---------"</span> <span class="token operator">+</span> rs<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"total_price---------"</span> <span class="token operator">+</span> rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> BasicDataSource <span class="token function">createDataSource</span><span class="token punctuation">(</span>String url<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        BasicDataSource dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"rootroot"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>总结: <code>ShardingRuleConfiguration</code> 可以包含多个<code>TableRuleConfiguration</code>(多张表), 也可以设置默认的分库和分表策略</p>
<p>每个<code>TableRuleConfiguration</code>  可以针对表设置 <code>ShardingStrategyConfiguration</code>, 包括分库分表策略</p>
<p><code>ShardingStrategyConfiguration</code> 有5种实现(标准、行内、复合、Hint、无)</p>
<p><code>ShardingDataSourceFactory</code> 利用了 <code>ShardingStrategyConfiguration</code>  创建数据源</p>
<p>有了数据源, 就可以走JDBC的流程了.</p>
<p><img src="http://files.luyanan.com//img/20200407103428.png" alt="image-20200407103427714"></p>
<p>在JDBC中使用,我们可以直接创建数据源, 如果在Spring 中使用, 我们自定义的数据源怎么定义呢? 可以通过注解或者xml 配置文件注入. </p>
<h3 id="2-3-Spring-使用"><a href="#2-3-Spring-使用" class="headerlink" title="2.3 Spring 使用"></a>2.3 Spring 使用</h3><p>先来总结一下, 因为我们要使用<code>Sharding-JDBC</code> 去访问数据库,所以我们不再使用ORM框架或者容器去定义数据源, 而是注入到<code>Sharding-JDBC</code> 自定义的数据源, 这样才能保证动态的选择数据源。</p>
<p>第二个, 因为<code>Sharding-JDBC</code> 是工作在客户端, 所以我们要在客户端配置分库分表的策略,跟Mycat 不一样的是, <code>Sharding-JDBC</code> 没有内置各种分片策略和算法,需要我们通过表达式或者自定义的配置文件实现。我们创建的数据源中包含了分片的策略. </p>
<p>总体上, 需要配置的就是这两个,数据源和分片策略。当然分片策略又包含分库策略和分表的策略. </p>
<p>配置的方式是各种各样的. </p>
<p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/configuration/config-java/">https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/configuration/config-java/</a></p>
<p>位置: 4 用户手册-?&gt; 4.1 <code>Sharding-JDBC</code> -&gt; 4.1.2 配置手册</p>
<h4 id="2-3-1-java配置"><a href="#2-3-1-java配置" class="headerlink" title="2.3.1 java配置"></a>2.3.1 java配置</h4><p>第一种是把数据源和分片策略都写在<code>Java Config</code> 中,它的特点是非常灵活的, 我们可以实现各种定义的分片策略。但是缺点是, 如果把数据源和策略都配置在<code>Java Config</code> 中, 就出现了硬编码, 在修改的时候就比较麻烦. </p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShardingJDBCDataSourceConfig</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Primary</span>
    <span class="token keyword">public</span> DataSource <span class="token function">shardingDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        ShardingRuleConfiguration src <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShardingRuleConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 默认的分库策略</span>
        src<span class="token punctuation">.</span><span class="token function">setDefaultDatabaseShardingStrategyConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StandardShardingStrategyConfiguration</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> DBShardAlgo<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 默认的分表策略</span>
        src<span class="token punctuation">.</span><span class="token function">setDefaultTableShardingStrategyConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StandardShardingStrategyConfiguration</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> TblPreShardAlgo<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TblRangeShardAlgo<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 为user_info表设置分库分表策略、算法</span>
        <span class="token comment" spellcheck="true">// src.getTableRuleConfigs().add(getUserTableRuleConfiguration());</span>
        <span class="token comment" spellcheck="true">// 数据源名和数据源的映射表</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ShardingDataSource</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token function">createDataSourceMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 配置数据源</span>
    <span class="token keyword">private</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> DataSource<span class="token operator">></span> <span class="token function">createDataSourceMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> DataSource<span class="token operator">></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"shard0"</span><span class="token punctuation">,</span> <span class="token function">createDataSource</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://localhost:3306/shard0?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=UTC"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"shard1"</span><span class="token punctuation">,</span> <span class="token function">createDataSource</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://localhost:3306/shard1?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=UTC"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 根据数据源地址创建 DataSource</span>
    <span class="token keyword">private</span> DataSource <span class="token function">createDataSource</span><span class="token punctuation">(</span><span class="token keyword">final</span> String dataSourceName<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        BasicDataSource result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>dataSourceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 事务管理器</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> DataSourceTransactionManager <span class="token function">transactitonManager</span><span class="token punctuation">(</span>DataSource shardingDataSource<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">(</span>shardingDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 为user_info表设置分库分表策略、算法</span>
    <span class="token keyword">public</span> TableRuleConfiguration <span class="token function">getUserTableRuleConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        TableRuleConfiguration userTableRuleConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TableRuleConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userTableRuleConfig<span class="token punctuation">.</span><span class="token function">setLogicTable</span><span class="token punctuation">(</span><span class="token string">"user_info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userTableRuleConfig<span class="token punctuation">.</span><span class="token function">setActualDataNodes</span><span class="token punctuation">(</span><span class="token string">"ds0.user_info, ds1.user_info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userTableRuleConfig<span class="token punctuation">.</span><span class="token function">setDatabaseShardingStrategyConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StandardShardingStrategyConfiguration</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> DBShardAlgo<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userTableRuleConfig<span class="token punctuation">.</span><span class="token function">setTableShardingStrategyConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StandardShardingStrategyConfiguration</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> TblPreShardAlgo<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TblRangeShardAlgo<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> userTableRuleConfig<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="2-3-2-SpringBoot-配置"><a href="#2-3-2-SpringBoot-配置" class="headerlink" title="2.3.2 SpringBoot 配置"></a>2.3.2 SpringBoot 配置</h4><p>第二种是直接使用SpringBoot的<code>application.properties</code> 来配置, 这个要基于<code>start</code> 模块, <code>，org.apache.shardingsphere</code>的包还没有<code>starter</code>,只有<code>o.shardingsphere</code>的包有<code>starter</code></p>
<p>把数据源和分库分表的策略都配置在<code>application.properties</code>文件中, 这种方式配置简单, 但是不能实现复杂的分片策略, 不够灵活. </p>
<pre class=" language-properties"><code class="language-properties">
<span class="token comment" spellcheck="true"># 数据源配置</span>
<span class="token attr-name">sharding.jdbc.datasource.names</span><span class="token punctuation">=</span><span class="token attr-value">shard0,shard1</span>
<span class="token attr-name">sharding.jdbc.datasource.ds0.type</span><span class="token punctuation">=</span><span class="token attr-value">com.alibaba.druid.pool.DruidDataSource</span>
<span class="token attr-name">sharding.jdbc.datasource.ds0.driver-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.mysql.jdbc.Driver</span>
<span class="token attr-name">sharding.jdbc.datasource.ds0.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://localhost:3306/shard0</span>
<span class="token attr-name">sharding.jdbc.datasource.ds0.username</span><span class="token punctuation">=</span><span class="token attr-value">root</span>
<span class="token attr-name">sharding.jdbc.datasource.ds0.password</span><span class="token punctuation">=</span><span class="token attr-value">rootroot</span>

<span class="token attr-name">sharding.jdbc.datasource.ds1.type</span><span class="token punctuation">=</span><span class="token attr-value">com.alibaba.druid.pool.DruidDataSource</span>
<span class="token attr-name">sharding.jdbc.datasource.ds1.driver-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.mysql.jdbc.Driver</span>
<span class="token attr-name">sharding.jdbc.datasource.ds1.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://localhost:3306/shard1</span>
<span class="token attr-name">sharding.jdbc.datasource.ds1.username</span><span class="token punctuation">=</span><span class="token attr-value">root</span>
<span class="token attr-name">sharding.jdbc.datasource.ds1.password</span><span class="token punctuation">=</span><span class="token attr-value">rootroot</span>

<span class="token comment" spellcheck="true">#sharding.jdbc.config.sharding.default-database-strategy.inline.sharding-column=user_id</span>
<span class="token comment" spellcheck="true">#sharding.jdbc.config.sharding.default-database-strategy.inline.algorithm-expression=ds$&amp;#123;user_id % 2&amp;#125;</span>

<span class="token comment" spellcheck="true"># 分库算法 user_info，多库分表</span>
<span class="token comment" spellcheck="true"># 单库内没有分表，注释了分表策略</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.user_info.actual-data-nodes</span><span class="token punctuation">=</span><span class="token attr-value">ds$->&amp;#123;0..1&amp;#125;.user_info</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.user_info.databaseStrategy.inline.shardingColumn</span><span class="token punctuation">=</span><span class="token attr-value">user_id</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.user_info.databaseStrategy.inline.algorithm-expression</span><span class="token punctuation">=</span><span class="token attr-value">ds$&amp;#123;user_id % 2&amp;#125;</span>
<span class="token comment" spellcheck="true">###sharding.jdbc.config.sharding.tables.user_info.databaseStrategy.standard.shardingColumn=user_id</span>
<span class="token comment" spellcheck="true">###sharding.jdbc.config.sharding.tables.user_info.databaseStrategy.standard.preciseAlgorithmClassName=com.gupaoedu.config.DBShardAlgo</span>
<span class="token comment" spellcheck="true">###sharding.jdbc.config.sharding.tables.user_info.tableStrategy.standard.shardingColumn=user_id</span>
<span class="token comment" spellcheck="true">###sharding.jdbc.config.sharding.tables.user_info.tableStrategy.standard.preciseAlgorithmClassName=com.gupaoedu.config.TblPreShardAlgo</span>
<span class="token comment" spellcheck="true">###sharding.jdbc.config.sharding.tables.user_info.tableStrategy.standard.rangeAlgorithmClassName=com.gupaoedu.config.TblRangeShardAlgo</span>
<span class="token comment" spellcheck="true">##sharding.jdbc.config.sharding.tables.user_info.table-strategy.inline.sharding-column=user_id</span>
<span class="token comment" spellcheck="true">##sharding.jdbc.config.sharding.tables.user_info.table-strategy.inline.algorithm-expression=user_info</span>

<span class="token comment" spellcheck="true"># 分库算法 t_order 多库分表</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.t_order.databaseStrategy.inline.shardingColumn</span><span class="token punctuation">=</span><span class="token attr-value">order_id</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.t_order.databaseStrategy.inline.algorithm-expression</span><span class="token punctuation">=</span><span class="token attr-value">ds$&amp;#123;order_id % 2&amp;#125;</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.t_order.actual-data-nodes</span><span class="token punctuation">=</span><span class="token attr-value">ds$->&amp;#123;0..1&amp;#125;.t_order</span>

<span class="token comment" spellcheck="true"># 分库算法 t_order_item 多库分表</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.t_order_item.databaseStrategy.inline.shardingColumn</span><span class="token punctuation">=</span><span class="token attr-value">order_id</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.t_order_item.databaseStrategy.inline.algorithm-expression</span><span class="token punctuation">=</span><span class="token attr-value">ds$&amp;#123;order_id % 2&amp;#125;</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.t_order_item.actual-data-nodes</span><span class="token punctuation">=</span><span class="token attr-value">ds$->&amp;#123;0..1&amp;#125;.t_order_item</span>

<span class="token comment" spellcheck="true"># 绑定表规则列表，防止关联查询出现笛卡尔积</span>
<span class="token attr-name">sharding.jdbc.config.sharding.binding-tables[0]</span><span class="token punctuation">=</span><span class="token attr-value">t_order,t_order_item</span>

<span class="token comment" spellcheck="true"># 广播表</span>
<span class="token attr-name">sharding.jdbc.config.sharding.broadcast-tables</span><span class="token punctuation">=</span><span class="token attr-value">t_config</span>
</code></pre>
<h4 id="2-3-3-yml配置"><a href="#2-3-3-yml配置" class="headerlink" title="2.3.3 yml配置"></a>2.3.3 <code>yml</code>配置</h4><p>第三种是<code>Spring Boot</code>的<code>yml</code>配置, 也要依赖<code>starter</code>模块, 当然我们也可以结合不同的配置方法, 比如把分片策略放在<code>Java Config</code>中, 数据源配置在<code>yml</code> 中或者<code>properties</code> 中. </p>
<h3 id="2-4-Spring案例验证"><a href="#2-4-Spring案例验证" class="headerlink" title="2.4 Spring案例验证"></a>2.4 Spring案例验证</h3><p>这里验证的是切分到本地的两个库<code>shard0</code>和<code>shard1</code></p>
<p>两个库里面都是相同的四张表(<code>user_info</code>，<code>t_order</code>，<code>t_order_item</code>，<code>t_config</code>)</p>
<p>这些表必须提前创建, 中见表不会帮助我们生成的. </p>
<p>然后我们用Mybatis的generator 生成相应的实体类、Mapper接口和映射器</p>
<p>对数据库的基本的SSM的操作弄完了, 接下来就是分库分表的配置, 一个是数据源, 一个是分片策略. </p>
<p>我们先来看一下我们的数据源的配置<code>application.properties</code></p>
<pre class=" language-properties"><code class="language-properties">sharding.jdbc.datasource
</code></pre>
<p>如果用Spring 管理数据源</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://192.168.8.168:8066/shard1</span>
<span class="token attr-name">spring.datasource.username</span><span class="token punctuation">=</span><span class="token attr-value">root</span>
<span class="token attr-name">spring.datasource.password</span><span class="token punctuation">=</span><span class="token attr-value">rootroot</span>
<span class="token attr-name">spring.datasource.driver-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.mysql.jdbc.Driver</span>
</code></pre>
<p>但我们使用了<code>Sharding-JDBC</code>的数据源之后, 对于数据的操作就会交给<code>Sharding-JDBC</code>的代码处理. </p>
<p>分片策略从维度上分为两种: 一种是分库, 一种是分表.</p>
<p>我们可以定义默认的分库分表策略,例如用<code>user_id</code> 作为分片键, 这里用到了一种分片策略的实现 ,叫做行内表达式. 我们对<code>user_id</code>取模, 然后选择数据库. 如果 模等于0, 在第一个数据库中,模等于1, 在第二个数据库中.</p>
<p>数据源名称是行内表达式组装出来的</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">sharding.jdbc.config.sharding.default-database-strategy.inline.sharding-column</span><span class="token punctuation">=</span><span class="token attr-value">user_id</span>
<span class="token attr-name">sharding.jdbc.config.sharding.default-database-strategy.inline.algorithm-expression</span><span class="token punctuation">=</span><span class="token attr-value">ds$&amp;#123;user_id % 2&amp;#125;</span>
</code></pre>
<p>对于不同的表, 也可以单独配置分库策略(<code>databaseStrategy</code>) 和分表策略(<code>tableStrategy</code>), </p>
<p>使用以下配置打印路由信息</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">sharding.jdbc.config.sharding.props.sql.show</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
</code></pre>
<h4 id="2-4-1-取模分片"><a href="#2-4-1-取模分片" class="headerlink" title="2.4.1 取模分片"></a>2.4.1 取模分片</h4><p>我们用<code>user_info</code> 表来验证取模分片,根据<code>user_id</code>, 把用户数据划分到两个数据节点上. </p>
<p>在本地创建两个数据库<code>shard0</code>和<code>shard1</code>, 都创建<code>user_info</code>表. </p>
<pre class=" language-mysql"><code class="language-mysql">CREATE TABLE `user_info` (
`user_id` bigint(19) NOT NULL,
`user_name` varchar(45) DEFAULT NULL,
`account` varchar(45) NOT NULL,
`password` varchar(45) DEFAULT NULL,
 PRIMARY KEY (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre>
<p>这里只定义了分库策略, 没有定义单库内的分表策略, 两个库都是相同的表. </p>
<p>路由的结果 ：<code>ds0.user_info</code>，<code>ds1.user_info</code></p>
<p>如果定义了分库策略, 两个库里面都有两张表, 那么路由的结果可能有4种: </p>
<pre class=" language-text"><code class="language-text">ds0.user_info0，
ds0.user_info1；
ds1. user_info0,
ds1. user_info1
</code></pre>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">sharding.jdbc.config.sharding.tables.user_info.databaseStrategy.inline.shardingColumn</span><span class="token punctuation">=</span><span class="token attr-value">user_id</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.user_info.databaseStrategy.inline.algorithm-expression</span><span class="token punctuation">=</span><span class="token attr-value">ds$&amp;#123;user_id % 2&amp;#125;</span>
<span class="token comment" spellcheck="true">#sharding.jdbc.config.sharding.tables.user_info.table-strategy.inline.sharding-column=user_id</span>
<span class="token comment" spellcheck="true">#sharding.jdbc.config.sharding.tables.user_info.table-strategy.inline.algorithm-expression=user_info</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.user_info.actual-data-nodes</span><span class="token punctuation">=</span><span class="token attr-value">ds$->&amp;#123;0..1&amp;#125;.user_info</span>
</code></pre>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">"com.database.dao"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserShardingTest</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Autowired</span>
    UserInfoService userInfoService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

        userInfoService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        UserInfo userInfo1 <span class="token operator">=</span> userInfoService<span class="token punctuation">.</span><span class="token function">getUserInfoByUserId</span><span class="token punctuation">(</span>1L<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------userInfo1:"</span> <span class="token operator">+</span> userInfo1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        UserInfo userInfo2 <span class="token operator">=</span> userInfoService<span class="token punctuation">.</span><span class="token function">getUserInfoByUserId</span><span class="token punctuation">(</span>2L<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------userInfo2:"</span> <span class="token operator">+</span> userInfo2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoService</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> UserInfoMapper userInfoMapper<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> Long userId <span class="token operator">=</span> 1L<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

            UserInfo userInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            userInfo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            userInfo<span class="token punctuation">.</span><span class="token function">setAccount</span><span class="token punctuation">(</span><span class="token string">"account"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            userInfo<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"password"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            userInfo<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token string">"name"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            userId<span class="token operator">++</span><span class="token punctuation">;</span>
            userInfoMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>


    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> UserInfo <span class="token function">getUserInfoByUserId</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> userInfoMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>UserInfo<span class="token operator">></span> <span class="token function">selectByRange</span><span class="token punctuation">(</span>Long firstId<span class="token punctuation">,</span> Long lastId<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> userInfoMapper<span class="token punctuation">.</span><span class="token function">selectByRange</span><span class="token punctuation">(</span>firstId<span class="token punctuation">,</span> lastId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>演示结果: </p>
<p>我们看一下插入的结果, <code>user_id</code> 为偶数的数据, 都落到了第一个库,<code>user_id</code>为奇数的库,都落到了第二个库. </p>
<p>执行<code>select()</code> 测一下查询, 看看数据分布到两个节点的时候 ,我们用程序查询, 能不能取回正确的数据. </p>
<h4 id="2-4-2-绑定表"><a href="#2-4-2-绑定表" class="headerlink" title="2.4.2 绑定表"></a>2.4.2 绑定表</h4><p>第二种是绑定表, 也就是父表和子表有关联关系, 主表和子表使用相同的分片策略. </p>
<pre class=" language-mysql"><code class="language-mysql">CREATE TABLE `t_order` (
`order_id` int(11) NOT NULL,
`user_id` int(11) NOT NULL,
 PRIMARY KEY (`order_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `t_order_item` (
`item_id` int(11) NOT NULL,
`order_id` int(11) NOT NULL,
 `user_id` int(11) NOT NULL,
  PRIMARY KEY (`item_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre>
<p>除了定义分库和分表的算法之外, 我们还需要多定义一个<code>binding-tables</code>. </p>
<p>绑定表将使用主表的分片策略. </p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">sharding.jdbc.config.sharding.tables.user_info.databaseStrategy.inline.shardingColumn</span><span class="token punctuation">=</span><span class="token attr-value">user_id</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.user_info.databaseStrategy.inline.algorithm-expression</span><span class="token punctuation">=</span><span class="token attr-value">ds$&amp;#123;user_id % 2&amp;#125;</span>
<span class="token comment" spellcheck="true">#sharding.jdbc.config.sharding.tables.user_info.table-strategy.inline.sharding-column=user_id</span>
<span class="token comment" spellcheck="true">#sharding.jdbc.config.sharding.tables.user_info.table-strategy.inline.algorithm-expression=user_info</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.user_info.actual-data-nodes</span><span class="token punctuation">=</span><span class="token attr-value">ds$->&amp;#123;0..1&amp;#125;.user_info</span>
<span class="token comment" spellcheck="true"># 分库算法 t_order 多库分表</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.t_order.databaseStrategy.inline.shardingColumn</span><span class="token punctuation">=</span><span class="token attr-value">order_id</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.t_order.databaseStrategy.inline.algorithm-expression</span><span class="token punctuation">=</span><span class="token attr-value">ds$&amp;#123;order_id % 2&amp;#125;</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.t_order.actual-data-nodes</span><span class="token punctuation">=</span><span class="token attr-value">ds$->&amp;#123;0..1&amp;#125;.t_order</span>
<span class="token comment" spellcheck="true"># 分库算法 t_order_item 多库分表</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.t_order_item.databaseStrategy.inline.shardingColumn</span><span class="token punctuation">=</span><span class="token attr-value">order_id</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.t_order_item.databaseStrategy.inline.algorithm-expression</span><span class="token punctuation">=</span><span class="token attr-value">ds$&amp;#123;order_id % 2&amp;#125;</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.t_order_item.actual-data-nodes</span><span class="token punctuation">=</span><span class="token attr-value">ds$->&amp;#123;0..1&amp;#125;.t_order_item</span>
<span class="token comment" spellcheck="true"># 绑定表规则列表</span>
<span class="token attr-name">sharding.jdbc.config.sharding.binding-tables[0]</span><span class="token punctuation">=</span><span class="token attr-value">t_order,t_order_item</span>
</code></pre>
<p>绑定表不使用分片键查询时, 会出现笛卡尔积。 </p>
<p>什么叫笛卡尔积,假如有2个数据库, 两张表要相互关联, 两张表又各有分表, 那么SQL的执行路径就是<code>是 2*2*2=8 </code>种</p>
<p><img src="http://files.luyanan.com//img/20200407212653.png" alt="image-20200407212614047"></p>
<h4 id="2-4-3-广播表"><a href="#2-4-3-广播表" class="headerlink" title="2.4.3  广播表"></a>2.4.3  广播表</h4><pre class=" language-java"><code class="language-java">
<span class="token comment" spellcheck="true">/**
 * @author luyanan
 * @since 2020/4/7
 * &lt;p>广播表的分库分表策略&lt;/p>
 **/</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.database.dao"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigShardingTest</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Resource</span>
    ConfigService configService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

        configService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

        configService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        Config config1 <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">geConfigById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------config1:"</span><span class="token operator">+</span>config1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Config config2 <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">geConfigById</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------config2:"</span><span class="token operator">+</span>config2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>插入和更新都会在所有的节点上执行 </p>
<p>如果我们需要更加复杂的分片策略, <code>properties</code> 文件内行内表达式的这种方式肯定满足不了 , 实际上<code>properties</code> 里面的分片策略都可以指定, 比如<code>user_info</code> 表的分库和分表策略. </p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">sharding.jdbc.config.sharding.tables.user_info.tableStrategy.standard.shardingColumn</span><span class="token punctuation">=</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.user_info.tableStrategy.standard.preciseAlgorithmClassName</span><span class="token punctuation">=</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.user_info.tableStrategy.standard.rangeAlgorithmClassName</span><span class="token punctuation">=</span>
</code></pre>
<p>这个时候我们需要了解<code>Sharding-JDBC</code> 中几种不同的分片策略. </p>
<h2 id="3-分片策略详解"><a href="#3-分片策略详解" class="headerlink" title="3. 分片策略详解"></a>3. 分片策略详解</h2><p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/sharding/concept/sharding/">https://shardingsphere.apache.org/document/current/cn/features/sharding/concept/sharding/</a></p>
<p><code>Sharding-JDBC</code>中的分片策略有两个维度,分库(数据源分片)策略和分表策略. </p>
<p>分库策略表示数据路由到物理目标数据源, 分表分片策略表示数据被路由到的目的表。 分表策略是依赖分库策略的, 也就是说要先分库再分表, 当然也可以不分库只分表</p>
<p>跟Mycat 不一样的是, <code>Sharding-jdbc</code>  没有提供内置的分片算法, 而是通过抽象成接口, 让开发者自行去实现, 这样可以根据业务实际情况灵活地实现. </p>
<h3 id="3-1-分片策略"><a href="#3-1-分片策略" class="headerlink" title="3.1 分片策略"></a>3.1 分片策略</h3><p>包含分片键和分片算法, 分片算法是需要自定义的, 可以用于分库, 也可以用于分表. </p>
<p><code>Sharding-JDBC</code>  提供了5种分片策略, 这些策略全部继承自<code>ShardingStrategy</code></p>
<p><img src="http://files.luyanan.com//img/20200407215328.png" alt="image-20200407215326062"></p>
<h4 id="3-1-1-行表达式分片策略"><a href="#3-1-1-行表达式分片策略" class="headerlink" title="3.1.1 行表达式分片策略"></a>3.1.1 行表达式分片策略</h4><p>对应<code>InlineShardingStrategy</code> 类,只支持单分片键, 提供对<code>+</code>和<code>IN</code>操作的支持, 行内表达式    的配置比较简单. </p>
<p>例如: <code>$&#123;begin..end&#125;</code>: 表示范围区间</p>
<p><code>$&#123;[unit1, unit2, unit_x]&#125;</code>: 表示枚举值</p>
<p><code>t_user_$-&gt;&#123;u_id % 8&#125;</code>: 表示<code>t_user</code> 表根据<code>u_id</code>模8, 而分成8张表,表名称为<code>t_user_0</code>到<code>t_user_8</code> </p>
<p>行表达式中如果出现连续多个<code>个$&#123; expression &#125;</code>或<code>$-&gt;&#123; expression &#125;</code> 表达式, 整个表达式最终的结果将会根据每个子表达式的结果进行笛卡尔积. </p>
<p>例如: 以下行表达式</p>
<p><code>$&#123;[&#39;db1&#39;, &#39;db2&#39;]&#125;_table$&#123;1..3&#125;</code><br>最终会解析为: </p>
<p><code>db1_table1</code>, <code>db1_table2</code>, <code>db1_table3</code>, <code>db2_table1</code>,<code>db2_table2</code>,<code>db2_table3</code></p>
<h4 id="3-1-2-标准分片策略"><a href="#3-1-2-标准分片策略" class="headerlink" title="3.1.2 标准分片策略"></a>3.1.2 标准分片策略</h4><p>对应<code>StandardShardingStrategy</code> 类</p>
<p>标准分片策略只支持单分片键, 提供了提供<code>PreciseShardingAlgorithm</code> 和 <code>RangeShardingAlgorithm</code> 两个分片算法,分别对应SQL 语句中的<code>=</code>、<code>IN</code>和<code>BETWEEN AND</code></p>
<p>如果要使用标准分片策略, 必须实现<code>PreciseShardingAlgorithm</code>, 用来处理<code>=</code>和<code>IN</code>的分片上。<code>RangeShardingAlgorithm</code> 是可选的, 如果没有实现,SQL语句会发到所有的数据节点上执行. </p>
<h4 id="3-1-3-符合分片策略"><a href="#3-1-3-符合分片策略" class="headerlink" title="3.1.3 符合分片策略"></a>3.1.3 符合分片策略</h4><p>比如: 根据日期和ID两个字段分片,每个月3张表,先根据日期, 再根据id取模,</p>
<p>对应<code>ComplexShardingStrategy</code> 类, 可以支持等值查询和范围查询. </p>
<p>符合分片策略支持多分片键, 提供了<code>ComplexKeysShardingAlgorithm</code>,分片算法需要自己实现. </p>
<h4 id="3-1-4-Hint-分片策略"><a href="#3-1-4-Hint-分片策略" class="headerlink" title="3.1.4 Hint 分片策略"></a>3.1.4 Hint 分片策略</h4><p>对应<code>HintShardingStrategy</code>. 通过<code>Hint</code> 而非SQL解析的方式分片的策略, 有点类似于Mycat 的指定分片注解. </p>
<p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/usage/hint/">https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/usage/hint/</a></p>
<h4 id="3-1-5-不分片策略"><a href="#3-1-5-不分片策略" class="headerlink" title="3.1.5  不分片策略"></a>3.1.5  不分片策略</h4><p>对应<code>NoneShardingStrategy</code>, 不分片的策略</p>
<h3 id="3-2-分片算法"><a href="#3-2-分片算法" class="headerlink" title="3.2 分片算法"></a>3.2 分片算法</h3><p>创建了分片策略之后, 还需要实现分片算法, <code>Sharding-JDBC</code> 目前提供了4种分片算法. </p>
<h4 id="3-2-1-精确分片算法"><a href="#3-2-1-精确分片算法" class="headerlink" title="3.2.1 精确分片算法"></a>3.2.1 精确分片算法</h4><p>对应<code>PreciseShardingAlgorithm</code>,用于处理使用单一键作为分片键的<code>=</code>与<code>IN</code> 进行分片的场景,需要配合<code>StandardShardingStrategy</code> 使用. </p>
<h4 id="3-2-2-范围分片算法"><a href="#3-2-2-范围分片算法" class="headerlink" title="3.2.2 范围分片算法"></a>3.2.2 范围分片算法</h4><p>对应<code>RangeShardingAlgorithm</code> ,用于处理使用单一键作为分片键的<code>BETWEEN AND</code> 进行分片的场景, 需要配合<code>StandardShardingStrategy</code> 使用. </p>
<p>如果不配置范围分片算法, 范围查询默认会路由到所有的节点. </p>
<h4 id="3-2-3-复合分片算法"><a href="#3-2-3-复合分片算法" class="headerlink" title="3.2.3 复合分片算法"></a>3.2.3 复合分片算法</h4><p>对应<code>ComplexKeysShardingAlgorithm</code>, 用于处理使用多键作为分片键进行分片的场景, 包含多个分片键的逻辑较为复杂，需要应用开发者自行处理其中的复杂度,需要配合<code>ComplexShardingStrategy</code> 使用. </p>
<h4 id="3-2-4-Hint-分片算法"><a href="#3-2-4-Hint-分片算法" class="headerlink" title="3.2.4 Hint 分片算法"></a>3.2.4 Hint 分片算法</h4><p>对应<code>HintShardingAlgorithm</code>, 用于处理使用Hint 行分片的场景, 需要配合<code>HintShardingStrategy</code> 使用. </p>
<p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/usage/hint/">https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/usage/hint/</a></p>
<h4 id="3-2-5-算法实现"><a href="#3-2-5-算法实现" class="headerlink" title="3.2.5 算法实现"></a>3.2.5 算法实现</h4><p>所有的算法都需要实现对应的接口, 实现<code>doSharding()</code> 方法.</p>
<p>例如: <code>PreciseShardingAlgorithm</code></p>
<p>传入分片键,返回一个精确的分片(数据源名称)</p>
<pre class=" language-java"><code class="language-java">String <span class="token function">doSharding</span><span class="token punctuation">(</span>Collection<span class="token operator">&lt;</span>String<span class="token operator">></span> availableTargetNames<span class="token punctuation">,</span> PreciseShardingValue<span class="token operator">&lt;</span>T<span class="token operator">></span> shardingValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>RangeShardingAlgorithm</code></p>
<p>传入分片键, 返回多个数据源名称</p>
<pre class=" language-java"><code class="language-java">Collection<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">doSharding</span><span class="token punctuation">(</span>Collection<span class="token operator">&lt;</span>String<span class="token operator">></span> availableTargetNames<span class="token punctuation">,</span> RangeShardingValue<span class="token operator">&lt;</span>T<span class="token operator">></span> shardingValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>ComplexKeysShardingAlgorithm</code></p>
<p>传入多个分片键,返回多个数据源名称</p>
<pre class=" language-java"><code class="language-java">Collection<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">doSharding</span><span class="token punctuation">(</span>Collection<span class="token operator">&lt;</span>String<span class="token operator">></span> availableTargetNames<span class="token punctuation">,</span> Collection<span class="token operator">&lt;</span>ShardingValue<span class="token operator">></span> shardingValues<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="4-分布式事务"><a href="#4-分布式事务" class="headerlink" title="4.分布式事务"></a>4.分布式事务</h2><h3 id="4-1-事务概况"><a href="#4-1-事务概况" class="headerlink" title="4.1 事务概况"></a>4.1 事务概况</h3><p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/transaction/">https://shardingsphere.apache.org/document/current/cn/features/transaction/</a></p>
<h3 id="4-2-两阶段事务-XA"><a href="#4-2-两阶段事务-XA" class="headerlink" title="4.2 两阶段事务-XA"></a>4.2 两阶段事务-XA</h3><p>添加依赖</p>
<pre class=" language-xml"><code class="language-xml">  <span class="token comment" spellcheck="true">&lt;!--xa分布式事务--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>sharding-transaction-2pc-xa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>sharding-transaction-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<p>默认用<code>atomikos</code> 实现的. </p>
<p>在<code>Server</code> 类上加上注解</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@ShardingTransactionType</span><span class="token punctuation">(</span>TransactionType<span class="token punctuation">.</span>XA<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> Exception<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
</code></pre>
<p>其他的事务类型:<code>Local</code>、<code>BASE</code></p>
<p>模拟在两个节点上操作,id=12673,id=12674 路由到两个节点,第二个节点上插入两个相同的对象,发生主键冲突,会发现回滚. </p>
<pre class=" language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">/**
     * 测试跨库事务
     */</span>
    <span class="token annotation punctuation">@ShardingTransactionType</span><span class="token punctuation">(</span>TransactionType<span class="token punctuation">.</span>XA<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> Exception<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTransactional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        User user1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">12673</span><span class="token punctuation">,</span> <span class="token string">"张三"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userDao<span class="token punctuation">.</span><span class="token function">addOne</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        User user2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">12674</span><span class="token punctuation">,</span> <span class="token string">"张三"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 主键冲突</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userDao<span class="token punctuation">.</span><span class="token function">addOne</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userDao<span class="token punctuation">.</span><span class="token function">addOne</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>XA 的实现类</p>
<p><code>ShardingTransactionManager</code> -&gt; <code>XATransactionManager</code>-&gt; <code>AtomikosTransactionManager</code></p>
<h3 id="4-3-柔性事务"><a href="#4-3-柔性事务" class="headerlink" title="4.3 柔性事务"></a>4.3 柔性事务</h3><p><code>ShardingSphere</code> 的柔性事务已经过第三方SPI实现<code>Sega</code>事务,<code>Sega</code> 引擎使用<code>Servicecomb-Saga</code></p>
<p>参考官方的这篇文章<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzIwMzc4NDY4Mw==&mid=2247486704&idx=1&sn=edc76d838cbed006a107573732ba271b&chksm=96cb6474a1bced623e55db47e2d2fa5b7493eff5730bc3a6d0a5f1c4b08d2cc27fcccd61513e&mpshare=1&scene=1&srcid=1022xTpRYjxUbdUEZPgLpvV6&sharer_sharetime=1571725596151&sharer_shareid=035a2b61dca579f53be4eae95018f9cf&key=07d257d046da7c4bd15ab473b579736eb78a263ceaf74f267306f034ad9d436c49c55f92ae9d7ab24b1fd410a4de62b2ae1c6f968405882d59633162adc18476f01c6db048de3071e6c2549918a20836&ascene=1&uin=MTE5MTQzNjA0MA==&devicetype=Windows+7&version=62070152&lang=zh_CN&pass_ticket=Q2/OQotkJiA//FksN+2ivqC0PU2wLceaL8QDpYYehC5L5uxZ69kRygI53NXEXcdU">《分布式事务在 Sharding-Sphere 中的实现》</a></p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>sharding-transaction-2pc-spi<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<h3 id="4-4-柔性事务Seata"><a href="#4-4-柔性事务Seata" class="headerlink" title="4.4 柔性事务Seata"></a>4.4 柔性事务<code>Seata</code></h3><p><a target="_blank" rel="noopener" href="https://github.com/seata/seata">https://github.com/seata/seata</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/seata/seata-workshop">https://github.com/seata/seata-workshop</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/xfUGep5XMcIqRTGY3WFpgA">https://mp.weixin.qq.com/s/xfUGep5XMcIqRTGY3WFpgA</a></p>
<p><code>GTS</code> 的社区版本叫 <code>Fescar</code>（<code>Fast &amp; Easy Commit And Rollback</code>），<code>Fescar</code> 改名后 叫 <code>Seata AT</code>（<code>Simple Extensible Autonomous Transaction Architecture</code>）。</p>
<p>需要额外部署<code>Seata-server</code> 服务进行分支事务的协调. </p>
<p>官方的demo中有一个例子: </p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/incubator-shardingsphere-example">https://github.com/apache/incubator-shardingsphere-example</a></p>
<p><code>incubator-shardingsphere-example-dev\sharding-jdbc-example\transaction -example\transaction-base-seata-raw-jdbc-example</code></p>
<h2 id="5-分布式全局ID"><a href="#5-分布式全局ID" class="headerlink" title="5.  分布式全局ID"></a>5.  分布式全局ID</h2><p>我们可以使用<code>key-generator-column-name</code> 配置, 生成一个18位的ID</p>
<p><code>properties</code>的配置</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">sharding.jdbc.config.sharding.default-key-generator-class-name</span><span class="token punctuation">=</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.t_order.keyGeneratorColumnName</span><span class="token punctuation">=</span>
<span class="token attr-name">sharding.jdbc.config.sharding.tables.t_order.keyGeneratorClassName</span><span class="token punctuation">=</span>
</code></pre>
<p><code>Java Config</code>的配置</p>
<pre class=" language-java"><code class="language-java">tableRuleConfig<span class="token punctuation">.</span><span class="token function">setKeyGeneratorColumnName</span><span class="token punctuation">(</span><span class="token string">"order_id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
tableRuleConfig<span class="token punctuation">.</span><span class="token function">setKeyGeneratorClass</span><span class="token punctuation">(</span><span class="token string">"io.shardingsphere.core.keygen.DefaultKeyGenerator"</span><span class="token punctuation">)</span>
</code></pre>
<p><code>keyGeneratorColumnName</code>: 指定需要ID的实例</p>
<p><code>KeyGenerotorClass</code>：指定生成器类，默认是 <code>DefaultKeyGenerator.java</code>, 里面使用了雪花算法. </p>
<h2 id="6-Sharding-JDBC-工作流程"><a href="#6-Sharding-JDBC-工作流程" class="headerlink" title="6. Sharding-JDBC 工作流程"></a>6. <code>Sharding-JDBC</code> 工作流程</h2><p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/sharding/principle/">内核剖析</a></p>
<p><code>Sharding-JDBC</code>的原理总结起来很简单</p>
<p><code>SQL解析</code>-&gt; <code>执行器优化</code>-&gt;<code>SQL路由</code> -&gt;<code>SQL改写</code> -&gt;<code>SQL执行</code> -&gt; <code>结果归并</code></p>
<p><img src="http://files.luyanan.com//img/20200408094815.png" alt="image-20200408094743237"></p>
<h3 id="6-1-SQL解析"><a href="#6-1-SQL解析" class="headerlink" title="6.1 SQL解析"></a>6.1 SQL解析</h3><p>SQL解析主要是词法和语法的解析,目前常见的sql解析器有<code>fdb</code>、<code>jsqlparser</code>和<code>Druid</code>.<code>Shard-JDBC</code> 1.4x之前的版本使用的是<code>Druid</code> 作为sql解析器, 从 1.5X版本开始, <code>Sharding-JDBC</code> 采用完全自研的SQL解析引擎. </p>
<h3 id="6-2-SQL路由"><a href="#6-2-SQL路由" class="headerlink" title="6.2 SQL路由"></a>6.2 SQL路由</h3><p><img src="http://files.luyanan.com//img/20200408095205.png" alt="image-20200408095204423"></p>
<p>SQL路由是根据分片规则配置以及解析上下文的分片条件, 将SQL 定位至真正的数据源, 它又分为直接路由、简单路由和笛卡尔积路由. </p>
<p>直接路由,使用<code>Hint</code>方式. </p>
<p><code>Binding</code> 表是指使用同样的分片键和分片规则的一组表,也就是说任何情况下, <code>Binding</code> 表的分片结果应该与主表一致. 例如<code>order_info</code> 表和<code>order_item</code> 表, 都根据<code>order_id</code> 分片, 结果应该是<code>order_1</code>与<code>order_item_1</code>  成对出现. 这样的关联查询和单表查询复杂度和性能相当,如果分片条件不是等于, 而是<code>BETWEEN</code> 或者<code>IN</code>,则路由结果不一定落入单库(表)，因此一条逻辑sql最终可能拆分成多条SQL 语句. </p>
<p>笛卡尔积查询最为复杂,因为无法根据<code>Binding</code> 关系定位分片规则的一致性, 所以非<code>Binding</code> 表的关联查询需要拆解为笛卡尔积组合执行. 查询性能较低, 而且数据库连接比较高, 需谨慎使用, </p>
<h3 id="6-3-SQL-改写"><a href="#6-3-SQL-改写" class="headerlink" title="6.3 SQL 改写"></a>6.3 SQL 改写</h3><p>例如: 将逻辑表名称改写成真实表的名称, 优化分页查询等. </p>
<h3 id="6-4-SQL执行"><a href="#6-4-SQL执行" class="headerlink" title="6.4 SQL执行."></a>6.4 SQL执行.</h3><p>因为可能连接到多个真实的数据源,<code>Sharding-JDBC</code>将采用多线程并发执行SQL.</p>
<h3 id="6-5-结果归总"><a href="#6-5-结果归总" class="headerlink" title="6.5 结果归总"></a>6.5 结果归总</h3><p>例如数据的组装、分页、排序等等    .</p>
<h2 id="7-Sharding-JDBC-实现原理"><a href="#7-Sharding-JDBC-实现原理" class="headerlink" title="7. Sharding-JDBC 实现原理"></a>7. <code>Sharding-JDBC</code> 实现原理</h2><p>我们知道JDBC的四大核心对象 <code>DataSource</code>、<code>Connection</code>、<code>Statement（PS）</code>、<code>ResulstSet</code>。<code>Sharding-JDBC</code> 封装了这四个核心类,在类名前面加上了<code>Sharding</code>. </p>
<p><img src="http://files.luyanan.com//img/20200408102528.png" alt="image-20200408102527034"></p>
<p>如果说带<code>Sharding</code>的类要替换JDBC的对象，那么一定要找到创建和调用他们的地方.<code>ShardingDataSource</code> 我们就不说了, 系统启动的时候就创建好了. </p>
<p>问题就在于, 我们是什么时候用<code>ShardingDataSource</code> 获取一个<code>ShardingConnection</code> 的?</p>
<p>没有看过Mybatis的源码的同学一定要去看看,我们的查询方法最终会走到<code>SimpleExecutor</code> 的<code>doQuery()</code> 方法, 这个是我们的前提知识, 那我们直接在<code>doQuery()</code>打断点. </p>
<p><code>doQuery()</code> 方法里面调用了<code>prepareStatement()</code>  创建连接. </p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">private</span> Statement <span class="token function">prepareStatement</span><span class="token punctuation">(</span>StatementHandler handler<span class="token punctuation">,</span> Log statementLog<span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        Connection connection <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>statementLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Statement stmt <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transaction<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        handler<span class="token punctuation">.</span><span class="token function">parameterize</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> stmt<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>它经过以下两个方法, 返回一个<code>ShardingConnection</code></p>
<pre class=" language-java"><code class="language-java">DataSourceUtil<span class="token punctuation">.</span><span class="token function">fetchConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
Connection con <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>基于这个<code>ShardingConnection</code>，最终得到一个 <code>ShardingStatement</code></p>
<pre class=" language-java"><code class="language-java">stmt <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> transaction<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>接下来就是执行</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">return</span> handler<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> resultHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>再调用了<code>ShardingStatement</code>的<code>execute()</code></p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token operator">&lt;</span>E<span class="token operator">></span> List<span class="token operator">&lt;</span>E<span class="token operator">></span> <span class="token function">query</span><span class="token punctuation">(</span>Statement statement<span class="token punctuation">,</span> ResultHandler resultHandler<span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    PreparedStatement ps <span class="token operator">=</span> <span class="token punctuation">(</span>PreparedStatement<span class="token punctuation">)</span> statement<span class="token punctuation">;</span>
    ps<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> resultSetHandler<span class="token punctuation">.</span><span class="token function">handleResultSets</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>最终调用的是<code>ShardingPreparedStatement</code> 的<code>execute</code> 方法</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token function">clearPrevious</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">sqlRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">initPreparedStatementExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> preparedStatementExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">finally</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token function">refreshTableMetaData</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getShardingContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> routeResult<span class="token punctuation">.</span><span class="token function">getSqlStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">clearBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>SQL的解析路由就是在这一步完成的。 </p>
<h2 id="8-Sharding-Proxy-介绍"><a href="#8-Sharding-Proxy-介绍" class="headerlink" title="8. Sharding-Proxy 介绍"></a>8. <code>Sharding-Proxy</code> 介绍</h2><p>下载地址</p>
<p><a target="_blank" rel="noopener" href="https://github.com/sharding-sphere/sharding-sphere-doc/raw/master/dist/sharding-proxy-3.0.0.tar.gz">https://github.com/sharding-sphere/sharding-sphere-doc/raw/master/dist/sharding-proxy-3.0.0.tar.gz</a></p>
<p><code>lib</code> 目录就是<code>sharding-proxy</code> 核心代码,以及依赖的jar</p>
<p><code>bin</code>目录就是存在启停脚本的地方</p>
<p><code>conf</code> 目录就是存放所有配置文件,包括<code>sharding-proxy</code> 服务的配置文件、数据源以及<code>sahrding</code> 规则配置文件和项目日志配置文件. </p>
<p>linux 运行<code>start.sh</code> 文件(window用<code>start.bat</code>) ,默认端口为3307</p>
<p>需要的自定义分表算法, 只需要将他编译成class文件, 然后放到<code>conf</code>目录下,也可以打成jar 包放到<code>lib</code> 目录</p>
<h2 id="9-与Mycat-对比"><a href="#9-与Mycat-对比" class="headerlink" title="9. 与Mycat 对比"></a>9. 与Mycat 对比</h2><table>
<thead>
<tr>
<th></th>
<th><code>Sharding-JDBC</code></th>
<th><code>Mycat</code></th>
</tr>
</thead>
<tbody><tr>
<td>工作层面</td>
<td>JDBC协议</td>
<td>Mysql协议JDBC协议</td>
</tr>
<tr>
<td>运行方式</td>
<td>jar包, 客户端</td>
<td>独立服务, 服务端</td>
</tr>
<tr>
<td>开发方式</td>
<td>代码/配置改动</td>
<td>连接地址(数据源)</td>
</tr>
<tr>
<td>运维方式</td>
<td>无</td>
<td>管理独立服务,运维成本高</td>
</tr>
<tr>
<td>性能</td>
<td>多线程并发操作, 性能高</td>
<td>独立服务+网络开销,存在性能损失风险</td>
</tr>
<tr>
<td>功能范围</td>
<td>协议层面</td>
<td>包括分布式事务、数据迁移</td>
</tr>
<tr>
<td>适用操作</td>
<td>OLTP</td>
<td>OLTP+OLAP</td>
</tr>
<tr>
<td>支持数据库</td>
<td>基于JDBC协议的数据库</td>
<td>mysql 和其他支持JDBC协议的数据库</td>
</tr>
<tr>
<td>支持语言</td>
<td>java项目中使用</td>
<td>支持JDBC协议</td>
</tr>
</tbody></table>
<p>从易用性和功能完善的角度来看看,Mycat 似乎比<code>Sharding-JDBC</code> 要好, 因为有现成的分片规则, 也提供了4种ID生成方式, 通过注解可以支持高级功能, 比如跨库关联查询. </p>
<p>建议: 小型项目, 分片规则简单的项目用<code>sharding-JDBC</code>.大型项目, 可以用<code>Mycat</code></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">luyanan</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://rainsoil.github.io/2022/01/04/shu-ju-ku/fen-ku-fen-biao-zhi-sharding-jdbc-5/">https://rainsoil.github.io/2022/01/04/shu-ju-ku/fen-ku-fen-biao-zhi-sharding-jdbc-5/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">luyanan</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/01/04/wei-fu-wu/zookpeer/ji-yu-zookeeper-shi-xian-fen-bu-shi-suo/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/23.jpg" class="responsive-img" alt="基于Zookeeper实现分布式锁">
                        
                        <span class="card-title">基于Zookeeper实现分布式锁</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-01-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/zookpeer/" class="post-category">
                                    zookpeer
                                </a>
                            
                            <a href="/categories/zookpeer/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="post-category">
                                    微服务
                                </a>
                            
                            <a href="/categories/zookpeer/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="post-category">
                                    微服务
                                </a>
                            
                            <a href="/categories/zookpeer/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1/zookpeer/" class="post-category">
                                    zookpeer
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/01/04/shu-ju-ku/fen-ku-fen-biao-zhi-mycat-3/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="分库分表之Mycat(3)">
                        
                        <span class="card-title">分库分表之Mycat(3)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-01-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">
                                    数据库
                                </a>
                            
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">
                                    数据库
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <a href="/about" target="_blank">luyanan</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">803.3k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/rainsoil" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:luyanan0718@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=914596513" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 914596513" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
