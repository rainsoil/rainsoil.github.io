<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="分库分表之Mycat(3), railsoil">
    <meta name="description" content="分库分表之Mycat官网: http://www.mycat.io/
Mycat 概要介绍： https://github.com/MyCATApache/Mycat-Server
入门指南: https://github.com/MyCA">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>分库分表之Mycat(3) | railsoil</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="railsoil" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">railsoil</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">railsoil</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/8.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">分库分表之Mycat(3)</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">
                                数据库
                            </a>
                        
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">
                                数据库
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-01-04
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    8.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    40 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="分库分表之Mycat"><a href="#分库分表之Mycat" class="headerlink" title="分库分表之Mycat"></a>分库分表之Mycat</h1><p>官网: <a target="_blank" rel="noopener" href="http://www.mycat.io/">http://www.mycat.io/</a></p>
<p>Mycat 概要介绍： <a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-Server">https://github.com/MyCATApache/Mycat-Server</a></p>
<p>入门指南: <a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-doc/tree/master/%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97">https://github.com/MyCATApache/Mycat-doc/tree/master/%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97</a></p>
<h2 id="1-Mycat介绍和核心概念"><a href="#1-Mycat介绍和核心概念" class="headerlink" title="1.Mycat介绍和核心概念"></a>1.Mycat介绍和核心概念</h2><h4 id="1-1-基本介绍"><a href="#1-1-基本介绍" class="headerlink" title="1.1 基本介绍"></a>1.1 基本介绍</h4><p>历史:从阿里的<code>cobar</code>升级而来, 由开源组织维护, 2.0 正在开发中. </p>
<p>定位：运行在应用和数据库之间, 可以当作一个mysql 服务器使用,实现对Mysql数据库的分库分表, 也可以通过JDBC 支持其他的数据库. </p>
<p>Mycat 的关键特性: </p>
<ol>
<li>可以当作一个MYSQL 数据库使用</li>
<li>支持Mysql之外的数据库, 通过JDBC实现. </li>
<li>解决了我们提到的很多问题, 多表<code>join</code>、分布式事务、全局序列号、翻页排序等. </li>
<li>支持ZK配置,带监控<code>mycat-web</code></li>
<li>2.0  正在开发中.</li>
</ol>
<h4 id="1-2-核心概念"><a href="#1-2-核心概念" class="headerlink" title="1.2 核心概念"></a>1.2 核心概念</h4><table>
<thead>
<tr>
<th>概念</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>主机</td>
<td>物理主机, 一台服务器、一个数据库、一个3306端口</td>
</tr>
<tr>
<td>物理数据库</td>
<td>真实的数据库</td>
</tr>
<tr>
<td>物理表</td>
<td>真实存在的表</td>
</tr>
<tr>
<td>分片</td>
<td>将原来单个数据库的数据切分后分散在不同的数据库节点</td>
</tr>
<tr>
<td>分片节点</td>
<td>分片以后数据存储的节点</td>
</tr>
<tr>
<td>分片键</td>
<td>分片依据的字段,例如<code>order</code> 表中以id为依据分片, id就是分片键, 通常为主键</td>
</tr>
<tr>
<td>分片算法</td>
<td>分片的规则, 例如随机、取模、范围、哈希、枚举以及各种组合算法</td>
</tr>
<tr>
<td>逻辑表</td>
<td>相当于物理表,是分片表聚合后的结果,对于客户端来说跟真实的表没有区别</td>
</tr>
<tr>
<td>逻辑数据库</td>
<td>相当于物理数据库, 是数据节点聚合后的结果,</td>
</tr>
</tbody></table>
<p>下载, 解压Mycat(有window版本, 可以在本地数据库测试)</p>
<p><a target="_blank" rel="noopener" href="http://dl.mycat.io/">http://dl.mycat.io/</a></p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">wget</span> http://dl.mycat.io/1.6.7.3/20190927161129/Mycat-server-1.6.7.3-release-20190927161129-linux.tar.gz
<span class="token function">tar</span> -xzvf Mycat-server-1.6.7.3-release-20190927161129-linux.tar.gz
</code></pre>
<p><code>Mycat</code>解压之后有5个目录, </p>
<table>
<thead>
<tr>
<th>目录</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>bin</code></td>
<td>启动目录</td>
</tr>
<tr>
<td><code>catlet</code></td>
<td>空目录</td>
</tr>
<tr>
<td><code>conf</code></td>
<td>配置目录</td>
</tr>
<tr>
<td><code>lib</code></td>
<td>jar包依赖</td>
</tr>
<tr>
<td><code>logs</code></td>
<td>日志目录</td>
</tr>
</tbody></table>
<h2 id="2-Mycat-配置详解"><a href="#2-Mycat-配置详解" class="headerlink" title="2. Mycat 配置详解"></a>2. <code>Mycat</code> 配置详解</h2><p>主要的配置文件有<code>server.xml</code>、<code>schema.xml</code>、<code>rule.xml</code> 和具体的分片规则文件. </p>
<h3 id="2-1-server-xml"><a href="#2-1-server-xml" class="headerlink" title="2.1 server.xml"></a>2.1 <code>server.xml</code></h3><p>包含系统配置信息, </p>
<p><code>System</code>标签: 例如字符集、线程数、心跳、分布式事务开关等. </p>
<p><code>user</code>标签: 配置登录用户和权限</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span> <span class="token attr-name">defaultAccount</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>123456<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>schemas<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>catmall<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">></span></span>
</code></pre>
<p><code>Mycat</code>对密码加密</p>
<pre class=" language-bash"><code class="language-bash">java -cp Mycat-server-1.6.7.3-release.jar io.mycat.util.DecryptUtil 0:root:123456
</code></pre>
<h3 id="2-2-schema-xml"><a href="#2-2-schema-xml" class="headerlink" title="2.2  schema.xml"></a>2.2  <code>schema.xml</code></h3><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/glossary.html">https://dev.mysql.com/doc/refman/5.7/en/glossary.html</a></p>
<p><code>schema</code> 在Mysql 里面跟数据库是等价的. </p>
<p><code>schema.xml</code> 里面包含逻辑库、表、分片规则、分片节点和数据源, 可以定义多个<code>schema</code></p>
<p>这里面有三个主要的标签(<code>table</code>、<code>tableNode</code>、<code>dataHost</code>)</p>
<h4 id="lt-table-gt"><a href="#lt-table-gt" class="headerlink" title="&lt;/table&gt;"></a><code>&lt;/table&gt;</code></h4><p>表名和库名最好小写, 定义了逻辑表以及逻辑表分布的节点和分片规则</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schema</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>catmall<span class="token punctuation">"</span></span> <span class="token attr-name">checkSQLschema</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">sqlMaxLimit</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- 范围分片 --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>customer<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rang-long-cust<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- 取模分片 --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>order_info<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mod-long-order<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
      <span class="token comment" spellcheck="true">&lt;!-- ER 表 --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>childTable</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>order_detail<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">joinKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>order_id<span class="token punctuation">"</span></span> <span class="token attr-name">parentKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>order_id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- 全局表 --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>student<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sid<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>global<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schema</span><span class="token punctuation">></span></span>
</code></pre>
<table>
<thead>
<tr>
<th>配置</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>primaryKey</code></td>
<td>执行该逻辑表对应的真实表的主键,<code>Mycat</code> 会缓存主键(通过<code>primaryKey</code> 属性配置)与具体的<code>dataNode</code>的信息<br />当分片规则(rule) 使用非主键进行分片时, 那么在使用主键进行查询时,<code>Mycat</code> 就会通过缓存先确定记录在哪个<code>dataNode</code>上, 然后再在该<code>dataNode</code> 上执行查询. <br />如果没有缓存/缓存并没有命中的话,还是会发送所有语句给<code>dataNode</code></td>
</tr>
<tr>
<td><code>dataNode</code></td>
<td>数据分片的节点</td>
</tr>
<tr>
<td><code>autoIncrement</code></td>
<td>自增长(全局序列)、true代表主键使用自增长策略</td>
</tr>
<tr>
<td><code>type</code></td>
<td>全局表:<code>global</code>, 其他： 不配置</td>
</tr>
</tbody></table>
<h4 id="lt-dataNode-gt"><a href="#lt-dataNode-gt" class="headerlink" title="&lt;dataNode&gt;"></a><code>&lt;dataNode&gt;</code></h4><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataNode</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1<span class="token punctuation">"</span></span> <span class="token attr-name">dataHost</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>host1<span class="token punctuation">"</span></span> <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mycat<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre>
<p>数据节点与物理数据库的对应关系.</p>
<h4 id="lt-dataHost-gt"><a href="#lt-dataHost-gt" class="headerlink" title="&lt;dataHost/&gt;"></a><code>&lt;dataHost/&gt;</code></h4><p>配置物理主机的信息， <code>readHost</code>是从属于<code>writeHost</code>的</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataHost</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>host1<span class="token punctuation">"</span></span> <span class="token attr-name">maxCon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span> <span class="token attr-name">minCon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">balance</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">writeType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">dbType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mysql<span class="token punctuation">"</span></span> <span class="token attr-name">dbDriver</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>native<span class="token punctuation">"</span></span> <span class="token attr-name">switchType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">slaveThreshold</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>heartbeat</span><span class="token punctuation">></span></span>select user()<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>heartbeat</span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- can have multi write hosts --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>writeHost</span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hostM1<span class="token punctuation">"</span></span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>localhost:3306<span class="token punctuation">"</span></span> <span class="token attr-name">user</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span> <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- can have multi read hosts --></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>readHost</span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hostS2<span class="token punctuation">"</span></span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>192.168.8.146:3306<span class="token punctuation">"</span></span> <span class="token attr-name">user</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span> <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>xxx<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>writeHost</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>writeHost</span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hostS1<span class="token punctuation">"</span></span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>localhost:3316<span class="token punctuation">"</span></span> <span class="token attr-name">user</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span> <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- &lt;writeHost host="hostM2" url="localhost:3316" user="root" password="123456"/> --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataHost</span><span class="token punctuation">></span></span>
</code></pre>
<p><code>balance</code>: 负载的配置, 决定<code>select</code>语句的负载. </p>
<table>
<thead>
<tr>
<th>值</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>不开启读写分离机制,所有读操作都发送到当前可用的<code>writeHost</code> 上</td>
</tr>
<tr>
<td>1</td>
<td>所有的读操作都随机的发送到当前的<code>writeHost</code> 对应的<code>readHost</code>和备用的<code>writeHost</code>上.</td>
</tr>
<tr>
<td>2</td>
<td>所有的读操作都随机发送到所有的<code>writeHost</code>和<code>readHost</code>上.</td>
</tr>
<tr>
<td>3</td>
<td>所有的读操作都只发送到<code>writeHost</code>的<code>readHost</code>上.</td>
</tr>
</tbody></table>
<p><code>writeType</code> : 读写分离的配置, 决定<code>update</code>、<code>delete</code>、<code>insert</code> 语句的负载. </p>
<table>
<thead>
<tr>
<th>值</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>所有的写操作都发送到可用的<code>writeHost</code>上(默认第一个,第一个挂了以后发送到第二个)</td>
</tr>
<tr>
<td>1</td>
<td>所有的写操作都随机的发送到<code>writeHost</code>上</td>
</tr>
</tbody></table>
<p><code>switchType</code>: 主从切换的配置</p>
<table>
<thead>
<tr>
<th>值</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>-1</td>
<td>表示不自动切换</td>
</tr>
<tr>
<td>1</td>
<td>默认值, 表示自动切换</td>
</tr>
<tr>
<td>2</td>
<td>基于Mysql主从切换的状态决定是否切换, 心跳语句<code>show slave status</code></td>
</tr>
<tr>
<td>3</td>
<td>基于<code>Mysql  galary cluster</code> 的切换机制（适合集群）（1.4.1），心跳语句为 <code>show status like &#39;wsrep%&#39;。</code></td>
</tr>
</tbody></table>
<h3 id="2-3-rule-xml"><a href="#2-3-rule-xml" class="headerlink" title="2.3 rule.xml"></a>2.3 <code>rule.xml</code></h3><p>定义了分片规则和算法</p>
<p>分片规则: </p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rang-long-cust<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">></span></span>id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">></span></span>func-rang-long-cust<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">></span></span>
</code></pre>
<p>分片算法</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>func-rang-long-cust<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.mycat.route.function.AutoPartitionByLong<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mapFile<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>rang-long-cust.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">></span></span>
</code></pre>
<p>分片配置:<code>rang-long-cust.txt</code></p>
<pre class=" language-text"><code class="language-text">10001-20000=1
0-10000=0
20001-100000=2
</code></pre>
<h3 id="2-4-ZK配置"><a href="#2-4-ZK配置" class="headerlink" title="2.4 ZK配置"></a>2.4 ZK配置</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/leeSmall/p/9551038.html">https://www.cnblogs.com/leeSmall/p/9551038.html</a></p>
<p><code>Mycat</code> 也支持zk配置(用于管理配置和生成全局ID), 执行<code>bin</code>目录下的<code>init_zk_data.sh</code>, 会自动将<code>zkconf</code>下的所有配置文件上传到zk(先拷贝到这个目录)</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">cd</span> /usr/local/soft/mycat/conf
<span class="token function">cp</span> *.txt *.xml *.properties zkconf/
<span class="token function">cd</span> /usr/local/soft/mycat/bin
./init_zk_data.sh
</code></pre>
<p>启用zk配置</p>
<p><code>mycat/conf/myid.properties</code></p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">loadZk</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
<span class="token attr-name">zkURL</span><span class="token punctuation">=</span><span class="token attr-value">127.0.0.1:2181</span>
<span class="token attr-name">clusterId</span><span class="token punctuation">=</span><span class="token attr-value">010</span>
<span class="token attr-name">myid</span><span class="token punctuation">=</span><span class="token attr-value">01001</span>
<span class="token attr-name">clusterSize</span><span class="token punctuation">=</span><span class="token attr-value">1</span>
<span class="token attr-name">clusterNodes</span><span class="token punctuation">=</span><span class="token attr-value">mycat_01</span>
<span class="token comment" spellcheck="true">#server booster ; booster install on db same server,will reset all minCon to 2</span>
<span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value">server</span>
<span class="token attr-name">boosterDataHosts</span><span class="token punctuation">=</span><span class="token attr-value">dataHost1</span>
</code></pre>
<p>注意如果指定<code>init_zk_data.sh</code> 脚本报错的话, 代表未写入成功, 此时不要启动zk配置并重启,否则本地文件会被覆盖, </p>
<p>启动的时如果<code>oadzk=true</code> 启动时, 会自动从zk下载配置文件并覆盖到本地配置.</p>
<p>在这种情况下如果修改配置, 需要先修改<code>conf</code> 目录的配置, <code>copy</code>到<code>zkconf</code>, 再执行上传. </p>
<p><img src="http://files.luyanan.com//img/20200404214256.png" alt="image-20200404214238782"></p>
<h3 id="2-5-启动停止"><a href="#2-5-启动停止" class="headerlink" title="2.5 启动停止"></a>2.5 启动停止</h3><p>进入<code>mycat/bin</code> 目录(主要要先启动物理数据库)</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>命令</th>
</tr>
</thead>
<tbody><tr>
<td>启动</td>
<td><code>./mycat start</code></td>
</tr>
<tr>
<td>停止</td>
<td><code>./mycat stop</code></td>
</tr>
<tr>
<td>重启</td>
<td><code>./mycat restart</code></td>
</tr>
<tr>
<td>查看状态</td>
<td><code>./mycat status</code></td>
</tr>
<tr>
<td>前台运行</td>
<td><code>/mycat console</code></td>
</tr>
</tbody></table>
<p>连接</p>
<pre class=" language-bash"><code class="language-bash">mysql -uroot -p123456 -h 192.168.8.151 -P8066 catmall
</code></pre>
<h2 id="3-Mycat-分片验证"><a href="#3-Mycat-分片验证" class="headerlink" title="3. Mycat 分片验证"></a>3. Mycat 分片验证</h2><p><code>explain</code> 可以用来看路由结果</p>
<p>在三个数据库中建表</p>
<pre class=" language-mysql"><code class="language-mysql">CREATE TABLE `customer` (
`id` int(11) DEFAULT NULL,
 `name` varchar(255) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `order_info` (
`order_id` int(11) NOT NULL COMMENT '订单 ID', 
 `uid` int(11) DEFAULT NULL COMMENT '用户 ID',
 `nums` int(11) DEFAULT NULL COMMENT '商品数量',
 `state` int(2) DEFAULT NULL COMMENT '订单状态',
 `create_time` datetime DEFAULT NULL ON UPDATE   CURRENT_TIMESTAMP COMMENT '创建时间',
 `update_time` datetime DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
 PRIMARY KEY (`order_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `order_detail` (
 `order_id` int(11) NOT NULL COMMENT '订单号',
 `id` int(11) NOT NULL COMMENT '订单详情',
 `goods_id` int(11) DEFAULT NULL COMMENT '货品 ID',
 `price` decimal(10,2) DEFAULT NULL COMMENT '价格',
 `is_pay` int(2) DEFAULT NULL COMMENT '支付状态',
 `is_ship` int(2) DEFAULT NULL COMMENT '是否发货',
 `status` int(2) DEFAULT NULL COMMENT '订单详情状态',
 PRIMARY KEY (`order_id`,`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `student` (
`sid` int(8) NOT NULL AUTO_INCREMENT,
 `name` varchar(255) DEFAULT NULL,
 `qq` varchar(255) DEFAULT NULL,
 PRIMARY KEY (`sid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre>
<p><code>schema.xml</code></p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>customer<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rang-long-cust<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>order_info<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mod-long-order<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>childTable</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>order_detail<span class="token punctuation">"</span></span> <span class="token attr-name">joinKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>order_id<span class="token punctuation">"</span></span> <span class="token attr-name">parentKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>order_id<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>student<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sid<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>global<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
</code></pre>
<p>数据节点配置</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataNode</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1<span class="token punctuation">"</span></span> <span class="token attr-name">dataHost</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>host1<span class="token punctuation">"</span></span> <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mycat<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataNode</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn2<span class="token punctuation">"</span></span> <span class="token attr-name">dataHost</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>host2<span class="token punctuation">"</span></span> <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mycat<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataNode</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn3<span class="token punctuation">"</span></span> <span class="token attr-name">dataHost</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>host3<span class="token punctuation">"</span></span> <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mycat<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataHost</span> <span class="token attr-name">balance</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">maxCon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span> <span class="token attr-name">minCon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>host1<span class="token punctuation">"</span></span> <span class="token attr-name">writeType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">switchType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">slaveThreshold</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span> <span class="token attr-name">dbType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mysql<span class="token punctuation">"</span></span> <span class="token attr-name">dbDriver</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>native<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>heartbeat</span><span class="token punctuation">></span></span>select user()<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>heartbeat</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>writeHost</span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hostM1<span class="token punctuation">"</span></span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>192.168.8.146:3306<span class="token punctuation">"</span></span> <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span> <span class="token attr-name">user</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataHost</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataHost</span> <span class="token attr-name">balance</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">maxCon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span> <span class="token attr-name">minCon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>host2<span class="token punctuation">"</span></span> <span class="token attr-name">writeType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">switchType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">slaveThreshold</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span> <span class="token attr-name">dbType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mysql<span class="token punctuation">"</span></span> <span class="token attr-name">dbDriver</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>native<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>heartbeat</span><span class="token punctuation">></span></span>select user()<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>heartbeat</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>writeHost</span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hostM1<span class="token punctuation">"</span></span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>192.168.8.150:3306<span class="token punctuation">"</span></span> <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span> <span class="token attr-name">user</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataHost</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataHost</span> <span class="token attr-name">balance</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">maxCon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span> <span class="token attr-name">minCon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>host3<span class="token punctuation">"</span></span> <span class="token attr-name">writeType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">switchType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">slaveThreshold</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span> <span class="token attr-name">dbType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mysql<span class="token punctuation">"</span></span> <span class="token attr-name">dbDriver</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>native<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>heartbeat</span><span class="token punctuation">></span></span>select user()<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>heartbeat</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>writeHost</span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hostM1<span class="token punctuation">"</span></span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>192.168.8.151:3306<span class="token punctuation">"</span></span> <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span> <span class="token attr-name">user</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataHost</span><span class="token punctuation">></span></span>
</code></pre>
<p><code>schema——rule.xml——分片配置</code></p>
<h4 id="3-1-范围分片"><a href="#3-1-范围分片" class="headerlink" title="3.1 范围分片"></a>3.1 范围分片</h4><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rang-long-cust<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">></span></span>id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">></span></span>rang-long-cust<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">></span></span>
</code></pre>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rang-long-cust<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.mycat.route.function.AutoPartitionByLong<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mapFile<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>rang-long-cust.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">></span></span>
</code></pre>
<p>customer</p>
<pre class=" language-mysql"><code class="language-mysql">INSERT INTO `customer` (`id`, `name`) VALUES (6666, '赵先生');
INSERT INTO `customer` (`id`, `name`) VALUES (7777, '钱先生');
INSERT INTO `customer` (`id`, `name`) VALUES (16666, '孙先生');
INSERT INTO `customer` (`id`, `name`) VALUES (17777, '李先生');
INSERT INTO `customer` (`id`, `name`) VALUES (26666, '周先生');
INSERT INTO `customer` (`id`, `name`) VALUES (27777, '吴先生');
</code></pre>
<h4 id="3-2-取模分片-ER表"><a href="#3-2-取模分片-ER表" class="headerlink" title="3.2 取模分片(ER表)"></a>3.2 取模分片(ER表)</h4><p>order_info</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mod-long-order<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">></span></span>order_id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">></span></span>mod-long<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">></span></span>
</code></pre>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mod-long<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByMod<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>count<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">></span></span>
</code></pre>
<pre class=" language-mysql"><code class="language-mysql">INSERT INTO `order_info` (`order_id`, `uid`, `nums`, `state`, `create_time`, `update_time`) VALUES (1, 1000001, 1, 2,
'2019-9-23 14:35:37', '2019-9-23 14:35:37');
INSERT INTO `order_info` (`order_id`, `uid`, `nums`, `state`, `create_time`, `update_time`) VALUES (2, 1000002, 1, 2,
'2019-9-24 14:35:37', '2019-9-24 14:35:37');
INSERT INTO `order_info` (`order_id`, `uid`, `nums`, `state`, `create_time`, `update_time`) VALUES (3, 1000003, 3, 1,
'2019-9-25 11:35:49', '2019-9-25 11:35:49');
</code></pre>
<p>order_detail</p>
<pre class=" language-mysql"><code class="language-mysql">INSERT INTO `order_detail` (`order_id`, `id`, `goods_id`, `price`, `is_pay`, `is_ship`, `status`) VALUES (3, 20180001, 85114752, 19.99, 1, 1, 1);
INSERT INTO `order_detail` (`order_id`, `id`, `goods_id`, `price`, `is_pay`, `is_ship`, `status`) VALUES (1, 20180002, 25411251, 1280.00, 1, 1, 0);
INSERT INTO `order_detail` (`order_id`, `id`, `goods_id`, `price`, `is_pay`, `is_ship`, `status`) VALUES (1, 20180003, 62145412, 288.00, 1, 1, 2);
INSERT INTO `order_detail` (`order_id`, `id`, `goods_id`, `price`, `is_pay`, `is_ship`, `status`) VALUES (2, 20180004, 21456985, 399.00, 1, 1, 2);
INSERT INTO `order_detail` (`order_id`, `id`, `goods_id`, `price`, `is_pay`, `is_ship`, `status`) VALUES (2, 20180005, 21457452, 1680.00, 1, 1, 2);
INSERT INTO `order_detail` (`order_id`, `id`, `goods_id`, `price`, `is_pay`, `is_ship`, `status`) VALUES (2, 20180006, 65214789, 9999.00, 1, 1, 3);
</code></pre>
<h4 id="3-3-全局表"><a href="#3-3-全局表" class="headerlink" title="3.3  全局表"></a>3.3  全局表</h4><p>student</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>student<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sid<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>global<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
</code></pre>
<pre class=" language-mysql"><code class="language-mysql">INSERT INTO `student` (`sid`, `name`, `qq`) VALUES (1, '黑白', '166669999');
INSERT INTO `student` (`sid`, `name`, `qq`) VALUES (2, 'AV 哥', '466669999');
INSERT INTO `student` (`sid`, `name`, `qq`) VALUES (3, '最强菜鸟', '368828888');
INSERT INTO `student` (`sid`, `name`, `qq`) VALUES (4, '加载中', '655556666');
INSERT INTO `student` (`sid`, `name`, `qq`) VALUES (5, '猫老公', '265286999');
INSERT INTO `student` (`sid`, `name`, `qq`) VALUES (6, '一个人的精彩', '516895555');
</code></pre>
<h4 id="3-4-Mycat全局id"><a href="#3-4-Mycat全局id" class="headerlink" title="3.4 Mycat全局id"></a>3.4 Mycat全局id</h4><p>Mycat 全局序列实现方式主要有4种: 本地文件方式、数据库方式、本地时间戳算法、ZK。 也可以自定义业务序列. </p>
<p>主要获取全局ID的前缀都是<code>MYCATSEQ_</code></p>
<h5 id="3-4-1-本地文件方式"><a href="#3-4-1-本地文件方式" class="headerlink" title="3.4.1 本地文件方式"></a>3.4.1 本地文件方式</h5><p>配置文件<code>件 server.xml</code>  <code>sequnceHandlerType</code>的值:</p>
<p>0:文件、1:数据库、2:本地时间戳、3: ZK</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sequnceHandlerType<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
</code></pre>
<p>文件方式:配置<code>conf/sequence_conf.properties</code></p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">CUSTOMER.HISIDS</span><span class="token punctuation">=</span><span class="token attr-value"> </span>
<span class="token attr-name">CUSTOMER.MINID</span><span class="token punctuation">=</span><span class="token attr-value">10000001</span>
<span class="token attr-name">CUSTOMER.MAXID</span><span class="token punctuation">=</span><span class="token attr-value">20000000</span>
<span class="token attr-name">CUSTOMER.CURID</span><span class="token punctuation">=</span><span class="token attr-value">10000001</span>
</code></pre>
<p>语法: <code>select next value for MYCATSEQ_CUSTOMER</code></p>
<pre class=" language-mysql"><code class="language-mysql">INSERT INTO `customer` (`id`, `name`) VALUES (next value for MYCATSEQ_CUSTOMER, 'zhangsan');
</code></pre>
<p>优点: 本地加载, 读取速度快. </p>
<p>缺点: 当Mycat 重新发布后, 配置文件中的<code>sequence</code> 需要替换. Mycat 不能做集群部署. </p>
<h5 id="3-4-2-数据库方式"><a href="#3-4-2-数据库方式" class="headerlink" title="3.4.2  数据库方式"></a>3.4.2  数据库方式</h5><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sequnceHandlerType<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
</code></pre>
<p>配置:  <code>sequence_db_conf.properties</code></p>
<p>把这张表创建在146上, 所以是db1</p>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">#sequence stored in datanode</span>
<span class="token attr-name">GLOBAL</span><span class="token punctuation">=</span><span class="token attr-value">dn1</span>
<span class="token attr-name">CUSTOMER</span><span class="token punctuation">=</span><span class="token attr-value">dn1</span>
</code></pre>
<p>在第一个数据库节点上创建<code>MYCAT_SEQUENCE</code> 表:</p>
<pre class=" language-mysql"><code class="language-mysql">DROP TABLE IF EXISTS MYCAT_SEQUENCE;
CREATE TABLE MYCAT_SEQUENCE (
name VARCHAR(50) NOT NULL,
current_value INT NOT NULL,
increment INT NOT NULL DEFAULT 1,
remark varchar(100),
PRIMARY KEY(name))
 ENGINE=InnoDB;
</code></pre>
<p>注：可以在<code>schema.xml</code>  配置文件中配置这张表, 供外部访问</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mycat_sequence<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1<span class="token punctuation">"</span></span> <span class="token attr-name">autoIncrement</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span>
</code></pre>
<p>创建存储过程, 获取当前的<code>sequence</code>的值</p>
<pre class=" language-mysql"><code class="language-mysql">DROP FUNCTION IF EXISTS `mycat_seq_currval`;
DELIMITER ;;
CREATE DEFINER=`root`@`%` FUNCTION `mycat_seq_currval`(seq_name VARCHAR(50)) RETURNS varchar(64)
CHARSET latin1
DETERMINISTIC
BEGIN
DECLARE retval VARCHAR(64);
SET retval="-999999999,null";
SELECT concat(CAST(current_value AS CHAR),",",CAST(increment AS CHAR) ) INTO retval FROM
MYCAT_SEQUENCE WHERE name = seq_name;
RETURN retval ;
END
;;
DELIMITER ;
</code></pre>
<p>创建存储过程, 获取下一个<code>sequence</code></p>
<pre class=" language-mysql"><code class="language-mysql">DROP FUNCTION IF EXISTS `mycat_seq_nextval`;
DELIMITER ;;
CREATE DEFINER=`root`@`%` FUNCTION `mycat_seq_nextval`(seq_name VARCHAR(50)) RETURNS varchar(64)
CHARSET latin1
DETERMINISTIC
BEGIN
UPDATE MYCAT_SEQUENCE
SET current_value = current_value + increment WHERE name = seq_name;
RETURN mycat_seq_currval(seq_name);
END
;;
DELIMITER ;
</code></pre>
<p>创建存储过程, 设置<code>sequence</code></p>
<pre class=" language-mysql"><code class="language-mysql">DROP FUNCTION IF EXISTS `mycat_seq_setval`;
DELIMITER ;;
CREATE DEFINER=`root`@`%` FUNCTION `mycat_seq_setval`(seq_name VARCHAR(50), value INTEGER)
RETURNS varchar(64) CHARSET latin1
DETERMINISTIC
BEGIN
UPDATE MYCAT_SEQUENCE
SET current_value = value
WHERE name = seq_name;
RETURN mycat_seq_currval(seq_name);
END
;;
DELIMITER ;
</code></pre>
<p>插入记录</p>
<pre class=" language-mysql"><code class="language-mysql">INSERT INTO MYCAT_SEQUENCE(name,current_value,increment,remark) VALUES ('GLOBAL', 1, 100,'');
INSERT INTO MYCAT_SEQUENCE(name,current_value,increment,remark) VALUES ('ORDERS', 1, 100,'订单表使
用');
</code></pre>
<p>测试</p>
<pre class=" language-mysql"><code class="language-mysql">select next value for MYCATSEQ_ORDERS
</code></pre>
<h5 id="3-4-3-本地时间戳方式"><a href="#3-4-3-本地时间戳方式" class="headerlink" title="3.4.3 本地时间戳方式"></a>3.4.3 本地时间戳方式</h5><p>ID= 64 位二进制 (42(毫秒)+5(机器 ID)+5(业务编码)+12(重复累加) ，长度为 18 位</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sequnceHandlerType<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
</code></pre>
<p>配置文件<code>sequence_time_conf.properties</code></p>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">#sequence depend on TIME</span>
<span class="token attr-name">WORKID</span><span class="token punctuation">=</span><span class="token attr-value">01</span>
<span class="token attr-name">DATAACENTERID</span><span class="token punctuation">=</span><span class="token attr-value">01</span>
</code></pre>
<p>验证: <code>select next value for MYCATSEQ_GLOBAL</code></p>
<p><img src="http://files.luyanan.com//img/20200404223525.png" alt="image-20200404223523720"></p>
<h5 id="3-4-5-ZK方式"><a href="#3-4-5-ZK方式" class="headerlink" title="3.4.5 ZK方式"></a>3.4.5 ZK方式</h5><p>修改<code>conf/myid.properties</code><br>设置<code>loadZk=true</code>（启动时会从zk加载配置, 一定要注意备份配置文件, 并且先用<code>bin/init_zk_data.sh</code>,把配置文件写入到zk）</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sequnceHandlerType<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
</code></pre>
<p>配置文件: <code>sequence_distributed_conf.properties</code></p>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># 代表使用 zk</span>
<span class="token attr-name">INSTANCEID</span><span class="token punctuation">=</span><span class="token attr-value">ZK</span>
<span class="token comment" spellcheck="true"># 与 myid.properties 中的 CLUSTERID 设置的值相同</span>
<span class="token attr-name">CLUSTERID</span><span class="token punctuation">=</span><span class="token attr-value">010</span>
</code></pre>
<p>复制配置文件</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">cd</span> /usr/local/soft/mycat/conf
<span class="token function">cp</span> *.txt *.xml *.properties zkconf/
<span class="token function">chown</span> -R zkconf/
<span class="token function">cd</span> /usr/local/soft/mycat/bin
./init_zk_data.sh
</code></pre>
<p>验证: <code>select next value for MYCATSEQ_GLOBAL</code></p>
<p><img src="http://files.luyanan.com//img/20200404223845.png" alt="image-20200404223843594"></p>
<h4 id="3-5-使用"><a href="#3-5-使用" class="headerlink" title="3.5 使用"></a>3.5 使用</h4><p>在<code>schema.xml</code> 的    <code>table</code>  标签上配置 <code>autoIncrement=&quot;true&quot;</code>,不需要获取和指定序列的情况下, 就可以使用全局ID</p>
<h2 id="4-Mycat-监控和日志监控"><a href="#4-Mycat-监控和日志监控" class="headerlink" title="4. Mycat 监控和日志监控"></a>4. Mycat 监控和日志监控</h2><h3 id="4-1-监控"><a href="#4-1-监控" class="headerlink" title="4.1 监控"></a>4.1 监控</h3><h4 id="4-1-1-命令行监控"><a href="#4-1-1-命令行监控" class="headerlink" title="4.1.1 命令行监控"></a>4.1.1 命令行监控</h4><p>连接到管理端口9066,注意必须带ip</p>
<pre class=" language-bash"><code class="language-bash">mysql -uroot -h127.0.0.1 -p123456 -P9066
</code></pre>
<p>全部命令</p>
<pre class=" language-mysql"><code class="language-mysql">mysql>show @@help;
</code></pre>
<table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>show @@server</code></td>
<td>查看服务器状态, 包括占用内存</td>
</tr>
<tr>
<td><code>show @@database</code></td>
<td>查看数据库</td>
</tr>
<tr>
<td><code>show @@datanode</code></td>
<td>查看数据节点</td>
</tr>
<tr>
<td><code>show @@datasource</code></td>
<td>查看数据源</td>
</tr>
<tr>
<td><code>show @@connection</code></td>
<td>该命令用于获取Mycat的前端连接状态, 即应用与mycat 的连接</td>
</tr>
<tr>
<td><code>show @@cache</code></td>
<td>查看缓存使用情况 <br />SQLRouteCache：sql 路由缓存。 <br />TableID2DataNodeCache ： 缓存表主键与分 片对应关系。 <br />ER_SQL2PARENTID ：缓存 ER 分片中子表与 父表关系</td>
</tr>
<tr>
<td><code>reload @@config</code></td>
<td>重新加载配置文件, 使用这个命令时mycat服务不可用</td>
</tr>
<tr>
<td><code>show @@sysparam</code></td>
<td>查看参数</td>
</tr>
<tr>
<td><code>show @@sql.high</code></td>
<td>执行频率高的sql</td>
</tr>
<tr>
<td><code>show @@sql.slow</code></td>
<td>慢SQL<br />设置慢SQL的命令:<code>reload @@sqlslow=5 ;</code></td>
</tr>
<tr>
<td><code>show @@backend</code></td>
<td>查看后端连接状态</td>
</tr>
</tbody></table>
<h4 id="4-1-2-命令行监控-mycatweb-监控"><a href="#4-1-2-命令行监控-mycatweb-监控" class="headerlink" title="4.1.2 命令行监控 mycatweb 监控"></a>4.1.2 命令行监控 <code>mycatweb</code> 监控</h4><p><a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-download/tree/master/mycat-web-1.0">https://github.com/MyCATApache/Mycat-download/tree/master/mycat-web-1.0</a></p>
<p><code>mycat-web</code>是mycat 提供的一个监控工具, 他依赖于zk</p>
<p>本地必须要运行一个zk, 必须先启动zk</p>
<p>下载<code>mycat-web</code></p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">cd</span> /usr/local/soft
<span class="token function">wget</span> http://dl.mycat.io/mycat-web-1.0/Mycat-web-1.0-SNAPSHOT-20170102153329-linux.tar.gz
<span class="token function">tar</span> -xzvf Mycat-web-1.0-SNAPSHOT-20170102153329-linux.tar.gz
</code></pre>
<p>启动<code>mycat-web</code></p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">cd</span> mycat-web
<span class="token function">nohup</span> ./start.sh <span class="token operator">&amp;</span>
</code></pre>
<p>停止</p>
<p><code>：kill start.jar</code> 相关的进程</p>
<p>访问端口8082</p>
<p><a target="_blank" rel="noopener" href="http://192.168.8.151:8082/mycat/">http://192.168.8.151:8082/mycat/</a></p>
<p><code>mycat</code> <code> server.xml</code>的配置</p>
<pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- 1 为开启实时统计、0 为关闭 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>useSqlStat<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
</code></pre>
<p>重启<code>mycat</code> 服务生效</p>
<h3 id="4-2-日志"><a href="#4-2-日志" class="headerlink" title="4.2 日志"></a>4.2 日志</h3><p><code>log4j</code>的<code>level</code> 配置要改成<code>debug</code></p>
<h4 id="4-2-1-wrapper-log-日志"><a href="#4-2-1-wrapper-log-日志" class="headerlink" title="4.2.1  wrapper.log 日志"></a>4.2.1  <code>wrapper.log</code> 日志</h4><p><code>wrapper.log</code> 日志: mycat 启动、停止、添加服务等都会被记录到此文件, 如果系统环境配置错误或者缺少配置时, 导致mycat无法启动,可以通过查看<code>wrapper.log</code> 定位具体错误原因. </p>
<h4 id="4-2-2-mycat-log-日志"><a href="#4-2-2-mycat-log-日志" class="headerlink" title="4.2.2  mycat.log 日志"></a>4.2.2  <code>mycat.log</code> 日志</h4><p><code>mycat.log</code> 为mycat的主要日志文件, 记录了启动时分配的相关buffer 信息， 数据源连接信息, 连接池、动态类加载信息等等. </p>
<p>在<code>conf/log4j2.xml</code> 文件中进行相关配置, 如保留个数、大小、字符集、日志文件大小等. </p>
<p>以<code>select</code> 为例</p>
<p><img src="http://files.luyanan.com//img/20200404225555.png" alt="image-20200404225553807"></p>
<h2 id="5-Mycat-高可用"><a href="#5-Mycat-高可用" class="headerlink" title="5. Mycat 高可用"></a>5. Mycat 高可用</h2><p>目前Mycat 没有实现对多<code>Mycat</code> 集群的支持, 可以暂时使用<code>HAProxy</code>来做负载. </p>
<p>思路：<code>HAProxy</code> 对<code>Mycat</code> 进行负载. <code>Keepalived</code>  实现<code>VIP</code></p>
<p><img src="C:/Users/luyanan/Downloads/image%20(1).png" alt="image (http://files.luyanan.com//img/20200406112937.png)"></p>
<h2 id="6-Mycat注解"><a href="#6-Mycat注解" class="headerlink" title="6.Mycat注解"></a>6.Mycat注解</h2><h3 id="6-1-注解的作用"><a href="#6-1-注解的作用" class="headerlink" title="6.1 注解的作用"></a>6.1 注解的作用</h3><p>当关联的数据不再同一个节点的时候, Mycat是无法实现跨库<code>join</code>的. </p>
<p>举例: </p>
<p>如果直接在150节点插入主表数据,151插入明细表数据, 此时关联查询无法查询出来数据. </p>
<pre class=" language-mysql"><code class="language-mysql">-- 150 节点插入
INSERT INTO `order_info` (`order_id`, `uid`, `nums`, `state`, `create_time`, `update_time`) VALUES (9, 1000003, 2673, 1, '2019-9-25 11:35:49', '2019-9-25 11:35:49'); -- 151 节点插入
INSERT INTO `order_detail` (`order_id`, `id`, `goods_id`, `price`, `is_pay`, `is_ship`, `status`) VALUES (9, 20180001, 2673, 19.99, 1, 1, 1);
</code></pre>
<p>在mycat 数据库查询, 直接查询没有查到结果</p>
<pre class=" language-mysql"><code class="language-mysql">select a.order_id,b.price from order_info a, order_detail b where a.nums = b.goods_id;
</code></pre>
<p>Mycat 作为一个中间件,有很多自身不支持的SQL语句,比如存储过程,但是这些语句在实际的数据库节点上是可以执行的. 有没有办法让Mycat 做一层透明的代理转发,直接找到目标数据节点去执行这些SQL语句呢?</p>
<p>那我们必须有一种方式来告诉Mycat 应该在那些节点上执行. 这个就是Mycat 的注解, 我们在需要执行的SQL 语句前面加上一段代码, 帮助Mycat 找到我们的目标节点. </p>
<h3 id="6-2-注解的用法"><a href="#6-2-注解的用法" class="headerlink" title="6.2 注解的用法"></a>6.2 注解的用法</h3><p>注解的形式是: </p>
<pre class=" language-mysql"><code class="language-mysql">/*!mycat: sql=注解 SQL 语句*/
</code></pre>
<p>注解的使用方式: </p>
<pre class=" language-mysql"><code class="language-mysql">/*!mycat: sql=注解 SQL 语句*/ 真正执行的 SQL
</code></pre>
<p>使用时, 将<code>=</code> 号后面的”注解SQL语句”, 替换为需要的SQL语句即可. </p>
<p>使用注解有一些限制, 或者注意的地方</p>
<table>
<thead>
<tr>
<th>原始SQL</th>
<th>注解SQL</th>
</tr>
</thead>
<tbody><tr>
<td><code>select</code></td>
<td>如果需要分片,则使用能确定分片的注解, 比如<code>/*!mycat: sql=select * from users where user_id=1*/</code><br />如果要在所有的分片上执行则可以不加能确定分片的条件</td>
</tr>
<tr>
<td><code>insert</code></td>
<td>使用<code>insert</code>的表作为注解SQL,必须能确定到某个分片<br />原始SQL插入的字段必须包含分片字段<br />非分片字段(只在某个节点上): 需要能确定到某个分片</td>
</tr>
<tr>
<td><code>delete</code></td>
<td>使用<code>delete</code>的表作为注解SQL</td>
</tr>
<tr>
<td><code>update</code></td>
<td>使用<code>update</code>的表作为注解SQL</td>
</tr>
</tbody></table>
<p>使用注解并不会额外增加Mycat的执行时间,从解析复杂度以及性能考虑, 注解SQL 应该尽量简单,因为它只是用来做路由的. </p>
<p>注解可以帮我们解决什么问题呢?</p>
<h3 id="6-3-注解使用案例"><a href="#6-3-注解使用案例" class="headerlink" title="6.3 注解使用案例"></a>6.3 注解使用案例</h3><h4 id="6-3-1-创建表或存储过程"><a href="#6-3-1-创建表或存储过程" class="headerlink" title="6.3.1 创建表或存储过程"></a>6.3.1 创建表或存储过程</h4><p><code>customer.id=1</code> 全部路由到146</p>
<pre class=" language-mysql"><code class="language-mysql">-- 存储过程
/*!mycat: sql=select * from customer where id =1 */ CREATE PROCEDURE test_proc() BEGIN END ; -- 表
/*!mycat: sql=select * from customer where id =1 */ CREATE TABLE test2(id INT);
</code></pre>
<h4 id="6-3-2-特殊语句自定义分片"><a href="#6-3-2-特殊语句自定义分片" class="headerlink" title="6.3.2 特殊语句自定义分片"></a>6.3.2 特殊语句自定义分片</h4><p>Mycat 本身不支持<code>insert</code>,<code>select</code>, 通过注解支持</p>
<pre class=" language-mysql"><code class="language-mysql">/*!mycat: sql=select * from customer where id =1 */ INSERT INTO test2(id) SELECT id FROM order_detail;
</code></pre>
<h4 id="6-3-3-多表shareJoin"><a href="#6-3-3-多表shareJoin" class="headerlink" title="6.3.3  多表shareJoin"></a>6.3.3  多表<code>shareJoin</code></h4><pre class=" language-mysql"><code class="language-mysql">/*!mycat:catlet=io.mycat.catlets.ShareJoin */
select a.order_id,b.price from order_info a, order_detail b where a.nums 
</code></pre>
<h4 id="6-3-4-读写分离"><a href="#6-3-4-读写分离" class="headerlink" title="6.3.4 读写分离"></a>6.3.4 读写分离</h4><p>读写分离:配置Mycat读写分离后, 默认查询都会从读节点获取数据, 但是有些场景需要获取实时数据, 如果从读节点获取数据可能因延时而无法实现实时, Mycat 支持通过注解<code>/*balance*/</code> 来强制从写节点(<code>write host</code>) 查询数据.</p>
<pre class=" language-mysql"><code class="language-mysql">/*balance*/ select a.* from customer a where a.id=6666;
</code></pre>
<p>读写分离数据库选择(1.6版本之后)</p>
<pre class=" language-mysql"><code class="language-mysql">/*!mycat: db_type=master */ select * from customer;
/*!mycat: db_type=slave */ select * from customer;
/*#mycat: db_type=master */ select * from customer;
/*#mycat: db_type=slave */ select * from customer;
</code></pre>
<p>支持直接的<code>!</code> 不被mysql 单库兼容</p>
<p>注解支持<code>#</code> 不被Mybatis兼容</p>
<h3 id="6-4-注解原理"><a href="#6-4-注解原理" class="headerlink" title="6.4 注解原理"></a>6.4 注解原理</h3><p>Mycat 在执行SQL 之前会先解析SQL语句, 在获取分片信息后再到对应的物理节点上执行。如果SQL 无法解析,则不能被执行. 如果语句有注解, 则会先会解析注解的内容获取分片信息,再把真正需要执行的SQL语句发送到对应的物理节点上. </p>
<p>所以我们在使用注解的时候, 应该清楚的知道目标SQL 应该在哪个节点上执行, 注解的SQL 也指向这个分片,这样才能使用. 如果注解没有使用正确的条件, 会导致原始SQL 被发送到所有的节点上执行, 造成数据错误. </p>
<h2 id="7-分片策略详解"><a href="#7-分片策略详解" class="headerlink" title="7. 分片策略详解"></a>7. 分片策略详解</h2><p>分片的目标是将大量的数据和访问请求均分分布在多个节点上, 通过这种方式提升数据服务的存储和负载能力. </p>
<p>总体上分为连续分片和离散分片, 还有一种是连续分片和离散分片的结合, 例如先范围后取模. </p>
<p>比如范围分片(id或者时间)就是典型的连续分片, 单个分区的数量和边界是确定的. 离散分片的分区总数量和边界是确定的, 例如对key 进行哈希运算, 或者再取模。 </p>
<p>关键词: 范围查询、热点数据、扩容. </p>
<p>连续分片优点: </p>
<ul>
<li>范围条件查询消耗资源少(不需要汇总数据)</li>
<li>扩容无需迁移数据(分片固定)</li>
</ul>
<p>连续分片缺点:</p>
<ul>
<li>存在热点数据的可能性</li>
<li>并发访问能力受限于单一或者少量<code>DataNode</code>(访问集中)</li>
</ul>
<p>离散分片优点:</p>
<ul>
<li>并发访问能力增强(负载到不同的节点)</li>
<li>范围条件查询能力提升(并行计算)</li>
</ul>
<p>离散分片缺点:</p>
<ul>
<li>数据扩容比较困难,设计到数据迁移问题</li>
<li>数据库连接消耗比较多</li>
</ul>
<h3 id="7-1-连续分片"><a href="#7-1-连续分片" class="headerlink" title="7.1 连续分片"></a>7.1 连续分片</h3><h5 id="范围分片"><a href="#范围分片" class="headerlink" title="范围分片"></a>范围分片</h5><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>auto-sharding-long<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">></span></span>id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">></span></span>rang-long<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">></span></span>
</code></pre>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rang-long<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.mycat.route.function.AutoPartitionByLong<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mapFile<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>autopartition-long.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">></span></span>
</code></pre>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># range start-end ,data node index</span>
<span class="token comment" spellcheck="true"># K=1000,M=10000. 0-500M=0</span>
<span class="token attr-name">500M-1000M</span><span class="token punctuation">=</span><span class="token attr-value">1</span>
<span class="token attr-name">1000M-1500M</span><span class="token punctuation">=</span><span class="token attr-value">2</span>
</code></pre>
<p>特点: 容易出现冷热数据</p>
<h5 id="按自然月分片"><a href="#按自然月分片" class="headerlink" title="按自然月分片"></a>按自然月分片</h5><p>建表语句</p>
<pre class=" language-mysql"><code class="language-mysql">CREATE TABLE `sharding_by_month` (
`create_time` timestamp NULL DEFAULT NULL ON UPDATE 
    `db_nm` varchar(20) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre>
<p>逻辑表</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schema</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>catmall<span class="token punctuation">"</span></span> <span class="token attr-name">checkSQLschema</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">sqlMaxLimit</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sharding_by_month<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qs-sharding-by-month<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schema</span><span class="token punctuation">></span></span>
</code></pre>
<p>分片规则</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sharding-by-month<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">></span></span>create_time<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">></span></span>qs-partbymonth<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">></span></span>
</code></pre>
<p>分片算法</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qs-partbymonth<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByMonth<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dateFormat<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>yyyy-MM-dd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sBeginDate<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>2019-10-01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sEndDate<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>2019-12-31<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">></span></span>
</code></pre>
<ul>
<li>columns 标识将要分片的表字段, 字符串类型, 与<code>dataformat</code>格式一致</li>
<li><code>algorithm</code>:为分片函数, </li>
<li><code>dataFormat</code>: 为日期字符串格式</li>
<li><code>sBeginDate</code>为开始日期</li>
<li><code>sEndDate</code>:  为结束日期</li>
</ul>
<p> 注意: 节点个数要大于月份的个数</p>
<p>测试语句</p>
<pre class=" language-mysql"><code class="language-mysql">INSERT INTO sharding_by_month (create_time,db_nm) VALUES ('2019-10-16', database());
INSERT INTO sharding_by_month (create_time,db_nm) VALUES ('2019-10-27', database());
INSERT INTO sharding_by_month (create_time,db_nm) VALUES ('2019-11-04', database());
INSERT INTO sharding_by_month (create_time,db_nm) VALUES ('2019-11-11', database());
INSERT INTO sharding_by_month (create_time,db_nm) VALUES ('2019-12-25', database());
INSERT INTO sharding_by_month (create_time,db_nm) VALUES ('2019-12-31', database());
</code></pre>
<p>另外还有按天分片(可以指定多少天一个分片)、按小时分片</p>
<h3 id="7-2-离散分片"><a href="#7-2-离散分片" class="headerlink" title="7.2 离散分片"></a>7.2 离散分片</h3><h5 id="枚举分片"><a href="#枚举分片" class="headerlink" title="枚举分片"></a>枚举分片</h5><p>将所有可能出现的值列举出来,指定分片.例如: 全局34个省, 要将不同的省的数据存放在不同的节点, 可用枚举 的方式</p>
<p>建表语句</p>
<pre class=" language-mysql"><code class="language-mysql">CREATE TABLE `sharding_by_intfile` (
`age` int(11) NOT NULL,
 `db_nm` varchar(20) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre>
<p>逻辑表</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sharding_by_intfile<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn$1-3<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qs-sharding-by-intfile<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre>
<p>分片规则</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sharding-by-intfile<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">></span></span>sharding_id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">></span></span>hash-int<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">></span></span>
</code></pre>
<p>分片算法</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hash-int<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.opencloudb.route.function.PartitionByFileMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mapFile<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>partition-hash-int.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>type<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>defaultNode<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">></span></span>
</code></pre>
<p>type: 默认值为0, 0表示<code>Integer</code>,非零表示<code>String</code></p>
<p><code>PartitionByFileMap.java</code>  通过map实现</p>
<p>策略文件:  <code>partition-hash-int.txt</code></p>
<pre class=" language-text"><code class="language-text">16=0
17=1
18=2
</code></pre>
<p>插入数据测试:</p>
<pre class=" language-mysql"><code class="language-mysql">INSERT INTO `sharding_by_intfile` (age,db_nm) VALUES (16, database());
INSERT INTO `sharding_by_intfile` (age,db_nm) VALUES (17, database());
INSERT INTO `sharding_by_intfile` (age,db_nm) VALUES (18, database())
</code></pre>
<p>特点: 适用于枚举值固定的场景. </p>
<h5 id="一致性哈希"><a href="#一致性哈希" class="headerlink" title="一致性哈希"></a>一致性哈希</h5><p>一致性hash 有效的解决了分布式数据的扩容问题</p>
<p>建表语句</p>
<pre class=" language-mysql"><code class="language-mysql">CREATE TABLE `sharding_by_murmur` (
`id` int(10) DEFAULT NULL,
 `db_nm` varchar(20) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre>
<p>逻辑表</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schema</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>test<span class="token punctuation">"</span></span> <span class="token attr-name">checkSQLschema</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">sqlMaxLimit</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sharding_by_murmurhash<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn$1-3<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sharding-by-murmur<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schema</span><span class="token punctuation">></span></span>
</code></pre>
<p>分片规则</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sharding-by-murmur<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">></span></span>id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">></span></span>qs-murmur<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">></span></span>
</code></pre>
<p>分片算法</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qs-murmur<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByMurmurHash<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>seed<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>count<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>virtualBucketTimes<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>160<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">></span></span>
</code></pre>
<p>测试语句</p>
<pre class=" language-mysql"><code class="language-mysql">INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (1, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (2, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (3, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (4, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (5, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (6, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (7, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (8, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (9, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (10, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (11, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (12, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (13, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (14, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (15, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (16, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (17, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (18, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (19, database());
INSERT INTO `sharding_by_murmur` (id,db_nm) VALUES (20, database());
</code></pre>
<p>特点: 可以一定程序上 减少数据的迁移. </p>
<h5 id="十进制取模分片"><a href="#十进制取模分片" class="headerlink" title="十进制取模分片"></a>十进制取模分片</h5><p>根据分片键进行十进制求模运算. </p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mod-long<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">></span></span>sid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">></span></span>mod-long<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">></span></span>
</code></pre>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mod-long<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByMod<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token comment" spellcheck="true">&lt;!-- how many data nodes --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>count<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">></span></span>
</code></pre>
<p>特点: 分布均匀, 但是迁移工作量比较大. </p>
<h5 id="固定分片哈希"><a href="#固定分片哈希" class="headerlink" title="固定分片哈希"></a>固定分片哈希</h5><p>这是先求模得到逻辑分片号, 再根据逻辑分片号直接映射到物理分片的一种散列算法</p>
<p>建表语句</p>
<pre class=" language-mysql"><code class="language-mysql">CREATE TABLE `sharding_by_long` (
`id` int(10) DEFAULT NULL,
    `db_nm` varchar(20) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre>
<p>逻辑表</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schema</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>test<span class="token punctuation">"</span></span> <span class="token attr-name">checkSQLschema</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">sqlMaxLimit</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sharding_by_long<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn$1-3<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qs-sharding-by-long<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schema</span><span class="token punctuation">></span></span>
</code></pre>
<p>分片规则</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qs-sharding-by-long<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">></span></span>id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">></span></span>qs-sharding-by-long<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">></span></span>
</code></pre>
<p>平均分成8片(%1024的余数, 1024=128*8)</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qs-sharding-by-long<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByLong<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>partitionCount<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>partitionLength<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>128<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">></span></span>
</code></pre>
<ul>
<li>partitionCount:  为指定分片个数列表</li>
<li>partitionLength: 为分片范围列表</li>
</ul>
<p><img src="http://files.luyanan.com//img/20200406153633.png" alt="image-20200406153632403"></p>
<p>第二个例子: </p>
<p>两个数组,分成不均匀的3个节点(%1024的余数,1024=2*256+1*512)</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qs-sharding-by-long<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByLong<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>partitionCount<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>2,1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>partitionLength<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>256,512<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">></span></span>
</code></pre>
<p>3个节点, 对1024取模余数的分布</p>
<p><img src="http://files.luyanan.com//img/20200406153847.png" alt="image-20200406153846049"></p>
<p>测试语句</p>
<pre class=" language-mysql"><code class="language-mysql">INSERT INTO `sharding_by_long` (id,db_nm) VALUES (222, database());
INSERT INTO `sharding_by_long` (id,db_nm) VALUES (333, database());
INSERT INTO `sharding_by_long` (id,db_nm) VALUES (666, database());
</code></pre>
<p>特点: 在一定范围内id是连续分布的. </p>
<h5 id="取模范围分布"><a href="#取模范围分布" class="headerlink" title="取模范围分布"></a>取模范围分布</h5><p>逻辑表</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schema</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>test<span class="token punctuation">"</span></span> <span class="token attr-name">checkSQLschema</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">sqlMaxLimit</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sharding_by_pattern<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn$0-10<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qs-sharding-by-pattern<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schema</span><span class="token punctuation">></span></span>
</code></pre>
<p>建表语句</p>
<pre class=" language-mysql"><code class="language-mysql">CREATE TABLE `sharding_by_pattern` (
`id` varchar(20) DEFAULT NULL,
 `db_nm` varchar(20) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre>
<p>分片规则</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sharding-by-pattern<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">></span></span>user_id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">></span></span>sharding-by-pattern<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">></span></span>
</code></pre>
<p>分片算法</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sharding-by-pattern<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span> io.mycat.route.function.PartitionByPattern<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>patternValue<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>100<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>defaultNode<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mapFile<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>partition-pattern.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">></span></span>
</code></pre>
<p><code>patternValue</code> 取模基数, 这里设置成100</p>
<p><code>partition-pattern.txt</code> , 一共三个节点</p>
<p>id=19%100=19，在 dn1；<br>       id=222%100=22，dn2；<br>       id=371%100=71，dn3</p>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># id partition range start-end ,data node index</span>
<span class="token comment" spellcheck="true">###### first host configuration</span>
<span class="token attr-name">1-20</span><span class="token punctuation">=</span><span class="token attr-value">0</span>
<span class="token attr-name">21-70</span><span class="token punctuation">=</span><span class="token attr-value">1</span>
<span class="token attr-name">71-100</span><span class="token punctuation">=</span><span class="token attr-value">2</span>
<span class="token attr-name">0-0</span><span class="token punctuation">=</span><span class="token attr-value">0</span>
</code></pre>
<p>测试语句: </p>
<pre class=" language-mysql"><code class="language-mysql">INSERT INTO `sharding_by_pattern` (id,db_nm) VALUES (19, database());
INSERT INTO `sharding_by_pattern` (id,db_nm) VALUES (222, database());
INSERT INTO `sharding_by_pattern` (id,db_nm) VALUES (371, database());
</code></pre>
<p>特点: 可以调整节点的数据分布</p>
<h5 id="范围取模分片"><a href="#范围取模分片" class="headerlink" title="范围取模分片"></a>范围取模分片</h5><p>建表语句</p>
<pre class=" language-mysql"><code class="language-mysql">CREATE TABLE `sharding_by_rang_mod` (
`id` bigint(20) DEFAULT NULL,
 `db_nm` varchar(20) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre>
<p>逻辑表</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schema</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>test<span class="token punctuation">"</span></span> <span class="token attr-name">checkSQLschema</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">sqlMaxLimit</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sharding_by_rang_mod<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn$1-3<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qs-sharding-by-rang-mod<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schema</span><span class="token punctuation">></span></span>
</code></pre>
<p>分片规则</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qs-sharding-by-rang-mod<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">></span></span>id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">></span></span>qs-rang-mod<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">></span></span>
</code></pre>
<p>分片算法</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qs-rang-mod<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByRangeMod<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mapFile<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>partition-range-mod.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">></span></span>
</code></pre>
<p><code>partition-range-mod.txt</code></p>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># range start-end ,data node group size</span>
<span class="token attr-name">0-20000</span><span class="token punctuation">=</span><span class="token attr-value">1</span>
<span class="token attr-name">20001-40000</span><span class="token punctuation">=</span><span class="token attr-value">2</span>
</code></pre>
<p>解读: 先范围后取模, id在20000以内的, 全部分布到dn1, id在20001-40000的, %2分布到dn2、dn3. </p>
<p>插入数据</p>
<pre class=" language-mysql"><code class="language-mysql">INSERT INTO `sharding_by_rang_mod` (id,db_nm) VALUES (666, database());
INSERT INTO `sharding_by_rang_mod` (id,db_nm) VALUES (6667, database());
INSERT INTO `sharding_by_rang_mod` (id,db_nm) VALUES (16666, database());
INSERT INTO `sharding_by_rang_mod` (id,db_nm) VALUES (21111, database());
INSERT INTO `sharding_by_rang_mod` (id,db_nm) VALUES (22222, database());
INSERT INTO `sharding_by_rang_mod` (id,db_nm) VALUES (23333, database());
INSERT INTO `sharding_by_rang_mod` (id,db_nm) VALUES (24444, database());
</code></pre>
<p>特点:扩容的时候旧数据无需迁移. </p>
<h5 id="其他分片规则"><a href="#其他分片规则" class="headerlink" title="其他分片规则"></a>其他分片规则</h5><p>应用指定分片: <code>PartitionDirectBySubString</code></p>
<p>日期范围哈希: <code>PartitionByRangeDateHash</code></p>
<p>冷热数据分片： <code>PartitionByHotDate</code></p>
<p>也可以自定义分片规则: <code>extends AbstractPartitionAlgorithm implements RuleAlgorithm。</code></p>
<h3 id="7-3-切分规则的选择"><a href="#7-3-切分规则的选择" class="headerlink" title="7.3 切分规则的选择"></a>7.3 切分规则的选择</h3><p>步骤: </p>
<ol>
<li>找到需要切分的大表, 和关联的表</li>
<li>确定分片的字段(尽量使用主键),一般是用最频繁使用的查询条件</li>
<li>考虑单个分片的存储容量和请求,数据增长(业务特性)、扩容和数据迁移问题</li>
</ol>
<p>例如： 按照什么递增? 序号还是日期?主键是否还有业务意义? </p>
<p>一般来说,分片数要比当前规划的节点数要大</p>
<p> 总结: 根据业务场景, 合理的选择分片规则</p>
<h2 id="8-Mycat-离线扩缩容"><a href="#8-Mycat-离线扩缩容" class="headerlink" title="8. Mycat 离线扩缩容"></a>8. Mycat 离线扩缩容</h2><p>当我们规划了数据分片, 而数据已经超过了单个节点的存储上限或者需要下线节点的时候, 就需要对数据进行重新分片. </p>
<h3 id="8-1-Mycat-自带的工具"><a href="#8-1-Mycat-自带的工具" class="headerlink" title="8.1 Mycat 自带的工具"></a>8.1 Mycat 自带的工具</h3><h4 id="8-1-1-准备工作"><a href="#8-1-1-准备工作" class="headerlink" title="8.1.1 准备工作"></a>8.1.1 准备工作</h4><ol>
<li>mycat 所在环境安装mysql 客户端</li>
<li>mycat 的<code>lib</code> 目录下添加<code>mysql</code>的<code>jdbc</code> 驱动</li>
<li>对扩缩容的表所有节点进行备份, 以免迁移失败后的数据恢复</li>
</ol>
<h4 id="8-1-2-步骤"><a href="#8-1-2-步骤" class="headerlink" title="8.1.2 步骤"></a>8.1.2 步骤</h4><p>以取模分片<code>sharding-by-mod</code> 缩容为例. </p>
<p><img src="http://files.luyanan.com//img/20200406160218.png" alt="image-20200406160217558"></p>
<ol>
<li>复制 <code>schema.xml</code>、<code>rule.xml</code> 重命名为<code>newSchema.xml</code>、<code>newRule.xml</code> 放于<code>conf</code>目录下</li>
<li>修改<code>newSchema.xml </code>和 <code>newRule.xml</code> 配置文件为扩缩容后的mycat 配置参数(表的节点数、数据源、路由规则)</li>
</ol>
<p>注意： </p>
<p>只有节点变化的表才会进行迁移,仅分片配置变化不会迁移. </p>
<p><code>newSchema.xml</code></p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sharding_by_mod<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qs-sharding-by-mod<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre>
<p>改成(减少了一个节点)</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sharding_by_mod<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1,dn2<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qs-sharding-by-mod<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre>
<p><code>newRule.xml</code> 修改<code>count</code> 的个数</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>qs-sharding-by-mod-long<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByMod<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>count<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">></span></span>
</code></pre>
<ol start="3">
<li><p>修改<code>conf</code> 目录下的<code>migrateTables.properties</code> 的配置文件,告诉工具那些表需要进行扩容或者缩容, 没有出现在此配置文件的<code>schema</code> 表 不会进行数据迁移, 格式:</p>
<p> 注意: </p>
<ol>
<li>不迁移的表, 不要修改dn的个数, 否则会出错</li>
<li>ER表,因为只有主表有分片规则, 字表不会进行迁移</li>
</ol>
</li>
</ol>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">catmall</span><span class="token punctuation">=</span><span class="token attr-value">sharding-by-mod</span>
</code></pre>
<ol start="4">
<li><p><code>dataMigrate.sh</code> 中这个配置必须配置</p>
<p> 通过命令 <code>&quot;find / -name mysqldump&quot;</code> 查找<code>mysqldump</code> 路径为：<code>/usr/bin/mysqldump</code>,指定<code>#mysql bin</code> 路径为<code>/usr/bin</code></p>
</li>
</ol>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">#mysql bin 路径</span>
<span class="token attr-name">RUN_CMD</span><span class="token punctuation">=</span><span class="token attr-value">"$RUN_CMD -mysqlBin= /usr/bin/</span>
</code></pre>
<ol start="5">
<li><p>停止mycat 服务</p>
</li>
<li><p>执行<code>bin/ dataMigrate.sh</code> 脚本</p>
<blockquote>
<p> 必须要配置java 环境变量, 不能用openjdk</p>
</blockquote>
</li>
<li><p>脚本执行完成, 如果最后的数据迁移验证通过, 就可以将之前的<code>newSchema.xml</code> 和 <code>newRule.xml</code> 替换之前的 <code>schema.xml</code> 和 <code>rule.xml </code>文 件，并重启 mycat 即可。</p>
</li>
</ol>
<p>注意事项： </p>
<ol>
<li><p>保证分片表迁移数据前后路由规则一直(取模-取模)</p>
</li>
<li><p>保证分片表迁移数据前后分片字段一致</p>
</li>
<li><p>全局表将被忽略</p>
</li>
<li><p>不要将非分片表配置到 <code>migrateTables.properties</code> 文件中., </p>
</li>
<li><p>暂时只支持分片表使用Mysql 作为数据源的扩容缩容</p>
<p><code>migrate</code> 限制比较多, 还可以使用<code>mysqldump</code> 方法</p>
</li>
</ol>
<h3 id="8-2-mysqldump-方式"><a href="#8-2-mysqldump-方式" class="headerlink" title="8.2 mysqldump 方式"></a>8.2 <code>mysqldump</code> 方式</h3><p>系统第一次上线, 把单张表迁移到mycat,也可以用<code>mysqldump</code></p>
<p>Mysql 导出</p>
<pre class=" language-mysql"><code class="language-mysql">mysqldump -uroot -p123456 -h127.0.0.1 -P3306 -c -t --skip-extended-insert gpcat > mysql-1017.sql
</code></pre>
<ul>
<li>-c 代表带列名</li>
<li>-t 代表只要数据, 不要建表语句</li>
<li>–skip-extended-insert 代表生成多行 insert（mycat childtable 不支持多行插入 咕泡出品，必属精品 <a target="_blank" rel="noopener" href="http://www.gupaoedu.com/">www.gupaoedu.com</a> 28 ChildTable multi insert not provided）</li>
</ul>
<p>Mycat导入</p>
<pre class=" language-mysql"><code class="language-mysql">mysql -uroot -p123456 -h127.0.0.1 -P8066 catmall < mysql-1017.sql
</code></pre>
<p>Mycat导出</p>
<pre class=" language-mysql"><code class="language-mysql">mysqldump -h192.168.8.151 -uroot -p123456 -P8066 -c -t --skip-extended-insert catmall customer > mycat-cust.sql
</code></pre>
<p>其他导入方式: </p>
<p><code>load data local infile &#39;/mycat/customer.txt&#39; into table customer;</code></p>
<p><code>source sql &#39;/mycat/customer.sql&#39;;</code></p>
<h2 id="9-核心流程总结"><a href="#9-核心流程总结" class="headerlink" title="9. 核心流程总结"></a>9. 核心流程总结</h2><p>官网的架构图</p>
<p><img src="http://files.luyanan.com//img/20200406164438.png" alt="image-20200406164437442"></p>
<h4 id="9-1-启动"><a href="#9-1-启动" class="headerlink" title="9.1  启动"></a>9.1  启动</h4><ol>
<li>mycatServer 启动, 解析配置文件, 包括服务器、分片规则</li>
<li>创建工作线程, 建立前端连接和后端连接</li>
</ol>
<h4 id="9-2-执行SQL"><a href="#9-2-执行SQL" class="headerlink" title="9.2 执行SQL"></a>9.2 执行SQL</h4><ol>
<li><p>前端连接接受MYSQL 命令</p>
</li>
<li><p>解析MYSQL, mycat 用的是Druid 的 DruidParser</p>
</li>
<li><p>获取路由</p>
</li>
<li><p>改写MYSQL,例如两个条件在两个节点, 则变成两条单独的SQL</p>
<p> 例如： <code>select * from customer where id in(5000001, 10000001);</code></p>
<p>改写成</p>
<pre class=" language-mysql"><code class="language-mysql">select * from customer where id = 5000001；（dn2 执行）
select * from customer where id = 10000001；（dn3 执行）
</code></pre>
</li>
<li><p>与后盾数据库建立连接</p>
</li>
<li><p>发送SQL语句到MYSQL 执行</p>
</li>
<li><p>获取返回结果</p>
</li>
<li><p>处理返回结果, 例如排序、计算等等</p>
</li>
<li><p>返回给客户端</p>
</li>
</ol>
<h2 id="10-源码下载和调试环境搭建"><a href="#10-源码下载和调试环境搭建" class="headerlink" title="10 源码下载和调试环境搭建"></a>10 源码下载和调试环境搭建</h2><h3 id="10-1-下载源代码-导入工程"><a href="#10-1-下载源代码-导入工程" class="headerlink" title="10.1 下载源代码, 导入工程"></a>10.1 下载源代码, 导入工程</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/MyCATApache/Mycat-Server
</code></pre>
<h3 id="10-2-配置"><a href="#10-2-配置" class="headerlink" title="10.2 配置"></a>10.2 配置</h3><p><code>schema.xml</code></p>
<pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0"?></span>
<span class="token doctype">&lt;!DOCTYPE mycat:schema SYSTEM "schema.dtd"></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">mycat:</span>schema</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>mycat</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://io.mycat/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schema</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>TESTDB<span class="token punctuation">"</span></span> <span class="token attr-name">checkSQLschema</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">sqlMaxLimit</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>travelrecord<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>auto-sharding-long<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>company<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ID<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>global<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hotnews<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ID<span class="token punctuation">"</span></span> <span class="token attr-name">autoIncrement</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mod-long<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schema</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataNode</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1<span class="token punctuation">"</span></span> <span class="token attr-name">dataHost</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>localhost1<span class="token punctuation">"</span></span> <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>db1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataNode</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn2<span class="token punctuation">"</span></span> <span class="token attr-name">dataHost</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>localhost1<span class="token punctuation">"</span></span> <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>db2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataNode</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn3<span class="token punctuation">"</span></span> <span class="token attr-name">dataHost</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>localhost1<span class="token punctuation">"</span></span> <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>db3<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataHost</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>localhost1<span class="token punctuation">"</span></span> <span class="token attr-name">maxCon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span> <span class="token attr-name">minCon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">balance</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">writeType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">dbType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mysql<span class="token punctuation">"</span></span> <span class="token attr-name">dbDriver</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>native<span class="token punctuation">"</span></span> <span class="token attr-name">switchType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">slaveThreshold</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>heartbeat</span><span class="token punctuation">></span></span>select user()<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>heartbeat</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>writeHost</span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hostM1<span class="token punctuation">"</span></span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>127.0.0.1:3306<span class="token punctuation">"</span></span> <span class="token attr-name">user</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span> <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>writeHost</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataHost</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">mycat:</span>schema</span><span class="token punctuation">></span></span>
</code></pre>
<h3 id="10-3-表结构"><a href="#10-3-表结构" class="headerlink" title="10.3 表结构"></a>10.3 表结构</h3><p>本地数据库创建db1、db2、db3 数据库, 全部执行建表脚本</p>
<pre class=" language-mysql"><code class="language-mysql">CREATE TABLE `company` (
`id` bigint(20) NOT NULL AUTO_INCREMENT,
 `name` varchar(64) DEFAULT '',
 `market_value` bigint(20) DEFAULT '0', PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4;

CREATE TABLE `hotnews` (
`id` bigint(20) NOT NULL AUTO_INCREMENT,
 `title` varchar(64) DEFAULT '',
 `content` varchar(512) DEFAULT '0',
 `time` varchar(8) DEFAULT '',
 `cat_name` varchar(10) DEFAULT '',
 PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `travelrecord` (
`id` bigint(20) NOT NULL AUTO_INCREMENT,
 `city` varchar(32) DEFAULT '',
 `time` varchar(8) DEFAULT '', 
PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
</code></pre>
<h3 id="10-4逻辑表配置"><a href="#10-4逻辑表配置" class="headerlink" title="10.4逻辑表配置"></a>10.4逻辑表配置</h3><p><code>travelrecord</code> 表配置</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>travelrecord<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>auto-sharding-long<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>auto-sharding-long<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">></span></span>id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">></span></span>rang-long<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rang-long<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.mycat.route.function.AutoPartitionByLong<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mapFile<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>autopartition-long.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">></span></span>
</code></pre>
<p><code>hotnews</code> 表配置</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hotnews<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ID<span class="token punctuation">"</span></span> <span class="token attr-name">autoIncrement</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mod-long<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mod-long<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">></span></span>id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">></span></span>mod-long<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mod-long<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByMod<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token comment" spellcheck="true">&lt;!-- how many data nodes --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>count<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">></span></span>
</code></pre>
<p><code>company</code> 表配置</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>company<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ID<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>global<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre>
<h3 id="10-5-debug-方式启动"><a href="#10-5-debug-方式启动" class="headerlink" title="10.5 debug 方式启动"></a>10.5 debug 方式启动</h3><p>debug方式启动`main 方式</p>
<p><code>Mycat-Server-1.6.5-RELEASE\src\main\java\io\mycat\MycatStartup.java</code></p>
<h3 id="10-6-连接本地Mycat-服务"><a href="#10-6-连接本地Mycat-服务" class="headerlink" title="10.6 连接本地Mycat 服务"></a>10.6 连接本地Mycat 服务</h3><p>测试语句</p>
<pre class=" language-mysql"><code class="language-mysql">insert into travelrecord(`id`, `city`, `time`) values(1, '长沙', '20191020');
insert into hotnews(`title`, `content`) values('新闻', 'aaaa');
insert into company(`name`, `market_value`) values('spring', 100);
</code></pre>
<h3 id="10-7-调试入口"><a href="#10-7-调试入口" class="headerlink" title="10.7 调试入口"></a>10.7 调试入口</h3><p>连接入口</p>
<p><code>io.mycat.net.NIOAcceptor#accept</code></p>
<p>SQL入口</p>
<p><code>io.mycat.server.ServerQueryHandler#query</code></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">luyanan</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://rainsoil.github.io/2022/01/04/shu-ju-ku/fen-ku-fen-biao-zhi-mycat-3/">https://rainsoil.github.io/2022/01/04/shu-ju-ku/fen-ku-fen-biao-zhi-mycat-3/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">luyanan</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/01/04/shu-ju-ku/fen-ku-fen-biao-zhi-sharding-jdbc-5/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="分库分表之Sharding-JDBC(5)">
                        
                        <span class="card-title">分库分表之Sharding-JDBC(5)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-01-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">
                                    数据库
                                </a>
                            
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">
                                    数据库
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/01/04/wei-fu-wu/zookpeer/zookeeper-yuan-li-zhi-leader-xuan-ju-yuan-ma-fen-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="Zookeeper原理之Leader选举源码分析">
                        
                        <span class="card-title">Zookeeper原理之Leader选举源码分析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-01-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/zookpeer/" class="post-category">
                                    zookpeer
                                </a>
                            
                            <a href="/categories/zookpeer/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="post-category">
                                    微服务
                                </a>
                            
                            <a href="/categories/zookpeer/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="post-category">
                                    微服务
                                </a>
                            
                            <a href="/categories/zookpeer/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1/zookpeer/" class="post-category">
                                    zookpeer
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <a href="/about" target="_blank">luyanan</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">803.3k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/rainsoil" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:luyanan0718@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=914596513" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 914596513" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
