<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="任务调度之Quartz, railsoil">
    <meta name="description" content="任务调度之Quartz1. 漫谈任务调度1.1 什么时候需要任务调度1.1.1 任务调度的背景在业务系统中,有很多这样的场景:

账单日或者还款日上午10点, 给每个信用卡客户发送账单通知, 还款通知。 如何判断客户的账单日、还款日,完成通">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>任务调度之Quartz | railsoil</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="railsoil" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">railsoil</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">railsoil</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/21.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">任务调度之Quartz</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/" class="post-category">
                                任务调度
                            </a>
                        
                            <a href="/categories/%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/" class="post-category">
                                任务调度
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-01-04
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    12.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    57 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="任务调度之Quartz"><a href="#任务调度之Quartz" class="headerlink" title="任务调度之Quartz"></a>任务调度之Quartz</h1><h2 id="1-漫谈任务调度"><a href="#1-漫谈任务调度" class="headerlink" title="1. 漫谈任务调度"></a>1. 漫谈任务调度</h2><h3 id="1-1-什么时候需要任务调度"><a href="#1-1-什么时候需要任务调度" class="headerlink" title="1.1 什么时候需要任务调度"></a>1.1 什么时候需要任务调度</h3><h4 id="1-1-1-任务调度的背景"><a href="#1-1-1-任务调度的背景" class="headerlink" title="1.1.1 任务调度的背景"></a>1.1.1 任务调度的背景</h4><p>在业务系统中,有很多这样的场景:</p>
<ol>
<li><p>账单日或者还款日上午10点, 给每个信用卡客户发送账单通知, 还款通知。 如何判断客户的账单日、还款日,完成通知的发送.</p>
</li>
<li><p>银行业务系统,夜间要完成跑批的一系列流程, 清理数据、下载文件、解析文件、对账清算、切换结算日期等, 如何触发一系列流程的执行? </p>
</li>
<li><p>金融机构跟人民银行二代支付系统对接, 人民银行要求小于5W的金额(小额支付)半小时打一次包发送, 以缓解并发压力. 所以, 银行的跨行转账分成了多个流程:录入、复核、发送. 如何把半个小时以内的数据一次性发送. </p>
</li>
</ol>
<p> 类似于这种:</p>
<ol>
<li>基于准确的时刻或者固定的时间间隔发送的任务 </li>
<li>有批量数据需要处理</li>
<li>要实现两个动作的解耦</li>
</ol>
<p>这种场景, 我们都可以用任务调度来实现. </p>
<h3 id="1-2-任务调度需求分析"><a href="#1-2-任务调度需求分析" class="headerlink" title="1.2 任务调度需求分析"></a>1.2 任务调度需求分析</h3><p>任务调度的实现方式有很多, 如果要实现我们的调度需求, 我们对这个工具有什么样的基本要求呢? </p>
<h4 id="1-2-1-基本需求"><a href="#1-2-1-基本需求" class="headerlink" title="1.2.1 基本需求"></a>1.2.1 基本需求</h4><ol>
<li>可以定义触发的规则, 比如基于时刻、时间间隔、表达式</li>
<li>可以定义需要执行的任务, 比如执行一个脚本或者一段代码.任务或者规则是分开的. </li>
<li>集中管理配置, 持久配置. 不用把规则写在代码里面,可以看到所有的任务配置,方便维护. 重启之后任务还可以再次调度,</li>
<li>支持任务的串行执行, 例如执行A任务之后再执行任务B再执行任务C</li>
<li>支持多个任务并发执行, 互不干扰. </li>
<li>有自己的调度系统, 可以启动、中断、停止任务 </li>
<li>容易集成到Spring中. </li>
</ol>
<h3 id="1-3-任务调度工具对比"><a href="#1-3-任务调度工具对比" class="headerlink" title="1.3 任务调度工具对比"></a>1.3 任务调度工具对比</h3><table>
<thead>
<tr>
<th>层次</th>
<th>举例</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>操作系统</td>
<td><code>linux crontab</code><br />windows计划任务</td>
<td>只能执行简单的脚本或者命令</td>
</tr>
<tr>
<td>数据库</td>
<td>Mysql、Oracle</td>
<td>可以操作数据, 但是不能执行代码</td>
</tr>
<tr>
<td>工具</td>
<td><code>Kettle</code></td>
<td>可以操作数据,执行脚本,没有集中配置</td>
</tr>
<tr>
<td>开发语言</td>
<td><code>JDK Timer</code>、<code>SchedultThreadPool</code></td>
<td><code>Timer</code>:单线程<br />JDK1.5 之后：<code>ScheduledThreadPool</code>（<code>Cache</code>、<code>Fiexed</code>、 <code>Single</code>）:没有集中配置，日程管理不够灵活</td>
</tr>
<tr>
<td>容器</td>
<td><code>Spring Task</code>、<code>@Scheduled</code></td>
<td>不支持集群</td>
</tr>
<tr>
<td>分布式框架</td>
<td><code>xxl-job</code>、<code>Elastic-Job</code></td>
<td></td>
</tr>
</tbody></table>
<p>@Scheduled 也是用 JUC 的 ScheduledExecutorService 实现的</p>
<p>简单分析一下实现流程: </p>
<ol>
<li><p><code>org.springframework.scheduling.annotation.ScheduledAnnotationBeanPostProcessor</code> 的<code>org.springframework.scheduling.annotation.ScheduledAnnotationBeanPostProcessor#postProcessAfterInitialization</code> 将<code>@Scheduled</code> 的方法包装为指定的task 添加到<code>ScheduledTaskRegistra</code>中. </p>
<p> 我们看一下代码</p>
<pre class=" language-java"><code class="language-java">
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">AopInfrastructureBean</span> <span class="token operator">||</span> bean <span class="token keyword">instanceof</span> <span class="token class-name">TaskScheduler</span> <span class="token operator">||</span>
                bean <span class="token keyword">instanceof</span> <span class="token class-name">ScheduledExecutorService</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Ignore AOP infrastructure such as scoped proxies.</span>
            <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> targetClass <span class="token operator">=</span> AopProxyUtils<span class="token punctuation">.</span><span class="token function">ultimateTargetClass</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>nonAnnotatedClasses<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                AnnotationUtils<span class="token punctuation">.</span><span class="token function">isCandidateClass</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">,</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>Scheduled<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> Schedules<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            Map<span class="token operator">&lt;</span>Method<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>Scheduled<span class="token operator">>></span> annotatedMethods <span class="token operator">=</span> MethodIntrospector<span class="token punctuation">.</span><span class="token function">selectMethods</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>MethodIntrospector<span class="token punctuation">.</span>MetadataLookup<span class="token operator">&lt;</span>Set<span class="token operator">&lt;</span>Scheduled<span class="token operator">>></span><span class="token punctuation">)</span> method <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        Set<span class="token operator">&lt;</span>Scheduled<span class="token operator">></span> scheduledMethods <span class="token operator">=</span> AnnotatedElementUtils<span class="token punctuation">.</span><span class="token function">getMergedRepeatableAnnotations</span><span class="token punctuation">(</span>
                                method<span class="token punctuation">,</span> Scheduled<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> Schedules<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">!</span>scheduledMethods<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> scheduledMethods <span class="token operator">:</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>annotatedMethods<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>nonAnnotatedClasses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"No @Scheduled annotations found on bean class: "</span> <span class="token operator">+</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Non-empty set of methods</span>
                annotatedMethods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> scheduledMethods<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
                        scheduledMethods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>scheduled <span class="token operator">-</span><span class="token operator">></span> <span class="token function">processScheduled</span><span class="token punctuation">(</span>scheduled<span class="token punctuation">,</span> method<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span>annotatedMethods<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" @Scheduled methods processed on bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>
                            <span class="token string">"': "</span> <span class="token operator">+</span> annotatedMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
</li>
<li><p><code>ScheduledAnnotationBeanPostProcessor</code> 会监听Spring容器初始化事件,在Spring容器初始化完成的时候进行<code>TaskScheduler</code> 实现类实例的查找,若发现有<code>SchedulingConfigurer</code>的实现类实例, 会跳过3</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span>ContextRefreshedEvent event<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
           <span class="token comment" spellcheck="true">// Running in an ApplicationContext -> register tasks this late...</span>
           <span class="token comment" spellcheck="true">// giving other ContextRefreshedEvent listeners a chance to perform</span>
           <span class="token comment" spellcheck="true">// their work at the same time (e.g. Spring Batch's job registration).</span>
           <span class="token function">finishRegistration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">finishRegistration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>scheduler <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
           <span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">.</span><span class="token function">setScheduler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token keyword">instanceof</span> <span class="token class-name">ListableBeanFactory</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
           Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> SchedulingConfigurer<span class="token operator">></span> beans <span class="token operator">=</span>
                   <span class="token punctuation">(</span><span class="token punctuation">(</span>ListableBeanFactory<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeansOfType</span><span class="token punctuation">(</span>SchedulingConfigurer<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           List<span class="token operator">&lt;</span>SchedulingConfigurer<span class="token operator">></span> configurers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>beans<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           AnnotationAwareOrderComparator<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>configurers<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">for</span> <span class="token punctuation">(</span>SchedulingConfigurer configurer <span class="token operator">:</span> configurers<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
               configurer<span class="token punctuation">.</span><span class="token function">configureTasks</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">.</span><span class="token function">hasTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">.</span><span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
           Assert<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">!=</span> null<span class="token punctuation">,</span> <span class="token string">"BeanFactory must be set to find scheduler by type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
               <span class="token comment" spellcheck="true">// Search for TaskScheduler bean...</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">.</span><span class="token function">setTaskScheduler</span><span class="token punctuation">(</span><span class="token function">resolveSchedulerBean</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> TaskScheduler<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
           <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoUniqueBeanDefinitionException</span> ex<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
               logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Could not find unique TaskScheduler bean"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                   <span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">.</span><span class="token function">setTaskScheduler</span><span class="token punctuation">(</span><span class="token function">resolveSchedulerBean</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> TaskScheduler<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
               <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchBeanDefinitionException</span> ex2<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                   <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                       logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"More than one TaskScheduler bean exists within the context, and "</span> <span class="token operator">+</span>
                               <span class="token string">"none is named 'taskScheduler'. Mark one of them as primary or name it 'taskScheduler' "</span> <span class="token operator">+</span>
                               <span class="token string">"(possibly as an alias); or implement the SchedulingConfigurer interface and call "</span> <span class="token operator">+</span>
                               <span class="token string">"ScheduledTaskRegistrar#setScheduler explicitly within the configureTasks() callback: "</span> <span class="token operator">+</span>
                               ex<span class="token punctuation">.</span><span class="token function">getBeanNamesFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
               <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
           <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchBeanDefinitionException</span> ex<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
               logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Could not find default TaskScheduler bean"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment" spellcheck="true">// Search for ScheduledExecutorService bean next...</span>
               <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                   <span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">.</span><span class="token function">setScheduler</span><span class="token punctuation">(</span><span class="token function">resolveSchedulerBean</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> ScheduledExecutorService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
               <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoUniqueBeanDefinitionException</span> ex2<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                   logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Could not find unique ScheduledExecutorService bean"</span><span class="token punctuation">,</span> ex2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                       <span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">.</span><span class="token function">setScheduler</span><span class="token punctuation">(</span><span class="token function">resolveSchedulerBean</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> ScheduledExecutorService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchBeanDefinitionException</span> ex3<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                       <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                           logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"More than one ScheduledExecutorService bean exists within the context, and "</span> <span class="token operator">+</span>
                                   <span class="token string">"none is named 'taskScheduler'. Mark one of them as primary or name it 'taskScheduler' "</span> <span class="token operator">+</span>
                                   <span class="token string">"(possibly as an alias); or implement the SchedulingConfigurer interface and call "</span> <span class="token operator">+</span>
                                   <span class="token string">"ScheduledTaskRegistrar#setScheduler explicitly within the configureTasks() callback: "</span> <span class="token operator">+</span>
                                   ex2<span class="token punctuation">.</span><span class="token function">getBeanNamesFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
               <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
               <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchBeanDefinitionException</span> ex2<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                   logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Could not find default ScheduledExecutorService bean"</span><span class="token punctuation">,</span> ex2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token comment" spellcheck="true">// Giving up -> falling back to default scheduler within the registrar...</span>
                   logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"No TaskScheduler/ScheduledExecutorService bean found for scheduled processing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

       <span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
</li>
<li><p>查找<code>TaskScheduler</code>的实现类实例默认是通过类型查找,若有多个实现类则会查找名字为<code>&quot;taskScheduler&quot;</code>的实现bean, 如没有找见则在<code>ScheduledTaskRegistrar</code>调度任务的时候创建一个<code>newSingleThreadScheduledExecutor</code>,将<code>TaskScheduler</code> 的实现类实例设置到 <code>ScheduledTaskRegistrar</code> 属性中</p>
</li>
<li><p><code>ScheduledTaskRegistrar</code> 的 <code>scheduleTasks</code> 方法触发任务调度</p>
</li>
<li><p>真正调度任务的类是 <code>TaskScheduler</code> 实现类中的 <code>ScheduledExecutorService</code>，由 <code>J.U.C</code> 提供</p>
</li>
</ol>
<h2 id="2-Quartz-基本介绍"><a href="#2-Quartz-基本介绍" class="headerlink" title="2. Quartz 基本介绍"></a>2. Quartz 基本介绍</h2><p>官网: <a target="_blank" rel="noopener" href="http://www.quartz-scheduler.org/">http://www.quartz-scheduler.org/</a></p>
<p><code>Quartz</code>的意思是石英, 像石英表一样精确. </p>
<blockquote>
<p>Quartz is a richly featured, open source job scheduling library that can be integrated within virtually any Java application - from the smallest stand-alone application to the largest e-commerce system. Quartz can be used to create simple or complex schedules for executing tens, hundreds, or even tens-of-thousands of jobs; jobs whose tasks are defined as standard Java components that may execute virtually anything you may program them to do. The Quartz Scheduler includes many enterprise-class features, such as support for JTA transactions and clustering.<br>    Quatz 是一个特性丰富的，开源的任务调度库，它几乎可以嵌入所有的 Java 程序，从很小的独立应用程序到大型 商业系统。Quartz 可以用来创建成百上千的简单的或者复杂的任务，这些任务可以用来执行任何程序可以做的事情。 Quartz 拥有很多企业级的特性，包括支持 JTA 事务和集群。</p>
</blockquote>
<p><code>Quartz</code> 是一个老牌的任务调度系统, 98年构思, 01年发布到<code>sourceforge</code>.现在更新比较慢, 因为已经非常成熟了. </p>
<p><a target="_blank" rel="noopener" href="https://github.com/quartz-scheduler/quartz">https://github.com/quartz-scheduler/quartz</a></p>
<p><code>Quzrtz</code>的目的就是让任务调度变得更加简单, 开发人员只需要关注即可, 它是用java语言编写的. Java代码能够做的任何事情,<code>Quartz</code> 都可以调度. </p>
<p>特点：</p>
<ol>
<li>精确到毫秒级别的调度</li>
<li>可以独立运行, 也可以集成到容器中</li>
<li>支持事务(<code>JobStoreCMT</code>)</li>
<li>支持集群</li>
<li>支持持久化</li>
</ol>
<h2 id="3-Quartz-Java编程"><a href="#3-Quartz-Java编程" class="headerlink" title="3. Quartz Java编程"></a>3. <code>Quartz</code> Java编程</h2><p><a target="_blank" rel="noopener" href="http://www.quartz-scheduler.org/documentation/quartz-2.3.0/">http://www.quartz-scheduler.org/documentation/quartz-2.3.0/</a></p>
<p><a target="_blank" rel="noopener" href="http://www.quartz-scheduler.org/documentation/quartz-2.3.0/quick-start.html">http://www.quartz-scheduler.org/documentation/quartz-2.3.0/quick-start.html</a></p>
<h3 id="3-1-引入依赖"><a href="#3-1-引入依赖" class="headerlink" title="3.1 引入依赖"></a>3.1 引入依赖</h3><pre class=" language-xml"><code class="language-xml"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.quartz-scheduler<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>quartz<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.3.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<h3 id="3-2-默认的配置文件"><a href="#3-2-默认的配置文件" class="headerlink" title="3.2  默认的配置文件"></a>3.2  默认的配置文件</h3><p><code>org.quartz.core</code>包下, 有一个默认的配置文件, <code>quartz.properties</code>,当我们没有定义一个同名的配置文件的时候, 会使用默认配置文件的配置. </p>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># quartz 配置文件</span>
<span class="token attr-name">org.quartz.scheduler.instanceName</span><span class="token punctuation">:</span> <span class="token attr-value">DefaultQuartzScheduler</span>
<span class="token attr-name">org.quartz.scheduler.rmi.export</span><span class="token punctuation">:</span> <span class="token attr-value">false</span>
<span class="token attr-name">org.quartz.scheduler.rmi.proxy</span><span class="token punctuation">:</span> <span class="token attr-value">false</span>
<span class="token attr-name">org.quartz.scheduler.wrapJobExecutionInUserTransaction</span><span class="token punctuation">:</span> <span class="token attr-value">false</span>
<span class="token attr-name">org.quartz.threadPool.class</span><span class="token punctuation">:</span> <span class="token attr-value">org.quartz.simpl.SimpleThreadPool</span>
<span class="token attr-name">org.quartz.threadPool.threadCount</span><span class="token punctuation">:</span> <span class="token attr-value">10</span>
<span class="token attr-name">org.quartz.threadPool.threadPriority</span><span class="token punctuation">:</span> <span class="token attr-value">5</span>
<span class="token attr-name">org.quartz.threadPool.threadsInheritContextClassLoaderOfInitializingThread</span><span class="token punctuation">:</span> <span class="token attr-value">true</span>
<span class="token attr-name">org.quartz.jobStore.misfireThreshold</span><span class="token punctuation">:</span> <span class="token attr-value">60000</span>
<span class="token attr-name">org.quartz.jobStore.class</span><span class="token punctuation">:</span> <span class="token attr-value">org.quartz.simpl.RAMJobStore</span>
</code></pre>
<h3 id="3-3-创建Job"><a href="#3-3-创建Job" class="headerlink" title="3.3 创建Job"></a>3.3 创建Job</h3><p>实现唯一的方法<code>execute</code>,方法里的代码就是任务执行的内容,</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * @author luyanan
 * @since 2020/4/9
 * &lt;p>任务&lt;/p>
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyJob</span> <span class="token keyword">implements</span> <span class="token class-name">Job</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>JobExecutionContext jobExecutionContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> JobExecutionException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收破烂了。。。"</span> <span class="token operator">+</span> LocalDateTime<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>DateTimeFormatter<span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>然后需要将<code>Job</code>进一步的包装成<code>JobDetail</code>, 必须要指定<code>JobName</code>和<code>groupName</code>, 两个合起来是唯一标识. </p>
<p>可以携带KV 的数据(jobDataMap), 用于扩展属性,在运行的时候, 可以从<code>JobExecutionContext</code> 中获取到</p>
<pre class=" language-java"><code class="language-java">  JobDetail jobDetail <span class="token operator">=</span> JobBuilder<span class="token punctuation">.</span><span class="token function">newJob</span><span class="token punctuation">(</span>MyJob<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"job1"</span><span class="token punctuation">,</span> <span class="token string">"group1"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">usingJobData</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"张三"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="3-4-创建Trigger"><a href="#3-4-创建Trigger" class="headerlink" title="3.4 创建Trigger"></a>3.4 创建<code>Trigger</code></h3><p>基于<code>SimpleTrigger</code> 定义了一个每2秒钟运行一次, 不断重复的<code>Trigger</code></p>
<pre class=" language-java"><code class="language-java">Trigger trigger <span class="token operator">=</span> TriggerBuilder
                <span class="token punctuation">.</span><span class="token function">newTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"trigger1"</span><span class="token punctuation">,</span> <span class="token string">"group1"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withSchedule</span><span class="token punctuation">(</span>SimpleScheduleBuilder
                        <span class="token punctuation">.</span><span class="token function">simpleSchedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">withIntervalInSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">repeatForever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="3-5创建Scheduler"><a href="#3-5创建Scheduler" class="headerlink" title="3.5创建Scheduler"></a>3.5创建<code>Scheduler</code></h3><p>通过<code>Factory</code> 获取调度器的实例, 把<code>JobDetail</code> 和 <code>Trigger</code> 绑定, 注册到调度器中. </p>
<p>Scheduler 先启动还是后启动无所谓,只要有<code>Trigger</code>到达 触发条件, 就会执行任务.</p>
<pre class=" language-java"><code class="language-java">  SchedulerFactory factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StdSchedulerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Scheduler scheduler <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduler<span class="token punctuation">.</span><span class="token function">scheduleJob</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">,</span> trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduler<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="3-6-体系结构总结"><a href="#3-6-体系结构总结" class="headerlink" title="3.6 体系结构总结"></a>3.6 体系结构总结</h3><p><img src="http://files.luyanan.com//img/20200409100011.png" alt="image-20200409100008669"></p>
<h4 id="3-6-1-JobDetail"><a href="#3-6-1-JobDetail" class="headerlink" title="3.6.1 JobDetail"></a>3.6.1 <code>JobDetail</code></h4><p>我们创建一个实现<code>Job</code>接口的类, 使用<code>JobBuilder</code> 包装成<code>JobDetail</code>, 它可以携带KV的数据</p>
<h4 id="3-6-2-Trigger"><a href="#3-6-2-Trigger" class="headerlink" title="3.6.2 Trigger"></a>3.6.2 <code>Trigger</code></h4><p>定义任务触发的规律,<code>Trigger</code>,使用<code>TriggerBuilder</code> 来构建. </p>
<p><code>JobDetail</code> 跟 <code>Trigger</code> 是 1:N 的关系。</p>
<blockquote>
<p>思考： 为什么要解耦呢? </p>
</blockquote>
<p><code>Trigger</code> 接口在<code>Quartz</code> 有4个继承的子接口. </p>
<table>
<thead>
<tr>
<th>子接口</th>
<th>描述</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td><code>SimpleTrigger</code></td>
<td>简单触发器</td>
<td>固定时刻或者时间间隔, 毫秒</td>
</tr>
<tr>
<td><code>CalendarIntervalTrigger</code></td>
<td>基于日历的触发器</td>
<td>比简单触发器更多时间单位,支持非固定时间的触发,例如一年可能有365/366,一个月可能29/29/30/31</td>
</tr>
<tr>
<td><code>DailyTimeIntervalTrigger</code></td>
<td>基于日期的触发器</td>
<td>每天的某个时间段</td>
</tr>
<tr>
<td>CronTrigger</td>
<td>基于<code>corn</code> 表达式的触发器</td>
<td></td>
</tr>
</tbody></table>
<p><code>MutableTrigger</code> 和<code>CoreTrigger</code> 最终也是用到了四个类的实现类</p>
<p><img src="http://files.luyanan.com//img/20200409104529.png" alt="image-20200409104528041"></p>
<h5 id="SimpleTrigger"><a href="#SimpleTrigger" class="headerlink" title="SimpleTrigger"></a><code>SimpleTrigger</code></h5><p><code>SimpleTrigger</code> 可以定义固定时刻或者固定时间间隔的调度规则(精确到毫秒)</p>
<p>例如: 每天9点运行一次, 每隔30分钟运行一次. </p>
<h5 id="CalendarIntervalTrigger"><a href="#CalendarIntervalTrigger" class="headerlink" title="CalendarIntervalTrigger"></a><code>CalendarIntervalTrigger</code></h5><p><code>CalendarIntervalTrigger</code>  可以定义更多的时间单位的调度需求, 精确到秒</p>
<p>好处是不需要去计算时间间隔, 比如1个小时等于多少毫秒</p>
<p>例如: 每年、每月、每周、每天、每小时、每分钟、每秒</p>
<p>每年的月数和每个月的天数是不固定的, 这种情况也适用.</p>
<h5 id="DailyTimeIntervalTrigger"><a href="#DailyTimeIntervalTrigger" class="headerlink" title="DailyTimeIntervalTrigger"></a><code>DailyTimeIntervalTrigger</code></h5><p>每天的某个时间段内, 以一定的时间间隔执行任务 . </p>
<p>例如: 每天早上9点到晚上9点, 每隔半小时执行一次, 并且只在周一到周六执行. </p>
<h5 id="CronTrigger"><a href="#CronTrigger" class="headerlink" title="CronTrigger"></a>CronTrigger</h5><p><code>CronTrigger</code> 可以定义基于<code>Cron</code>表达式的调度规则, 是最常用的触发器类型. </p>
<p><code>Cron</code> 表达式</p>
<table>
<thead>
<tr>
<th>位置</th>
<th>时间域</th>
<th></th>
<th>特殊值</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>秒</td>
<td>0-59</td>
<td><code>, - * /</code></td>
</tr>
<tr>
<td>2</td>
<td>分钟</td>
<td>0-59</td>
<td><code>, - * /</code></td>
</tr>
<tr>
<td>3</td>
<td>小时</td>
<td>0-23</td>
<td><code>, - * /</code></td>
</tr>
<tr>
<td>4</td>
<td>日期</td>
<td>1-31</td>
<td><code>, - * ? / L W C</code></td>
</tr>
<tr>
<td>5</td>
<td>月份呢</td>
<td>1-12</td>
<td><code>, - * /</code></td>
</tr>
<tr>
<td>6</td>
<td>星期</td>
<td>1-7</td>
<td><code>, - * ? / L W C</code></td>
</tr>
<tr>
<td>7</td>
<td>年份(可选)</td>
<td>1-31</td>
<td><code>, - * /</code></td>
</tr>
</tbody></table>
<ul>
<li><p>星号(<code>*</code>): 可用在所有字段中,标识对应时间域的每一个时刻, 例如, 在分钟字段时, 表示每分钟</p>
</li>
<li><p>问号<code>?</code>: 该字符只在日期和星期字段中使用, 它通常指定为:<code>无意义的值</code>,相当于点位符</p>
</li>
<li><p>减号(<code>-</code>): 表达一个范围, 如在小时字段中使用<code>10-12</code>, 则表示从10点到12点, 即10、11、12</p>
</li>
<li><p>逗号(<code>,</code>): 表达一个列表, 如在星期字段中使用“MON,WED,FRI”,则表示星期一,星期三和星期五</p>
</li>
<li><p>斜杠(/)：x/y 表达一个等步长序列，x 为起始值，y 为增量步长值。如在分钟字段中使用 0/15，则表示为 0,15,30 和 45 秒，而 5/15 在分钟字段中表示 5,20,35,50，你也可以使用*/y，它等同于 0/y；</p>
</li>
<li><p>L：该字符只在日期和星期字段中使用，代表“Last”的意思，但它在两个字段中意思不同。L 在日期字段中，表示 这个月份的最后一天，如一月的 31 号，非闰年二月的 28 号；如果 L 用在星期中，则表示星期六，等同于 7。但是，如 果 L 出现在星期字段里，而且在前面有一个数值 X，则表示“这个月的最后 X 天”，例如，6L 表示该月的最后星期五； </p>
</li>
<li><p>W：该字符只能出现在日期字段里，是对前导日期的修饰，表示离该日期最近的工作日。例如 15W 表示离该月 15 号最近的工作日，如果该月 15 号是星期六，则匹配 14 号星期五；如果 15 日是星期日，则匹配 16 号星期一；如果 15 号是星期二，那结果就是 15 号星期二。但必须注意关联的匹配日期不能够跨月，如你指定 1W，如果 1 号是星期六， 结果匹配的是 3 号星期一，而非上个月最后的那天。W 字符串只能指定单一日期，而不能指定日期范围；</p>
</li>
<li><p> LW 组合：在日期字段可以组合使用 LW，它的意思是当月的最后一个工作日； 井号(#)：该字符只能在星期字段中使用，表示当月某个工作日。如 6#3 表示当月的第三个星期五(6 表示星期五， #3 表示当前的第三个)，而 4#5 表示当月的第五个星期三，假设当月没有第五个星期三，忽略不触发；</p>
</li>
<li><p> C：该字符只在日期和星期字段中使用，代表“Calendar”的意思。它的意思是计划所关联的日期，如果日期没有 被关联，则相当于日历中所有日期。例如 5C 在日期字段中就相当于日历 5 日以后的第一天。1C 在星期字段中相当于 星期日后的第一天。 </p>
</li>
</ul>
<p>  Cron 表达式对特殊字符的大小写不敏感，对代表星期的缩写英文大小写也不敏感。</p>
<p>上面定义的都是在什么时间执行, 但是我们有一些在什么时间不执行的需求. </p>
<p>比如: 理财周末和法定节假日购买不计息,证券公司周末和法定假日休市. </p>
<p>是不是要日期写在数据库, 然后读取基于当前时间进行判断呢? </p>
<h5 id="基于Calendar的排除规则"><a href="#基于Calendar的排除规则" class="headerlink" title="基于Calendar的排除规则"></a>基于<code>Calendar</code>的排除规则</h5><p>如果要在触发器的基础上, 排除一些时间区间不执行任务,就要用到<code>Quartz</code> 的<code>Calendar</code> 类(注意不是JDK的<code>Calendar</code>), 可以按照年、月、日、特定的日期、<code>Corn</code>表达式来排除. </p>
<p><img src="http://files.luyanan.com//img/20200409162147.png" alt="image-20200409162145377"></p>
<p>调用<code>Trigger</code>的<code>modifiedByCalendar()</code> 添加到触发器中, 并且调用调度器的<code>addCalendar()</code> 添加注册排除规则.</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        SchedulerFactory sf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StdSchedulerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Scheduler scheduler <span class="token operator">=</span> sf<span class="token punctuation">.</span><span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduler<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 定义日历</span>
        AnnualCalendar holidays <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnualCalendar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 排除咕泡日</span>
        Calendar gupaoDay <span class="token operator">=</span> <span class="token punctuation">(</span>Calendar<span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">GregorianCalendar</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        holidays<span class="token punctuation">.</span><span class="token function">setDayExcluded</span><span class="token punctuation">(</span>gupaoDay<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 排除中秋节</span>
        Calendar midAutumn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GregorianCalendar</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        holidays<span class="token punctuation">.</span><span class="token function">setDayExcluded</span><span class="token punctuation">(</span>midAutumn<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 排除圣诞节</span>
        Calendar christmas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GregorianCalendar</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        holidays<span class="token punctuation">.</span><span class="token function">setDayExcluded</span><span class="token punctuation">(</span>christmas<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 调度器添加日历</span>
        scheduler<span class="token punctuation">.</span><span class="token function">addCalendar</span><span class="token punctuation">(</span><span class="token string">"holidays"</span><span class="token punctuation">,</span> holidays<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        JobDetail jobDetail <span class="token operator">=</span> JobBuilder<span class="token punctuation">.</span><span class="token function">newJob</span><span class="token punctuation">(</span>MyJob<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"job1"</span><span class="token punctuation">,</span> <span class="token string">"group1"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Trigger trigger <span class="token operator">=</span> TriggerBuilder<span class="token punctuation">.</span><span class="token function">newTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"trigger1"</span><span class="token punctuation">,</span> <span class="token string">"group1"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">modifiedByCalendar</span><span class="token punctuation">(</span><span class="token string">"holidays"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withSchedule</span><span class="token punctuation">(</span>SimpleScheduleBuilder<span class="token punctuation">.</span><span class="token function">simpleSchedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">withIntervalInSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">repeatForever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Date firstRunTime <span class="token operator">=</span> scheduler<span class="token punctuation">.</span><span class="token function">scheduleJob</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">,</span> trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 第一次触发： "</span> <span class="token operator">+</span> firstRunTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<table>
<thead>
<tr>
<th><code>Calendar</code> 名称</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td><code>BaseCalendar</code></td>
<td>为高级的 <code>Calendar</code> 实现了基本的功能，实现了 <code>org.quartz.Calendar</code> 接口</td>
</tr>
<tr>
<td><code>AnnualCalendar</code></td>
<td>排除年中一天或多天</td>
</tr>
<tr>
<td><code>CronCalendar</code></td>
<td>日历的这种实现排除了由给定的 <code>CronExpression</code> 表达的时间集合。 例如， 您可以使用此日历使用表达式<code>* * 0-7,18-23？* *</code>每天排除所有营业时 间（上午 8 点至下午 5 点）。 如果 <code>CronTrigger</code> 具有给定的 <code>cron</code> 表达式并 且与具有相同表达式的 <code>CronCalendar</code> 相关联，则日历将排除触发器包含的 所有时间，并且它们将彼此抵消</td>
</tr>
<tr>
<td><code>DailyCalendar</code></td>
<td>您可以使用此日历来排除营业时间（上午 8 点 - 5 点）每天。 每个 <code>DailyCalendar</code> 仅允许指定单个时间范围，并且该时间范围可能不会跨越每 日边界（即，您不能指定从上午 8 点至凌晨 5 点的时间范围）。 如果属 性 <code>invertTimeRange</code> 为 <code>false</code>（默认），则时间范围定义触发器不允许触发 的时间范围。 如果 <code>invertTimeRange</code> 为 <code>true</code>，则时间范围被反转 - 也就是 排除在定义的时间范围之外的所有时间。</td>
</tr>
<tr>
<td><code>HolidayCalendar</code></td>
<td>特别的用于从 <code>Trigger</code> 中排除节假日</td>
</tr>
<tr>
<td><code>MonthlyCalendar</code></td>
<td>排除月份中的指定数天，例如，可用于排除每月的最后一天</td>
</tr>
<tr>
<td><code>WeeklyCalendar</code></td>
<td>排除星期中的任意周几，例如，可用于排除周末，默认周六和周日</td>
</tr>
</tbody></table>
<h4 id="3-6-3-Scheduler"><a href="#3-6-3-Scheduler" class="headerlink" title="3.6.3 Scheduler"></a>3.6.3 <code>Scheduler</code></h4><p>调度器是<code>Quartz</code>的指挥官,由<code>StdSchedulerFactory</code> 产生, 是单例的. </p>
<p>并且是<code>Quartz</code> 中最重要的API, 默认的实现类是<code>StdScheduler</code>, 里面包含了一个<code>QuartzScheduler</code>,<code>QuartzScheduler</code> 里面包含了一个<code>QuartzSchedulerThread</code>.</p>
<p><img src="http://files.luyanan.com//img/20200409163922.png" alt="image-20200409163920748"></p>
<p><code>Scheduler</code> 中的方法主要分为三大类：</p>
<ol>
<li>调度器本身,例如调度器的启动<code>start()</code>, 调度器的关闭<code>shutdown()</code></li>
<li>调用<code>Trigger</code>,例如<code>pauseTriggers()</code>、<code>resumeTrigger()</code>。</li>
<li>操纵<code>Job</code>, 例如<code>scheduleJob()</code>、<code>unscheduleJob()</code>、<code>rescheduleJob()</code></li>
</ol>
<p>这些方法非常重要,可以获取任务的动态调度. </p>
<h4 id="3-6-4-Listener"><a href="#3-6-4-Listener" class="headerlink" title="3.6.4 Listener"></a>3.6.4 <code>Listener</code></h4><p>我们有这么一种需求,再每个任务运行结束后发送通知给运维管理人员,那是不是要再每个任务的最后添加一行代码呢? 这种方式对原来的代码造成了入侵,不利于维护. 如果代码不是写在任务代码的最后一行, 怎么知道任务执行完了呢? 或者说, 怎么检测到任务的生命周期呢? </p>
<p>观察者模式:定义对象间一种一对多的依赖关系,使得每当一个对象改变状态, 则所有依赖它的对象都会得到通知并自动更新.</p>
<p><code>Quartz</code> 中提供了三种<code>Listener</code>,监听<code>Scheduler</code>的, 监听<code>Trigger</code>的, 监听<code>Job</code>的. </p>
<p>只需要创建类实现相应的接口, 并在<code>Scheduler</code> 上注册<code>Listener</code>,便可以实现对核心对象的监听. </p>
<h5 id="代码演示："><a href="#代码演示：" class="headerlink" title="代码演示："></a>代码演示：</h5><p>我们这里先准备一个<code>job</code></p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyJob</span> <span class="token keyword">implements</span> <span class="token class-name">Job</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>JobExecutionContext jobExecutionContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> JobExecutionException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收破烂了。。。"</span> <span class="token operator">+</span> LocalDateTime<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>DateTimeFormatter<span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h5 id="监听Job"><a href="#监听Job" class="headerlink" title="监听Job"></a>监听<code>Job</code></h5><pre class=" language-java"><code class="language-java">
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyJobListener</span> <span class="token keyword">implements</span> <span class="token class-name">JobListener</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        String name <span class="token operator">=</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> <span class="token string">"Method 111111 :"</span><span class="token operator">+</span> <span class="token string">"获取到监听器名称："</span><span class="token operator">+</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jobToBeExecuted</span><span class="token punctuation">(</span>JobExecutionContext context<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        String jobName <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getJobDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Method 222222 :"</span><span class="token operator">+</span> jobName <span class="token operator">+</span> <span class="token string">" ——任务即将执行 "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jobExecutionVetoed</span><span class="token punctuation">(</span>JobExecutionContext context<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        String jobName <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getJobDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Method 333333 :"</span><span class="token operator">+</span> jobName <span class="token operator">+</span> <span class="token string">" ——任务被否决 "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jobWasExecuted</span><span class="token punctuation">(</span>JobExecutionContext context<span class="token punctuation">,</span> JobExecutionException jobException<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        String jobName <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getJobDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Method 444444 :"</span><span class="token operator">+</span> jobName <span class="token operator">+</span> <span class="token string">" ——执行完毕 "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>测试类</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyJobListenerTest</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> SchedulerException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// JobDetail</span>
        JobDetail jobDetail <span class="token operator">=</span> JobBuilder<span class="token punctuation">.</span><span class="token function">newJob</span><span class="token punctuation">(</span>MyJob<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"job1"</span><span class="token punctuation">,</span> <span class="token string">"group1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Trigger</span>
        Trigger trigger <span class="token operator">=</span> TriggerBuilder<span class="token punctuation">.</span><span class="token function">newTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"trigger1"</span><span class="token punctuation">,</span> <span class="token string">"group1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withSchedule</span><span class="token punctuation">(</span>SimpleScheduleBuilder<span class="token punctuation">.</span><span class="token function">simpleSchedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withIntervalInSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">repeatForever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// SchedulerFactory</span>
        SchedulerFactory factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StdSchedulerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Scheduler</span>
        Scheduler scheduler <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        scheduler<span class="token punctuation">.</span><span class="token function">scheduleJob</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">,</span> trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 创建并注册一个全局的Job Listener</span>
        scheduler<span class="token punctuation">.</span><span class="token function">getListenerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addJobListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyJobListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> EverythingMatcher<span class="token punctuation">.</span><span class="token function">allJobs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        scheduler<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>四个方法: </p>
<table>
<thead>
<tr>
<th>方法</th>
<th>作用或者执行实际</th>
</tr>
</thead>
<tbody><tr>
<td><code>getName()</code></td>
<td>返回<code>JobListener</code>的名称</td>
</tr>
<tr>
<td><code>jobToBeExecuted()</code></td>
<td><code>Scheduler</code> 在 <code>JobDetail</code> 将要被执行时调用这个方法</td>
</tr>
<tr>
<td><code>jobExecutionVetoed()</code></td>
<td><code>Scheduler</code> 在 <code>JobDetail</code> 即将被执行，但又被 <code>TriggerListener</code> 否决了时调用这个 方法</td>
</tr>
<tr>
<td><code>jobWasExecuted()</code></td>
<td><code>Scheduler</code> 在 <code>JobDetail</code> 被执行之后调用这个方法</td>
</tr>
</tbody></table>
<p>工具类： <code>ListenerManager</code>, 用于添加、获取、移除监听器. </p>
<p>工具类： <code>Matcher</code>，主要是基于 <code>groupName</code> 和 <code>keyName</code> 进行匹配。</p>
<p><img src="http://files.luyanan.com//img/20200409172407.png" alt="image-20200409172405633"></p>
<h5 id="监听Trigger"><a href="#监听Trigger" class="headerlink" title="监听Trigger"></a>监听<code>Trigger</code></h5><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTriggerListener</span> <span class="token keyword">implements</span> <span class="token class-name">TriggerListener</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">MyTriggerListener</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Trigger 被触发，Job 上的 execute() 方法将要被执行时</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">triggerFired</span><span class="token punctuation">(</span>Trigger trigger<span class="token punctuation">,</span> JobExecutionContext context<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        String triggerName <span class="token operator">=</span> trigger<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Method 11111 "</span> <span class="token operator">+</span> triggerName <span class="token operator">+</span> <span class="token string">" was fired"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 在 Trigger 触发后，Job 将要被执行时由 Scheduler 调用这个方法</span>
    <span class="token comment" spellcheck="true">// 返回true时，这个任务不会被触发</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">vetoJobExecution</span><span class="token punctuation">(</span>Trigger trigger<span class="token punctuation">,</span> JobExecutionContext context<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        String triggerName <span class="token operator">=</span> trigger<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Method 222222 "</span> <span class="token operator">+</span> triggerName <span class="token operator">+</span> <span class="token string">" was not vetoed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">triggerMisfired</span><span class="token punctuation">(</span>Trigger trigger<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        String triggerName <span class="token operator">=</span> trigger<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Method 333333 "</span> <span class="token operator">+</span> triggerName <span class="token operator">+</span> <span class="token string">" misfired"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">triggerComplete</span><span class="token punctuation">(</span>Trigger trigger<span class="token punctuation">,</span> JobExecutionContext context<span class="token punctuation">,</span>
                                Trigger<span class="token punctuation">.</span>CompletedExecutionInstruction triggerInstructionCode<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        String triggerName <span class="token operator">=</span> trigger<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Method 444444 "</span> <span class="token operator">+</span> triggerName <span class="token operator">+</span> <span class="token string">" is complete"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>测试</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTriggerListenerTest</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> SchedulerException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// JobDetail</span>
        JobDetail jobDetail <span class="token operator">=</span> JobBuilder<span class="token punctuation">.</span><span class="token function">newJob</span><span class="token punctuation">(</span>MyJob<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"job1"</span><span class="token punctuation">,</span> <span class="token string">"group1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Trigger</span>
        Trigger trigger <span class="token operator">=</span> TriggerBuilder<span class="token punctuation">.</span><span class="token function">newTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"trigger1"</span><span class="token punctuation">,</span> <span class="token string">"group1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withSchedule</span><span class="token punctuation">(</span>SimpleScheduleBuilder<span class="token punctuation">.</span><span class="token function">simpleSchedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withIntervalInSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">repeatForever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// SchedulerFactory</span>
        SchedulerFactory  factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StdSchedulerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Scheduler</span>
        Scheduler scheduler <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        scheduler<span class="token punctuation">.</span><span class="token function">scheduleJob</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">,</span> trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment" spellcheck="true">// 创建并注册一个全局的Trigger Listener</span>
        scheduler<span class="token punctuation">.</span><span class="token function">getListenerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTriggerListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyTriggerListener</span><span class="token punctuation">(</span><span class="token string">"myListener1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> EverythingMatcher<span class="token punctuation">.</span><span class="token function">allTriggers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 创建并注册一个局部的Trigger Listener</span>
        scheduler<span class="token punctuation">.</span><span class="token function">getListenerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTriggerListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyTriggerListener</span><span class="token punctuation">(</span><span class="token string">"myListener2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> KeyMatcher<span class="token punctuation">.</span><span class="token function">keyEquals</span><span class="token punctuation">(</span>TriggerKey<span class="token punctuation">.</span><span class="token function">triggerKey</span><span class="token punctuation">(</span><span class="token string">"trigger1"</span><span class="token punctuation">,</span> <span class="token string">"gourp1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 创建并注册一个特定组的Trigger Listener</span>
        GroupMatcher<span class="token operator">&lt;</span>TriggerKey<span class="token operator">></span> matcher <span class="token operator">=</span> GroupMatcher<span class="token punctuation">.</span><span class="token function">triggerGroupEquals</span><span class="token punctuation">(</span><span class="token string">"gourp1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduler<span class="token punctuation">.</span><span class="token function">getListenerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTriggerListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyTriggerListener</span><span class="token punctuation">(</span><span class="token string">"myListener3"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> matcher<span class="token punctuation">)</span><span class="token punctuation">;</span>

        scheduler<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<table>
<thead>
<tr>
<th>方法</th>
<th>作用或者执行实际</th>
</tr>
</thead>
<tbody><tr>
<td><code>getName()</code></td>
<td>返回监听器的名称</td>
</tr>
<tr>
<td><code>triggerFired()</code></td>
<td><code>Trigger</code> 被触发，<code>Job</code> 上的 <code>execute()</code> 方法将要被执行时，<code>Scheduler</code> 就调用这个 方法</td>
</tr>
<tr>
<td><code>vetoJobExecution()</code></td>
<td>在 <code>Trigger</code> 触 发 后 ， <code>Job</code> 将 要 被 执 行 时 由 <code>Scheduler</code> 调 用 这 个 方 法 。 <code>TriggerListener</code> 给了一个选择去否决 <code>Job</code> 的执行。假如这个方法返回 <code>true</code>，这 个 <code>Job</code> 将不会为此次 <code>Trigger</code> 触发而得到执行</td>
</tr>
<tr>
<td><code>triggerMisfired()</code></td>
<td><code>Trigger</code> 错过触发时调用</td>
</tr>
<tr>
<td><code>triggerComplete()</code></td>
<td><code>Trigger</code> 被触发并且完成了 <code>Job</code> 的执行时，<code>Scheduler</code> 调用这个方法</td>
</tr>
</tbody></table>
<h5 id="监听Scheduler"><a href="#监听Scheduler" class="headerlink" title="监听Scheduler"></a>监听<code>Scheduler</code></h5><pre class=" language-java"><code class="language-java">
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySchedulerListener</span> <span class="token keyword">implements</span> <span class="token class-name">SchedulerListener</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jobScheduled</span><span class="token punctuation">(</span>Trigger trigger<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        String jobName <span class="token operator">=</span> trigger<span class="token punctuation">.</span><span class="token function">getJobKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> jobName <span class="token operator">+</span> <span class="token string">" has been scheduled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jobUnscheduled</span><span class="token punctuation">(</span>TriggerKey triggerKey<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>triggerKey <span class="token operator">+</span> <span class="token string">" is being unscheduled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">triggerFinalized</span><span class="token punctuation">(</span>Trigger trigger<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Trigger is finished for "</span> <span class="token operator">+</span> trigger<span class="token punctuation">.</span><span class="token function">getJobKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">triggerPaused</span><span class="token punctuation">(</span>TriggerKey triggerKey<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>triggerKey <span class="token operator">+</span> <span class="token string">" is being paused"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">triggersPaused</span><span class="token punctuation">(</span>String triggerGroup<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"trigger group "</span><span class="token operator">+</span>triggerGroup <span class="token operator">+</span> <span class="token string">" is being paused"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">triggerResumed</span><span class="token punctuation">(</span>TriggerKey triggerKey<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>triggerKey <span class="token operator">+</span> <span class="token string">" is being resumed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">triggersResumed</span><span class="token punctuation">(</span>String triggerGroup<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"trigger group "</span><span class="token operator">+</span>triggerGroup <span class="token operator">+</span> <span class="token string">" is being resumed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jobAdded</span><span class="token punctuation">(</span>JobDetail jobDetail<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" is added"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jobDeleted</span><span class="token punctuation">(</span>JobKey jobKey<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jobKey<span class="token operator">+</span><span class="token string">" is deleted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jobPaused</span><span class="token punctuation">(</span>JobKey jobKey<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jobKey<span class="token operator">+</span><span class="token string">" is paused"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jobsPaused</span><span class="token punctuation">(</span>String jobGroup<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"job group "</span><span class="token operator">+</span>jobGroup<span class="token operator">+</span><span class="token string">" is paused"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jobResumed</span><span class="token punctuation">(</span>JobKey jobKey<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jobKey<span class="token operator">+</span><span class="token string">" is resumed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jobsResumed</span><span class="token punctuation">(</span>String jobGroup<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"job group "</span><span class="token operator">+</span>jobGroup<span class="token operator">+</span><span class="token string">" is resumed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">schedulerError</span><span class="token punctuation">(</span>String msg<span class="token punctuation">,</span> SchedulerException cause<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg <span class="token operator">+</span> cause<span class="token punctuation">.</span><span class="token function">getUnderlyingException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">schedulerInStandbyMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"scheduler is in standby mode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">schedulerStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"scheduler has been started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">schedulerStarting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"scheduler is being started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">schedulerShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"scheduler has been shutdown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">schedulerShuttingdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"scheduler is being shutdown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">schedulingDataCleared</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"scheduler has cleared all data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>测试</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySchedulerListenerTest</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> SchedulerException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// JobDetail</span>
        JobDetail jobDetail <span class="token operator">=</span> JobBuilder<span class="token punctuation">.</span><span class="token function">newJob</span><span class="token punctuation">(</span>MyJob<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"job1"</span><span class="token punctuation">,</span> <span class="token string">"group1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Trigger</span>
        Trigger trigger <span class="token operator">=</span> TriggerBuilder<span class="token punctuation">.</span><span class="token function">newTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"trigger1"</span><span class="token punctuation">,</span> <span class="token string">"group1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withSchedule</span><span class="token punctuation">(</span>SimpleScheduleBuilder<span class="token punctuation">.</span><span class="token function">simpleSchedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withIntervalInSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">repeatForever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// SchedulerFactory</span>
        SchedulerFactory  factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StdSchedulerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Scheduler</span>
        Scheduler scheduler <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        scheduler<span class="token punctuation">.</span><span class="token function">scheduleJob</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">,</span> trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 创建Scheduler Listener</span>
        scheduler<span class="token punctuation">.</span><span class="token function">getListenerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addSchedulerListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MySchedulerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        scheduler<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="3-6-5-jobStore"><a href="#3-6-5-jobStore" class="headerlink" title="3.6.5 jobStore"></a>3.6.5 <code>jobStore</code></h4><p><code>JobStore</code> 用来存储任务和触发器的相关的信息. 例如所有任务的名称、数量、状态等等. <code>Quartz</code> 中有两种存储任务的方式, 一种是在内存中, 一种是在数据库. </p>
<h5 id="RAMJobStore"><a href="#RAMJobStore" class="headerlink" title="RAMJobStore"></a><code>RAMJobStore</code></h5><p><code>Quartz</code> 默认的<code>JobStore</code> 是<code>RAMJobStore</code>,也就是把任务和触发器信息运行的信息存储到内存中, 用到了<code>HashMap</code>、<code>TreeSet</code>、<code>HashSet</code>. </p>
<p>如果程序崩溃或者重启, 所有存储在内存中的数据都会丢失, 所以我们需要把这些数据持久化到磁盘. </p>
<h5 id="JDBCJobStore"><a href="#JDBCJobStore" class="headerlink" title="JDBCJobStore"></a><code>JDBCJobStore</code></h5><p><code>JDBCJobStore</code> 可以通过JDBC 接口,将任务运行数据保存到数据库. </p>
<p><img src="http://files.luyanan.com//img/20200409174304.png" alt="image-20200409174303231"></p>
<p><code>JDBC</code>的实现方式有两种: <code>JobStoreSupport</code> 类的两个子类: </p>
<p><code>JobStoreTX</code>: 在独立的程序中使用, 自己管理事务, 不参与外部事务. </p>
<p><code>JobStoreCMT</code>：<code>(Container Managed Transactions (CMT)</code>,如果需要容器管理事务时, 使用它. </p>
<p>使用<code>JDBCJobSotre</code>时, 需要配置数据库信息。 </p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">org.quartz.jobStore.class</span><span class="token punctuation">:</span><span class="token attr-value">org.quartz.impl.jdbcjobstore.JobStoreTX</span>
<span class="token attr-name">org.quartz.jobStore.driverDelegateClass</span><span class="token punctuation">:</span><span class="token attr-value">org.quartz.impl.jdbcjobstore.StdJDBCDelegate</span>
<span class="token comment" spellcheck="true"># 使用 quartz.properties，不使用默认配置</span>
<span class="token attr-name">org.quartz.jobStore.useProperties</span><span class="token punctuation">:</span><span class="token attr-value">true</span>
<span class="token comment" spellcheck="true">#数据库中 quartz 表的表名前缀</span>
<span class="token attr-name">org.quartz.jobStore.tablePrefix</span><span class="token punctuation">:</span><span class="token attr-value">QRTZ_</span>
<span class="token attr-name">org.quartz.jobStore.dataSource</span><span class="token punctuation">:</span><span class="token attr-value">myDS</span>
<span class="token comment" spellcheck="true">#配置数据源</span>
<span class="token attr-name">org.quartz.dataSource.myDS.driver</span><span class="token punctuation">:</span><span class="token attr-value">com.mysql.jdbc.Driver</span>
<span class="token attr-name">org.quartz.dataSource.myDS.URL</span><span class="token punctuation">:</span><span class="token attr-value">jdbc:mysql://localhost:3306/quartz?useUnicode=true&amp;characterEncoding=utf8</span>
<span class="token attr-name">org.quartz.dataSource.myDS.user</span><span class="token punctuation">:</span><span class="token attr-value">root</span>
<span class="token attr-name">org.quartz.dataSource.myDS.password</span><span class="token punctuation">:</span><span class="token attr-value">rootroot</span>
<span class="token attr-name">org.quartz.dataSource.myDS.validationQuery</span><span class="token punctuation">=</span><span class="token attr-value">select 0 from dual</span>
</code></pre>
<p>问题来了? 需要建什么表? 表里面有什么字段? 字段类型和长度是什么? </p>
<p>在官网的<code>Downloads</code>  链接中, 提供了11张表的建表语句 </p>
<p><code>quartz-2.2.3-distribution\quartz-2.2.3\docs\dbTables</code></p>
<p>2.3 的版本在这个路径下：<code>src\org\quartz\impl\jdbcjobstore</code></p>
<p>表名和作用</p>
<table>
<thead>
<tr>
<th>表名</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>QRTZ_BLOB_TRIGGERS</code></td>
<td><code>Trigger</code> 作为 <code>Blob</code> 类型存储</td>
</tr>
<tr>
<td><code>QRTZ_CALENDARS</code></td>
<td>存储 <code>Quartz</code> 的 <code>Calendar</code> 信息</td>
</tr>
<tr>
<td><code>QRTZ_CRON_TRIGGERS</code></td>
<td>存储 <code>CronTrigger</code>，包括<code>Cron</code> 表达式和时区信息</td>
</tr>
<tr>
<td><code>QRTZ_FIRED_TRIGGERS</code></td>
<td>存储与已触发的 <code>Trigger</code> 相关的状态信息，以及相关 Job 的执行信息</td>
</tr>
<tr>
<td><code>QRTZ_JOB_DETAILS</code></td>
<td>存储每一个已配置的 <code>Job</code>的详细信息</td>
</tr>
<tr>
<td><code>QRTZ_LOCKS</code></td>
<td>存储程序的悲观锁的信息</td>
</tr>
<tr>
<td><code>QRTZ_PAUSED_TRIGGER_GRPS</code></td>
<td>存储已暂停的 <code>Trigger</code> 组的信息</td>
</tr>
<tr>
<td><code>QRTZ_SCHEDULER_STATE</code></td>
<td>存储少量的有关 <code>Scheduler</code> 的状态信息，和别的 <code>Scheduler</code> 实例</td>
</tr>
<tr>
<td><code>QRTZ_SIMPLE_TRIGGERS</code></td>
<td>存储 <code>SimpleTrigger</code> 的信息，包括重复次数、间隔、以及已触的次数</td>
</tr>
<tr>
<td><code>QRTZ_SIMPROP_TRIGGERS</code></td>
<td>存储 <code>CalendarIntervalTrigger</code> 和 <code>DailyTimeIntervalTrigger</code> 两种类型的触发器</td>
</tr>
<tr>
<td><code>QRTZ_TRIGGERS</code></td>
<td>存储已配置的 <code>Trigger</code> 的信息</td>
</tr>
</tbody></table>
<h2 id="4-Quartz-继承到Spring中"><a href="#4-Quartz-继承到Spring中" class="headerlink" title="4.Quartz 继承到Spring中"></a>4.<code>Quartz</code> 继承到Spring中</h2><p><code>Spring</code> 在 <code>spring-context-support.jar</code> 中直接提供了对 <code>Quartz</code> 的支持。</p>
<p><img src="http://files.luyanan.com//img/20200410140146.png" alt="image-20200410140143689"></p>
<p>可以在配置文件中把<code>JobDetail</code>、<code>Trigger</code>、<code>Scheduler</code> 定义成 <code>Bean</code>。</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QuartzConfig</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> JobDetail <span class="token function">myJobJobDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> JobBuilder<span class="token punctuation">.</span><span class="token function">newJob</span><span class="token punctuation">(</span>MyJob<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"myjob"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">usingJobData</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"张三"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">storeDurably</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> Trigger <span class="token function">myJobTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        CronScheduleBuilder cronScheduleBuilder <span class="token operator">=</span> CronScheduleBuilder<span class="token punctuation">.</span><span class="token function">cronSchedule</span><span class="token punctuation">(</span><span class="token string">"0/5 * * * * ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> TriggerBuilder
                <span class="token punctuation">.</span><span class="token function">newTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token punctuation">.</span><span class="token function">forJob</span><span class="token punctuation">(</span><span class="token function">myJobJobDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"quartzTaskService"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withSchedule</span><span class="token punctuation">(</span>cronScheduleBuilder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="5-动态调度的实现"><a href="#5-动态调度的实现" class="headerlink" title="5. 动态调度的实现"></a>5. 动态调度的实现</h2><p>传统的Spring 方式集成, 由于任务信息全部配置在<code>xml</code> 文件中, 如果需要操作任务或者修改任务运行频率, 只能重新编译、打包、部署、重启,如果有紧急问题需要处理, 会浪费很多时间. </p>
<p>有没有可以动态调度任务的方法? 比如停止一个<code>Job</code>?启动一个<code>Job</code>? 修改<code>Job</code>的触发频率. </p>
<p>读取配置文件、写入配置文件、重启<code>Scheduler</code> 或者重启应用明显不可取的. </p>
<p>对于这种频繁变更并且需要实时生效的配置信息, 我们放到哪里呢? </p>
<p><code>ZK</code>、<code>Redis</code>、<code>DB</code></p>
<p>并且我们可以提供一个页面, 实现对数据表的轻松操作. </p>
<h3 id="5-1-配置管理"><a href="#5-1-配置管理" class="headerlink" title="5.1 配置管理"></a>5.1 配置管理</h3><p>这里我们用最简单的数据库实现. </p>
<p>问题 1：建一张什么样的表？参考 JobDetail 的属性。</p>
<pre class=" language-mysql"><code class="language-mysql">CREATE TABLE `sys_job` (
 `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ID',
 `job_name` varchar(512) NOT NULL COMMENT '任务名称',
 `job_group` varchar(512) NOT NULL COMMENT '任务组名',
 `job_cron` varchar(512) NOT NULL COMMENT '时间表达式',
 `job_class_path` varchar(1024) NOT NULL COMMENT '类路径,全类型',
 `job_data_map` varchar(1024) DEFAULT NULL COMMENT '传递 map 参数',
 `job_status` int(2) NOT NULL COMMENT '状态:1 启用 0 停用',
 `job_describe` varchar(1024) DEFAULT NULL COMMENT '任务功能描述',
 PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=0 DEFAULT CHARSET=utf8;
</code></pre>
<h3 id="5-2-数据操作和任务调度"><a href="#5-2-数据操作和任务调度" class="headerlink" title="5.2 数据操作和任务调度"></a>5.2 数据操作和任务调度</h3><p>操作数据表非常简单， SSM 增删改查</p>
<p>但是在修改了表的数据之后, 怎么让调度器知道呢? </p>
<p>调度器的接口: <code>：Scheduler</code></p>
<p>在我们的需求中,我们需要做的事情: </p>
<ol>
<li>新增一个任务</li>
<li>删除一个任务</li>
<li>启动、停止一个任务</li>
<li>修改任务的信息(包括调度规则)</li>
</ol>
<p>因此我们可以将相关的操作封装到一个工具类里</p>
<h3 id="5-3-前端页面"><a href="#5-3-前端页面" class="headerlink" title="5.3 前端页面"></a>5.3 前端页面</h3><p><img src="http://files.luyanan.com//img/20200410164504.png" alt="image-20200410164500687"></p>
<p>接下来我们有两个问题 需要解决. </p>
<h3 id="5-4-容器启动和Service注入"><a href="#5-4-容器启动和Service注入" class="headerlink" title="5.4 容器启动和Service注入"></a>5.4 容器启动和<code>Service</code>注入</h3><h4 id="5-4-1-容器启动"><a href="#5-4-1-容器启动" class="headerlink" title="5.4.1  容器启动"></a>5.4.1  容器启动</h4><p>因为任务没有定义在<code>ApplicationContext.xm</code>中,而是放到了数据库中, <code>Spring Boot</code> 启动时, 怎么读取任务信息? </p>
<p>或者说, 怎么在Spring 启动完成的时候做一些事情呢? </p>
<p>创建一些类,实现<code>CommandLineRunner</code> 接口, 实现<code>run</code>方法. </p>
<p>从表中查出来的是1的任务, 然后构建. </p>
<h4 id="5-4-2-Service-类注入到job-中"><a href="#5-4-2-Service-类注入到job-中" class="headerlink" title="5.4.2  Service 类注入到job 中"></a>5.4.2  <code>Service</code> 类注入到<code>job</code> 中</h4><p><code>Spring Bean</code> 如何注入到实现了<code>Job</code> 接口的类中. </p>
<p>例如在<code>Task</code> 类中, 需要注入<code>Service</code> 查询数据库执行一些操作。 </p>
<p>如果没有任务配置, 注入就会报空指针. </p>
<p>原因: </p>
<p>因为定时任务<code>Job</code> 对象的实例化过程是在<code>Quartz</code> 中进行的,  而<code>Service Bean</code> 是由Spring 容器管理的，<code>Quartz</code> 察觉不到<code>Service Bean</code>的存在,所以无法将<code>Service Bean</code> 装配到<code>Job</code> 对象中. </p>
<p>分析:</p>
<p><code>Quartz</code> 集成到<code>Spring</code>中, 用到了<code>SchedulerFactoryBean</code>,其内实现了<code>InitializingBean</code> 方法, 在唯一的方法<code>afterPropertiesSet()</code> 在<code>Bean</code> 的属性初始化后调用. </p>
<p>调度器用<code>AdaptableJobFactory</code> 对<code>Job</code> 对象进行实例化. 所以我们可以把这个<code>JobFactory</code> 指定为我们自定义的工厂的话, 就可以在<code>Job</code> 实例化之后, 把<code>Job</code>纳入到<code>Spring</code>容器中管理. </p>
<p><strong>解决这个问题的步骤</strong>:</p>
<ol>
<li><p>定义一个<code>AdaptableJobFactory</code> ,实现<code>JobFactory</code> 接口,实现接口定义的<code>newJob</code> 方法, 在这里返回<code>Job</code>实例.</p>
<pre class=" language-java"><code class="language-java">  
<span class="token comment" spellcheck="true">/**
*
* 将Spring的对象注入到Quartz Job 1
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdaptableJobFactory</span> <span class="token keyword">implements</span> <span class="token class-name">JobFactory</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> Job <span class="token function">newJob</span><span class="token punctuation">(</span>TriggerFiredBundle bundle<span class="token punctuation">,</span> Scheduler arg1<span class="token punctuation">)</span> <span class="token keyword">throws</span> SchedulerException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">newJob</span><span class="token punctuation">(</span>bundle<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> Job <span class="token function">newJob</span><span class="token punctuation">(</span>TriggerFiredBundle bundle<span class="token punctuation">)</span> <span class="token keyword">throws</span> SchedulerException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
           <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
               <span class="token comment" spellcheck="true">// 返回Job实例</span>
               Object jobObject <span class="token operator">=</span> <span class="token function">createJobInstance</span><span class="token punctuation">(</span>bundle<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">return</span> <span class="token function">adaptJob</span><span class="token punctuation">(</span>jobObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
           <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SchedulerException</span><span class="token punctuation">(</span><span class="token string">"Job instantiation failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

       <span class="token comment" spellcheck="true">// 通过反射的方式创建实例</span>
       <span class="token keyword">protected</span> Object <span class="token function">createJobInstance</span><span class="token punctuation">(</span>TriggerFiredBundle bundle<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
           Method getJobDetail <span class="token operator">=</span> bundle<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getJobDetail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           Object jobDetail <span class="token operator">=</span> ReflectionUtils<span class="token punctuation">.</span><span class="token function">invokeMethod</span><span class="token punctuation">(</span>getJobDetail<span class="token punctuation">,</span> bundle<span class="token punctuation">)</span><span class="token punctuation">;</span>
           Method getJobClass <span class="token operator">=</span> jobDetail<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getJobClass"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           Class <span class="token class-name">jobClass</span> <span class="token operator">=</span> <span class="token punctuation">(</span>Class<span class="token punctuation">)</span> ReflectionUtils<span class="token punctuation">.</span><span class="token function">invokeMethod</span><span class="token punctuation">(</span>getJobClass<span class="token punctuation">,</span> jobDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> jobClass<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

       <span class="token keyword">protected</span> Job <span class="token function">adaptJob</span><span class="token punctuation">(</span>Object jobObject<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>jobObject <span class="token keyword">instanceof</span> <span class="token class-name">Job</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
               <span class="token keyword">return</span> <span class="token punctuation">(</span>Job<span class="token punctuation">)</span> jobObject<span class="token punctuation">;</span>
           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
           <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>jobObject <span class="token keyword">instanceof</span> <span class="token class-name">Runnable</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
               <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DelegatingJob</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Runnable<span class="token punctuation">)</span> jobObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
           <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unable to execute job class ["</span> <span class="token operator">+</span> jobObject<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                       <span class="token string">"]: only [org.quartz.Job] and [java.lang.Runnable] supported."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p> <img src="http://files.luyanan.com//img/20200410194728.png" alt="image-20200410194700787"></p>
</li>
<li><p>定义一个<code>MyJobFactory</code>,继承<code>AdaptableJobFactory</code>. </p>
<p> 使用<code>Spring</code>的<code>AutowireCapableBeanFactory</code>,把<code>Job</code> 实例注入到容器中. </p>
</li>
</ol>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyJobFactory</span> <span class="token keyword">extends</span> <span class="token class-name">AdaptableJobFactory</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> AutowireCapableBeanFactory capableBeanFactory<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> Object <span class="token function">createJobInstance</span><span class="token punctuation">(</span>TriggerFiredBundle bundle<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//调用父类的方法</span>
        Object jobInstance <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">createJobInstance</span><span class="token punctuation">(</span>bundle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        capableBeanFactory<span class="token punctuation">.</span><span class="token function">autowireBean</span><span class="token punctuation">(</span>jobInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> jobInstance<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<ol start="3">
<li><p>指定<code>Scheduler</code>的<code>JobFactory</code>为自定义的<code>JobFactory</code>. </p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 通过SchedulerFactory获取一个调度器实例</span>
       SchedulerFactory sf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StdSchedulerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       Scheduler scheduler <span class="token operator">=</span> sf<span class="token punctuation">.</span><span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">// 如果不设置JobFactory，Service注入到Job会报空指针</span>
       scheduler<span class="token punctuation">.</span><span class="token function">setJobFactory</span><span class="token punctuation">(</span>myJobFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">// 启动调度器</span>
       scheduler<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</li>
</ol>
<p>  考虑这么一种情况:</p>
<p>正在运行的<code>Quzrtz</code>节点挂了, 而所有人完全不知情. </p>
<h2 id="6-Quartz集群部署"><a href="#6-Quartz集群部署" class="headerlink" title="6. Quartz集群部署"></a>6. <code>Quartz</code>集群部署</h2><h3 id="6-1-为什么需要集群呢"><a href="#6-1-为什么需要集群呢" class="headerlink" title="6.1 为什么需要集群呢?"></a>6.1 为什么需要集群呢?</h3><ol>
<li>防止单点故障, 减少对业务的影响. </li>
<li>减少节点的压力, 例如在10点要触发1000个任务, 如果由10个节点, 则每个节点只需要执行100个任务. </li>
</ol>
<h3 id="6-2-集群需要解决的问题"><a href="#6-2-集群需要解决的问题" class="headerlink" title="6.2 集群需要解决的问题?"></a>6.2 集群需要解决的问题?</h3><ol>
<li>任务重跑,因为节点部署的内容是一样的,到10点的时候,每个节点都会执行相同的操作,引入数据混乱.比如跑批, 绝对不能执行多次. </li>
<li>任务漏跑,假如任务是平均分配的，本来应该是在某个节点上执行的任务, 因为节点故障,一直没有得到执行. </li>
<li>水平集群需要注意的是时间同步 问题. </li>
<li><code>Quartz</code>  使用的是随机的负载均衡算法,不能指定节点执行. </li>
</ol>
<p>所以必须由一种共享数据或者通信的机制, 在分布式系统的不同节点, 我们可以采用什么样的方式, 实现数据共享. </p>
<p>两两通信, 或者基于分布式服务, 实现数据共享. </p>
<p>例如<code>ZK</code>、<code>Redis</code>、<code>DB</code></p>
<p>在<code>Quartz</code> 中, 提供了一种简单的方式,基于数据库共享任务执行信息,也就是i说, 一个节点执行任务的时候, 会操作数据库,其他的节点查询数据库,便可以感知到了. </p>
<p>同样的问题,建什么表? 哪些字段? 依旧使用系统自带的11张表. </p>
<h3 id="6-3-集群配置与验证"><a href="#6-3-集群配置与验证" class="headerlink" title="6.3 集群配置与验证"></a>6.3 集群配置与验证</h3><p><code>quertz.properties</code>配置</p>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">#调度器名称</span>
<span class="token attr-name">org.quartz.scheduler.instanceName</span><span class="token punctuation">:</span> <span class="token attr-value">MyScheduler</span>

<span class="token comment" spellcheck="true">#如果使用集群，instanceId必须唯一，设置成AUTO</span>
<span class="token attr-name">org.quartz.scheduler.instanceId</span> <span class="token punctuation">=</span> <span class="token attr-value">AUTO</span>

<span class="token attr-name">org.quartz.threadPool.class</span><span class="token punctuation">:</span> <span class="token attr-value">org.quartz.simpl.SimpleThreadPool</span>
<span class="token attr-name">org.quartz.threadPool.threadCount</span><span class="token punctuation">:</span> <span class="token attr-value">10</span>
<span class="token attr-name">org.quartz.threadPool.threadPriority</span><span class="token punctuation">:</span> <span class="token attr-value">5</span>
<span class="token attr-name">org.quartz.threadPool.threadsInheritContextClassLoaderOfInitializingThread</span><span class="token punctuation">:</span> <span class="token attr-value">true</span>
<span class="token attr-name">org.quartz.jobStore.misfireThreshold</span><span class="token punctuation">:</span> <span class="token attr-value">60000</span>

<span class="token comment" spellcheck="true">#是否使用集群</span>
<span class="token attr-name">org.quartz.jobStore.isClustered</span> <span class="token punctuation">=</span> <span class="token attr-value">true</span>

<span class="token comment" spellcheck="true"># jobStore 持久化配置</span>
<span class="token comment" spellcheck="true">#存储方式使用JobStoreTX，也就是数据库</span>
<span class="token attr-name">org.quartz.jobStore.class</span><span class="token punctuation">:</span><span class="token attr-value">org.quartz.impl.jdbcjobstore.JobStoreTX</span>
<span class="token attr-name">org.quartz.jobStore.driverDelegateClass</span><span class="token punctuation">:</span><span class="token attr-value">org.quartz.impl.jdbcjobstore.StdJDBCDelegate</span>
<span class="token comment" spellcheck="true"># 使用quartz.properties，不使用默认配置</span>
<span class="token attr-name">org.quartz.jobStore.useProperties</span><span class="token punctuation">:</span><span class="token attr-value">true</span>
<span class="token comment" spellcheck="true">#数据库中quartz表的表名前缀</span>
<span class="token attr-name">org.quartz.jobStore.tablePrefix</span><span class="token punctuation">:</span><span class="token attr-value">QRTZ_</span>
<span class="token attr-name">org.quartz.jobStore.dataSource</span><span class="token punctuation">:</span><span class="token attr-value">myDS</span>

<span class="token comment" spellcheck="true">#配置数据源</span>
<span class="token attr-name">org.quartz.dataSource.myDS.driver</span><span class="token punctuation">:</span><span class="token attr-value">com.mysql.jdbc.Driver</span>
<span class="token attr-name">org.quartz.dataSource.myDS.URL</span><span class="token punctuation">:</span><span class="token attr-value">jdbc:mysql://localhost:3306/quartz?useUnicode=true&amp;characterEncoding=utf8</span>
<span class="token attr-name">org.quartz.dataSource.myDS.user</span><span class="token punctuation">:</span><span class="token attr-value">root</span>
<span class="token attr-name">org.quartz.dataSource.myDS.password</span><span class="token punctuation">:</span><span class="token attr-value">luyanan</span>
<span class="token attr-name">org.quartz.dataSource.myDS.validationQuery</span><span class="token punctuation">=</span><span class="token attr-value">select 0 from dual</span>
</code></pre>
<p>四个配置: 集群实例ID、集群开关、数据持久化、数据源信息.</p>
<h2 id="7-Quartz-调度原理"><a href="#7-Quartz-调度原理" class="headerlink" title="7. Quartz 调度原理"></a>7. <code>Quartz</code> 调度原理</h2><p>问题:</p>
<ol>
<li><code>Job</code> 没有继承<code>Thread</code> 和实现<code>Runnable</code>,是怎么被调用的呢? 通过反射还是什么? </li>
<li>任务是什么时候被调度的? 是谁在监视任务还是监视<code>Trigger</code></li>
<li>任务是怎么被调用的? 谁执行了任务?</li>
<li>任务本身有状态吗? 还是触发器有状态? </li>
</ol>
<p>看源码的入口</p>
<pre class=" language-java"><code class="language-java">        SchedulerFactory factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StdSchedulerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Scheduler scheduler <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduler<span class="token punctuation">.</span><span class="token function">scheduleJob</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">,</span> trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduler<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="7-1-获取调度器实例"><a href="#7-1-获取调度器实例" class="headerlink" title="7.1 获取调度器实例"></a>7.1 获取调度器实例</h3><h4 id="7-1-1-读取配置文件"><a href="#7-1-1-读取配置文件" class="headerlink" title="7.1.1 读取配置文件"></a>7.1.1 读取配置文件</h4><pre class=" language-java"><code class="language-java">  <span class="token keyword">public</span> Scheduler <span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> SchedulerException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cfg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 读取quartz.properties 配置文件</span>
            <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">// 这个类是一个HashMap,用来基于调度器的名称保证调度器的唯一性</span>
        SchedulerRepository schedRep <span class="token operator">=</span> SchedulerRepository<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果调度器已经存在了</span>
        Scheduler sched <span class="token operator">=</span> schedRep<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token function">getSchedulerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sched <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 调度器关闭了, 移除</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sched<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                schedRep<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token function">getSchedulerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 返回调度器</span>
                <span class="token keyword">return</span> sched<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// 调度器不存在,初始化</span>
        sched <span class="token operator">=</span> <span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> sched<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p><code>instantiate()</code>方法里面做了初始化的所有工作 </p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> Scheduler <span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> SchedulerException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cfg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>initException <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> initException<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 存储任务信息的JobStore</span>
        JobStore js <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 创建线程池,默认是`SimpleThreadPool`</span>
        ThreadPool tp <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 创建调度器</span>
        QuartzScheduler qs <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//连接数据库的连接管理器  </span>
        DBConnectionManager dbMgr <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 自动生成ID</span>
        String instanceIdGeneratorClass <span class="token operator">=</span> null<span class="token punctuation">;</span>
        Properties tProps <span class="token operator">=</span> null<span class="token punctuation">;</span>
        String userTXLocation <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> wrapJobInTx <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> autoId <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> idleWaitTime <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> dbFailureRetry <span class="token operator">=</span> 15000L<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 15 secs</span>
        String classLoadHelperClass<span class="token punctuation">;</span>
        String jobFactoryClass<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 创建线程执行器, 默认为`DefaultThreadExecutor`</span>
        ThreadExecutor threadExecutor<span class="token punctuation">;</span>
    
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="7-1-2-创建线程池-包工头"><a href="#7-1-2-创建线程池-包工头" class="headerlink" title="7.1.2  创建线程池(包工头)"></a>7.1.2  创建线程池(包工头)</h4><p>830行和839行,创建了一个线程池,默认是配置文件中指定的<code>SimpleThreadPool</code></p>
<pre class=" language-java"><code class="language-java"> <span class="token comment" spellcheck="true">// Get ThreadPool Properties</span>
        <span class="token comment" spellcheck="true">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

        String tpClass <span class="token operator">=</span> cfg<span class="token punctuation">.</span><span class="token function">getStringProperty</span><span class="token punctuation">(</span>PROP_THREAD_POOL_CLASS<span class="token punctuation">,</span> SimpleThreadPool<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>tpClass <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            initException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SchedulerException</span><span class="token punctuation">(</span>
                    <span class="token string">"ThreadPool class not specified. "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> initException<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            tp <span class="token operator">=</span> <span class="token punctuation">(</span>ThreadPool<span class="token punctuation">)</span> loadHelper<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>tpClass<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            initException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SchedulerException</span><span class="token punctuation">(</span><span class="token string">"ThreadPool class '"</span>
                    <span class="token operator">+</span> tpClass <span class="token operator">+</span> <span class="token string">"' could not be instantiated."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> initException<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p><code>SimpleThreadPool</code> 里面维护了三个<code>list</code>, 分别存放所有的工作线程、空闲的工作线程和忙碌的工作线程, 我们可以把<code>SimpleThreadPool</code> 理解为包工头. </p>
<pre class=" language-java"><code class="language-java">
    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>WorkerThread<span class="token operator">></span> workers<span class="token punctuation">;</span>
    <span class="token keyword">private</span> LinkedList<span class="token operator">&lt;</span>WorkerThread<span class="token operator">></span> availWorkers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span>WorkerThread<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> LinkedList<span class="token operator">&lt;</span>WorkerThread<span class="token operator">></span> busyWorkers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span>WorkerThread<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>tp</code>的<code>runInThread()</code>方法是线程池运行的接口方法, 存数<code>Runnable</code>是执行的任务内容. </p>
<p>取出<code>WorkerThread</code> 去执行参数里面的<code>runnable</code>（<code>JobRunShell</code>）</p>
<p><code>org.quartz.simpl.SimpleThreadPool#runInThread</code></p>
<pre class=" language-java"><code class="language-java">  WorkerThread wt <span class="token operator">=</span> <span class="token punctuation">(</span>WorkerThread<span class="token punctuation">)</span>availWorkers<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                busyWorkers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                wt<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="7-1-3-WorkerThread-工人"><a href="#7-1-3-WorkerThread-工人" class="headerlink" title="7.1.3 WorkerThread(工人)"></a>7.1.3 <code>WorkerThread</code>(工人)</h4><p><code>WorkerThread</code>是<code>SimpleThreadPool</code>的内部类,用来执行任务,我们把<code>WorkerThread</code> 理解为工人, 在<code>WorkerThread</code>的<code>run</code> 方法中, 执行传入的参数<code>runnable</code>任务. </p>
<pre class=" language-java"><code class="language-java">  <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> ran <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            
            <span class="token keyword">while</span> <span class="token punctuation">(</span>run<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span>runnable <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> run<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            lock<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>runnable <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            ran <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// 执行任务</span>
                            runnable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> unblock<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// do nothing (loop will terminate if shutdown() was called</span>
                    <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Worker thread was interrupt()'ed."</span><span class="token punctuation">,</span> unblock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ignore to help with a tomcat glitch</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> exceptionInRunnable<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error while executing the Runnable: "</span><span class="token punctuation">,</span>
                            exceptionInRunnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ignore to help with a tomcat glitch</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">finally</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        runnable <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// repair the thread in case the runnable mucked it up...</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> tp<span class="token punctuation">.</span><span class="token function">getThreadPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token function">setPriority</span><span class="token punctuation">(</span>tp<span class="token punctuation">.</span><span class="token function">getThreadPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>runOnce<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                           run<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">clearFromBusyWorkersList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ran<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        ran <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token function">makeAvailable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//if (log.isDebugEnabled())</span>
            <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"WorkerThread is shut down."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ignore to help with a tomcat glitch</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="7-1-4-创建调度线程-项目经历"><a href="#7-1-4-创建调度线程-项目经历" class="headerlink" title="7.1.4  创建调度线程(项目经历)"></a>7.1.4  创建调度线程(项目经历)</h4><p><code>org.quartz.impl.StdSchedulerFactory</code>的1321行,创建了调度器<code>QuartzScheduler</code>. </p>
<pre class=" language-java"><code class="language-java">qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuartzScheduler</span><span class="token punctuation">(</span>rsrcs<span class="token punctuation">,</span> idleWaitTime<span class="token punctuation">,</span> dbFailureRetry<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>在<code>QuartzScheduler</code>的构造函数中, 创建了<code>QuartzSchedulerThread</code>,我们把他理解为项目经理, 他会调用包工头的工人资源, 给他们安排任务. </p>
<p>并且创建了线程执行器<code>schedThreadExecutor</code>,执行了这个<code>QuartzSchedulerThread</code>,也就是调用了他的<code>run</code> 方法. </p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token function">QuartzScheduler</span><span class="token punctuation">(</span>QuartzSchedulerResources resources<span class="token punctuation">,</span> <span class="token keyword">long</span> idleWaitTime<span class="token punctuation">,</span> <span class="token annotation punctuation">@Deprecated</span> <span class="token keyword">long</span> dbRetryInterval<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> SchedulerException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resources <span class="token operator">=</span> resources<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resources<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">JobListener</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">addInternalJobListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span>JobListener<span class="token punctuation">)</span>resources<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">// 创建一个线程, resources 里面有线程名称</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>schedThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuartzSchedulerThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//  线程执行器</span>
        ThreadExecutor schedThreadExecutor <span class="token operator">=</span> resources<span class="token punctuation">.</span><span class="token function">getThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 执行这个线程, 也就是调用了线程的run方法</span>
        schedThreadExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>schedThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>idleWaitTime <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>schedThread<span class="token punctuation">.</span><span class="token function">setIdleWaitTime</span><span class="token punctuation">(</span>idleWaitTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        jobMgr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExecutingJobsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addInternalJobListener</span><span class="token punctuation">(</span>jobMgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        errLogger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addInternalSchedulerListener</span><span class="token punctuation">(</span>errLogger<span class="token punctuation">)</span><span class="token punctuation">;</span>

        signaler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SchedulerSignalerImpl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>schedThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Quartz Scheduler v."</span> <span class="token operator">+</span> <span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" created."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>点开<code>QuartzSchedulerThread</code> 类, 找到<code>run</code> 方法,这个就是<code>Quartz</code> 任务调度的核心方法</p>
<pre class=" language-java"><code class="language-java">  <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> acquiresFailed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">// 检查scheduler 是否为停止状态</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>halted<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// check if we're supposed to pause...</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sigLock<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                     <span class="token comment" spellcheck="true">// 检查是否为暂停状态</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>paused <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>halted<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// wait until togglePause(false) is called...</span>
                            <span class="token comment" spellcheck="true">// 暂停的话会尝试去获取信号锁, 并wait一会儿</span>
                            sigLock<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>1000L<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignore<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                        <span class="token comment" spellcheck="true">// reset failure counter when paused, so that we don't</span>
                        <span class="token comment" spellcheck="true">// wait again after unpausing</span>
                        acquiresFailed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>halted<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// wait a bit, if reading from job store is consistently</span>
                <span class="token comment" spellcheck="true">// failing (e.g. DB is down or restarting)..</span>
                <span class="token comment" spellcheck="true">// 从JobStore 中获取job持续失败, sleep一下</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>acquiresFailed <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">long</span> delay <span class="token operator">=</span> <span class="token function">computeDelayForRepeatedErrors</span><span class="token punctuation">(</span>qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acquiresFailed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignore<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
               <span class="token comment" spellcheck="true">// 从线程获取可用的线程</span>
                <span class="token keyword">int</span> availThreadCount <span class="token operator">=</span> qsRsrcs<span class="token punctuation">.</span><span class="token function">getThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">blockForAvailableThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>availThreadCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// will always be true, due to semantics of blockForAvailableThreads...</span>

                    List<span class="token operator">&lt;</span>OperableTrigger<span class="token operator">></span> triggers<span class="token punctuation">;</span>

                    <span class="token keyword">long</span> now <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token function">clearSignaledSchedulingChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 获取需要下次执行的 triggers</span>
                        <span class="token comment" spellcheck="true">// idleWaitTime： 默认 30s</span>
                        <span class="token comment" spellcheck="true">// availThreadCount：获取可用（空闲）的工作线程数量，总会大于 1，因为该方法会一直阻塞，直到有工作线程空闲下来。</span>
                        <span class="token comment" spellcheck="true">// maxBatchSize：一次拉取 trigger 的最大数量，默认是 1</span>
                        <span class="token comment" spellcheck="true">// batchTimeWindow：时间窗口调节参数，默认是 0</span>
                        <span class="token comment" spellcheck="true">// misfireThreshold： 超过这个时间还未触发的 trigger，被认为发生了 misfire，默认 60s</span>
                        <span class="token comment" spellcheck="true">// 调度线程一次会拉取 NEXT_FIRETIME 小于（now + idleWaitTime +batchTimeWindow）,大于（now - misfireThreshold）的，min(availThreadCount,maxBatchSize)个 triggers，默认情况下，会拉取未来 30s、过去 60s 之间还未 fire 的 1 个 trigger</span>
                        triggers <span class="token operator">=</span> qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acquireNextTriggers</span><span class="token punctuation">(</span>
                                now <span class="token operator">+</span> idleWaitTime<span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>availThreadCount<span class="token punctuation">,</span> qsRsrcs<span class="token punctuation">.</span><span class="token function">getMaxBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> qsRsrcs<span class="token punctuation">.</span><span class="token function">getBatchTimeWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        acquiresFailed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"batch acquisition of "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>triggers <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> triggers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" triggers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JobPersistenceException</span> jpe<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>acquiresFailed <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            qs<span class="token punctuation">.</span><span class="token function">notifySchedulerListenersError</span><span class="token punctuation">(</span>
                                <span class="token string">"An error occurred while scanning for the next triggers to fire."</span><span class="token punctuation">,</span>
                                jpe<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>acquiresFailed <span class="token operator">&lt;</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span>
                            acquiresFailed<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>acquiresFailed <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"quartzSchedulerThreadLoop: RuntimeException "</span>
                                    <span class="token operator">+</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>acquiresFailed <span class="token operator">&lt;</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span>
                            acquiresFailed<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>triggers <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>triggers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

                        now <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">long</span> triggerTime <span class="token operator">=</span> triggers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNextFireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">long</span> timeUntilTrigger <span class="token operator">=</span> triggerTime <span class="token operator">-</span> now<span class="token punctuation">;</span>
                        <span class="token keyword">while</span><span class="token punctuation">(</span>timeUntilTrigger <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sigLock<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>halted<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isCandidateNewTimeEarlierWithinReason</span><span class="token punctuation">(</span>triggerTime<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                    <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                        <span class="token comment" spellcheck="true">// we could have blocked a long while</span>
                                        <span class="token comment" spellcheck="true">// on 'synchronize', so we must recompute</span>
                                        now <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        timeUntilTrigger <span class="token operator">=</span> triggerTime <span class="token operator">-</span> now<span class="token punctuation">;</span>
                                        <span class="token keyword">if</span><span class="token punctuation">(</span>timeUntilTrigger <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">)</span>
                                            sigLock<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>timeUntilTrigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignore<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">releaseIfScheduleChangedSignificantly</span><span class="token punctuation">(</span>triggers<span class="token punctuation">,</span> triggerTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                            now <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            timeUntilTrigger <span class="token operator">=</span> triggerTime <span class="token operator">-</span> now<span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                        <span class="token comment" spellcheck="true">// this happens if releaseIfScheduleChangedSignificantly decided to release triggers</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>triggers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>

                        <span class="token comment" spellcheck="true">// set triggers to 'executing'</span>
                        List<span class="token operator">&lt;</span>TriggerFiredResult<span class="token operator">></span> bndles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>TriggerFiredResult<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">boolean</span> goAhead <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>sigLock<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            goAhead <span class="token operator">=</span> <span class="token operator">!</span>halted<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>goAhead<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// 触发 Trigger，把 ACQUIRED 状态改成 EXECUTING</span>
                                <span class="token comment" spellcheck="true">// 如果这个 trigger 的 NEXTFIRETIME 为空，也就是未来不再触发，就将其状态改为COMPLETE</span>
                                <span class="token comment" spellcheck="true">// 如果 trigger 不允许并发执行（即 Job 的实现类标注了@DisallowConcurrentExecution），则将状态变为 BLOCKED，否则就将状态改为 WAITING                      </span>
                                List<span class="token operator">&lt;</span>TriggerFiredResult<span class="token operator">></span> res <span class="token operator">=</span> qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">triggersFired</span><span class="token punctuation">(</span>triggers<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                                    bndles <span class="token operator">=</span> res<span class="token punctuation">;</span>
                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SchedulerException</span> se<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                qs<span class="token punctuation">.</span><span class="token function">notifySchedulerListenersError</span><span class="token punctuation">(</span>
                                        <span class="token string">"An error occurred while firing triggers '"</span>
                                                <span class="token operator">+</span> triggers <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> se<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">//QTZ-179 : a problem occurred interacting with the triggers from the db</span>
                                <span class="token comment" spellcheck="true">//we release them and loop again</span>
                                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> triggers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                    qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">releaseAcquiredTrigger</span><span class="token punctuation">(</span>triggers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 循环处理Trigger</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bndles<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            TriggerFiredResult result <span class="token operator">=</span>  bndles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            TriggerFiredBundle bndle <span class="token operator">=</span>  result<span class="token punctuation">.</span><span class="token function">getTriggerFiredBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            Exception exception <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"RuntimeException while firing trigger "</span> <span class="token operator">+</span> triggers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">releaseAcquiredTrigger</span><span class="token punctuation">(</span>triggers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                            <span class="token comment" spellcheck="true">// it's possible to get 'null' if the triggers was paused,</span>
                            <span class="token comment" spellcheck="true">// blocked, or other similar occurrences that prevent it being</span>
                            <span class="token comment" spellcheck="true">// fired at this time...  or if the scheduler was shutdown (halted)</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>bndle <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">releaseAcquiredTrigger</span><span class="token punctuation">(</span>triggers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                            JobRunShell shell <span class="token operator">=</span> null<span class="token punctuation">;</span>
                            <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// 根据trigger 信息实例化JobRunShell(implements Runnable),同时依据JOB_CLASS_NAME 实例化 Job，随后我们将 JobRunShell 实例丢入工作线。</span>
                                shell <span class="token operator">=</span> qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobRunShellFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createJobRunShell</span><span class="token punctuation">(</span>bndle<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                shell<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>qs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SchedulerException</span> se<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">triggeredJobComplete</span><span class="token punctuation">(</span>triggers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> bndle<span class="token punctuation">.</span><span class="token function">getJobDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CompletedExecutionInstruction<span class="token punctuation">.</span>SET_ALL_JOB_TRIGGERS_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                           <span class="token comment" spellcheck="true">// 执行JobRunShell的run方法</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>qsRsrcs<span class="token punctuation">.</span><span class="token function">getThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">runInThread</span><span class="token punctuation">(</span>shell<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// this case should never happen, as it is indicative of the</span>
                                <span class="token comment" spellcheck="true">// scheduler being shutdown or a bug in the thread pool or</span>
                                <span class="token comment" spellcheck="true">// a thread pool being used concurrently - which the docs</span>
                                <span class="token comment" spellcheck="true">// say not to do...</span>
                                <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"ThreadPool.runInThread() return false!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">triggeredJobComplete</span><span class="token punctuation">(</span>triggers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> bndle<span class="token punctuation">.</span><span class="token function">getJobDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CompletedExecutionInstruction<span class="token punctuation">.</span>SET_ALL_JOB_TRIGGERS_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                        <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// while (!halted)</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// if(availThreadCount > 0)</span>
                    <span class="token comment" spellcheck="true">// should never happen, if threadPool.blockForAvailableThreads() follows contract</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// while (!halted)</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                <span class="token keyword">long</span> now <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">long</span> waitTime <span class="token operator">=</span> now <span class="token operator">+</span> <span class="token function">getRandomizedIdleWaitTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">long</span> timeUntilContinue <span class="token operator">=</span> waitTime <span class="token operator">-</span> now<span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span><span class="token punctuation">(</span>sigLock<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>halted<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// QTZ-336 A job might have been completed in the mean time and we might have</span>
                        <span class="token comment" spellcheck="true">// missed the scheduled changed signal by not waiting for the notify() yet</span>
                        <span class="token comment" spellcheck="true">// Check that before waiting for too long in case this very job needs to be</span>
                        <span class="token comment" spellcheck="true">// scheduled very soon</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isScheduleChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                          sigLock<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>timeUntilContinue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignore<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>RuntimeException re<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Runtime error occurred in main trigger firing loop."</span><span class="token punctuation">,</span> re<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// while (!halted)</span>

        <span class="token comment" spellcheck="true">// drop references to scheduler stuff to aid garbage collection...</span>
        qs <span class="token operator">=</span> null<span class="token punctuation">;</span>
        qsRsrcs <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h5 id="JobRunShell的作用"><a href="#JobRunShell的作用" class="headerlink" title="JobRunShell的作用"></a>JobRunShell的作用</h5><blockquote>
<p>JobRunShell instances are responsible for providing the ‘safe’ environment for Job s to run in, and for performing all of the work of executing the Job, catching ANY thrown exceptions, updating the Trigger with the Job’s completion code, etc.</p>
<p> A JobRunShell instance is created by a JobRunShellFactory on behalf of the QuartzSchedulerThread which then runs the shell in a thread from the configured ThreadPool when the scheduler determines that a Job has been triggered. </p>
<p>JobRunShell 用来为 Job 提供安全的运行环境的，执行 Job 中所有的作业，捕获运行中的异常，在任务执行完毕的 时候更新 Trigger 状态，等等。 </p>
<p>JobRunShell 实例是用 JobRunShellFactory 为 QuartzSchedulerThread 创建的，在调度器决定一个 Job 被触发的时候， 它从线程池中取出一个线程来执行任务。</p>
</blockquote>
<h4 id="7-1-5-线程模型总结"><a href="#7-1-5-线程模型总结" class="headerlink" title="7.1.5  线程模型总结"></a>7.1.5  线程模型总结</h4><p><code>SimpleThreadPool</code>：包工头，管理所有 <code>WorkerThread</code> </p>
<p><code>WorkerThread</code>：工人，把 Job 包装成 <code>JobRunShell</code>，执行 </p>
<p><code>QuartSchedulerThread</code>：项目经理，获取即将触发的 <code>Trigger</code>，从包工头出拿到 <code>worker</code>，执行 <code>Trigger</code> 绑定的任务</p>
<h3 id="7-2-绑定JobDetail和Trigger"><a href="#7-2-绑定JobDetail和Trigger" class="headerlink" title="7.2 绑定JobDetail和Trigger"></a>7.2 绑定<code>JobDetail</code>和<code>Trigger</code></h3><pre class=" language-java"><code class="language-java">       <span class="token comment" spellcheck="true">//存储JobDetail和Trigger</span>
        resources<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">storeJobAndTrigger</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">,</span> trig<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">// 通知相关的Listener</span>
        <span class="token function">notifySchedulerListenersJobAdded</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">notifySchedulerThread</span><span class="token punctuation">(</span>trigger<span class="token punctuation">.</span><span class="token function">getNextFireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">notifySchedulerListenersSchduled</span><span class="token punctuation">(</span>trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="7-3-启动调度器"><a href="#7-3-启动调度器" class="headerlink" title="7.3 启动调度器"></a>7.3 启动调度器</h3><pre class=" language-java"><code class="language-java">        <span class="token comment" spellcheck="true">// QTZ-212 : calling new schedulerStarting() method on the listeners</span>
        <span class="token comment" spellcheck="true">// right after entering start()</span>
        <span class="token comment" spellcheck="true">// 通知监听器</span>
        <span class="token function">notifySchedulerListenersStarting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>initialStart <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            initialStart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>resources<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">schedulerStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
            <span class="token function">startPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            resources<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">schedulerResumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">// 通知QuartzSchedulerThread 不再等待, 开始干活</span>
        schedThread<span class="token punctuation">.</span><span class="token function">togglePause</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>
                <span class="token string">"Scheduler "</span> <span class="token operator">+</span> resources<span class="token punctuation">.</span><span class="token function">getUniqueIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" started."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 通知监听器</span>
        <span class="token function">notifySchedulerListenersStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="7-4-源码总结"><a href="#7-4-源码总结" class="headerlink" title="7.4  源码总结"></a>7.4  源码总结</h3><p><code>getScheduler</code> 方法创建线程池 <code>ThreadPool</code>，创建调度器 <code>QuartzScheduler</code>，创建 调度线程 <code>QuartzSchedulerThread</code>，调度线程初始处于暂停状态。 </p>
<p><code>scheduleJob</code> 将任务添加到 <code>JobStore</code> 中。 </p>
<p><code>scheduler.start()</code>方法激活调度器，<code>QuartzSchedulerThread</code> 从 <code>timeTrriger</code> 取出待 触 发 的 任 务 ， 并 包 装 成 <code>TriggerFiredBundle</code> ， 然 后 由 <code>JobRunShellFactory</code> 创 建 <code>TriggerFiredBundle</code> 的 执 行 线 程 <code>JobRunShell</code> ， 调 度 执 行 通 过 线 程 池 <code>SimpleThreadPool</code> 去执行 <code>JobRunShell</code>，而<code> JobRunShell</code> 执行的就是任务类的 <code>execute</code> 方法：<code>job.execute(JobExecutionContext context)</code>。</p>
<h3 id="7-5-集群原理"><a href="#7-5-集群原理" class="headerlink" title="7.5  集群原理"></a>7.5  集群原理</h3><p>基于数据库,如何实现任务的不重跑不漏跑. </p>
<p>问题1: 如果任务执行中的资源是”下一个即将触发的任务”, 怎么基于数据库实现这个资源的竞争的? </p>
<p>问题2: 怎么对数据进行行加锁? </p>
<p><img src="http://files.luyanan.com//img/20200410215231.png" alt="image-20200410215228221"></p>
<p><code>QuartzSchedulerThread</code> 第287行, 获取下一个即将触发的<code>Trigger</code></p>
<pre class=" language-java"><code class="language-java">triggers <span class="token operator">=</span> qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acquireNextTriggers</span><span class="token punctuation">(</span>
</code></pre>
<p>调用 <code>JobStoreSupport</code> 的 <code>acquireNextTriggers()</code>方法，2793 行</p>
<p>调用 <code>JobStoreSupport.executeInNonManagedTXLock()</code>方法，3829 行：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">return</span> <span class="token function">executeInNonManagedTXLock</span><span class="token punctuation">(</span>lockName
</code></pre>
<p>尝试获取锁,3843行</p>
<pre class=" language-java"><code class="language-java">transOwner <span class="token operator">=</span> <span class="token function">getLockHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">obtainLock</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> lockName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>下面有回滚和释放锁的语句, 即时发生异常,锁同样能够释放. </p>
<p>调用 <code>DBSemaphore</code> 的 <code>obtainLock()</code>方法，103 行</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">obtainLock</span><span class="token punctuation">(</span>Connection conn<span class="token punctuation">,</span> String lockName<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> LockException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
                <span class="token string">"Lock '"</span> <span class="token operator">+</span> lockName <span class="token operator">+</span> <span class="token string">"' is desired by: "</span>
                        <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isLockOwner</span><span class="token punctuation">(</span>lockName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

            <span class="token function">executeSQL</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> lockName<span class="token punctuation">,</span> expandedSQL<span class="token punctuation">,</span> expandedInsertSQL<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
                    <span class="token string">"Lock '"</span> <span class="token operator">+</span> lockName <span class="token operator">+</span> <span class="token string">"' given to: "</span>
                            <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">getThreadLocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>lockName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//getThreadLocksObtainer().put(lockName, new</span>
            <span class="token comment" spellcheck="true">// Exception("Obtainer..."));</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
                <span class="token string">"Lock '"</span> <span class="token operator">+</span> lockName <span class="token operator">+</span> <span class="token string">"' Is already owned by: "</span>
                        <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>调用<code>org.quartz.impl.jdbcjobstore.DBSemaphore#executeSQL</code> 方法. 最终调用JDBC 执行SQL语句, 语句内容是<code>expandedSQL</code> 和 <code>expandedInsertSQL。</code></p>
<pre class=" language-java"><code class="language-java">ps <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>expandedSQL<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>问题：<code>expandedSQL</code> 和 <code>expandedInsertSQL</code> 是一条什么 SQL 语句？似乎我们没 有赋值？</p>
<p>在<code>StdRowLockSemaphore</code> 的构造函数中, 把定义的两条SQL 传进去</p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token function">StdRowLockSemaphore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>DEFAULT_TABLE_PREFIX<span class="token punctuation">,</span> null<span class="token punctuation">,</span> SELECT_FOR_LOCK<span class="token punctuation">,</span> INSERT_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SELECT_FOR_LOCK <span class="token operator">=</span> <span class="token string">"SELECT * FROM "</span>
            <span class="token operator">+</span> TABLE_PREFIX_SUBST <span class="token operator">+</span> TABLE_LOCKS <span class="token operator">+</span> <span class="token string">" WHERE "</span> <span class="token operator">+</span> COL_SCHEDULER_NAME <span class="token operator">+</span> <span class="token string">" = "</span> <span class="token operator">+</span> SCHED_NAME_SUBST
            <span class="token operator">+</span> <span class="token string">" AND "</span> <span class="token operator">+</span> COL_LOCK_NAME <span class="token operator">+</span> <span class="token string">" = ? FOR UPDATE"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String INSERT_LOCK <span class="token operator">=</span> <span class="token string">"INSERT INTO "</span>
        <span class="token operator">+</span> TABLE_PREFIX_SUBST <span class="token operator">+</span> TABLE_LOCKS <span class="token operator">+</span> <span class="token string">"("</span> <span class="token operator">+</span> COL_SCHEDULER_NAME <span class="token operator">+</span> <span class="token string">", "</span> <span class="token operator">+</span> COL_LOCK_NAME <span class="token operator">+</span> <span class="token string">") VALUES ("</span> 
        <span class="token operator">+</span> SCHED_NAME_SUBST <span class="token operator">+</span> <span class="token string">", ?)"</span><span class="token punctuation">;</span> 
</code></pre>
<p>他调用了父类**<code>DBSemaphore</code>**的构造函数</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">DBSemaphore</span><span class="token punctuation">(</span>String tablePrefix<span class="token punctuation">,</span> String schedName<span class="token punctuation">,</span> String defaultSQL<span class="token punctuation">,</span> String defaultInsertSQL<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tablePrefix <span class="token operator">=</span> tablePrefix<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>schedName <span class="token operator">=</span> schedName<span class="token punctuation">;</span>
        <span class="token function">setSQL</span><span class="token punctuation">(</span>defaultSQL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setInsertSQL</span><span class="token punctuation">(</span>defaultInsertSQL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>在 <code>setSQL()</code>和 <code>setInsertSQL()</code>中为 <code>expandedSQL</code> 和 <code>expandedInsertSQL</code> 赋值。</p>
<p>执行的SQL语句:</p>
<pre class=" language-mysql"><code class="language-mysql">select * from QRTZ_LOCKS t where t.lock_name='TRIGGER_ACCESS' for update
</code></pre>
<p>在我们执行官方的建表脚本的时候,<code>QRTZ_LOCKS</code> 表,他会为每个调度器创建两行数据， 获取<code>Trigger</code>  和触发<code>Trigger</code>是两把锁</p>
<p><img src="http://files.luyanan.com//img/20200410222927.png" alt="image-20200410222925535"></p>
<h3 id="7-6-任务为什么重复执行"><a href="#7-6-任务为什么重复执行" class="headerlink" title="7.6  任务为什么重复执行?"></a>7.6  任务为什么重复执行?</h3><p>在多个调度器中,任务没有重复执行, 也就是默认会加锁, 什么情况下不会上锁呢? </p>
<p><code>JobStoreSupport</code> 的 <code>executeInNonManagedTXLock()</code> 方法</p>
<p>如果<code>lockName</code> 为空, 则不上锁. </p>
<pre class=" language-java"><code class="language-java"> <span class="token keyword">protected</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">executeInNonManagedTXLock</span><span class="token punctuation">(</span>
            String lockName<span class="token punctuation">,</span> 
            TransactionCallback<span class="token operator">&lt;</span>T<span class="token operator">></span> txCallback<span class="token punctuation">,</span> <span class="token keyword">final</span> TransactionValidator<span class="token operator">&lt;</span>T<span class="token operator">></span> txValidator<span class="token punctuation">)</span> <span class="token keyword">throws</span> JobPersistenceException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> transOwner <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        Connection conn <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lockName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// If we aren't using db locks, then delay getting DB connection </span>
                <span class="token comment" spellcheck="true">// until after acquiring the lock since it isn't needed.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getLockHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requiresConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    conn <span class="token operator">=</span> <span class="token function">getNonManagedTXConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                
                transOwner <span class="token operator">=</span> <span class="token function">getLockHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">obtainLock</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> lockName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                conn <span class="token operator">=</span> <span class="token function">getNonManagedTXConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            
            <span class="token keyword">final</span> T result <span class="token operator">=</span> txCallback<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">commitConnection</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JobPersistenceException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">rollbackConnection</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>txValidator <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">retryExecuteInNonManagedTXLock</span><span class="token punctuation">(</span>lockName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TransactionCallback</span><span class="token operator">&lt;</span>Boolean<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> Boolean <span class="token function">execute</span><span class="token punctuation">(</span>Connection conn<span class="token punctuation">)</span> <span class="token keyword">throws</span> JobPersistenceException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> txValidator<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            Long sigTime <span class="token operator">=</span> <span class="token function">clearAndGetSignalSchedulingChangeOnTxCompletion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>sigTime <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> sigTime <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">signalSchedulingChangeImmediately</span><span class="token punctuation">(</span>sigTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JobPersistenceException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">rollbackConnection</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">rollbackConnection</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JobPersistenceException</span><span class="token punctuation">(</span><span class="token string">"Unexpected runtime exception: "</span>
                    <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">finally</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">releaseLock</span><span class="token punctuation">(</span>lockName<span class="token punctuation">,</span> transOwner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">finally</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">cleanupConnection</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>而上一步 <code>JobStoreSupport</code> 的 <code>acquireNextTriggers()</code>方法，</p>
<ol>
<li>如果<code>acquireTriggersWithinLock=true</code> 或 者 <code>batchTriggerAcquisitionMaxCount&gt;1 </code>时 ， <code>locaName</code> 赋 值 为 <code>LOCK_TRIGGER_ACCESS</code>，此时获取 <code>Trigger</code> 会加锁。</li>
<li>否则，如果 <code>isAcquireTriggersWithinLock()</code>值是 false 并且 <code>maxCount=1</code> 的话， <code>lockName</code> 赋值为 null，这种情况获取 <code>Trigger</code> 下不加锁。</li>
</ol>
<pre class=" language-java"><code class="language-java">   <span class="token keyword">public</span> List<span class="token operator">&lt;</span>OperableTrigger<span class="token operator">></span> <span class="token function">acquireNextTriggers</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> noLaterThan<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> maxCount<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeWindow<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> JobPersistenceException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        
        String lockName<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isAcquireTriggersWithinLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> maxCount <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> 
            lockName <span class="token operator">=</span> LOCK_TRIGGER_ACCESS<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            lockName <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">executeInNonManagedTXLock</span><span class="token punctuation">(</span>lockName<span class="token punctuation">,</span> 
                <span class="token keyword">new</span> <span class="token class-name">TransactionCallback</span><span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>OperableTrigger<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>OperableTrigger<span class="token operator">></span> <span class="token function">execute</span><span class="token punctuation">(</span>Connection conn<span class="token punctuation">)</span> <span class="token keyword">throws</span> JobPersistenceException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token function">acquireNextTrigger</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> noLaterThan<span class="token punctuation">,</span> maxCount<span class="token punctuation">,</span> timeWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">TransactionValidator</span><span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>OperableTrigger<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">public</span> Boolean <span class="token function">validate</span><span class="token punctuation">(</span>Connection conn<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>OperableTrigger<span class="token operator">></span> result<span class="token punctuation">)</span> <span class="token keyword">throws</span> JobPersistenceException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            List<span class="token operator">&lt;</span>FiredTriggerRecord<span class="token operator">></span> acquired <span class="token operator">=</span> <span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">selectInstancesFiredTriggerRecords</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token function">getInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            Set<span class="token operator">&lt;</span>String<span class="token operator">></span> fireInstanceIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span>FiredTriggerRecord ft <span class="token operator">:</span> acquired<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                fireInstanceIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ft<span class="token punctuation">.</span><span class="token function">getFireInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span>OperableTrigger tr <span class="token operator">:</span> result<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>fireInstanceIds<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span><span class="token function">getFireInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JobPersistenceException</span><span class="token punctuation">(</span><span class="token string">"error validating trigger acquisition"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p><code>acquireTriggersWithinLock</code> 变量默认是 false：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> acquireTriggersWithinLock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre>
<p><code>maxCount</code> 来自 <code>QuartzSchedulerThread</code>：</p>
<pre class=" language-java"><code class="language-java">triggers <span class="token operator">=</span> qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acquireNextTriggers</span><span class="token punctuation">(</span>
now <span class="token operator">+</span> idleWaitTime<span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>availThreadCount<span class="token punctuation">,</span> qsRsrcs<span class="token punctuation">.</span><span class="token function">getMaxBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> qsRsrcs<span class="token punctuation">.</span><span class="token function">getBatchTimeWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>getMaxBatchSize()</code>来自 <code>QuartzSchedulerResources</code>，代表 <code>Scheduler</code> 一次拉取 <code>trigger</code> 的最大数量，默认是 1：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> maxBatchSize <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
<p>这个值可以通过参数修改, 代表允许调度程序节点获取(用于触发)的触发器的最大量,默认值是1</p>
<pre class=" language-java"><code class="language-java">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span>batchTriggerAcquisitionMaxCount<span class="token operator">=</span><span class="token number">1</span>
</code></pre>
<p>根据以上两个默认值，理论上在获取 <code>Trigger</code> 的时候不会上锁，但是实际上为什么没 有出现频繁的重复执行问题？因为每个调度器的线程持有锁的时间太短了，单机的测试 无法体现，而在高并发的情况下，有可能会出现这个问题。</p>
<p><code>QuartzSchedulerThread </code>的 <code>triggersFired()</code>方法：</p>
<pre class=" language-java"><code class="language-java">List<span class="token operator">&lt;</span>TriggerFiredResult<span class="token operator">></span> res <span class="token operator">=</span> qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">triggersFired</span><span class="token punctuation">(</span>triggers<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>调用了 <code>JobStoreSupport</code> 的 <code>triggersFired()</code>方法，接着又调用了一个 <code>triggerFired triggerFired(Connection conn, OperableTrigger trigger)</code>方法：</p>
<p>如果 <code>Trigger</code> 的状态不是 <code>ACQUIRED</code>，也就是说被其他的线程 <code>fire</code> 了，返回空。但 是这种乐观锁的检查在高并发下难免会出现 ABA 的问题，比如线程 A 拿到的时候还是<code>ACQUIRED</code> 状态，但是刚准备执行的时候已经变成了 <code>EXECUTING</code> 状态，这个时候就会 出现重复执行的问题。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>STATE_ACQUIRED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> null<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>总结，如果： 如果设置的数量为 1（默认值），并且使用 <code>JDBC JobStore</code>（<code>RAMJobStore</code> 不支持 分 布 式 ， 只 有 一 个 调 度 器 实 例 ， 所 以 不 加 锁 ） ， 则 属 性 <code>org.quartz.jobStore.acquireTriggersWithinLock</code> 应设置为 true。否则不加锁可能会导 致任务重复执行。</p>
<h2 id="8-Quzrtz-Misfire"><a href="#8-Quzrtz-Misfire" class="headerlink" title="8. Quzrtz-Misfire"></a>8. <code>Quzrtz-Misfire</code></h2><p>**什么情况下会错过触发? 错过触发怎么样? **</p>
<p>线程池只有5个线程,当有5个任务都在执行的时候,第六个任务即将触发,这个时候任务就不能得到执行.在<code>quartz.properties</code>中有一个属性<code>misfireThresh</code>,用来定义触发器超时的<code>临界值</code>, 也就是超过了这个时间,就算错过了触发. </p>
<p>例如, 如果<code>misfireThresh</code> 是6000(6秒),9点整应该执行的任务, 9点零1分还没有可用的线程去执行它,就是超时(<code>misfires</code>)</p>
<p>下面这些原因可能造成<code>misfires job</code>:</p>
<ol>
<li>没有可用的线程</li>
<li><code>Trigger</code>被暂停</li>
<li>系统重启</li>
<li>禁止并发执行的任务在到达触发时间的时候,上次执行的任务还没有结束. </li>
</ol>
<p>错过触发怎么办? <code>misfire</code> 策略设置:</p>
<p>每一种<code>Trigger</code> 都定义了自己的   <code>Misfire</code> 策略,不同的策略通过不同的方法来设置, </p>
<pre class=" language-java"><code class="language-java">        <span class="token comment" spellcheck="true">// Trigger1</span>
        Trigger trigger <span class="token operator">=</span> TriggerBuilder<span class="token punctuation">.</span><span class="token function">newTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"trigger1"</span><span class="token punctuation">,</span> <span class="token string">"group1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withSchedule</span><span class="token punctuation">(</span>SimpleScheduleBuilder<span class="token punctuation">.</span><span class="token function">simpleSchedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                        <span class="token function">withMisfireHandlingInstructionNowWithExistingCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                        <span class="token function">withIntervalInSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                        <span class="token function">repeatForever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>大体来说 , 可以分为三种: </p>
<ul>
<li>忽略</li>
<li>立即跑一次</li>
<li>下次跑</li>
</ul>
<p>详细内容参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/daxin/p/3919927.html">Quartz Scheduler misfireThreshold属性的意义与触发器超时后的处理策略</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/skyLogin/p/6927629.html">quartz-misfire 错失、补偿执行</a></p>
<p><strong>怎么避免任务错过触发</strong>:</p>
<ul>
<li>合理的设置线程池数量,以及任务触发间隔. </li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">luyanan</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://rainsoil.github.io/2022/01/04/ren-wu-diao-du/ren-wu-diao-du-zhi-quartz/">https://rainsoil.github.io/2022/01/04/ren-wu-diao-du/ren-wu-diao-du-zhi-quartz/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">luyanan</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/01/04/window/window10-ding-shi-ren-wu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/21.jpg" class="responsive-img" alt="window10 定时任务">
                        
                        <span class="card-title">window10 定时任务</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-01-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/window/" class="post-category">
                                    window
                                </a>
                            
                            <a href="/categories/window/window/" class="post-category">
                                    window
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/01/04/fen-bu-shi/1.man-tan-fen-bu-shi-jia-gou/fen-bu-shi-jia-gou-de-yan-jin-guo-cheng-1/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/23.jpg" class="responsive-img" alt="分布式架构的演进过程(1)">
                        
                        <span class="card-title">分布式架构的演进过程(1)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-01-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/1-%E6%BC%AB%E8%B0%88%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/" class="post-category">
                                    1. 漫谈分布式架构
                                </a>
                            
                            <a href="/categories/1-%E6%BC%AB%E8%B0%88%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/%E5%88%86%E5%B8%83%E5%BC%8F/" class="post-category">
                                    分布式
                                </a>
                            
                            <a href="/categories/1-%E6%BC%AB%E8%B0%88%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F/" class="post-category">
                                    分布式
                                </a>
                            
                            <a href="/categories/1-%E6%BC%AB%E8%B0%88%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F/1-%E6%BC%AB%E8%B0%88%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/" class="post-category">
                                    1. 漫谈分布式架构
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <a href="/about" target="_blank">luyanan</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">803.3k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/rainsoil" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:luyanan0718@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=914596513" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 914596513" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
